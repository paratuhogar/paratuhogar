<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHADOW MARKETER | War Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Librer√≠a para comprimir ZIP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        body { font-family: 'Rajdhani', sans-serif; background-color: #050505; color: #e2e8f0; }
        .neon-border { box-shadow: 0 0 10px rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.5); }
        .loader { width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Ocultar canvas de procesamiento */
        #generator-canvas { display: none; }
    </style>
</head>
<body class="min-h-screen p-6">

    <!-- HEADER -->
    <header class="max-w-6xl mx-auto flex justify-between items-center mb-10 border-b border-gray-800 pb-4">
        <div>
            <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-indigo-500 uppercase tracking-widest">
                SHADOW MARKETER
            </h1>
            <p class="text-xs text-gray-500 font-bold uppercase tracking-[0.3em]">Operaciones de Marketing Automatizado v1.0</p>
        </div>
        <div class="flex gap-4">
            <button onclick="loadPendingProducts()" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded text-xs font-bold uppercase tracking-wider transition-all">
                üîÑ Escanear Nuevos
            </button>
            <button id="btn-nuke" onclick="startBatchGeneration()" class="px-6 py-2 bg-gradient-to-r from-purple-700 to-indigo-600 text-white rounded font-black uppercase tracking-widest shadow-lg shadow-purple-900/50 hover:scale-105 transition-all flex items-center gap-2">
                <span class="material-symbols-outlined">auto_fix_high</span> Generar Todo
            </button>
        </div>
    </header>

    <!-- GRID DE PRODUCTOS -->
    <main class="max-w-6xl mx-auto">
        <div id="status-bar" class="mb-6 text-sm text-gray-400 font-mono hidden"></div>
        <div id="war-grid" class="grid grid-cols-1 gap-6">
            <!-- AQU√ç SE INYECTAN LAS TARJETAS -->
            <div class="text-center py-20 opacity-50">
                <span class="material-symbols-outlined text-6xl text-gray-700">radar</span>
                <p class="mt-4 text-gray-600 uppercase tracking-widest">Esperando escaneo de la red...</p>
            </div>
        </div>
    </main>

    <!-- CANVAS OCULTO PARA PROCESAMIENTO GRAFICO -->
    <canvas id="generator-canvas" width="1080" height="1080"></canvas>

<script>
    // --- 1. CONFIGURACI√ìN ---
    const SUPABASE_URL = 'https://ljqwaovevfatkiigirhf.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_DAuFcu0JjUo15yLDAev3MQ_9x5GIVXt'; 
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DATOS DEL GESTOR (Modo Dios)
    const AGENT_NAME = "Marcel Montano";
    const AGENT_PHONE = "58183649"; 

    let pendingProducts = [];
    let processing = false;

    // --- 2. SEGURIDAD ---
    window.onload = async () => {
        const pass = prompt("üõ°Ô∏è SALA DE GUERRA\nClave de Mando:");
        if(pass !== "marcel/6") { 
            document.body.innerHTML = "<h1 style='color:red;text-align:center;margin-top:20%;font-family:sans-serif'>ACCESO DENEGADO</h1>";
            return;
        }
        if(!localStorage.getItem('pth_gemini_api_key')) {
            const key = prompt("üîë API Key Gemini:");
            if(key) localStorage.setItem('pth_gemini_api_key', key);
        }
        loadPendingProducts();
    };

    // --- 3. CARGA DE DATOS ---
    async function loadPendingProducts() {
        const grid = document.getElementById('war-grid');
        grid.innerHTML = `<div class="text-center py-10"><span class="loader"></span><p class="mt-2 text-xs text-purple-400">Escaneando...</p></div>`;

        const hace3Dias = new Date();
        hace3Dias.setDate(hace3Dias.getDate() - 3);

        const { data: productos, error } = await supabaseClient
            .from('productos')
            .select('*')
            .gte('created_at', hace3Dias.toISOString())
            .order('created_at', { ascending: false });

        if(error) return alert("Error DB: " + error.message);

        const { data: assets } = await supabaseClient.from('marketing_assets').select('product_id');
        const processedIds = new Set((assets || []).map(a => a.product_id));
        pendingProducts = productos.filter(p => !processedIds.has(p.id));
        
        renderGrid();
    }

    // --- 4. RENDERIZADO UI ---
    function renderGrid() {
        const grid = document.getElementById('war-grid');
        const status = document.getElementById('status-bar');
        
        if(pendingProducts.length === 0) {
            grid.innerHTML = `<div class="text-center py-20 border border-dashed border-gray-800 rounded-xl"><p class="text-gray-500 uppercase">‚úÖ Todo procesado.</p></div>`;
            document.getElementById('btn-nuke').classList.add('opacity-50', 'cursor-not-allowed');
            return;
        }

        document.getElementById('btn-nuke').classList.remove('opacity-50', 'cursor-not-allowed');
        
        // CONTENEDOR DEL POST MASIVO
        let summaryHTML = `
            <div id="batch-summary-box" class="hidden bg-gray-900 border border-indigo-500/50 p-6 rounded-xl mb-8 shadow-2xl relative">
                <h3 class="text-indigo-400 font-black uppercase tracking-widest mb-2 flex items-center gap-2">
                    <span class="material-symbols-outlined">campaign</span> POST DE LANZAMIENTO MASIVO
                </h3>
                <p class="text-[10px] text-gray-400 mb-2">Este texto agrupa todas las novedades. Ideal para Grupos de Facebook y Telegram.</p>
                <textarea id="summary-text-area" class="w-full h-64 bg-black/50 border border-gray-700 text-xs text-green-400 p-4 rounded-lg font-mono resize-none leading-relaxed"></textarea>
                <div class="flex gap-2 mt-2">
                    <button onclick="copyToClipboard('summary-text-area')" class="bg-indigo-600 hover:bg-indigo-500 text-white py-3 px-6 rounded text-xs font-bold uppercase w-full shadow-lg shadow-indigo-500/20">COPIAR POST COMPLETO</button>
                </div>
            </div>
        `;

        status.innerHTML = `DETECTADOS: <span class="text-purple-400 font-bold">${pendingProducts.length} PRODUCTOS</span>`;
        status.classList.remove('hidden');

        let cardsHTML = pendingProducts.map((p, index) => `
            <div id="card-${index}" class="bg-[#0a0a0a] border border-gray-800 p-6 rounded-xl flex gap-6 items-start relative group">
                <div class="w-32 h-32 shrink-0 bg-gray-900 rounded-lg flex items-center justify-center p-2">
                    <img src="${fixDriveUrl(p.thumbnail)}" class="w-full h-full object-contain">
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-black text-white uppercase">${p.nombre}</h3>
                    <p class="text-xs text-gray-500">$${p.precio} USD</p>
                    
                    <div id="result-${index}" class="hidden flex gap-4 mt-4 p-4 bg-gray-900/50 rounded-lg border border-gray-800 animate-fade-in">
                        <div class="w-1/2 relative">
                            <p class="absolute top-2 left-2 bg-black/70 text-[10px] px-2 rounded text-white">Imagen Individual</p>
                            <img id="img-result-${index}" class="w-full h-auto rounded shadow-lg cursor-pointer hover:opacity-90 transition-opacity" onclick="downloadImage(this, '${p.nombre.replace(/'/g, "")}')">
                        </div>
                        <div class="w-1/2 flex flex-col">
                            <textarea id="text-result-${index}" class="w-full h-64 bg-black border border-gray-700 text-xs text-gray-300 p-2 rounded resize-none mb-2 font-mono leading-relaxed"></textarea>
                            <div class="flex gap-2">
                                <button onclick="copyToClipboard('text-result-${index}')" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-xs font-bold uppercase shadow-lg shadow-blue-900/20">Copiar</button>
                                <button onclick="shareFacebook('text-result-${index}')" class="px-3 bg-gray-700 text-white rounded text-xs font-bold uppercase">FB</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="status-${index}" class="absolute top-6 right-6">
                    <span class="px-3 py-1 bg-yellow-900/30 text-yellow-500 border border-yellow-700/50 rounded text-[10px] font-bold uppercase">PENDIENTE</span>
                </div>
            </div>
        `).join('');

        grid.innerHTML = summaryHTML + cardsHTML;
    }

    // --- 5. MOTOR DE GENERACI√ìN MASIVA (L√ìGICA DEL POST CORREGIDA) ---
    async function startBatchGeneration() {
        if(processing) return;
        processing = true;
        const btn = document.getElementById('btn-nuke');
        btn.innerHTML = `<span class="loader"></span> TRABAJANDO...`;

        // === INICIO DEL POST MASIVO (COPYWRITING) ===
        let summaryContent = `üö® *¬°ATENCI√ìN FAMILIA! ACABAN DE ENTRAR* üö®\n\n`;
        summaryContent += `üëã Hola a todos, les traigo lo nuevo que acaba de aterrizar en almac√©n. Calidad garantizada y entrega r√°pida en La Habana. üööüí®\n\n`;
        summaryContent += `‚¨áÔ∏è *MIRA LA LISTA Y PRECIOS AQU√ç* ‚¨áÔ∏è\n\n`;

        for (let i = 0; i < pendingProducts.length; i++) {
            const p = pendingProducts[i];
            document.getElementById(`status-${i}`).innerHTML = `<span class="px-3 py-1 bg-blue-900/30 text-blue-400 border border-blue-700/50 rounded text-[10px] font-bold uppercase animate-pulse">CREANDO...</span>`;

            try {
                // Generaci√≥n Paralela
                const [imgBase64, aiText] = await Promise.all([
                    generateAdImage(p),
                    generateAdCopy(p, i)
                ]);

                // Generar Link Espec√≠fico del Producto
                // --- CAMBIO AQU√ç: GENERAR LINK CORTO REAL ---
                // Usamos await porque ahora consultamos a Supabase
                const finalLink = await getOrGenerateShortLink(p.nombre);
                
                // Link individual para WhatsApp (Para la publicaci√≥n individual)
                const waLinkIndividual = `https://wa.me/${AGENT_PHONE}?text=${encodeURIComponent('Hola Marcel, me interesa: ' + p.nombre)}`;
                
                // Texto Individual Completo
                const finalText = `${aiText}\n\nüîó *Ver Fotos y Detalles:* \n${finalLink}\n\nüì≤ *Pedir YA:* \n${waLinkIndividual}\n\n#VentasHabana #ElectrodomesticosCuba #${p.categoria.replace(/\s+/g,'')} #Cuba`;

                // === AGREGAR AL POST MASIVO (ESTRUCTURA DE VENTA) ===
                summaryContent += `‚úÖ *${p.nombre}*\n`;
                summaryContent += `üí∞ *Precio:* $${p.precio} USD\n`;
                summaryContent += `üëÄ *Ver Fotos:* ${finalLink}\n`;
                summaryContent += `‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n`;

                // Guardar
                await supabaseClient.from('marketing_assets').insert([{ product_id: p.id, ad_copy: finalText }]);

                // UI Individual
                const imgEl = document.getElementById(`img-result-${i}`);
                const txtEl = document.getElementById(`text-result-${i}`);
                imgEl.src = imgBase64;
                txtEl.value = finalText;
                
                document.getElementById(`result-${i}`).classList.remove('hidden');
                document.getElementById(`status-${i}`).innerHTML = `<span class="px-3 py-1 bg-green-900/30 text-green-400 border border-green-700/50 rounded text-[10px] font-bold uppercase">‚úÖ LISTO</span>`;

            } catch (err) {
                console.error(err);
                document.getElementById(`status-${i}`).innerHTML = `<span class="text-red-500">ERROR</span>`;
            }
            await new Promise(r => setTimeout(r, 800)); 
        }

        // === CIERRE DEL POST MASIVO ===
        const waLinkGeneral = `https://wa.me/${AGENT_PHONE}?text=${encodeURIComponent('Hola Marcel, vi el listado de nuevos ingresos y quiero hacer un pedido.')}`;
        
        summaryContent += `\nüöÄ *¬°NO TE QUEDES SIN EL TUYO!* üöÄ\n\n`;
        summaryContent += `üì≤ *Toca aqu√≠ para pedir por WhatsApp:*\n${waLinkGeneral}\n\n`;
        summaryContent += `#VentasHabana #Electrodomesticos #Cuba #Revolico #VentasCuba #EnviosCuba #Paratuhogar`;
        
        // Poner el texto en la caja
        const summaryBox = document.getElementById('batch-summary-box');
        const summaryArea = document.getElementById('summary-text-area');
        summaryArea.value = summaryContent;
        summaryBox.classList.remove('hidden');

        btn.innerHTML = `FINALIZADO`;
        processing = false;
    }

    // --- 6. DISE√ëO GR√ÅFICO (ZONA SEGURA + FOTO GRANDE) ---
    async function generateAdImage(p) {
        const canvas = document.getElementById('generator-canvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;

        // Fondo Dark Mode
        const gradient = ctx.createLinearGradient(0, 0, 0, h);
        gradient.addColorStop(0, '#0f172a'); 
        gradient.addColorStop(1, '#1e1b4b'); 
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, w, h);

        // Grilla
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.03)';
        ctx.lineWidth = 1;
        const gridSize = 60;
        for(let i=0; i<w; i+=gridSize) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,h); ctx.stroke(); }
        for(let i=0; i<h; i+=gridSize) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(w,i); ctx.stroke(); }

        // --- ZONAS DE DIBUJO ---
        // Header: 0 - 200 | Body: 200 - 900 | Footer: 900 - 1080
        
        // 1. HEADER (Limpio)
        ctx.shadowBlur = 0; 
        ctx.textAlign = 'center';
        ctx.fillStyle = '#ffffff';
        ctx.font = '800 60px Rajdhani';
        
        // Envolver T√≠tulo
        const words = p.nombre.split(' ');
        let line = '';
        let yText = 100;
        
        // Si el t√≠tulo es muy largo, subimos un poco el inicio
        if (words.length > 5) yText = 80;

        for(let n = 0; n < words.length; n++) {
            const testLine = line + words[n] + ' ';
            if (ctx.measureText(testLine).width > w - 100 && n > 0) {
                ctx.fillText(line, w/2, yText);
                line = words[n] + ' ';
                yText += 70;
            } else {
                line = testLine;
            }
        }
        ctx.fillText(line, w/2, yText);

        // 2. IMAGEN PRODUCTO (Zona Segura)
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.src = fixDriveUrl(p.thumbnail);
        
        try {
            await new Promise((r, j) => { img.onload = r; img.onerror = j; });
            
            // Espacio disponible para la imagen (entre t√≠tulo y footer)
            const imgAreaY = yText + 50; 
            const imgAreaH = 880 - imgAreaY; 
            
            const scale = Math.min((w - 100) / img.width, imgAreaH / img.height);
            const iw = img.width * scale;
            const ih = img.height * scale;
            
            const ix = (w - iw) / 2;
            const iy = imgAreaY + (imgAreaH - ih) / 2;

            // Fondo blanco "Sticker"
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.roundRect(ix - 15, iy - 15, iw + 30, ih + 30, 20);
            ctx.fill();

            // Sombra imagen
            ctx.shadowColor = "rgba(0,0,0,0.5)";
            ctx.shadowBlur = 20;
            ctx.drawImage(img, ix, iy, iw, ih);
            ctx.shadowBlur = 0;
            
        } catch(e) {}

        // 3. PRECIO (Superpuesto abajo, estilo etiqueta)
        ctx.fillStyle = '#EAB308'; // Amarillo
        ctx.font = '900 130px Rajdhani';
        ctx.shadowColor = "rgba(0,0,0,0.8)";
        ctx.shadowBlur = 30;
        ctx.fillText(`$${p.precio}`, w/2, 850);
        ctx.shadowBlur = 0;
        
        ctx.font = '700 40px Rajdhani';
        ctx.fillStyle = '#fff';
        ctx.fillText("USD", w/2 + (ctx.measureText(`$${p.precio}`).width / 2) + 20, 850);

        // 4. FOOTER
        ctx.fillStyle = '#1e40af'; 
        ctx.fillRect(0, 930, w, 150);
        
        ctx.fillStyle = '#ffffff';
        ctx.font = '700 45px Rajdhani';
        ctx.fillText("üì¶ ENV√çO R√ÅPIDO A TODA LA HABANA", w/2, 990);
        
        ctx.fillStyle = '#fbbf24'; 
        ctx.font = '900 55px Rajdhani';
        ctx.fillText(`üìû PEDIDOS: +53 ${AGENT_PHONE}`, w/2, 1055);

        // 5. BADGE "STOCK" (Esquina)
        ctx.save();
        ctx.translate(920, 180);
        ctx.rotate(15 * Math.PI / 180);
        ctx.fillStyle = '#dc2626';
        ctx.beginPath();
        ctx.roundRect(-100, -40, 200, 80, 15);
        ctx.fill();
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 4;
        ctx.stroke();
        ctx.fillStyle = 'white';
        ctx.font = '900 40px Rajdhani';
        ctx.fillText("STOCK", 0, 15);
        ctx.restore();

        return canvas.toDataURL('image/jpeg', 0.95);
    }

    // --- 7. COPYWRITING (IA) ---
    async function generateAdCopy(p, index) {
        const apiKey = localStorage.getItem('pth_gemini_api_key');
        const styles = [
            "URGENCIA: Pocas unidades.",
            "BENEFICIO: Soluci√≥n al calor/necesidad.",
            "DIRECTO: Calidad y precio."
        ];
        const selectedStyle = styles[index % styles.length];

        const prompt = `Escribe un post de venta para Facebook (Cuba).
        Producto: "${p.nombre}". Precio: $${p.precio}.
        Estilo: ${selectedStyle}
        
        Estructura:
        1. Gancho con Emojis.
        2. Descripci√≥n breve pero potente.
        3. Llamada a la acci√≥n.
        
        Sin hashtags ni enlaces (los pongo yo). M√°ximo 50 palabras.`;

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            return data.candidates[0].content.parts[0].text.trim();
        } catch (e) {
            console.error("Error IA:", e); // Para ver en consola por qu√© falla
            // Texto de respaldo mejorado
            return `üî• ¬°OFERTA DISPONIBLE!\nüì¶ Modelo: *${p.nombre}*\nüí∞ Precio: *$${p.precio} USD*\nüíé Garant√≠a y Entrega R√°pida.\nüöÄ ¬°Escribe antes que se agote!`;
        }
    }

    // --- UTILIDADES ---
    function fixDriveUrl(url) {
        if (!url) return 'https://placehold.co/400x400';
        if (url.startsWith('http')) return url;
        return `${SUPABASE_URL}/storage/v1/object/public/productos/${url}`;
    }

    // --- NUEVA CONFIGURACI√ìN DE URL ---
    const BASE_WEB_URL = "https://paratuhogar.github.io/paratuhogar"; 

    // --- FUNCI√ìN PARA GENERAR LINK CORTO REAL (CON SUPABASE) ---
    async function getOrGenerateShortLink(productName) {
        // 1. Construir el enlace largo base con TU web correcta
        const cleanName = encodeURIComponent(productName.trim());
        const longLink = `${BASE_WEB_URL}/index.html?search=${cleanName}&gestor=${encodeURIComponent(AGENT_NAME)}&tel=${AGENT_PHONE}`;

        try {
            // 2. Verificar si ya existe en la base de datos
            const { data } = await supabaseClient
                .from('short_links')
                .select('slug')
                .eq('original_url', longLink)
                .maybeSingle();

            if (data && data.slug) {
                return `${BASE_WEB_URL}/index.html?s=${data.slug}`;
            }

            // 3. Si no existe, crear uno nuevo
            const newSlug = Math.random().toString(36).substring(2, 7);
            const { error } = await supabaseClient.from('short_links').insert([{
                slug: newSlug,
                original_url: longLink,
                gestor: AGENT_NAME
            }]);

            if (!error) {
                return `${BASE_WEB_URL}/index.html?s=${newSlug}`;
            }
        } catch (e) {
            console.error("Error acortando link:", e);
        }

        // Si falla la base de datos, devuelve el largo por seguridad
        return longLink;
    }

    function copyToClipboard(id) {
        const el = document.getElementById(id);
        el.select();
        document.execCommand('copy');
        
        // Efecto visual en el bot√≥n
        let btn;
        if (el.nextElementSibling && el.nextElementSibling.tagName === 'BUTTON') {
             // Caso caja individual
             btn = el.nextElementSibling.querySelector('button'); 
             if(!btn) btn = el.nextElementSibling.children[0]; // El primer bot√≥n del div flex
        } else {
             // Caso resumen masivo
             btn = el.nextElementSibling;
        }

        if(btn) {
            const original = btn.innerText;
            btn.innerText = "¬°COPIADO!";
            btn.classList.add("bg-green-600");
            setTimeout(() => { 
                btn.innerText = original; 
                btn.classList.remove("bg-green-600");
            }, 2000);
        }
    }

    function downloadImage(imgEl, name) {
        const a = document.createElement('a');
        a.href = imgEl.src;
        a.download = `Post_${name.replace(/\s+/g, '_')}.jpg`;
        a.click();
    }
    
    function shareFacebook(id) {
        const text = document.getElementById(id).value;
        const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent("https://paratuhogar.cu")}&quote=${encodeURIComponent(text)}`;
        window.open(url, '_blank');
    }
</script>
</body>
</html>