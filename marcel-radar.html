<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA RADAR | Operaciones Marcel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Rajdhani', sans-serif; background: #020617; color: #94a3b8; }
        .radar-grid { background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 20px 20px; }
        .neon-text { text-shadow: 0 0 10px #22d3ee; color: #22d3ee; }
        .neon-border { border: 1px solid #22d3ee; box-shadow: 0 0 15px rgba(34, 211, 238, 0.2); }
        .feed-item { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="radar-grid min-h-screen p-6">

    <header class="flex justify-between items-center mb-8 border-b border-cyan-900/50 pb-4">
        <div>
            <h1 class="text-3xl font-bold neon-text tracking-tighter">PROJECT RADAR v1.0</h1>
            <p class="text-[10px] uppercase tracking-[0.5em] text-cyan-500">Monitoreo de Actividad en Tiempo Real</p>
        </div>
        <div class="text-right">
            <p id="status" class="text-xs font-bold text-emerald-500 animate-pulse">‚óè SISTEMA ONLINE</p>
            <p class="text-[10px]">OPERADOR: MARCEL MONTANO</p>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- COLUMNA 1: FEED EN VIVO -->
        <div class="lg:col-span-2 space-y-4">
            <h2 class="text-sm font-black uppercase tracking-widest border-l-4 border-cyan-500 pl-2">Log de Actividad Reciente</h2>
            <div id="live-feed" class="space-y-2 max-h-[70vh] overflow-y-auto pr-2">
                <!-- Se llena con JS -->
            </div>
        </div>

        <!-- COLUMNA 2: LEADS FANTASMA (ORO) -->
        <div class="space-y-4">
            <h2 class="text-sm font-black uppercase tracking-widest border-l-4 border-orange-500 pl-2 text-orange-500">Leads Fantasma (No terminaron)</h2>
            <div id="ghost-feed" class="space-y-3">
                <!-- Se llena con JS -->
            </div>

            <!-- MINI ESTADISTICAS -->
            <div class="mt-8 p-4 bg-slate-900/50 border border-slate-800 rounded-lg space-y-4">
                <h3 class="text-xs font-bold uppercase">M√©tricas de Hoy</h3>
                <div class="flex justify-between">
                    <span class="text-[10px]">Vistas Totales</span>
                    <span id="stat-views" class="text-cyan-400 font-bold">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[10px]">Clics WhatsApp</span>
                    <span id="stat-wa" class="text-emerald-400 font-bold">0</span>
                </div>
            </div>
        </div>

    </div>

    <script>
    // Usamos un nombre de variable √∫nico para evitar el error de "Already declared"
const SUPABASE_URL_RADAR = 'https://ljqwaovevfatkiigirhf.supabase.co';
const SUPABASE_KEY_RADAR = 'sb_publishable_DAuFcu0JjUo15yLDAev3MQ_9x5GIVXt'; 
const radarClient = supabase.createClient(SUPABASE_URL_RADAR, SUPABASE_KEY_RADAR);

async function initRadar() {
    // 1. Verificar Sesi√≥n de Marcel
    const session = JSON.parse(localStorage.getItem('pth_session'));
    if (!session || session.name !== 'Marcel Montano') {
        document.body.innerHTML = "<div style='color:white; padding:50px; text-align:center;'><h1>‚õî ACCESO DENEGADO</h1><p>Redirigiendo...</p></div>";
        setTimeout(() => window.location.href = 'index.html', 2000);
        return;
    }

    // 2. Carga inicial
    console.log("üì° Conectando al sat√©lite...");
    loadFeed();
    loadGhosts();

    // 3. Actualizaci√≥n autom√°tica cada 5 segundos
    setInterval(() => {
        loadFeed();
        loadGhosts();
    }, 5000);
}

async function loadFeed() {
    const { data, error } = await radarClient
        .from('log_espia')
        .select('*')
        .order('timestamp', { ascending: false })
        .limit(20);

    if (error) {
        console.error("Error Log:", error.message);
        return;
    }

    const container = document.getElementById('live-feed');
    if (!data || data.length === 0) {
        container.innerHTML = "<p class='opacity-30 italic'>Esperando se√±al de actividad...</p>";
        return;
    }

    container.innerHTML = data.map(log => {
        const hora = new Date(log.timestamp).toLocaleTimeString();
        let color = "text-cyan-400";
        if (log.accion === 'COMPRA_CONFIRMADA') color = "text-emerald-400 font-bold";
        if (log.accion === 'BUSQUEDA') color = "text-purple-400";

        return `
    <div class="feed-item bg-slate-900/80 border border-slate-800 p-4 rounded-lg flex justify-between items-center mb-3">
        <div class="flex gap-5 items-center">
            <span class="text-xs font-mono opacity-50 bg-slate-800 px-2 py-1 rounded">${hora}</span>
            <div>
                <p class="text-base ${color} font-bold">${log.accion}: <span class="text-white ml-2">${log.detalle}</span></p>
                <p class="text-xs opacity-60 mt-1 uppercase tracking-wider">GESTOR: <span class="text-cyan-400">${log.gestor_atribuido || 'Directo'}</span> | IP: ${log.ip}</p>
            </div>
        </div>
        <span class="text-xs font-black bg-slate-700 px-3 py-1 rounded-full text-slate-300 border border-slate-600">${log.dispositivo}</span>
    </div>`;
    }).join('');

    // Actualizar n√∫meros de las cajas de m√©tricas
    document.getElementById('stat-views').innerText = data.filter(l => l.accion === 'VIO_DETALLE').length;
    document.getElementById('stat-wa').innerText = data.filter(l => l.accion === 'COMPRA_CONFIRMADA').length;
}

async function loadGhosts() {
    const { data, error } = await radarClient
        .from('leads_fantasma')
        .select('*')
        .order('timestamp', { ascending: false })
        .limit(10);

    if (error) return;

    const container = document.getElementById('ghost-feed');
    if (!data || data.length === 0) {
        container.innerHTML = "<p class='text-sm opacity-50 italic'>Sin prospectos abandonados.</p>";
        return;
    }

    // --- NUEVO DISE√ëO CON LETRA GRANDE ---
    container.innerHTML = data.map(lead => `
        <div class="bg-orange-500/10 border-l-4 border-orange-500 p-5 rounded-r-lg mb-4 group shadow-lg">
            <div class="flex justify-between items-start mb-2">
                <p class="text-white text-sm font-black uppercase tracking-tight">${lead.nombre || 'Interesado An√≥nimo'}</p>
                <span class="text-xs opacity-50">${new Date(lead.timestamp).toLocaleDateString()}</span>
            </div>
            <p class="text-orange-400 text-xl font-black mb-3 tracking-tighter">${lead.telefono}</p>
            <p class="text-xs font-medium text-slate-400 bg-black/30 p-2 rounded border border-white/5 truncate">üõí ${lead.producto_en_carrito || 'Curioseando'}</p>
            <div class="mt-4">
                 <a href="https://wa.me/${lead.telefono.replace(/\D/g, '')}" target="_blank" class="w-full text-center block text-xs bg-orange-600 text-white font-black py-2 rounded-md hover:bg-orange-500 transition-all shadow-lg shadow-orange-900/20">RESCATAR VENTA AHORA</a>
            </div>
        </div>`).join('');
}
// Ejecutar al cargar
initRadar();
    </script>
</body>
</html>