<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA RADAR | Operaciones Marcel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Rajdhani', sans-serif; background: #020617; color: #94a3b8; overflow-x: hidden; }
        .radar-grid { background-image: radial-gradient(#1e293b 0.5px, transparent 0.5px); background-size: 15px 15px; }
        .neon-text { text-shadow: 0 0 10px #22d3ee; color: #22d3ee; }
        .neon-border { border: 1px solid rgba(34, 211, 238, 0.2); box-shadow: 0 0 20px rgba(34, 211, 238, 0.05); }
        .feed-item { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="radar-grid min-h-screen">

    <!-- HEADER SUPERIOR -->
    <header class="p-4 md:p-6 border-b border-cyan-900/30 bg-slate-950/80 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-[1600px] mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-bold neon-text tracking-tighter">PROJECT RADAR <span class="text-white opacity-20">v2.0</span></h1>
                <p class="text-[10px] uppercase tracking-[0.4em] text-cyan-500/70">Inteligencia de Mercado en Tiempo Real</p>
            </div>
            <div class="flex items-center gap-6 bg-slate-900/50 p-2 px-4 rounded-2xl border border-white/5">
                <div class="text-right hidden sm:block">
                    <p class="text-[10px] font-bold text-slate-500">OPERADOR</p>
                    <p class="text-xs font-black text-white uppercase">Marcel Montano</p>
                </div>
                <div class="h-8 w-px bg-white/10"></div>
                <p id="status" class="text-xs font-bold text-emerald-500 animate-pulse flex items-center gap-2">
                    <span class="block w-2.5 h-2.5 bg-emerald-500 rounded-full shadow-[0_0_10px_#10b981]"></span> ONLINE
                </p>
            </div>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto p-4 md:p-6">
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- COLUMNA IZQUIERDA: LOGS (3 cols) -->
            <div class="lg:col-span-3 space-y-4 order-3 lg:order-1">
                <div class="flex justify-between items-center border-l-4 border-cyan-500 pl-3">
                    <h2 class="text-sm font-black uppercase tracking-widest text-white">Actividad Reciente</h2>
                    <span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-cyan-400 font-mono" id="stat-log-count">0</span>
                </div>
                <div id="live-feed" class="space-y-3 h-[75vh] overflow-y-auto pr-2">
                    <!-- JS -->
                </div>
            </div>

            <!-- COLUMNA CENTRAL: GRÁFICA Y MÉTRICAS (6 cols) -->
            <div class="lg:col-span-6 space-y-6 order-1 lg:order-2">
                
                <!-- KPIs Rápidos -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5 text-center">
                        <p class="text-[10px] font-bold text-slate-500 uppercase">Vistas (Hoy)</p>
                        <p id="stat-views" class="text-3xl font-black text-cyan-400">0</p>
                    </div>
                    <div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5 text-center">
                        <p class="text-[10px] font-bold text-slate-500 uppercase">WhatsApp (Hoy)</p>
                        <p id="stat-wa" class="text-3xl font-black text-emerald-400">0</p>
                    </div>
                </div>

                <!-- Gráfica Principal -->
                <div class="bg-slate-900/80 p-6 rounded-3xl neon-border relative overflow-hidden">
                    <h3 class="text-xs font-black uppercase tracking-widest text-cyan-400 mb-6 flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">analytics</span> Radar de Interés por Producto
                    </h3>
                    <div style="height: 400px;">
                        <canvas id="vistasChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA: LEADS FANTASMA (3 cols) -->
            <div class="lg:col-span-3 space-y-4 order-2 lg:order-3">
                <div class="flex justify-between items-center border-l-4 border-orange-500 pl-3">
                    <h2 class="text-sm font-black uppercase tracking-widest text-orange-500">Leads a Rescatar</h2>
                    <span class="animate-ping text-orange-500 text-xs">●</span>
                </div>
                <div id="ghost-feed" class="space-y-4 h-[75vh] overflow-y-auto pr-2">
                    <!-- JS -->
                </div>
            </div>

        </div>
    </main>

    <script>
        const SUPABASE_URL_RADAR = 'https://ljqwaovevfatkiigirhf.supabase.co';
        const SUPABASE_KEY_RADAR = 'sb_publishable_DAuFcu0JjUo15yLDAev3MQ_9x5GIVXt'; 
        const radarClient = supabase.createClient(SUPABASE_URL_RADAR, SUPABASE_KEY_RADAR);

        let vistasChart = null;
        let lastGhostId = null;

        function playAlertSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.5);
            } catch(e) {}
        }

        async function initRadar() {
            const session = JSON.parse(localStorage.getItem('pth_session'));
            if (!session || session.name !== 'Marcel Montano') {
                window.location.href = 'index.html';
                return;
            }
            loadData();
            setInterval(loadData, 5000);
        }

        async function loadData() {
            loadFeed();
            loadGhosts();
        }

        async function loadFeed() {
            const { data } = await radarClient.from('log_espia').select('*').order('timestamp', { ascending: false }).limit(50);
            if (!data) return;

            // Actualizar Gráfica
            updateChart(data);

            const container = document.getElementById('live-feed');
            container.innerHTML = data.slice(0, 15).map(log => {
                const hora = new Date(log.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                let color = log.accion === 'COMPRA_CONFIRMADA' ? "text-emerald-400" : (log.accion === 'BUSQUEDA' ? "text-purple-400" : "text-cyan-400");
                
                return `
                <div class="feed-item bg-slate-900/50 border border-white/5 p-3 rounded-xl mb-2">
                    <div class="flex justify-between items-start">
                        <span class="text-[9px] font-mono opacity-30">${hora}</span>
                        <span class="text-[8px] uppercase font-black text-slate-500">${log.dispositivo}</span>
                    </div>
                    <p class="text-xs font-bold ${color} mt-1">${log.accion}</p>
                    <p class="text-white text-xs opacity-80 truncate">${log.detalle}</p>
                    <p class="text-[9px] opacity-40 mt-1 uppercase">GESTOR: ${log.gestor_atribuido || 'Directo'}</p>
                </div>`;
            }).join('');

            document.getElementById('stat-views').innerText = data.filter(l => l.accion === 'VIO_DETALLE').length;
            document.getElementById('stat-wa').innerText = data.filter(l => l.accion === 'COMPRA_CONFIRMADA').length;
            document.getElementById('stat-log-count').innerText = data.length;
        }

        async function loadGhosts() {
            const { data } = await radarClient.from('leads_fantasma').select('*').order('timestamp', { ascending: false }).limit(15);
            if (!data) return;

            if (data.length > 0) {
                if (lastGhostId && data[0].id > lastGhostId) playAlertSound();
                lastGhostId = data[0].id;
            }

            const container = document.getElementById('ghost-feed');
            container.innerHTML = data.map(lead => {
                const hasPhone = lead.telefono && lead.telefono.length > 5;
                return `
                <div class="bg-gradient-to-br from-orange-500/10 to-transparent border-l-2 border-orange-500 p-4 rounded-r-xl relative overflow-hidden group shadow-lg">
                    <div class="absolute right-[-10px] top-[-10px] opacity-5 text-orange-500">
                        <span class="material-symbols-outlined text-6xl">person_search</span>
                    </div>
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <p class="text-white text-xs font-black uppercase">${lead.nombre || 'Anónimo'}</p>
                        <span class="text-[9px] opacity-40">${new Date(lead.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    </div>
                    <p class="text-orange-400 text-xl font-black tracking-tighter mb-2 relative z-10">${lead.telefono || 'SIN TELÉFONO'}</p>
                    <div class="bg-black/30 p-2 rounded border border-white/5 mb-3 relative z-10">
                        <p class="text-[9px] text-slate-500 uppercase font-bold mb-1">Carrito:</p>
                        <p class="text-[10px] text-slate-300 truncate">${lead.producto_en_carrito || '...'}</p>
                    </div>
                    ${hasPhone ? `
                    <a href="https://wa.me/${lead.telefono.replace(/\D/g, '')}" target="_blank" 
                       class="w-full text-center block text-[10px] bg-orange-600 text-white font-black py-2 rounded-lg hover:bg-orange-500 transition-all uppercase tracking-widest shadow-lg shadow-orange-900/40">
                       RESCATAR VENTA
                    </a>` : `<p class="text-[10px] text-red-500 text-center font-bold">⚠️ DATO INCOMPLETO</p>`}
                </div>`;
            }).join('');
        }

        function updateChart(logs) {
            const ctx = document.getElementById('vistasChart').getContext('2d');
            const counts = {};
            logs.forEach(l => { if(l.accion === 'VIO_DETALLE') counts[l.detalle] = (counts[l.detalle] || 0) + 1; });
            
            const labels = Object.keys(counts);
            const values = Object.values(counts);

            if (vistasChart) {
                vistasChart.data.labels = labels;
                vistasChart.data.datasets[0].data = values;
                vistasChart.update();
            } else {
                vistasChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: 'rgba(34, 211, 238, 0.4)',
                            borderColor: '#22d3ee',
                            borderWidth: 2,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } },
                            y: { grid: { display: false }, ticks: { color: '#ffffff', font: { size: 10, weight: 'bold' } } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        initRadar();
    </script>
</body>
</html>