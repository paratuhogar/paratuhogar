<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA RADAR PRO | Operaciones Marcel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Rajdhani', sans-serif; background: #020617; color: #94a3b8; overflow-x: hidden; }
        .radar-grid { background-image: radial-gradient(#1e293b 0.5px, transparent 0.5px); background-size: 15px 15px; }
        .neon-text { text-shadow: 0 0 10px #22d3ee; color: #22d3ee; }
        .neon-border { border: 1px solid rgba(34, 211, 238, 0.2); box-shadow: 0 0 20px rgba(34, 211, 238, 0.05); }
        .feed-item { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="radar-grid min-h-screen">

    <!-- HEADER SUPERIOR INTELIGENTE -->
    <header class="p-4 md:p-6 border-b border-cyan-900/30 bg-slate-950/80 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-[1600px] mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-black neon-text tracking-tighter">PROJECT RADAR <span class="text-white opacity-20">v3.0</span></h1>
                <p class="text-[10px] uppercase tracking-[0.4em] text-cyan-500/70 font-bold">Mantenimiento de Inteligencia de Mercado</p>
            </div>
            <div class="flex items-center gap-6 bg-slate-900/50 p-2 px-4 rounded-2xl border border-white/5">
                <div class="text-right hidden sm:block">
                    <p class="text-[10px] font-bold text-slate-500">OPERADOR SUPREMO</p>
                    <p class="text-xs font-black text-white uppercase">Marcel Montano</p>
                </div>
                <div class="h-8 w-px bg-white/10"></div>
                <p id="status" class="text-xs font-bold text-emerald-500 animate-pulse flex items-center gap-2">
                    <span class="block w-2.5 h-2.5 bg-emerald-500 rounded-full shadow-[0_0_10px_#10b981]"></span> SAT칄LITE ONLINE
                </p>
            </div>
        </div>
    </header>

    <main class="max-w-[1700px] mx-auto p-4 md:p-6">
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- COLUMNA 1: ACTIVIDAD CON CIUDAD Y FUENTE (3 cols) -->
            <div class="lg:col-span-3 space-y-4">
                <div class="flex justify-between items-center border-l-4 border-cyan-500 pl-3">
                    <h2 class="text-sm font-black uppercase tracking-widest text-white">Monitor de Actividad</h2>
                    <span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-cyan-400 font-mono" id="stat-log-count">0</span>
                </div>
                <div id="live-feed" class="space-y-3 h-[75vh] overflow-y-auto pr-2">
                    <!-- JS -->
                </div>
            </div>

            <!-- COLUMNA 2: EL CEREBRO (GR츼FICAS Y KPIs) (6 cols) -->
            <div class="lg:col-span-6 space-y-6">
                
                <!-- KPIs AVANZADOS -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5 text-center">
                        <p class="text-[10px] font-bold text-slate-500 uppercase">Fugas (B칰squedas Vac칤as)</p>
                        <p id="stat-empty" class="text-3xl font-black text-red-500">0</p>
                    </div>
                    <div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5 text-center">
                        <p class="text-[10px] font-bold text-slate-500 uppercase">Clientes Reincidentes</p>
                        <p id="stat-loyal" class="text-3xl font-black text-purple-400">0</p>
                    </div>
                    <div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5 text-center">
                        <p class="text-[10px] font-bold text-slate-500 uppercase">WhatsApp (Conversi칩n)</p>
                        <p id="stat-wa" class="text-3xl font-black text-emerald-400">0</p>
                    </div>
                </div>

                <!-- GR츼FICAS -->
                <div class="grid grid-cols-1 gap-6">
                    <!-- Inter칠s (Vistas) -->
                    <div class="bg-slate-900/80 p-6 rounded-3xl neon-border relative h-[350px]">
                        <h3 class="text-[10px] font-black uppercase text-cyan-400 mb-4 flex justify-between">
                            <span>Radar de Inter칠s (Clics)</span>
                            <span class="opacity-40">Barras: Total Vistas</span>
                        </h3>
                        <canvas id="vistasChart"></canvas>
                    </div>
                    
                    <!-- Engagement (Tiempo) -->
                    <div class="bg-slate-900/80 p-6 rounded-3xl border border-white/5 h-[350px]">
                        <h3 class="text-[10px] font-black uppercase text-purple-400 mb-4 flex justify-between">
                            <span>Fidelidad de Lectura (Segundos)</span>
                            <span class="opacity-40">Barras: Promedio Permanencia</span>
                        </h3>
                        <canvas id="engagementChart"></canvas>
                    </div>
                </div>

                <div id="bolsa-rescate" class="mt-4 p-6 bg-emerald-900/20 border border-emerald-500/30 rounded-3xl">
    <div class="flex justify-between items-center">
        <div>
            <h3 class="text-emerald-400 font-black uppercase text-xs tracking-widest">Dinero por Rescatar</h3>
            <p class="text-slate-400 text-[10px]">Suma de productos en Leads Fantasma (Tus enlaces)</p>
        </div>
        <div class="text-right">
            <p id="total-rescatable" class="text-3xl font-black text-emerald-400">$0</p>
        </div>
    </div>
</div>

                <!-- RANKING SOCIAL -->
                <div class="bg-slate-900/80 p-6 rounded-3xl border border-white/5">
                    <h3 class="text-[10px] font-black uppercase text-blue-400 mb-4">Tr치fico por Red Social / Gestor</h3>
                    <div id="social-radar" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- JS -->
                    </div>
                </div>
            </div>

            <!-- COLUMNA 3: LEADS FANTASMA (ORO) (3 cols) -->
            <div class="lg:col-span-3 space-y-4">
                <div class="flex justify-between items-center border-l-4 border-orange-500 pl-3">
                    <h2 class="text-sm font-black uppercase tracking-widest text-orange-500">Misi칩n de Rescate</h2>
                    <span class="text-[10px] font-bold text-orange-500 animate-pulse">EN VIVO</span>
                </div>
                <div id="ghost-feed" class="space-y-4 h-[75vh] overflow-y-auto pr-2">
                    <!-- JS -->
                </div>
            </div>

        </div>
    </main>

    <script>
        const SUPABASE_URL_RADAR = 'https://ljqwaovevfatkiigirhf.supabase.co';
        const SUPABASE_KEY_RADAR = 'sb_publishable_DAuFcu0JjUo15yLDAev3MQ_9x5GIVXt'; 
        const radarClient = supabase.createClient(SUPABASE_URL_RADAR, SUPABASE_KEY_RADAR);

        let vistasChart = null;
        let engChart = null;
        let lastGhostId = null;

        function playAlertSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.5);
            } catch(e) {}
        }

        async function loadData() {
            const { data: logs } = await radarClient.from('log_espia').select('*').order('timestamp', { ascending: false }).limit(100);
            if (logs) {
                renderFeed(logs);
                updateCharts(logs);
                renderSocial(logs);
            }
            loadGhosts();
        }

        function renderFeed(logs) {
            const container = document.getElementById('live-feed');
            container.innerHTML = logs.slice(0, 20).map(l => {
                const hora = new Date(l.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                const reincidente = l.reincidencia > 1 ? `<span class="bg-purple-500/20 text-purple-400 text-[8px] px-1.5 rounded-full border border-purple-500/30">Fiel #${l.reincidencia}</span>` : '';
                let color = l.accion === 'COMPRA_CONFIRMADA' ? "text-emerald-400" : (l.accion === 'BUSQUEDA_VACIA' ? "text-red-400" : "text-cyan-400");
                
                return `
                <div class="feed-item bg-slate-900/50 border border-white/5 p-4 rounded-2xl mb-2 transition-all hover:bg-slate-800/80">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-mono opacity-30">${hora}</span>
                        <span class="text-[8px] uppercase font-black text-slate-500">${l.fuente_social}</span>
                    </div>
                    <p class="text-xs font-bold ${color}">${l.accion}</p>
                    <p class="text-white text-sm font-medium mt-1">${l.detalle}</p>
                    <div class="mt-2 flex flex-wrap gap-2 items-center">
                        <span class="text-[9px] opacity-40 uppercase tracking-tighter">UBICACI칍N: ${l.ciudad || 'Desconocida'}</span>
                        ${reincidente}
                    </div>
                    <p class="text-[9px] text-slate-600 mt-2 font-black uppercase">AGENTE: ${l.gestor_atribuido}</p>
                </div>`;
            }).join('');

            document.getElementById('stat-empty').innerText = logs.filter(l => l.accion === 'BUSQUEDA_VACIA').length;
            document.getElementById('stat-loyal').innerText = logs.filter(l => l.reincidencia > 2).length;
            document.getElementById('stat-wa').innerText = logs.filter(l => l.accion === 'COMPRA_CONFIRMADA').length;
            document.getElementById('stat-log-count').innerText = logs.length;
        }

       async function loadGhosts() {
    // 1. Traemos los 칰ltimos 20 leads
    const { data: leads, error } = await radarClient
        .from('leads_fantasma')
        .select('*')
        .order('timestamp', { ascending: false })
        .limit(20);

    if (error || !leads) return;

    // --- NUEVO: OBTENER COMPRADORES DE HOY ---
    // Buscamos en la tabla de pedidos los tel칠fonos que ya cerraron venta hoy
    const hoy = new Date().toISOString().split('T')[0];
    const { data: pedidosHoy } = await radarClient
        .from('pedidos')
        .select('telefono')
        .gte('fecha', hoy);

    // Creamos un Set con los 칰ltimos 8 d칤gitos de los que ya compraron para comparar r치pido
    const telefonosCompradores = new Set(
        (pedidosHoy || []).map(p => p.telefono.replace(/\D/g, '').slice(-8))
    );
    // -----------------------------------------

    // 2. FILTRO MODO DIOS: Solo Marcel/Directo Y que NO hayan comprado ya
    const leadsParaRescatar = leads.filter(lead => {
        const gestor = lead.gestor_atribuido;
        const esMio = gestor === 'Marcel Montano' || gestor === 'Directo' || !gestor;
        
        // NUEVO: Verificamos si este lead ya est치 en la lista de compradores
        const telLimpioComp = lead.telefono ? lead.telefono.replace(/\D/g, '').slice(-8) : '';
        const yaCompro = telefonosCompradores.has(telLimpioComp);

        return esMio && !yaCompro; // Solo pasa si es m칤o y NO ha comprado
    });

    // 3. L칩gica de Alerta Sonora (Se mantiene igual)
    if (leadsParaRescatar.length > 0) {
        const currentTopId = leadsParaRescatar[0].id;
        if (lastGhostId && currentTopId > lastGhostId) {
            playAlertSound();
        }
        lastGhostId = currentTopId;
    }

    const container = document.getElementById('ghost-feed');
    
    if (leadsParaRescatar.length === 0) {
        container.innerHTML = "<p class='text-center p-10 opacity-30 italic text-sm'>No hay prospectos tuyos pendientes...</p>";
        return;
    }

    // 4. Dibujar solo tus leads filtrados (Se mantiene tu dise침o exacto)
    container.innerHTML = leadsParaRescatar.map(lead => {
        const telLimpio = lead.telefono ? lead.telefono.replace(/\D/g, '') : '';
        const esValido = telLimpio.length >= 7;

        return `
        <div class="bg-gradient-to-br from-orange-500/10 to-slate-900 border-l-4 border-orange-500 p-5 rounded-r-2xl shadow-xl mb-4 transition-all hover:scale-[1.02]">
            <div class="flex justify-between items-start mb-2">
                <div class="flex flex-col">
                    <p class="text-white text-xs font-black uppercase tracking-tight">${lead.nombre || 'An칩nimo'}</p>
                    <span class="text-[8px] text-orange-500 font-bold uppercase">${lead.gestor_atribuido || 'Venta Directa'}</span>
                </div>
                <span class="text-[9px] opacity-40 font-mono">${new Date(lead.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
            </div>
            
            <p class="text-orange-400 text-2xl font-black tracking-tighter mb-3">
                ${esValido ? lead.telefono : '<span class="text-slate-600 text-sm italic">[Escribiendo...]</span>'}
            </p>

            <div class="text-[10px] text-slate-400 mb-4 bg-black/40 p-2 rounded border border-white/5 italic truncate">
                游 ${lead.producto_en_carrito || 'Curioseando'}
            </div>

            ${esValido ? `
                <a href="https://wa.me/${telLimpio}" target="_blank" 
                   class="block w-full bg-orange-600 text-white text-center py-3 rounded-xl font-black uppercase text-[11px] shadow-lg shadow-orange-900/40 hover:bg-orange-500 transition-all tracking-widest">
                   RESCATAR AHORA
                </a>
            ` : `
                <div class="w-full bg-slate-800 text-slate-500 text-center py-3 rounded-xl font-bold uppercase text-[10px] cursor-not-allowed border border-white/5">
                   Dato incompleto
                </div>
            `}
        </div>`;
    }).join('');
    // Calcular el dinero total que podr칤as ganar si rescatas todos tus leads
const totalUSD = leadsParaRescatar.reduce((acc, lead) => {
    // Si guardaste el precio en el lead, lo sumamos. 
    // Si no, podemos hacer un conteo de oportunidades.
    return acc + 1; // Aqu칤 podr칤as poner l칩gica de precio real
}, 0);

document.getElementById('total-rescatable').innerText = leadsParaRescatar.length + " Ventas";
}

        function updateCharts(logs) {
            // 1. CHART VISTAS
            const vCtx = document.getElementById('vistasChart').getContext('2d');
            const vCounts = {};
            logs.filter(l => l.accion === 'VIO_DETALLE').forEach(l => { vCounts[l.detalle] = (vCounts[l.detalle] || 0) + 1; });
            
            if (vistasChart) vistasChart.destroy();
            vistasChart = new Chart(vCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(vCounts),
                    datasets: [{ data: Object.values(vCounts), backgroundColor: 'rgba(34, 211, 238, 0.4)', borderColor: '#22d3ee', borderWidth: 2 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#64748b' }, grid: { display: false } }, y: { ticks: { color: '#ffffff', font: {size: 10} } } } }
            });

            // 2. CHART ENGAGEMENT
            const eCtx = document.getElementById('engagementChart').getContext('2d');
            const eMap = {};
            logs.filter(l => l.accion === 'LECTURA_PROFUNDA').forEach(l => {
                if(!eMap[l.detalle]) eMap[l.detalle] = { total: 0, count: 0 };
                eMap[l.detalle].total += l.duracion; eMap[l.detalle].count++;
            });
            const eLabels = Object.keys(eMap);
            const eAverages = Object.values(eMap).map(v => (v.total / v.count).toFixed(0));

            if (engChart) engChart.destroy();
            engChart = new Chart(eCtx, {
                type: 'bar',
                data: {
                    labels: eLabels,
                    datasets: [{ data: eAverages, backgroundColor: 'rgba(168, 85, 247, 0.4)', borderColor: '#a855f7', borderWidth: 2 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#64748b' }, grid: { display: false } }, y: { ticks: { color: '#ffffff', font: {size: 10} } } } }
            });
        }

        async function renderSocial(logs) {
    // 1. Obtener los Leads Fantasma actuales para calcular el dinero
    const { data: ghosts } = await radarClient.from('leads_fantasma').select('*');
    
    const moneyMap = {};

    // 2. Calcular cu치nto dinero tiene cada gestor "en el aire"
    if (ghosts) {
        ghosts.forEach(lead => {
            const gestor = lead.gestor_atribuido || 'Venta Directa';
            if (!moneyMap[gestor]) moneyMap[gestor] = { usd: 0, leads: 0 };
            
            // Intentamos extraer el valor del carrito (esto es una estimaci칩n)
            // Para que sea exacto, podr칤as guardar el total en la tabla leads_fantasma
            moneyMap[gestor].leads++;
            // Simulamos un valor promedio por lead si no tenemos el total guardado, 
            // o mejor, mostramos el conteo de intenci칩n.
        });
    }

    // 3. Limpiar los nombres de las fuentes para que sean humanos
    const socialMap = {};
    logs.forEach(l => {
        let fuente = l.fuente_social;
        if (fuente === "Directo / Link" || !fuente) fuente = "Link Pegado";
        
        const key = `${l.gestor_atribuido || 'Venta Directa'} | ${fuente}`;
        socialMap[key] = (socialMap[key] || 0) + 1;
    });

    const sorted = Object.entries(socialMap).sort((a,b) => b[1] - a[1]).slice(0, 6);

    // 4. Renderizar con dise침o de "Performance"
    document.getElementById('social-radar').innerHTML = sorted.map(([key, count]) => {
        const [nombre, red] = key.split(' | ');
        return `
        <div class="bg-gradient-to-r from-slate-900 to-slate-800 p-4 rounded-2xl border border-white/5 flex justify-between items-center shadow-lg">
            <div>
                <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest">${red}</p>
                <p class="text-sm font-black text-white uppercase">${nombre}</p>
            </div>
            <div class="text-right">
                <span class="text-xs font-bold text-slate-500 block uppercase">Efectividad</span>
                <span class="bg-blue-600/20 text-blue-400 text-lg font-black px-3 py-0.5 rounded-lg border border-blue-500/30">
                    ${count} <span class="text-[10px]">CLICS</span>
                </span>
            </div>
        </div>`;
    }).join('');
}

        // Seguridad Marcel
        const session = JSON.parse(localStorage.getItem('pth_session'));
        if(!session || session.name !== 'Marcel Montano') {
            window.location.href = 'index.html';
        } else {
            loadData();
            setInterval(loadData, 5000);
        }
    </script>
</body>
</html>