<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA RADAR PRO | Operaciones Marcel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Rajdhani', sans-serif; background: #020617; color: #94a3b8; overflow-x: hidden; }
        .radar-grid { background-image: radial-gradient(#1e293b 0.5px, transparent 0.5px); background-size: 15px 15px; }
        .neon-text { text-shadow: 0 0 10px #22d3ee; color: #22d3ee; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        /* Animaci√≥n suave para nuevos elementos */
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .item-anim { animation: slideIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="radar-grid min-h-screen flex flex-col">

    <!-- HEADER: ESTATUS DEL SISTEMA -->
    <header class="p-4 border-b border-cyan-900/30 bg-slate-950/90 backdrop-blur-md sticky top-0 z-50 shadow-2xl shadow-cyan-900/10">
        <div class="max-w-[1800px] mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl md:text-3xl font-black neon-text tracking-tighter italic">RADAR <span class="text-white">v4.0</span></h1>
                <p class="text-[10px] uppercase tracking-[0.3em] text-cyan-600 font-bold">Panel de Ataque - Modo Dios</p>
            </div>
            
            <div class="flex items-center gap-4 bg-slate-900 border border-slate-700 rounded-full px-4 py-1.5">
                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_10px_#10b981]"></div>
                <p class="text-xs font-bold text-slate-300">MARCEL MONTANO <span class="text-slate-600">|</span> <span class="text-emerald-500">ONLINE</span></p>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-[1800px] mx-auto w-full p-4 md:p-6 space-y-6">
    
        <!-- 1. DASHBOARD DE M√âTRICAS (HEADS UP DISPLAY) -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- Contador Targets -->
            <div class="bg-gradient-to-br from-slate-900 to-slate-950 p-4 rounded-2xl border border-orange-500/20 shadow-lg relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-all"><span class="material-symbols-outlined text-5xl text-orange-500">crisis_alert</span></div>
                <p class="text-[10px] font-black text-orange-500 uppercase tracking-widest">Objetivos Vivos</p>
                <p class="text-xs text-slate-500 font-bold">Leads Fantasma (Hoy)</p>
                <p id="count-targets" class="text-4xl font-black text-white mt-1">0</p>
            </div>

            <!-- Contador Mina -->
            <div class="bg-gradient-to-br from-slate-900 to-slate-950 p-4 rounded-2xl border border-emerald-500/20 shadow-lg relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-all"><span class="material-symbols-outlined text-5xl text-emerald-500">savings</span></div>
                <p class="text-[10px] font-black text-emerald-500 uppercase tracking-widest">Cartera Activa</p>
                <p class="text-xs text-slate-500 font-bold">Clientes Reciclables</p>
                <p id="count-goldmine" class="text-4xl font-black text-white mt-1">0</p>
            </div>
            
            <!-- Estado Actual -->
            <div class="col-span-2 bg-slate-900/50 p-4 rounded-2xl border border-slate-800 flex items-center justify-between">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Estado del Radar</p>
                    <p class="text-sm text-cyan-400 font-bold animate-pulse">ESCANEO ACTIVO...</p>
                </div>
                <button onclick="loadWarRoom()" class="bg-cyan-900/30 hover:bg-cyan-500/20 text-cyan-400 p-2 rounded-lg transition-all border border-cyan-500/30">
                    <span class="material-symbols-outlined">refresh</span>
                </button>
            </div>
        </div>

        <!-- 2. TABLERO DE COMANDO (3 COLUMNAS) -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-auto lg:h-[75vh]">
            
            <!-- COLUMNA 1: FRANCOTIRADOR (5/12) -->
            <div class="lg:col-span-5 flex flex-col bg-[#0f172a] rounded-3xl border border-orange-500/20 shadow-2xl shadow-orange-900/5 overflow-hidden">
                <div class="p-4 border-b border-orange-500/20 bg-gradient-to-r from-orange-900/10 to-transparent flex justify-between items-center">
                    <h2 class="text-sm font-black uppercase tracking-widest text-orange-500 flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg animate-pulse">target</span> 
                        FRANCOTIRADOR
                    </h2>
                    <span class="text-[9px] font-bold bg-orange-500/10 px-2 py-1 rounded text-orange-300 border border-orange-500/20">LEADS FANTASMA</span>
                </div>
                <div id="sniper-feed" class="flex-1 overflow-y-auto p-4 space-y-3 scroll-smooth">
                    <!-- JS INYECTA AQU√ç -->
                    <div class="text-center mt-10">
                        <span class="loader block w-6 h-6 border-2 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></span>
                        <p class="text-xs text-slate-600 italic">Buscando se√±ales...</p>
                    </div>
                </div>
            </div>

            <!-- COLUMNA 2: MINA DE ORO (4/12) -->
            <div class="lg:col-span-4 flex flex-col bg-[#0f172a] rounded-3xl border border-emerald-500/20 shadow-2xl shadow-emerald-900/5 overflow-hidden">
                <div class="p-4 border-b border-emerald-500/20 bg-gradient-to-r from-emerald-900/10 to-transparent flex justify-between items-center">
                    <h2 class="text-sm font-black uppercase tracking-widest text-emerald-500 flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">recycling</span> 
                        MINA DE ORO
                    </h2>
                    <span class="text-[9px] font-bold bg-emerald-500/10 px-2 py-1 rounded text-emerald-300 border border-emerald-500/20">RE-MARKETING</span>
                </div>
                <div id="goldmine-feed" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- JS INYECTA AQU√ç -->
                </div>
            </div>

            <!-- COLUMNA 3: OR√ÅCULO (3/12) -->
            <div class="lg:col-span-3 flex flex-col bg-[#0f172a] rounded-3xl border border-purple-500/20 shadow-2xl shadow-purple-900/5 overflow-hidden">
                <div class="p-4 border-b border-purple-500/20 bg-gradient-to-r from-purple-900/10 to-transparent">
                    <h2 class="text-sm font-black uppercase tracking-widest text-purple-500 flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">visibility</span> 
                        OR√ÅCULO
                    </h2>
                    <p class="text-[10px] text-purple-300/60 mt-0.5 font-bold ml-7">TENDENCIAS GLOBALES</p>
                </div>
                <div id="oracle-feed" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- JS INYECTA AQU√ç -->
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- 1. CONEXI√ìN A SUPABASE (CRUCIAL) ---
        const SUPABASE_URL_RADAR = 'https://ljqwaovevfatkiigirhf.supabase.co';
        const SUPABASE_KEY_RADAR = 'sb_publishable_DAuFcu0JjUo15yLDAev3MQ_9x5GIVXt'; 
        const radarClient = supabase.createClient(SUPABASE_URL_RADAR, SUPABASE_KEY_RADAR);

        // --- CONFIGURACI√ìN ---
        const MY_NAME = "Marcel Montano"; 
        
        async function loadWarRoom() {
            console.log("üì° Iniciando Escaneo de Combate...");
            await loadSniperTargets();  // Columna 1
            await loadGoldMine();       // Columna 2
            await loadOracle();         // Columna 3
        }

        // ======================================================
        // 1. EL FRANCOTIRADOR (Tus Leads Fantasma)
        // ======================================================
        // ======================================================
        // 1. EL FRANCOTIRADOR (BLINDADO Y √âTICO)
        // ======================================================
        async function loadSniperTargets() {
            // 1. Traemos leads recientes (√∫ltimas 24h es lo relevante para francotirador)
            const hace24h = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            
            const { data: leads, error } = await radarClient
                .from('leads_fantasma')
                .select('*')
                .eq('completado', false) 
                .gte('timestamp', hace24h) // Solo leads frescos
                .order('timestamp', { ascending: false });

            if (error || !leads) return;

            // 2. CONSULTA DE SEGURIDAD: ¬øQui√©n ha comprado hoy?
            // Traemos TODOS los pedidos de hoy (de cualquier gestor) para comparar tel√©fonos
            const { data: ventasHoy } = await radarClient
                .from('pedidos')
                .select('telefono')
                .gte('fecha', hace24h);

            // Creamos una lista de tel√©fonos que YA COMPRARON (Cleaned)
            const telefonosVendidos = new Set(
                (ventasHoy || []).map(v => v.telefono.replace(/\D/g, ''))
            );

            // 3. FILTRADO DE PROPIEDAD ESTRICTA + ANTI-ROBO
            const misLeads = leads.filter(l => {
                // A. Filtro de Propiedad: SOLO si dice expl√≠citamente TU NOMBRE
                // Eliminamos 'Directo' y 'Venta Directa' para evitar confusiones.
                const esMio = l.gestor_atribuido === MY_NAME;

                // B. Filtro Anti-Robo: Verificamos si ya compr√≥
                const telLead = l.telefono.replace(/\D/g, '');
                const yaCompro = telefonosVendidos.has(telLead);

                // Solo pasa si ES M√çO y NO HA COMPRADO A√öN
                return esMio && !yaCompro;
            });

            // 4. RENDERIZADO (Igual que antes)
            document.getElementById('count-targets').innerText = misLeads.length;
            const container = document.getElementById('sniper-feed');
            
            if (misLeads.length === 0) {
                container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-600 opacity-50"><span class="material-symbols-outlined text-4xl mb-2">radar</span><p class="text-xs uppercase font-bold">Sin objetivos confirmados</p></div>`;
                return;
            }

            container.innerHTML = "";

            misLeads.forEach(lead => {
                let score = 10;
                let badge = `<span class="text-[9px] font-bold text-slate-400 bg-slate-800 px-2 py-0.5 rounded border border-slate-700">‚ùÑÔ∏è FR√çO</span>`;
                
                if (lead.nombre && lead.nombre.length > 2) score += 40;
                if (lead.producto_en_carrito && lead.producto_en_carrito.length > 3) score += 20;
                
                if (score >= 50) badge = `<span class="text-[9px] font-bold text-orange-400 bg-orange-900/20 px-2 py-0.5 rounded border border-orange-500/30">üü† TIBIO</span>`;
                if (score >= 70) badge = `<span class="text-[9px] font-bold text-red-500 bg-red-900/20 px-2 py-0.5 rounded border border-red-500/50 animate-pulse">üî• FUEGO</span>`;

                const prod = lead.producto_en_carrito || "un equipo";
                const nombre = lead.nombre || "Cliente";
                const tel = lead.telefono;
                
                const cleanTel = tel.replace(/\D/g, '');
                const finalTel = cleanTel.length === 8 ? '53' + cleanTel : cleanTel;

                const msgCierre = `Hola ${nombre}, vi que intentaste pedir el *${prod}* en mi enlace personal. Ya te lo tengo separado. ¬øTe confirmo el env√≠o?`;
                const msgAyuda = `Hola ${nombre}, soy Marcel. Vi que estabas comprando *${prod}* pero no terminaste. ¬øTe dio error la p√°gina?`;

                const html = `
                <div class="item-anim bg-slate-800/40 border border-slate-700/50 p-4 rounded-xl hover:bg-slate-800 hover:border-orange-500/30 transition-all group relative">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="flex items-center gap-2 mb-1.5">
                                ${badge}
                                <span class="text-[10px] text-slate-500 font-mono flex items-center gap-1">
                                    <span class="material-symbols-outlined text-[10px]">schedule</span> ${timeAgo(lead.timestamp)}
                                </span>
                            </div>
                            <p class="text-white font-black uppercase text-sm leading-tight mb-0.5">${nombre}</p>
                            <p class="text-orange-400 font-mono text-xs font-bold tracking-wider">${tel}</p>
                        </div>
                    </div>
                    
                    <div class="bg-black/30 p-2 rounded border border-white/5 mb-3">
                        <p class="text-[10px] text-slate-400 italic truncate"><span class="text-slate-500 not-italic font-bold">INTENTO:</span> ${prod}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                        <a href="https://wa.me/${finalTel}?text=${encodeURIComponent(msgCierre)}" target="_blank" 
                           class="bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] font-black uppercase py-2.5 rounded-lg text-center flex items-center justify-center gap-1 shadow-lg shadow-emerald-900/20 active:scale-95 transition-all">
                           <span class="material-symbols-outlined text-sm">check_circle</span> Cierre
                        </a>
                        <a href="https://wa.me/${finalTel}?text=${encodeURIComponent(msgAyuda)}" target="_blank"
                           class="bg-slate-700 hover:bg-slate-600 text-white text-[10px] font-bold uppercase py-2.5 rounded-lg text-center flex items-center justify-center gap-1 border border-slate-600 active:scale-95 transition-all">
                           <span class="material-symbols-outlined text-sm">support_agent</span> Ayuda
                        </a>
                    </div>
                </div>`;
                
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // ======================================================
        // 2. LA MINA DE ORO (Tus Clientes Antiguos)
        // ======================================================
        async function loadGoldMine() {
            // Buscamos clientes TUYOS de hace m√°s de 15 d√≠as
            const today = new Date();
            const limitDate = new Date();
            limitDate.setDate(today.getDate() - 15); 

            const { data: pedidos, error } = await radarClient
                .from('pedidos')
                .select('*')
                .eq('gestor', MY_NAME)
                .eq('estado', 'Entregado')
                .lt('fecha', limitDate.toISOString())
                .order('fecha', { ascending: false })
                .limit(15);

            const container = document.getElementById('goldmine-feed');
            
            if (!pedidos || pedidos.length === 0) {
                container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-600 opacity-50"><span class="material-symbols-outlined text-4xl mb-2">hourglass_empty</span><p class="text-xs uppercase font-bold">Sin clientes antiguos</p></div>`;
                document.getElementById('count-goldmine').innerText = "0";
                return;
            }

            container.innerHTML = "";
            document.getElementById('count-goldmine').innerText = pedidos.length;

            pedidos.forEach(p => {
                // L√≥gica de Venta Cruzada
                let sugerencia = "un protector de voltaje";
                const prodPrevio = p.producto.toLowerCase();
                
                if (prodPrevio.includes('split') || prodPrevio.includes('aire')) sugerencia = "el mantenimiento o un soporte";
                if (prodPrevio.includes('nevera')) sugerencia = "un protector de voltaje profesional";
                if (prodPrevio.includes('moto')) sugerencia = "accesorios o casco";

                const nombreCliente = p.cliente.split(' ')[0];
                const msgRemarketing = `Hola ${nombreCliente}, ¬øqu√© tal te ha salido el equipo? Espero que todo bien. Te escribo porque me llegaron ofertas de *${sugerencia}* que te pueden servir. Av√≠same si te interesa. Saludos, Marcel.`;
                
                // Tel√©fono limpio
                const cleanTel = p.telefono.replace(/\D/g, '');
                const finalTel = cleanTel.length === 8 ? '53' + cleanTel : cleanTel;

                const diasPasados = Math.floor((today - new Date(p.fecha))/(1000*60*60*24));

                const html = `
                <div class="item-anim flex items-center gap-3 p-3 rounded-xl border border-emerald-500/10 bg-[#0f172a] hover:bg-emerald-900/10 transition-all group relative">
                    <div class="bg-emerald-500/10 text-emerald-500 w-10 h-10 rounded-lg flex flex-col items-center justify-center border border-emerald-500/20 shrink-0">
                        <span class="text-[10px] font-black">${diasPasados}</span>
                        <span class="text-[8px] uppercase">D√≠as</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-black text-white truncate uppercase">${p.cliente}</p>
                        <p class="text-[10px] text-slate-500 truncate">Compr√≥: ${p.producto.split('[')[0]}</p>
                    </div>
                    <a href="https://wa.me/${finalTel}?text=${encodeURIComponent(msgRemarketing)}" target="_blank"
                       class="bg-emerald-600 hover:bg-emerald-500 text-white p-2 rounded-lg shadow-lg transition-colors active:scale-95" title="Enviar Oferta">
                        <span class="material-symbols-outlined text-lg">send</span>
                    </a>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // ======================================================
        // 3. EL OR√ÅCULO (Tendencias Globales para tus Estados)
        // ======================================================
        async function loadOracle() {
            const { data: logs } = await radarClient
                .from('log_espia')
                .select('detalle, timestamp')
                .eq('accion', 'VIO_DETALLE')
                .order('timestamp', { ascending: false })
                .limit(50);

            if (!logs) return;

            const conteo = {};
            logs.forEach(l => {
                const prod = l.detalle;
                if(prod) conteo[prod] = (conteo[prod] || 0) + 1;
            });

            const top = Object.entries(conteo).sort((a,b) => b[1] - a[1]).slice(0, 5);
            
            const container = document.getElementById('oracle-feed');
            container.innerHTML = "";

            top.forEach(([prod, count], index) => {
                const width = Math.min(100, count * 15); 
                const msgEstado = `üò± ${count} personas est√°n preguntando por el *${prod}* hoy. ¬°Me quedan pocos! Escr√≠beme ya.`;

                const html = `
                <div class="item-anim mb-4 last:mb-0">
                    <div class="flex justify-between text-[10px] uppercase font-bold text-purple-200 mb-1">
                        <span class="truncate pr-2 w-3/4">${prod}</span>
                        <span class="text-purple-400 whitespace-nowrap">${count} VISTAS</span>
                    </div>
                    <div class="h-1.5 w-full bg-slate-800 rounded-full mb-2 overflow-hidden">
                        <div class="h-full bg-purple-500 shadow-[0_0_10px_#a855f7]" style="width: ${width}%"></div>
                    </div>
                    <button onclick="navigator.clipboard.writeText('${msgEstado}').then(()=>alert('‚úÖ Texto copiado. P√©galo en tu Estado.'))" 
                        class="w-full text-[9px] font-bold bg-purple-900/20 text-purple-300 border border-purple-500/30 py-1.5 rounded hover:bg-purple-500 hover:text-white transition-all flex items-center justify-center gap-1 group">
                        <span class="material-symbols-outlined text-[10px] group-hover:rotate-12 transition-transform">content_copy</span> COPIAR PARA ESTADO
                    </button>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function timeAgo(dateString) {
            const seconds = Math.floor((new Date() - new Date(dateString)) / 1000);
            if (seconds < 60) return "Ahora";
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m`;
            const hours = Math.floor(minutes / 60);
            return `${hours}h`;
        }

        // AUTO-ARRANQUE CON SEGURIDAD
        const session = JSON.parse(localStorage.getItem('pth_session'));
        
        // Verificaci√≥n Simple (Si no eres Marcel, te saca)
        if(!session || session.name !== 'Marcel Montano') {
            document.body.innerHTML = `<div class="h-screen w-full flex items-center justify-center bg-black text-red-500 font-mono font-bold flex-col gap-4">
                <span class="material-symbols-outlined text-6xl">lock</span>
                <p>ACCESO DENEGADO: PROTOCOLO OMEGA</p>
                <button onclick="window.location.href='index.html'" class="text-white underline">Volver</button>
            </div>`;
        } else {
            loadWarRoom();
            // Actualizaci√≥n autom√°tica cada 10 segundos
            setInterval(loadSniperTargets, 10000); 
        }
    </script>
</body>
</html>