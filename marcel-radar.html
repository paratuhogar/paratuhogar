<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA RADAR | Operaciones Marcel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Rajdhani', sans-serif; background: #020617; color: #94a3b8; }
        .radar-grid { background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 20px 20px; }
        .neon-text { text-shadow: 0 0 10px #22d3ee; color: #22d3ee; }
        .neon-border { border: 1px solid #22d3ee; box-shadow: 0 0 15px rgba(34, 211, 238, 0.2); }
        .feed-item { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="radar-grid min-h-screen p-6">

    <header class="flex justify-between items-center mb-8 border-b border-cyan-900/50 pb-4">
        <div>
            <h1 class="text-3xl font-bold neon-text tracking-tighter">PROJECT RADAR v1.0</h1>
            <p class="text-[10px] uppercase tracking-[0.5em] text-cyan-500">Monitoreo de Actividad en Tiempo Real</p>
        </div>
        <div class="text-right">
            <p id="status" class="text-xs font-bold text-emerald-500 animate-pulse">‚óè SISTEMA ONLINE</p>
            <p class="text-[10px]">OPERADOR: MARCEL MONTANO</p>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- COLUMNA 1: FEED EN VIVO -->
        <div class="lg:col-span-2 space-y-4">
            <h2 class="text-sm font-black uppercase tracking-widest border-l-4 border-cyan-500 pl-2">Log de Actividad Reciente</h2>
            <div id="live-feed" class="space-y-2 max-h-[70vh] overflow-y-auto pr-2">
                <!-- Se llena con JS -->
            </div>
        </div>

        <!-- COLUMNA 2: LEADS FANTASMA (ORO) -->
        <div class="space-y-4">
            <h2 class="text-sm font-black uppercase tracking-widest border-l-4 border-orange-500 pl-2 text-orange-500">Leads Fantasma (No terminaron)</h2>
            <div id="ghost-feed" class="space-y-3">
                <!-- Se llena con JS -->
            </div>

            <!-- MINI ESTADISTICAS -->
            <div class="mt-8 p-4 bg-slate-900/50 border border-slate-800 rounded-lg space-y-4">
                <h3 class="text-xs font-bold uppercase">M√©tricas de Hoy</h3>
                <div class="flex justify-between">
                    <span class="text-[10px]">Vistas Totales</span>
                    <span id="stat-views" class="text-cyan-400 font-bold">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[10px]">Clics WhatsApp</span>
                    <span id="stat-wa" class="text-emerald-400 font-bold">0</span>
                </div>
            </div>
        </div>

    </div>

    <script>
        const SUPABASE_URL = 'https://ljqwaovevfatkiigirhf.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_DAuFcu0JjUo15yLDAev3MQ_9x5GIVXt'; 
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function initRadar() {
    // 1. Intentar recuperar la sesi√≥n
    const session = JSON.parse(localStorage.getItem('pth_session'));

    // 2. Verificar si NO es Marcel Montano
    if (!session || session.name !== 'Marcel Montano') {
        // Borramos el cuerpo de la p√°gina inmediatamente para que no vea nada
        document.body.innerHTML = `
            <div style="background:#020617; color:white; height:100vh; display:flex; align-items:center; justify-content:center; font-family:sans-serif;">
                <div style="text-align:center;">
                    <h1 style="color:#ef4444;">‚õî ACCESO RESTRINGIDO</h1>
                    <p>No tienes permisos para operar el Sistema Radar.</p>
                    <p>Redirigiendo...</p>
                </div>
            </div>`;
        
        // Esperamos 2 segundos para que lea el mensaje y lo mandamos al index
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 2000);
        return; // Aqu√≠ termina la ejecuci√≥n para intrusos
    }

    // 3. Si es Marcel, el c√≥digo sigue aqu√≠ abajo normalmente
    console.log("üì° Radar Online. Bienvenido, Operador.");
    loadFeed();
    loadGhosts();
    setInterval(loadFeed, 5000); // Actualiza cada 5 segundos
}

        async function loadFeed() {
            const { data } = await supabase.from('log_espia').select('*').order('timestamp', {ascending: false}).limit(20);
            const container = document.getElementById('live-feed');
            
            container.innerHTML = data.map(log => {
                const hora = new Date(log.timestamp).toLocaleTimeString();
                let color = "text-cyan-400";
                if(log.accion === 'COMPRA_CONFIRMADA') color = "text-emerald-400 font-black";
                if(log.accion === 'BUSQUEDA') color = "text-purple-400";

                return `
                    <div class="feed-item bg-slate-900/80 border border-slate-800 p-3 rounded flex justify-between items-center">
                        <div class="flex gap-4 items-center">
                            <span class="text-[10px] font-mono opacity-40">${hora}</span>
                            <div>
                                <p class="text-xs ${color}">${log.accion}: <span class="text-white">${log.detalle}</span></p>
                                <p class="text-[9px] opacity-50">IP: ${log.ip} | GESTOR: ${log.gestor_atribuido}</p>
                            </div>
                        </div>
                        <span class="text-[8px] bg-slate-800 px-2 py-1 rounded">${log.dispositivo}</span>
                    </div>
                `;
            }).join('');

            // Stats rapidas
            document.getElementById('stat-views').innerText = data.filter(l => l.accion === 'VIO_DETALLE').length;
            document.getElementById('stat-wa').innerText = data.filter(l => l.accion === 'COMPRA_CONFIRMADA').length;
        }

        async function loadGhosts() {
            const { data } = await supabase.from('leads_fantasma').select('*').order('timestamp', {ascending: false}).limit(10);
            const container = document.getElementById('ghost-feed');

            container.innerHTML = data.map(lead => `
                <div class="bg-orange-500/5 border border-orange-900/30 p-3 rounded-lg relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-1">
                        <p class="text-white text-xs font-bold">${lead.nombre || 'Desconocido'}</p>
                        <span class="text-[8px] opacity-40">${new Date(lead.timestamp).toLocaleDateString()}</span>
                    </div>
                    <p class="text-orange-400 text-sm font-black mb-2">${lead.telefono}</p>
                    <p class="text-[10px] italic opacity-60 truncate">${lead.producto_en_carrito}</p>
                    <div class="absolute right-2 bottom-2 opacity-0 group-hover:opacity-100 transition-opacity">
                         <a href="https://wa.me/${lead.telefono.replace(/\D/g,'')}" target="_blank" class="text-[10px] bg-orange-600 text-white px-2 py-1 rounded">RESCATAR</a>
                    </div>
                </div>
            `).join('');
        }

        initRadar();
    </script>
</body>
</html>