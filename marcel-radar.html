<!DOCTYPE html>
<html lang="es">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA RADAR | Operaciones Marcel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Librer√≠a para Gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Rajdhani', sans-serif; background: #020617; color: #94a3b8; }
        .radar-grid { background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 20px 20px; }
        .neon-text { text-shadow: 0 0 10px #22d3ee; color: #22d3ee; }
        .neon-border { border: 1px solid #22d3ee; box-shadow: 0 0 15px rgba(34, 211, 238, 0.2); }
        .feed-item { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="radar-grid min-h-screen p-6">

    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b border-cyan-900/50 pb-6 gap-4">
        <div>
            <h1 class="text-4xl font-bold neon-text tracking-tighter">PROJECT RADAR v1.0</h1>
            <p class="text-[10px] uppercase tracking-[0.5em] text-cyan-500">Monitoreo en Tiempo Real</p>
        </div>
        <div class="flex flex-row md:flex-col justify-between w-full md:w-auto items-center md:items-end bg-slate-900/50 p-3 rounded-xl border border-white/5 md:border-none">
            <p id="status" class="text-xs font-bold text-emerald-500 animate-pulse flex items-center gap-2">
                <span class="block w-2 h-2 bg-emerald-500 rounded-full"></span> SISTEMA ONLINE
            </p>
            <p class="text-[10px] font-bold text-slate-500">OPERADOR: MARCEL MONTANO</p>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- COLUMNA 1: FEED EN VIVO -->
        <div class="lg:col-span-2 space-y-4">
            <h2 class="text-sm font-black uppercase tracking-widest border-l-4 border-cyan-500 pl-2">Log de Actividad Reciente</h2>
            <div id="live-feed" class="space-y-2 max-h-[70vh] overflow-y-auto pr-2">
                <!-- Se llena con JS -->
            </div>
        </div>

        <!-- COLUMNA 2: LEADS FANTASMA (ORO) -->
        <div class="space-y-4">
            <h2 class="text-sm font-black uppercase tracking-widest border-l-4 border-orange-500 pl-2 text-orange-500">Leads Fantasma (No terminaron)</h2>
            <div id="ghost-feed" class="space-y-3">
                <!-- Se llena con JS -->
            </div>

            <!-- MINI ESTADISTICAS -->
                <!-- GR√ÅFICA DE INTER√âS EN TIEMPO REAL -->
                <div class="mt-6 p-6 bg-slate-900/80 border border-cyan-900/30 rounded-2xl neon-border">
                    <h3 class="text-sm font-black uppercase tracking-widest text-cyan-400 mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">bar_chart</span> Radar de Inter√©s (√öltimas 50 acciones)
                    </h3>
                    <div style="height: 250px;">
                        <canvas id="vistasChart"></canvas>
                    </div>
                </div>
        </div>

    </div>

    <script>
    // Usamos un nombre de variable √∫nico para evitar el error de "Already declared"
const SUPABASE_URL_RADAR = 'https://ljqwaovevfatkiigirhf.supabase.co';
const SUPABASE_KEY_RADAR = 'sb_publishable_DAuFcu0JjUo15yLDAev3MQ_9x5GIVXt'; 
const radarClient = supabase.createClient(SUPABASE_URL_RADAR, SUPABASE_KEY_RADAR);

async function initRadar() {
    // 1. Verificar Sesi√≥n de Marcel
    const session = JSON.parse(localStorage.getItem('pth_session'));
    if (!session || session.name !== 'Marcel Montano') {
        document.body.innerHTML = "<div style='color:white; padding:50px; text-align:center;'><h1>‚õî ACCESO DENEGADO</h1><p>Redirigiendo...</p></div>";
        setTimeout(() => window.location.href = 'index.html', 2000);
        return;
    }

    // 2. Carga inicial
    console.log("üì° Conectando al sat√©lite...");
    loadFeed();
    loadGhosts();

    // 3. Actualizaci√≥n autom√°tica cada 5 segundos
    setInterval(() => {
        loadFeed();
        loadGhosts();
    }, 5000);
}


let lastGhostId = null; 
let vistasChart = null; 

// A. FUNCI√ìN NUEVA: EL SONIDO
function playAlertSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
    gainNode.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.01);
    gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.5);
}

// B. FUNCI√ìN NUEVA: DIBUJAR GR√ÅFICA
function updateChart(datosVistas) {
    const ctx = document.getElementById('vistasChart').getContext('2d');
    const conteo = {};
    datosVistas.forEach(log => {
        if(log.accion === 'VIO_DETALLE') {
            conteo[log.detalle] = (conteo[log.detalle] || 0) + 1;
        }
    });
    const labels = Object.keys(conteo);
    const values = Object.values(conteo);

    if (vistasChart) {
        vistasChart.data.labels = labels;
        vistasChart.data.datasets[0].data = values;
        vistasChart.update();
    } else {
        vistasChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: 'rgba(34, 211, 238, 0.5)',
                    borderColor: '#22d3ee',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: '#1e293b' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 9 } } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }
}

// C. FUNCI√ìN REEMPLAZADA: CARGAR FEED (M√ÅS GRANDE Y CON GR√ÅFICA)
async function loadFeed() {
    const { data, error } = await radarClient
        .from('log_espia')
        .select('*')
        .order('timestamp', { ascending: false })
        .limit(50);

    if (error) return;
    updateChart(data);

    const container = document.getElementById('live-feed');
    container.innerHTML = data.slice(0, 15).map(log => {
        const hora = new Date(log.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        let color = "text-cyan-400";
        if(log.accion === 'COMPRA_CONFIRMADA') color = "text-emerald-400 font-black";
        if(log.accion === 'BUSQUEDA') color = "text-purple-400";

        return `
            <div class="feed-item bg-slate-900/90 border border-slate-800 p-4 rounded-xl flex flex-col sm:flex-row justify-between gap-3 mb-4 shadow-xl">
                <div class="flex gap-4 items-start">
                    <span class="text-[10px] font-mono opacity-50 bg-slate-800 px-2 py-1 rounded mt-1">${hora}</span>
                    <div>
                        <p class="text-lg ${color} font-bold leading-tight">${log.accion}</p>
                        <p class="text-white text-base font-medium mt-1">${log.detalle}</p>
                        <p class="text-[10px] opacity-60 mt-2 uppercase tracking-tighter">
                            GESTOR: <span class="text-cyan-400">${log.gestor_atribuido || 'Directo'}</span> | IP: ${log.ip}
                        </p>
                    </div>
                </div>
                <div class="flex justify-end">
                    <span class="text-[9px] font-black bg-slate-800 px-3 py-1 rounded-full text-slate-400 border border-white/5">${log.dispositivo.toUpperCase()}</span>
                </div>
            </div>`;
    }).join('');

    document.getElementById('stat-views').innerText = data.filter(l => l.accion === 'VIO_DETALLE').length;
    document.getElementById('stat-wa').innerText = data.filter(l => l.accion === 'COMPRA_CONFIRMADA').length;
}

// D. FUNCI√ìN REEMPLAZADA: CARGAR GHOSTS (M√ÅS GRANDE Y CON SONIDO)
async function loadGhosts() {
    const { data, error } = await radarClient.from('leads_fantasma').select('*').order('timestamp', { ascending: false }).limit(10);
    if (error) return;

    if (data && data.length > 0) {
        if (lastGhostId && data[0].id > lastGhostId) playAlertSound();
        lastGhostId = data[0].id;
    }

    const container = document.getElementById('ghost-feed');
    if (!data || data.length === 0) {
        container.innerHTML = "<p class='text-center p-10 opacity-30 italic'>Sin prospectos...</p>";
        return;
    }

    container.innerHTML = data.map(lead => `
        <div class="bg-gradient-to-br from-orange-500/20 to-transparent border-l-4 border-orange-500 p-6 rounded-r-2xl mb-6 shadow-2xl relative overflow-hidden">
            <div class="absolute right-[-10px] top-[-10px] opacity-10 rotate-12">
                <span class="material-symbols-outlined text-7xl text-orange-500">person_search</span>
            </div>
            <div class="flex justify-between items-start mb-3 relative z-10">
                <p class="text-white text-base font-black uppercase tracking-tight">${lead.nombre || 'An√≥nimo'}</p>
                <span class="text-[10px] opacity-50 bg-black/40 px-2 py-0.5 rounded">${new Date(lead.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
            </div>
            <p class="text-orange-400 text-3xl font-black mb-4 tracking-tighter relative z-10">${lead.telefono}</p>
            <div class="bg-black/40 p-3 rounded-xl border border-white/5 mb-5 relative z-10">
                <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Inter√©s detectado:</p>
                <p class="text-xs text-slate-200 font-medium line-clamp-2">${lead.producto_en_carrito || 'Explorando cat√°logo'}</p>
            </div>
            <a href="https://wa.me/${lead.telefono.replace(/\D/g, '')}" target="_blank" 
               class="w-full text-center block text-sm bg-orange-600 text-white font-black py-4 rounded-xl hover:bg-orange-500 transition-all uppercase tracking-widest shadow-lg shadow-orange-900/40 active:scale-95">
               RESCATAR VENTA
            </a>
        </div>`).join('');
}

// Ejecutar al cargar
initRadar();
    </script>
</body>
</html>