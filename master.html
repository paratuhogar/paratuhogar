<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASTER CONTROL | Financiero</title>
    
    <!-- Estilos y Librer√≠as (Mismas que el index) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS para Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS para Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    
    <!-- PEGAR AQU√ç LA LIBRER√çA DE GR√ÅFICOS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    

    <style>
        body { font-family: 'Manrope', sans-serif; background-color: #0f172a; color: white; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .input-dark { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 8px; width: 100%; }
    </style>

    <script>
    // --- 1. SEGURIDAD: CHECKPOINT SUPREMO ---
    const session = JSON.parse(localStorage.getItem('pth_session') || '{}');
    
    // VERIFICACI√ìN ESTRICTA:
    // Solo entra si el rol es expl√≠citamente 'superadmin' O si es el usuario Marcel/√Ångel espec√≠fico.
    // Ya NO basta con ser "isAdmin: true".
    const isSuperBoss = session.data?.rol === 'superadmin' || session.name === 'Marcel Montano';

    if (!isSuperBoss) {
        alert("‚õî ACCESO DENEGADO: √Årea Financiera Restringida.\n\nTu nivel de administrador (Log√≠stica) no tiene permiso para ver el dinero.");
        window.location.href = 'index.html'; // Patada de vuelta al inicio
    }

    // Configuraci√≥n Supabase
    const SUPABASE_URL = 'https://ljqwaovevfatkiigirhf.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_DAuFcu0JjUo15yLDAev3MQ_9x5GIVXt'; 
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>
</head>
<body class="pb-20">

    <!-- Header Financiero -->
    <header class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900 sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <div class="bg-amber-500 p-2 rounded-lg text-slate-900"><span class="material-symbols-outlined">lock</span></div>
            <div>
                <h1 class="text-xl font-black tracking-tight text-amber-500">B√ìVEDA FINANCIERA</h1>
                <p class="text-xs text-slate-400">Control de Costos y Utilidades</p>
            </div>
        </div>
        <button onclick="window.location.href='index.html'" class="text-xs font-bold text-slate-400 hover:text-white uppercase">
            Volver a Log√≠stica
        </button>
    </header>

    <main class="max-w-7xl mx-auto p-6 space-y-8">

        <!-- NAVEGACI√ìN INTERNA -->
        <div class="flex gap-4 border-b border-slate-800 pb-4">
            <button onclick="switchTab('costos')" id="btn-costos" class="tab-btn px-4 py-2 bg-slate-800 rounded-lg text-sm font-bold hover:bg-slate-700">1. Gesti√≥n Costos</button>
            <button onclick="switchTab('conciliacion')" id="btn-conciliacion" class="tab-btn px-4 py-2 text-slate-400 text-sm font-bold hover:text-white">2. Conciliaci√≥n (Viernes)</button>
            <button onclick="switchTab('nomina')" id="btn-nomina" class="tab-btn px-4 py-2 text-slate-400 text-sm font-bold hover:text-white">3. N√≥mina Gestores (S√°bado)</button>
            <button onclick="switchTab('dashboard')" id="btn-dashboard" class="tab-btn px-4 py-2 text-slate-400 text-sm font-bold hover:text-white">4. Inteligencia (BI)</button>
        </div>

        <!-- 1. VISTA GESTI√ìN DE COSTOS (Estilo Excel) -->
        <section id="sec-costos" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">Establecer Costos de Proveedor</h2>
                <div class="text-right">
                    <p class="text-xs text-slate-400">Ganancia Neta Proyectada</p>
                    <p id="total-profit-projected" class="text-2xl font-black text-emerald-400">$0.00</p>
                </div>
            </div>

            <div class="overflow-x-auto rounded-xl border border-slate-700">
                <table class="w-full text-left text-sm text-slate-400">
                    <thead class="bg-slate-800 text-xs uppercase font-black text-slate-200">
                        <tr>
                            <th class="p-4">Producto</th>
                            <th class="p-4">Proveedor</th>
                            <th class="p-4 text-right text-blue-400">Precio Venta</th>
                            <th class="p-4 text-right text-red-400">Costo Real (Editable)</th>
                            <th class="p-4 text-right text-orange-400">Comisi√≥n Gestor</th>
                            <th class="p-4 text-right text-emerald-400">UTILIDAD BOSS</th>
                            <th class="p-4 text-center">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="table-costos" class="divide-y divide-slate-700 bg-slate-900/50">
                        <!-- JS Llenar√° esto -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 2. VISTA CONCILIACI√ìN (Para los viernes) -->
        <section id="sec-conciliacion" class="tab-content hidden">
            <div class="bg-amber-900/20 border border-amber-500/30 p-4 rounded-xl mb-6">
                <h3 class="font-bold text-amber-500 flex items-center gap-2"><span class="material-symbols-outlined">warning</span> ZONA DE CONCILIACI√ìN CON PROVEEDORES</h3>
                <p class="text-xs text-amber-200 mt-1">Aqu√≠ marcas los pedidos que <b>el proveedor ya te confirm√≥/pag√≥</b>. Solo lo que marques aqu√≠ pasar√° a la lista de pago de los gestores.</p>
            </div>

            <div class="glass-panel p-6 rounded-2xl">
                <div class="flex gap-4 mb-4">
                    <select id="filter-prov-conc" class="input-dark w-64" onchange="loadConciliacion()">
                        <option value="TODOS">Todos los Proveedores</option>
                    </select>
                    <button onclick="conciliarMasivo()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-emerald-500 transition-all">
                        CONFIRMAR SELECCIONADOS
                    </button>
                </div>

                <table class="w-full text-left text-sm text-slate-300">
                    <thead class="bg-slate-800/50 text-xs uppercase">
                        <tr>
                            <th class="p-3"><input type="checkbox" id="check-all-conc" onchange="toggleAllConc(this)"></th>
                            <th class="p-3">Pedido</th>
                            <th class="p-3">Producto</th>
                            <th class="p-3">Total Venta</th>
                            <th class="p-3">Costo Prov.</th>
                            <th class="p-3 text-emerald-400">A PAGARLE AL PROV.</th>
                        </tr>
                    </thead>
                    <tbody id="list-conciliacion"></tbody>
                </table>
            </div>
        </section>

        <!-- 3. VISTA N√ìMINA (Para los s√°bados) -->
        <!-- 3. VISTA N√ìMINA (Para los s√°bados y Adelantos) -->
<section id="sec-nomina" class="tab-content hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- COLUMNA IZQUIERDA: GESTI√ìN DE CAJA (Adelantos) -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Formulario de Adelantos -->
            <div class="glass-panel p-6 rounded-2xl border-l-4 border-blue-500">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-400">account_balance_wallet</span>
                    Registrar Movimiento
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-slate-400 uppercase font-bold">Gestor</label>
                        <select id="wallet-gestor" class="input-dark mt-1">
                            <!-- Se llena con JS -->
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 uppercase font-bold">Tipo Movimiento</label>
                        <select id="wallet-tipo" class="input-dark mt-1">
                            <option value="Adelanto">üí∏ Adelanto (Resta)</option>
                            <option value="Bono">üéÅ Bono Extra (Suma)</option>
                            <option value="Multa">‚ö†Ô∏è Penalizaci√≥n (Resta)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 uppercase font-bold">Monto ($)</label>
                        <input type="number" id="wallet-monto" class="input-dark mt-1 font-black text-lg" placeholder="0.00">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 uppercase font-bold">Nota / Motivo</label>
                        <input type="text" id="wallet-nota" class="input-dark mt-1" placeholder="Ej: Adelanto gasolina...">
                    </div>
                    <button onclick="guardarMovimientoCaja()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold shadow-lg transition-all mt-2">
                        REGISTRAR
                    </button>
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA: TABLA DE PAGOS (Corte S√°bado) -->
        <div class="lg:col-span-2">
            <div class="glass-panel p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl text-white">N√≥mina de Pago (S√°bado)</h3>
                    <button onclick="loadNomina()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-white flex items-center gap-1">
                        <span class="material-symbols-outlined text-sm">refresh</span> Actualizar
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-slate-300">
                        <thead class="bg-slate-800 text-xs uppercase font-black">
                            <tr>
                                <th class="p-3">Gestor</th>
                                <th class="p-3 text-right">Ventas Conciliadas</th>
                                <th class="p-3 text-right text-emerald-400">(+) Comisiones</th>
                                <th class="p-3 text-right text-red-400">(-) Adelantos</th>
                                <th class="p-3 text-right text-white text-lg">A PAGAR</th>
                                <th class="p-3 text-center">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="list-nomina" class="divide-y divide-slate-700">
                            <!-- Se llena con JS -->
                        </tbody>
                    </table>
                </div>
                <p class="text-xs text-slate-500 mt-4 italic">* Solo aparecen comisiones de pedidos marcados como "Conciliados" el viernes.</p>
            </div>
        </div>
    </div>
</section>

<!-- ... fin de la tabla de n√≥mina ... -->
            </div>
        </div>
    </div>
</section> <!-- Fin de section nomina -->

<!-- PEGAR AQU√ç LA SECCI√ìN DASHBOARD -->
<section id="sec-dashboard" class="tab-content hidden">
    
    <!-- 1. BARRA DE CONTROL (FILTROS DE TIEMPO) -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 bg-slate-800 p-4 rounded-xl border border-slate-700">
        <h3 class="text-white font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-amber-500">monitoring</span>
            Tablero de Mando
        </h3>
        <div class="flex gap-2">
            <button onclick="filterDash('semana')" id="btn-d-semana" class="dash-filter px-4 py-1 rounded-lg text-xs font-bold bg-slate-700 text-slate-300 hover:text-white transition-all">Esta Semana</button>
            <button onclick="filterDash('mes')" id="btn-d-mes" class="dash-filter px-4 py-1 rounded-lg text-xs font-bold bg-slate-700 text-slate-300 hover:text-white transition-all">Este Mes</button>
            <button onclick="filterDash('total')" id="btn-d-total" class="dash-filter px-4 py-1 rounded-lg text-xs font-bold bg-emerald-600 text-white shadow-lg">Hist√≥rico Total</button>
        </div>
    </div>

    <!-- 2. KPIs FINANCIEROS (LO QUE LE IMPORTA: SU BOLSILLO) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Tarjeta 1: Utilidad Neta -->
        <div class="glass-panel p-6 rounded-2xl border-l-4 border-emerald-500 relative overflow-hidden group">
            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-all">
                <span class="material-symbols-outlined text-6xl text-emerald-500">payments</span>
            </div>
            <p class="text-xs text-slate-400 uppercase font-black tracking-widest mb-1">Tu Ganancia L√≠quida</p>
            <h3 id="kpi-net-profit" class="text-4xl font-black text-white mb-2">$0.00</h3>
            <p class="text-[10px] text-emerald-400 font-bold bg-emerald-900/30 px-2 py-1 rounded inline-block">
                Dinero libre (Post Pagos)
            </p>
        </div>

        <!-- Tarjeta 2: Volumen Negocio -->
        <div class="glass-panel p-6 rounded-2xl border-l-4 border-blue-500 relative overflow-hidden">
            <p class="text-xs text-slate-400 uppercase font-black tracking-widest mb-1">Volumen Movido</p>
            <h3 id="kpi-total-sales" class="text-4xl font-black text-white mb-2">$0.00</h3>
            <div class="flex justify-between items-end">
                <p class="text-[10px] text-slate-400">Total facturado a clientes</p>
                <span id="kpi-orders-count" class="text-xl font-bold text-blue-400">0 Pedidos</span>
            </div>
        </div>

        <!-- Tarjeta 3: Eficiencia (Margen) -->
        <div class="glass-panel p-6 rounded-2xl border-l-4 border-purple-500 relative overflow-hidden">
            <p class="text-xs text-slate-400 uppercase font-black tracking-widest mb-1">Margen Promedio</p>
            <h3 id="kpi-margin" class="text-4xl font-black text-white mb-2">0%</h3>
            <p id="kpi-margin-text" class="text-[10px] text-purple-300">Calculando salud del negocio...</p>
        </div>
    </div>

    <!-- 3. IA DE RECOMENDACIONES (EL CEREBRO) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Los Mejores (Invertir) -->
        <div class="bg-gradient-to-br from-slate-900 to-slate-800 p-6 rounded-2xl border border-slate-700">
            <h4 class="text-sm font-black text-emerald-400 uppercase mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined">trending_up</span> Productos Estrella (Invertir)
            </h4>
            <div id="list-top-products" class="space-y-3">
                <!-- Se llena con JS -->
            </div>
        </div>

        <!-- Los Peores (Cortar) -->
        <div class="bg-gradient-to-br from-slate-900 to-slate-800 p-6 rounded-2xl border border-slate-700">
            <h4 class="text-sm font-black text-red-400 uppercase mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined">trending_down</span> Productos Lentos / Bajo Margen
            </h4>
            <div id="list-low-products" class="space-y-3">
                <!-- Se llena con JS -->
            </div>
        </div>
    </div>

    <!-- 4. GR√ÅFICOS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass-panel p-6 rounded-2xl">
            <h4 class="font-bold text-slate-300 mb-4 text-xs uppercase">Rendimiento de Gestores (Profit)</h4>
            <canvas id="chartGestorPerformance"></canvas>
        </div>
        <div class="glass-panel p-6 rounded-2xl">
            <h4 class="font-bold text-slate-300 mb-4 text-xs uppercase">Tendencia de Ganancia (Diaria)</h4>
            <canvas id="chartProfitTrend"></canvas>
        </div>
    </div>
</section>

</main>

    </main>

    <script>
        // --- LOGICA DEL MASTER ---

        let inventario = [];

        async function initMaster() {
            await loadCostos();
        }

        function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.replace('bg-slate-800', 'text-slate-400'));
    
    document.getElementById(`sec-${tabId}`).classList.remove('hidden');
    const btn = document.getElementById(`btn-${tabId}`);
    btn.classList.remove('text-slate-400');
    btn.classList.add('bg-slate-800', 'text-white');

    if(tabId === 'costos') loadCostos();
    if(tabId === 'conciliacion') loadConciliacion();
    if(tabId === 'nomina') loadNomina(); // Aseg√∫rate de tener esto
    if(tabId === 'dashboard') loadDashboard(); // <--- AGREGAR ESTA L√çNEA NUEVA
}

        // 1. CARGA DE COSTOS (TABLA EXCEL)
        // 1. CARGA DE COSTOS (TABLA EXCEL)
// 1. CARGA DE COSTOS (MEJORADA: PASA EL ELEMENTO "THIS")
async function loadCostos() {
    const { data, error } = await supabaseClient.from('productos').select('*').order('nombre');
    
    if(error) {
        console.error("Error cargando productos:", error);
        return;
    }
    
    inventario = data; // Guardamos en memoria
    const tbody = document.getElementById('table-costos');
    let totalProfit = 0;

    tbody.innerHTML = data.map(p => {
        const costo = p.costo_proveedor || 0;
        const comision = p.comision || 0;
        const profit = p.precio - costo - comision;
        
        if(p.disponible === 'SI') totalProfit += profit;

        return `
        <tr class="hover:bg-slate-800 transition-colors border-b border-slate-800">
            <td class="p-4 font-bold text-white">${p.nombre}</td>
            <td class="p-4 text-xs">${p.proveedor || 'General'}</td>
            <td class="p-4 text-right font-mono text-slate-300">$${p.precio}</td>
            <td class="p-4 text-right">
                <!-- CAMBIO AQU√ç: Agregamos 'this' al final para controlar el color -->
                <input type="number" value="${costo}" 
                    onchange="updateCosto('${p.id}', this.value, this)"
                    class="bg-slate-950 border border-slate-700 text-red-400 font-bold text-right w-24 rounded px-2 py-1 focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 transition-all">
            </td>
            <td class="p-4 text-right text-orange-400 font-mono">-$${comision}</td>
            <!-- Le ponemos un ID al profit para actualizarlo sin recargar -->
            <td id="profit-${p.id}" class="p-4 text-right font-black text-emerald-400 text-lg">$${profit.toFixed(0)}</td>
            <td class="p-4 text-center">
                <span class="material-symbols-outlined text-slate-600 text-sm">edit</span>
            </td>
        </tr>
        `;
    }).join('');
    
    // Actualizar proyecci√≥n total visual
    const profitEl = document.getElementById('total-profit-projected');
    if(profitEl) profitEl.innerText = `$${totalProfit.toLocaleString()}`;
}

// GUARDAR COSTO (SIN RECARGAR TABLA + FEEDBACK VISUAL)
async function updateCosto(id, nuevoCosto, inputElement) {
    // 1. Feedback visual: Opacidad bajita mientras guarda
    inputElement.classList.add('opacity-50');

    // 2. Guardar en Base de Datos
    const { error } = await supabaseClient
        .from('productos')
        .update({ costo_proveedor: nuevoCosto })
        .eq('id', id);

    inputElement.classList.remove('opacity-50');

    if(error) {
        alert("Error: " + error.message);
        inputElement.classList.add('border-red-500'); // Borde rojo si falla
    } else {
        // 3. √âXITO: Poner borde verde y texto verde por 2 segundos
        inputElement.classList.remove('border-slate-700', 'text-red-400');
        inputElement.classList.add('border-emerald-500', 'text-emerald-400', 'bg-emerald-900/20');

        setTimeout(() => {
            inputElement.classList.remove('border-emerald-500', 'text-emerald-400', 'bg-emerald-900/20');
            inputElement.classList.add('border-slate-700', 'text-red-400');
        }, 2000);

        // 4. ACTUALIZAR MEMORIA LOCAL (CRUCIAL PARA QUE NO SE BORRE AL CAMBIAR PESTA√ëA)
        const productoEnMemoria = inventario.find(p => p.id === id);
        if (productoEnMemoria) {
            productoEnMemoria.costo_proveedor = nuevoCosto;
            
            // Recalcular la utilidad en pantalla al instante
            const nuevaUtilidad = productoEnMemoria.precio - nuevoCosto - productoEnMemoria.comision;
            const celdaUtilidad = document.getElementById(`profit-${id}`);
            if(celdaUtilidad) celdaUtilidad.innerText = `$${nuevaUtilidad.toFixed(0)}`;
        }
        
        console.log("Costo guardado y memoria actualizada.");
    }
}

        async function conciliarMasivo() {
            const checks = document.querySelectorAll('.chk-conc:checked');
            if(checks.length === 0) return alert("Selecciona pedidos");

            const ids = Array.from(checks).map(c => c.value);
            
            if(!confirm(`¬øConfirmas que el proveedor YA PAG√ì/COBR√ì estos ${ids.length} pedidos?\n\nAl aceptar, el dinero de la ganancia pasar√° a estar DISPONIBLE para pagarle a los gestores.`)) return;

            const { error } = await supabaseClient
                .from('pedidos')
                .update({ estado_financiero: 'Conciliado_Prov' }) // Estado intermedio clave
                .in('id', ids);

            if(error) alert("Error: " + error.message);
            else {
                alert("‚úÖ Pedidos conciliados. Ahora aparecer√°n en la N√≥mina de Pago.");
                loadConciliacion();
            }
        }

        // 2. CARGA DE CONCILIACI√ìN (CORREGIDA Y BLINDADA)
// 2. CARGA DE CONCILIACI√ìN (CON TOTALIZADOR POR PROVEEDOR)
async function loadConciliacion() {
    
    // 1. Cargar inventario si falta (Seguridad)
    if (typeof inventario === 'undefined' || inventario.length === 0) {
        await loadCostos(); 
    }

    // 2. Obtener datos
    const { data, error } = await supabaseClient
        .from('pedidos')
        .select('*')
        .eq('estado', 'Entregado')
        .neq('estado_financiero', 'Conciliado_Prov');

    if(error) return console.error(error);

    // --- FILTROS ---
    const select = document.getElementById('filter-prov-conc');
    const valorActual = select.value;

    const proveedoresUnicos = [...new Set(data.map(p => p.proveedor || 'General'))].sort();
    
    if (select.options.length <= 1 || valorActual === 'TODOS') {
        select.innerHTML = `<option value="TODOS">Todos los Proveedores</option>` +
            proveedoresUnicos.map(prov => `<option value="${prov}">${prov}</option>`).join('');
        select.value = valorActual;
    }

    // Filtrar lista
    let pedidosFiltrados = data;
    if (valorActual !== 'TODOS') {
        pedidosFiltrados = data.filter(p => (p.proveedor || 'General') === valorActual);
    }

    // --- C√ÅLCULO DEL TOTAL ACUMULADO (NUEVO) ---
    let sumaTotalARecibir = 0;
    
    // Procesamos los datos para la tabla y sumamos al vuelo
    const filasHTML = pedidosFiltrados.map(p => {
        const nombreLimpio = p.producto.replace(/^\d+x\s*/, '').split('[')[0].trim();
        const prod = inventario.find(i => p.producto.includes(i.nombre) || i.nombre === nombreLimpio) || { costo_proveedor: 0 };
        const costoBase = Number(prod.costo_proveedor || 0);
        
        let qty = 1;
        const match = p.producto.match(/^(\d+)x/);
        if(match) qty = parseInt(match[1]);

        const totalVenta = parseFloat(p.total);
        const totalCosto = costoBase * qty;
        const aRecibir = totalVenta - totalCosto;

        // SUMAR AL TOTAL GENERAL
        sumaTotalARecibir += aRecibir;

        // Alerta visual si falta el costo
        const esAlerta = costoBase === 0;

        return `
        <tr class="border-b border-slate-800 hover:bg-slate-800/50">
            <td class="p-3"><input type="checkbox" class="chk-conc" value="${p.id}"></td>
            <td class="p-3 text-xs text-slate-400">${p.orden_dia || '---'}</td>
            <td class="p-3 font-bold text-white">
                ${p.producto}
                <div class="text-[10px] text-amber-500 uppercase">${p.proveedor || 'General'}</div>
            </td>
            <td class="p-3 text-slate-300">$${totalVenta}</td>
            <td class="p-3 font-mono">
                 ${esAlerta ? `<span class="text-red-500 font-bold">$0 (Alerta)</span>` : `<span class="text-red-300">$${totalCosto}</span>`}
            </td>
            <td class="p-3 font-black text-emerald-400 text-lg">+$${aRecibir.toFixed(2)}</td>
        </tr>
        `;
    }).join('');

    // --- INYECTAR EL PANEL DE TOTALES (NUEVO) ---
    // Buscamos d√≥nde poner el total (Antes de la tabla)
    const container = document.getElementById('list-conciliacion').parentElement; // La tabla
    let totalPanel = document.getElementById('panel-total-conciliacion');
    
    // Si no existe el panel, lo creamos din√°micamente
    if (!totalPanel) {
        totalPanel = document.createElement('div');
        totalPanel.id = 'panel-total-conciliacion';
        totalPanel.className = "bg-gradient-to-r from-slate-800 to-slate-900 p-4 rounded-xl mb-4 border border-slate-700 flex justify-between items-center shadow-lg";
        // Lo insertamos antes de la tabla
        container.parentElement.insertBefore(totalPanel, container);
    }

    // Actualizamos el contenido del panel
    const nombreProveedor = valorActual === 'TODOS' ? 'TOTAL GLOBAL' : `PROVEEDOR: ${valorActual}`;
    
    totalPanel.innerHTML = `
        <div class="flex items-center gap-3">
            <div class="p-3 bg-emerald-500/10 rounded-lg text-emerald-500">
                <span class="material-symbols-outlined text-2xl">payments</span>
            </div>
            <div>
                <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">MONTO A RECOGER (${nombreProveedor})</p>
                <p class="text-[10px] text-slate-500">Suma de ${pedidosFiltrados.length} pedidos seleccionados</p>
            </div>
        </div>
        <div class="text-right">
            <span class="block text-3xl font-black text-white tracking-tight">$${sumaTotalARecibir.toFixed(2)}</span>
            <span class="text-xs text-emerald-400 font-bold">Disponible para traer</span>
        </div>
    `;

    // --- RENDERIZAR LA TABLA ---
    const list = document.getElementById('list-conciliacion');
    
    // Arreglar encabezado si es necesario
    const thFinal = document.querySelector('#sec-conciliacion thead th:last-child');
    if(thFinal) thFinal.innerHTML = "A RECIBIR";

    if (pedidosFiltrados.length === 0) {
        list.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-500">Nada pendiente.</td></tr>`;
        // Si no hay datos, ocultamos el panel de totales o lo ponemos en 0
        if(totalPanel) totalPanel.innerHTML = `<div class="text-center w-full text-slate-500 text-xs">Sin montos pendientes</div>`;
    } else {
        list.innerHTML = filasHTML;
    }
}

        function toggleAllConc(source) {
            document.querySelectorAll('.chk-conc').forEach(c => c.checked = source.checked);
        }

        // --- 3. L√ìGICA DE N√ìMINA Y CAJA ---

        // 3. CARGA DE N√ìMINA (CON DETALLE DE PRODUCTOS)
async function loadNomina() {
    // A. Cargar Pedidos CONCILIADOS (Listos para pagar al gestor) pero NO LIQUIDADOS
    const { data: pedidos, error: errP } = await supabaseClient
        .from('pedidos')
        .select('*')
        .eq('estado_financiero', 'Conciliado_Prov') 
        .neq('pago_gestor', 'Pagado'); 

    // B. Cargar Movimientos de Caja
    const { data: caja, error: errC } = await supabaseClient.from('caja_gestores').select('*');

    if(errP || errC) return console.error("Error datos n√≥mina");

    // C. Agrupar por Gestor
    const nomina = {};

    // 1. Sumar Comisiones y Guardar Nombres de Productos
    pedidos.forEach(p => {
        const g = p.gestor || 'Sin Gestor';
        
        // Inicializamos el objeto si no existe
        if(!nomina[g]) nomina[g] = { 
            comision: 0, 
            adelantos: 0, 
            pedidosIds: [], 
            ventasCount: 0,
            listaProductos: [] // <--- NUEVO: Array para guardar nombres
        };
        
        nomina[g].comision += Number(p.comision_total || 0);
        nomina[g].ventasCount++;
        nomina[g].pedidosIds.push(p.id);

        // Limpieza del nombre del producto para que se vea bonito
        // Ej: "1x Arrocera [USD]" -> "Arrocera"
        let nombreLimpio = p.producto.replace(/^\d+x\s*/, '').split('[')[0].trim();
        nomina[g].listaProductos.push(nombreLimpio);
    });

    // 2. Restar Adelantos / Sumar Bonos
    caja.forEach(c => {
        const g = c.gestor;
        if(!nomina[g]) nomina[g] = { comision: 0, adelantos: 0, pedidosIds: [], ventasCount: 0, listaProductos: [] }; 
        
        if(c.tipo === 'Adelanto' || c.tipo === 'Multa') {
            nomina[g].adelantos += Number(c.monto);
        } else if (c.tipo === 'Bono') {
            nomina[g].comision += Number(c.monto); 
        }
    });

    // D. Renderizar Tabla
    const tbody = document.getElementById('list-nomina');
    const selectGestor = document.getElementById('wallet-gestor');
    
    // Llenar select de gestores
    const todosGestores = Object.keys(nomina).sort();
    selectGestor.innerHTML = todosGestores.map(g => `<option value="${g}">${g}</option>`).join('');

    tbody.innerHTML = Object.entries(nomina).map(([gestor, datos]) => {
        const totalPagar = datos.comision - datos.adelantos;
        const idsString = datos.pedidosIds.join(',');

        if(totalPagar === 0 && datos.ventasCount === 0) return '';

        // Generar HTML de la lista de productos
        // Usamos .join('') para unir los items
        const productosHTML = datos.listaProductos.map(prod => 
            `<div class="text-[9px] text-slate-400 border-b border-slate-700/50 pb-0.5 mb-0.5 last:border-0">‚Ä¢ ${prod}</div>`
        ).join('');

        return `
        <tr class="hover:bg-slate-800 transition-all">
            <td class="p-3 align-top font-bold text-white text-sm">${gestor}</td>
            
            <!-- COLUMNA MODIFICADA: Muestra Cantidad + Lista -->
            <td class="p-3 align-top text-right">
                <span class="font-black text-white text-lg block mb-1">${datos.ventasCount}</span>
                <div class="flex flex-col items-end opacity-80">
                    ${productosHTML}
                </div>
            </td>

            <td class="p-3 align-top text-right text-emerald-400 font-mono text-sm">+$${datos.comision.toFixed(2)}</td>
            <td class="p-3 align-top text-right text-red-400 font-mono text-sm">-$${datos.adelantos.toFixed(2)}</td>
            <td class="p-3 align-top text-right font-black text-xl ${totalPagar < 0 ? 'text-red-500' : 'text-white'}">
                $${totalPagar.toFixed(2)}
            </td>
            <td class="p-3 align-top text-center">
                ${totalPagar > 0 ? 
                    `<button onclick="liquidarGestor('${gestor}', '${idsString}', ${totalPagar})" 
                        class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-lg uppercase transition-all">
                        PAGAR
                    </button>` : 
                    `<span class="text-xs text-slate-500 font-bold">Sin Saldo</span>`
                }
            </td>
        </tr>
        `;
    }).join('');
}

        // GUARDAR ADELANTO
        async function guardarMovimientoCaja() {
            const gestor = document.getElementById('wallet-gestor').value;
            const tipo = document.getElementById('wallet-tipo').value;
            const monto = document.getElementById('wallet-monto').value;
            const nota = document.getElementById('wallet-nota').value;

            if(!gestor || !monto) return alert("Faltan datos");

            const { error } = await supabaseClient.from('caja_gestores').insert([{
                gestor: gestor,
                tipo: tipo,
                monto: monto,
                nota: nota
            }]);

            if(error) alert("Error: " + error.message);
            else {
                alert("Movimiento registrado");
                document.getElementById('wallet-monto').value = "";
                document.getElementById('wallet-nota').value = "";
                loadNomina(); // Recargar tabla
            }
        }

        // LIQUIDAR (PAGAR S√ÅBADO)
        async function liquidarGestor(gestor, idsString, monto) {
            if(!confirm(`¬øConfirmas que vas a PAGAR $${monto} a ${gestor}?\n\nEsto marcar√° los pedidos como 'Pagados' y archivar√° los adelantos.`)) return;

            // 1. Marcar pedidos como PAGADOS
            if(idsString) {
                const { error: err1 } = await supabaseClient
                    .from('pedidos')
                    .update({ 
                        pago_gestor: 'Pagado', 
                        estado_financiero: 'Liquidado_Gestor' 
                    })
                    .in('id', idsString.split(','));
                
                if(err1) return alert("Error actualizando pedidos");
            }

            // 2. Limpiar caja (Adelantos)
            // OPCI√ìN SIMPLE: Borramos los adelantos de este gestor porque ya se descontaron
            const { error: err2 } = await supabaseClient
                .from('caja_gestores')
                .delete()
                .eq('gestor', gestor);

            if(err2) alert("Error limpiando caja, pero los pedidos se marcaron pagados.");
            
            alert("‚úÖ Pago registrado correctamente. Cuenta en $0.");
            loadNomina();
        }

        // Aseg√∫rate de llamar a loadNomina si cambian de pesta√±a
        // (Ya est√° en la funci√≥n switchTab del c√≥digo anterior)

        // Arrancar

        // --- 4. L√ìGICA BI (DASHBOARD) ---

        // Variable global para almacenar todos los pedidos y poder filtrar
let allOrdersCache = [];

async function loadDashboard() {
    // 1. Cargar datos si no est√°n cacheados
    if(allOrdersCache.length === 0) {
        const { data } = await supabaseClient
            .from('pedidos')
            .select('*')
            .eq('estado', 'Entregado')
            .order('fecha', { ascending: true }); // Ordenar por fecha para el gr√°fico
        
        if(data) allOrdersCache = data;
        
        // Cargar inventario si no existe (para saber costos)
        if(typeof inventario === 'undefined' || inventario.length === 0) {
            await loadCostos();
        }
    }

    // Por defecto cargar "Hist√≥rico Total"
    filterDash('total');
}

// FUNCI√ìN DE FILTRADO Y C√ÅLCULO
function filterDash(periodo) {
    // 1. Actualizar botones visualmente
    document.querySelectorAll('.dash-filter').forEach(b => {
        b.classList.remove('bg-emerald-600', 'text-white', 'shadow-lg');
        b.classList.add('bg-slate-700', 'text-slate-300');
    });
    document.getElementById(`btn-d-${periodo}`).classList.add('bg-emerald-600', 'text-white', 'shadow-lg');
    document.getElementById(`btn-d-${periodo}`).classList.remove('bg-slate-700', 'text-slate-300');

    // 2. Filtrar Datos por Fecha
    const now = new Date();
    let filteredOrders = allOrdersCache;

    if (periodo === 'semana') {
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(now.getDate() - 7);
        filteredOrders = allOrdersCache.filter(p => new Date(p.fecha) >= oneWeekAgo);
    } else if (periodo === 'mes') {
        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(now.getMonth() - 1);
        filteredOrders = allOrdersCache.filter(p => new Date(p.fecha) >= oneMonthAgo);
    }

    calculateMetrics(filteredOrders);
}

function calculateMetrics(orders) {
    let netProfit = 0;
    let totalSales = 0;
    
    const prodStats = {}; 
    const gestorStats = {}; // Ahora guardar√° { sales: 0, profit: 0 }
    const trendData = {}; 

    orders.forEach(p => {
        const nombreLimpio = p.producto.replace(/^\d+x\s*/, '').split('[')[0].trim();
        
        const prodInv = inventario.find(i => p.producto.includes(i.nombre) || i.nombre === nombreLimpio) || { costo_proveedor: 0 };
        const costoBase = Number(prodInv.costo_proveedor || 0);

        let qty = 1;
        const match = p.producto.match(/^(\d+)x/);
        if(match) qty = parseInt(match[1]);

        const venta = parseFloat(p.total || 0);
        const comision = parseFloat(p.comision_total || 0);
        const costoTotal = costoBase * qty;
        const mensajeria = parseFloat(p.costo_mensajeria || 0);

        const gananciaBoss = venta - costoTotal - comision - mensajeria;

        // Sumatorias Generales
        netProfit += gananciaBoss;
        totalSales += venta;

        // Estad√≠sticas Producto
        if(!prodStats[nombreLimpio]) prodStats[nombreLimpio] = { qty: 0, profit: 0 };
        prodStats[nombreLimpio].qty += qty;
        prodStats[nombreLimpio].profit += gananciaBoss;

        // --- CORRECCI√ìN AQU√ç (Para que el gr√°fico funcione) ---
        const g = p.gestor || 'Directo';
        if(!gestorStats[g]) gestorStats[g] = { sales: 0, profit: 0 };
        
        gestorStats[g].sales += venta;       // Barra Azul (Volumen)
        gestorStats[g].profit += gananciaBoss; // Barra Verde (Tu Ganancia)
        // -----------------------------------------------------

        // Tendencia
        const fechaKey = new Date(p.fecha).toLocaleDateString();
        if(!trendData[fechaKey]) trendData[fechaKey] = 0;
        trendData[fechaKey] += gananciaBoss;
    });

    // Actualizar KPIs en pantalla
    document.getElementById('kpi-net-profit').innerText = `$${netProfit.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    document.getElementById('kpi-total-sales').innerText = `$${totalSales.toLocaleString()}`;
    document.getElementById('kpi-orders-count').innerText = `${orders.length} Pedidos`;
    
    const margin = totalSales > 0 ? (netProfit / totalSales) * 100 : 0;
    document.getElementById('kpi-margin').innerText = `${margin.toFixed(1)}%`;
    
    // Rankings
    const sortedProds = Object.entries(prodStats).sort(([,a], [,b]) => b.profit - a.profit);
    
    const topList = document.getElementById('list-top-products');
    topList.innerHTML = sortedProds.slice(0, 3).map(([name, data], i) => `
        <div class="flex justify-between items-center text-xs border-b border-slate-700/50 pb-2">
            <div class="flex items-center gap-2">
                <span class="font-black text-emerald-500">#${i+1}</span>
                <span class="text-slate-300 font-bold">${name}</span>
            </div>
            <div class="text-right">
                <span class="block font-black text-white">+$${data.profit.toFixed(0)}</span>
                <span class="text-[9px] text-slate-500">${data.qty} vendidos</span>
            </div>
        </div>
    `).join('') || '<p class="text-xs text-slate-500">Sin datos.</p>';

    const lowList = document.getElementById('list-low-products');
    const bottomProds = sortedProds.slice(-3).reverse();
    
    lowList.innerHTML = bottomProds.map(([name, data]) => `
        <div class="flex justify-between items-center text-xs border-b border-slate-700/50 pb-2">
            <span class="text-slate-400">${name}</span>
            <div class="text-right">
                <span class="block font-bold ${data.profit < 0 ? 'text-red-500' : 'text-amber-500'}">$${data.profit.toFixed(0)}</span>
            </div>
        </div>
    `).join('') || '<p class="text-xs text-slate-500">Sin datos.</p>';

    // Renderizar Gr√°ficos
    renderChartGestor(gestorStats);
    renderChartTrend(trendData);
}

// GR√ÅFICO 1: GESTORES
function renderChartGestor(data) {
    const ctx = document.getElementById('chartGestorPerformance').getContext('2d');
    if (window.myChart2) window.myChart2.destroy();

    // Ordenar por ganancia
    const sortedEntries = Object.entries(data).sort(([,a], [,b]) => b - a).slice(0,5);

    window.myChart2 = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: sortedEntries.map(e => e[0]),
            datasets: [{
                data: sortedEntries.map(e => e[1]),
                backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'right', labels: { color: '#94a3b8', font: {size: 10} } }
            }
        }
    });
}

// GR√ÅFICO 2: TENDENCIA DIARIA
function renderChartTrend(data) {
    const ctx = document.getElementById('chartProfitTrend').getContext('2d');
    if (window.myChart3) window.myChart3.destroy();

    const labels = Object.keys(data);
    const values = Object.values(data);

    window.myChart3 = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ganancia Diaria ($)',
                data: values,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: '#64748b', maxTicksLimit: 5 }, grid: { display: false } },
                y: { ticks: { color: '#64748b' }, grid: { color: '#334155' } }
            }
        }
    });
}

        // GR√ÅFICO 1: GESTORES (BARRAS COMPARATIVAS)
// GR√ÅFICO 1: MATRIZ DE EFICIENCIA (SCATTER PLOT)
function renderChartGestor(data) {
    const ctx = document.getElementById('chartGestorPerformance').getContext('2d');
    if (window.myChart2) window.myChart2.destroy();

    // Convertir los datos al formato X, Y (Puntos)
    // X = Ventas Totales, Y = Ganancia Real
    const puntos = Object.entries(data).map(([nombre, stats]) => ({
        x: stats.sales,
        y: stats.profit,
        gestor: nombre // Guardamos el nombre para el tooltip
    }));

    window.myChart2 = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Gestores',
                data: puntos,
                backgroundColor: 'rgba(16, 185, 129, 0.6)', // Verde transl√∫cido
                borderColor: '#10b981', // Verde s√≥lido
                borderWidth: 1,
                pointRadius: 6, // Tama√±o del punto
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const p = context.raw;
                            return `${p.gestor}: Vendi√≥ $${p.x.toLocaleString()} | Gan√≥ $${p.y.toLocaleString()}`;
                        }
                    },
                    backgroundColor: '#0f172a',
                    titleColor: '#10b981',
                    bodyColor: '#ffffff',
                    padding: 10,
                    cornerRadius: 8,
                    displayColors: false
                },
                annotation: { // Opcional: L√≠neas promedio si quisieras agregarlas luego
                    // ...
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    title: { display: true, text: 'Volumen de Ventas ($)', color: '#64748b', font: {weight: 'bold'} },
                    grid: { color: '#334155' },
                    ticks: { color: '#94a3b8' }
                },
                y: {
                    title: { display: true, text: 'Tu Ganancia Real ($)', color: '#64748b', font: {weight: 'bold'} },
                    grid: { color: '#334155' },
                    ticks: { color: '#94a3b8' }
                }
            }
        }
    });
}

        // Arrancar
        
        initMaster();

    </script>
</body>
</html>