<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Para Tu Hogar | Business Suite v5.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #020617; --card: #0f172a; --accent: #3b82f6; --text: #f8fafc; }
        body { background-color: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        .nav-tab { border-radius: 12px; transition: all 0.3s; font-size: 10px; font-weight: 800; color: #64748b; border: 1px solid transparent; }
        .nav-tab.active { background: var(--accent); color: white; box-shadow: 0 4px 20px -5px var(--accent); }
        .app-card { background: var(--card); border: 1px solid rgba(255,255,255,0.05); border-radius: 24px; }
        .glass-header { background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .category-pill { flex-shrink: 0; padding: 10px 18px; border-radius: 16px; background: #1e293b; font-size: 10px; font-weight: 800; text-transform: uppercase; color: #94a3b8; }
        .category-pill.active { border-color: #3b82f6; color: white; background: rgba(59, 130, 246, 0.2); }
        .btn-period { font-size: 9px; font-weight: 900; padding: 6px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); color: #64748b; transition: all 0.2s; }
        .btn-period.active { background: #3b82f6; border-color: #3b82f6; color: white; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .loader { width: 24px; height: 24px; border: 3px solid #3b82f6; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input, textarea { background: #1e293b !important; border: 1px solid #334155 !important; color: white !important; outline: none !important; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</head>
<body class="pb-28">

    <!-- Header -->
    <header class="glass-header sticky top-0 z-[100] px-5 py-4">
        <div class="container mx-auto space-y-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/40">
                        <i class="fas fa-rocket text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-base font-black tracking-tighter uppercase italic leading-none">Para Tu Hogar</h1>
                        <p id="gestor-label" class="text-[8px] font-black uppercase text-blue-400 mt-1 italic tracking-[0.1em]">Sincronizando...</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleCurrency()" class="bg-blue-600/10 border border-blue-500/20 px-3 py-1.5 rounded-xl text-[10px] font-black text-blue-400 uppercase">
                        <span id="currency-label">USD</span>
                    </button>
                    <button id="btn-open-gen" onclick="openGestorGen()" class="w-9 h-9 bg-white/5 rounded-xl flex items-center justify-center border border-white/10">
                        <i class="fas fa-link text-xs text-slate-400"></i>
                    </button>
                </div>
            </div>

            <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                <input type="text" id="search-bar" oninput="filterProducts()" placeholder="Buscar en el cat√°logo..." class="w-full bg-slate-900 border-none rounded-2xl py-4 pl-11 pr-4 text-xs font-bold focus:ring-2 focus:ring-blue-500">
            </div>

            <div id="category-list" class="flex gap-2 overflow-x-auto scrollbar-hide py-1">
                <button onclick="filterByCategory('TODOS')" class="category-pill active">Todos</button>
                <button onclick="filterByCategory('LAVADORAS')" class="category-pill">Lavadoras</button>
                <button onclick="filterByCategory('REFRIGERADORES')" class="category-pill">Fr√≠o</button>
                <button onclick="filterByCategory('NEVERAS')" class="category-pill">Neveras</button>
                <button onclick="filterByCategory('ENERG√çA')" class="category-pill">Energ√≠a</button>
            </div>
        </div>
    </header>

    <nav id="main-nav" class="container mx-auto px-5 mt-4 flex gap-2">
        <button onclick="showSection('catalogo')" id="tab-cat" class="nav-tab active px-5 py-3 uppercase flex-1">Cat√°logo</button>
        <button onclick="showSection('dashboard')" id="tab-dash" class="nav-tab px-5 py-3 uppercase flex-1 hidden bg-slate-900">Mi Panel</button>
    </nav>

    <main class="container mx-auto px-5 pt-6">
        <section id="sec-catalogo">
            <div id="productos" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="col-span-full py-32 text-center">
                    <span class="loader"></span>
                    <p class="text-[10px] font-black uppercase tracking-widest text-slate-500 mt-4">Actualizando Stock</p>
                </div>
            </div>
        </section>

        <section id="sec-dashboard" class="hidden space-y-6 animate-up">
            <div class="app-card p-7 bg-gradient-to-br from-blue-600/20 to-transparent border-blue-500/20 flex justify-between items-center relative overflow-hidden">
                <div>
                    <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1 italic">Profit Acumulado</p>
                    <h2 id="dash-money" class="text-4xl font-black tracking-tighter">$0.00</h2>
                </div>
                <button onclick="openGestorGen(true)" class="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center border border-white/20 z-10 active:scale-90"><i class="fas fa-cog text-xs"></i></button>
                <i class="fas fa-wallet absolute -right-4 -bottom-4 text-7xl text-white/5"></i>
            </div>

            <div class="app-card overflow-hidden">
                <div class="p-6 border-b border-white/5 flex justify-between items-center">
                    <h3 class="text-[11px] font-black uppercase italic tracking-widest text-blue-400">Ranking Elite</h3>
                    <div class="flex gap-1">
                        <button onclick="changeRankingPeriod('week')" id="p-week" class="btn-period active text-[8px]">7D</button>
                        <button onclick="changeRankingPeriod('month')" id="p-month" class="btn-period text-[8px]">MES</button>
                    </div>
                </div>
                <div id="ranking-list" class="divide-y divide-white/5"></div>
            </div>
            
            <div class="app-card p-6">
                <h3 class="text-[10px] font-black uppercase italic mb-6">Mis Art√≠culos Estrella</h3>
                <div id="top-items-list" class="space-y-3"></div>
            </div>
        </section>
    </main>

    <!-- Carrito Flotante -->
    <div onclick="toggleCartModal()" class="fixed bottom-8 right-6 bg-blue-600 text-white w-16 h-16 rounded-[24px] shadow-2xl flex items-center justify-center cursor-pointer z-[110] active:scale-90 border-2 border-white/20">
        <i class="fas fa-shopping-basket text-xl"></i>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-black w-7 h-7 rounded-xl flex items-center justify-center border-2 border-slate-950">0</span>
    </div>

    <!-- MODAL DETALLE -->
    <div id="detail-modal" class="fixed inset-0 bg-slate-950/98 backdrop-blur-xl hidden flex items-center justify-center p-2 z-[150]">
        <div class="bg-slate-900 rounded-[40px] w-full max-w-4xl max-h-[95vh] overflow-hidden flex flex-col md:flex-row shadow-2xl relative border border-white/5 animate-up">
            
            <!-- BOT√ìN CERRAR -->
            <button onclick="closeDetail()" class="absolute top-5 right-5 bg-white/10 hover:bg-white/20 text-white w-12 h-12 rounded-full z-[160] flex items-center justify-center border border-white/10 backdrop-blur-md">
                <i class="fas fa-times text-xl"></i>
            </button>

            <div class="md:w-1/2 p-4 bg-white/5 flex flex-col border-r border-white/5">
                <div class="flex-1 flex items-center justify-center bg-white rounded-[32px] p-8 mb-6 overflow-hidden">
                    <img id="detail-main-img" src="" class="max-w-full max-h-72 object-contain transition-all duration-700">
                </div>
                <div id="detail-thumbnails" class="flex gap-3 overflow-x-auto pb-4 scrollbar-hide justify-center px-4"></div>
            </div>

            <div class="md:w-1/2 p-8 md:p-12 flex flex-col overflow-y-auto">
                <div class="flex justify-between items-start mb-4">
                    <span id="detail-cat" class="text-blue-500 font-black text-[9px] uppercase tracking-[0.3em]"></span>
                    <button onclick="generateShareText()" class="bg-emerald-500/10 text-emerald-400 px-3 py-1.5 rounded-xl text-[9px] font-black uppercase border border-emerald-500/20"><i class="fas fa-share-nodes mr-1"></i> Oferta</button>
                </div>
                <h2 id="detail-name" class="text-2xl md:text-3xl font-black mb-5 uppercase italic tracking-tighter"></h2>
                
                <div class="flex items-center gap-5 mb-8">
                    <span id="detail-price" class="text-4xl font-black text-white"></span>
                    <span id="detail-price-cup" class="text-sm font-bold text-slate-500 italic"></span>
                    <div id="detail-admin-comm" class="hidden bg-emerald-500 text-white px-3 py-1.5 rounded-xl font-black text-[10px] uppercase border-2 border-emerald-400 ml-auto"></div>
                </div>

                <div id="detail-warranty" class="mb-8 bg-blue-500/10 px-4 py-2 rounded-2xl text-[10px] font-black text-blue-400 border border-blue-500/20 uppercase italic self-start"></div>
                
                <div class="flex-1 border-y border-white/5 py-8 my-4 overflow-y-auto">
                    <p id="detail-desc" class="text-slate-400 text-sm leading-relaxed whitespace-pre-line"></p>
                </div>

                <div class="mt-6 space-y-4">
                    <div class="flex items-center justify-between bg-white/5 p-2 rounded-2xl border border-white/5">
                        <span class="font-black text-[10px] uppercase text-slate-500 ml-4 italic">Cantidad</span>
                        <div class="flex items-center bg-slate-800 rounded-2xl border border-white/5">
                            <button onclick="updateQty(-1)" class="w-12 h-12 hover:bg-slate-700 font-black text-blue-400 text-xl">-</button>
                            <input type="number" id="detail-qty" value="1" min="1" class="w-10 text-center font-black bg-transparent border-none text-lg">
                            <button onclick="updateQty(1)" class="w-12 h-12 hover:bg-slate-700 font-black text-blue-400 text-xl">+</button>
                        </div>
                    </div>
                    <button onclick="addItemToCart()" class="w-full bg-blue-600 py-5 rounded-[22px] font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all">Agregar a la orden</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CARRITO -->
    <div id="cart-modal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-2xl hidden flex items-center justify-end z-[160]">
        <div class="bg-slate-900 w-full max-w-md h-full shadow-2xl flex flex-col border-l border-white/10 p-7">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-xs font-black uppercase italic tracking-[0.2em] text-blue-500">Mi Carrito</h2>
                <button onclick="toggleCartModal()" class="text-2xl text-slate-600">&times;</button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto space-y-5 mb-8 scrollbar-hide"></div>
            <div class="space-y-4 mb-8">
                <div class="flex justify-between text-2xl font-black text-white border-t border-white/10 pt-5 uppercase italic"><span>TOTAL:</span> <span id="cart-total"></span></div>
            </div>
            <form id="checkout-form" class="space-y-4">
                <input type="text" id="check-nombre" placeholder="Nombre completo" class="w-full p-4 rounded-2xl border-none text-sm font-bold" required>
                <div class="flex gap-4">
                    <input type="text" id="check-ci" placeholder="CI" class="w-full p-4 rounded-2xl border-none text-sm font-bold" required>
                    <input type="tel" id="check-tel" placeholder="Tel√©fono" class="w-full p-4 rounded-2xl border-none text-sm font-bold" required>
                </div>
                <textarea id="check-dir" placeholder="Direcci√≥n exacta..." class="w-full p-4 rounded-2xl border-none text-sm font-bold h-20" required></textarea>
                <button type="submit" id="final-submit-btn" class="w-full bg-emerald-600 text-white py-5 rounded-[22px] font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all mt-4">Tramitar Pedido</button>
            </form>
        </div>
    </div>

    <!-- MODAL GESTOR -->
    <div id="gestor-modal" class="fixed inset-0 bg-slate-950/98 backdrop-blur-2xl hidden flex items-center justify-center p-6 z-[200]">
        <div class="app-card w-full max-w-md p-8 border-blue-500/20 shadow-2xl">
            <h2 id="gen-title" class="text-xl font-black mb-4 uppercase italic text-blue-400">Zona Gestores</h2>
            <div class="space-y-4">
                <div id="pass-field"><input type="password" id="master-pass" class="w-full p-4 rounded-2xl border-none font-bold text-sm" placeholder="C√≥digo Maestro"></div>
                <input type="text" id="gen-name" class="w-full p-4 rounded-2xl border-none font-bold text-sm" placeholder="Tu Nombre">
                <input type="tel" id="gen-tel" class="w-full p-4 rounded-2xl border-none font-bold text-sm" placeholder="WhatsApp">
                <button onclick="processGestor()" class="w-full bg-blue-600 py-4.5 rounded-2xl font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all">Vincular</button>
            </div>
            <div id="links-result" class="hidden mt-8 space-y-4 border-t border-white/5 pt-6 animate-in slide-in-from-bottom">
                <div class="p-4 bg-blue-500/10 rounded-2xl border border-blue-500/20">
                    <p class="text-[8px] font-black text-blue-400 uppercase mb-2">Mi Panel (Privado)</p>
                    <input type="text" id="link-admin" readonly class="w-full text-[9px] p-2 bg-slate-950 rounded border-none mb-2 font-mono">
                    <button onclick="copy('link-admin')" class="text-[9px] font-black text-blue-500 uppercase tracking-widest">COPIAR LINK</button>
                </div>
                <div class="p-4 bg-slate-800 rounded-2xl">
                    <p class="text-[8px] font-black text-slate-500 uppercase mb-2">Enlace Clientes (P√∫blico)</p>
                    <input type="text" id="link-client" readonly class="w-full text-[9px] p-2 bg-slate-950 rounded border-none mb-2 font-mono">
                    <button onclick="copy('link-client')" class="text-[9px] font-black text-white uppercase tracking-widest">COPIAR LINK</button>
                </div>
            </div>
            <button onclick="closeGestorGen()" class="w-full mt-6 text-[10px] font-bold text-slate-600 uppercase">Regresar</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxQcNJatefVl1a46zXAOj9vxDAQQ4wgMp60eo2cgfpoyW-am-MypROpLBB9LqBt4maIdg/exec';
        const MASTER_KEY = "HOGAR2025"; 
        
        let productosRaw = [], cart = [], selectedProduct = null;
        let cupRate = 470, showInCUP = false, activeCategory = 'TODOS', currentPeriod = 'week';

        const urlParams = new URLSearchParams(window.location.search);
        const gestorName = urlParams.get('gestor'), gestorTel = urlParams.get('tel'), isAdmin = urlParams.get('admin') === 'true';

        window.addEventListener('load', () => {
            if (gestorName) {
                document.getElementById('gestor-label').innerText = `Agente: ${gestorName.toUpperCase()}`;
                if (isAdmin) {
                    document.getElementById('tab-dash').classList.remove('hidden');
                    document.getElementById('btn-open-gen').classList.add('hidden');
                }
            } else { document.getElementById('gestor-label').innerText = "Cat√°logo P√∫blico"; }
            loadProducts();
        });

        // FUNCIONES CORE
        async function loadProducts() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                productosRaw = data.productos;
                cupRate = data.tasa || 470;
                renderProducts();
            } catch (e) { alert("Error al conectar con inventario"); }
        }

        function renderProducts() {
            const query = document.getElementById('search-bar').value.toLowerCase();
            const container = document.getElementById('productos');
            const filtered = productosRaw.filter(p => {
                const matchSearch = p.Nombre.toLowerCase().includes(query) || p.Categoria.toLowerCase().includes(query);
                const matchCat = activeCategory === 'TODOS' || p.Categoria.toUpperCase().includes(activeCategory.toUpperCase());
                return matchSearch && matchCat && p.Disponible.toString().toUpperCase() === "SI";
            });

            container.innerHTML = filtered.map(p => {
                const price = parseFloat(p.Precio);
                const pDisplay = showInCUP ? `CUP ${Math.round(price * cupRate).toLocaleString()}` : `$${price}`;
                return `
                <div onclick="openDetail('${p.Nombre}')" class="app-card overflow-hidden cursor-pointer group flex flex-col transition-all active:scale-[0.97]">
                    <div class="h-48 bg-white relative p-10 flex items-center justify-center">
                        <img src="${fixDriveUrl(p.Thumbnail)}" loading="lazy" class="max-w-full max-h-full object-contain group-hover:scale-110 transition-all duration-1000">
                        <span class="absolute top-5 left-5 text-[8px] font-black bg-blue-600 text-white px-3 py-1.5 rounded-xl uppercase tracking-tighter shadow-lg">${p.Categoria}</span>
                    </div>
                    <div class="p-7 flex flex-col flex-1 bg-slate-900/50 border-t border-white/5">
                        <h3 class="text-[12px] font-black uppercase italic mb-4 leading-snug line-clamp-2 text-slate-200">${p.Nombre}</h3>
                        <div class="flex justify-between items-end mt-auto">
                            <div><p class="text-3xl font-black tracking-tighter text-blue-500 leading-none">${pDisplay}</p>
                            ${isAdmin ? `<p class="text-[9px] font-black text-emerald-500 mt-2 uppercase italic border-l-2 border-emerald-500 pl-2">Profit: $${p.Comision}</p>` : ''}</div>
                            <div class="text-[7px] font-black text-slate-600 uppercase italic text-right leading-none">GARANT√çA<br><span class="text-slate-400 text-[8px]">${p.Garant√≠a || 'S/G'}</span></div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function openDetail(name) {
            selectedProduct = productosRaw.find(p => p.Nombre === name);
            const p = selectedProduct;

            // TRACKING
            fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: "view", producto: name, gestor: gestorName || "Directo" })});

            // DATA BINDING
            document.getElementById('detail-name').innerText = p.Nombre;
            document.getElementById('detail-desc').innerText = p.Descripcion;
            document.getElementById('detail-price').innerText = `$${p.Precio}`;
            document.getElementById('detail-price-cup').innerText = `/ CUP ${Math.round(p.Precio * cupRate).toLocaleString()}`;
            document.getElementById('detail-cat').innerText = p.Categoria;
            document.getElementById('detail-warranty').innerHTML = `<i class="fas fa-shield-alt mr-2"></i> Garant√≠a: ${p.Garant√≠a}`;
            document.getElementById('detail-main-img').src = fixDriveUrl(p.Thumbnail);
            document.getElementById('detail-qty').value = 1;
            
            const box = document.getElementById('detail-admin-comm');
            if(isAdmin) { box.innerText = `GANAS: $${p.Comision}`; box.classList.remove('hidden'); } else { box.classList.add('hidden'); }

            const thumbs = [p.Thumbnail, p.Image1, p.Image2, p.Image3].filter(url => url && url.length > 5);
            document.getElementById('detail-thumbnails').innerHTML = thumbs.map(url => `<img src="${fixDriveUrl(url)}" onclick="document.getElementById('detail-main-img').src=this.src" class="w-16 h-16 object-contain rounded-2xl border-2 border-white/5 bg-white p-2 cursor-pointer transition-all hover:border-blue-500">`).join('');

            document.getElementById('detail-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // HELPERS UI
        function closeDetail() { document.getElementById('detail-modal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
        function toggleCurrency() { showInCUP = !showInCUP; document.getElementById('currency-label').innerText = showInCUP ? 'CUP' : 'USD'; renderProducts(); }
        function filterByCategory(cat) { activeCategory = cat; document.querySelectorAll('.category-pill').forEach(b => b.classList.toggle('active', b.innerText.toUpperCase().includes(cat.toUpperCase()) || (cat === 'TODOS' && b.innerText === 'Todos'))); renderProducts(); }
        function filterProducts() { renderProducts(); }
        function updateQty(val) { const i = document.getElementById('detail-qty'); let v = parseInt(i.value) + val; i.value = v < 1 ? 1 : v; }
        function showSection(s) { document.getElementById('sec-catalogo').classList.toggle('hidden', s!=='catalogo'); document.getElementById('sec-dashboard').classList.toggle('hidden', s!=='dashboard'); document.getElementById('tab-cat').classList.toggle('active', s==='catalogo'); document.getElementById('tab-dash').classList.toggle('active', s==='dashboard'); if(s==='dashboard') loadFullDashboard(); }
        
        // CARRITO
        function addItemToCart() {
            const qty = parseInt(document.getElementById('detail-qty').value);
            const existing = cart.find(item => item.Nombre === selectedProduct.Nombre);
            if(existing) existing.qty += qty; else cart.push({...selectedProduct, qty: qty});
            updateCartCount(); closeDetail(); toggleCartModal(true);
        }
        function updateCartCount() { document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0); }
        function toggleCartModal(forceOpen = false) { const m = document.getElementById('cart-modal'); if(forceOpen) m.classList.remove('hidden'); else m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) renderCart(); }
        function renderCart() {
            const container = document.getElementById('cart-items');
            if(cart.length === 0) { container.innerHTML = `<p class="text-center py-20 text-slate-700 font-black uppercase text-[10px]">Vac√≠o</p>`; updateTotals(0); return; }
            container.innerHTML = cart.map((item, index) => `<div class="flex gap-4 bg-white/5 p-4 rounded-2xl border border-white/5 relative"><img src="${fixDriveUrl(item.Thumbnail)}" class="w-12 h-12 object-contain rounded-xl bg-white p-1"><div class="flex-1"><h4 class="text-[9px] font-black uppercase italic leading-tight pr-6">${item.Nombre}</h4><p class="text-lg font-black text-blue-500 mt-1">$${item.qty * item.Precio}</p></div><button onclick="removeFromCart(${index})" class="absolute top-4 right-4 text-slate-600 transition-all hover:text-red-500"><i class="fas fa-trash-alt text-xs"></i></button></div>`).join('');
            const sub = cart.reduce((acc, item) => acc + (item.Precio * item.qty), 0);
            updateTotals(sub);
        }
        function updateTotals(sub) { document.getElementById('cart-total').innerText = `$${sub.toFixed(2)}`; }
        function removeFromCart(index) { cart.splice(index, 1); updateCartCount(); renderCart(); }

        // DASHBOARD
        async function loadFullDashboard() {
            try {
                const [sResp, rResp] = await Promise.all([
                    fetch(`${API_URL}?action=getStats&gestor=${encodeURIComponent(gestorName)}`),
                    fetch(`${API_URL}?action=getRanking&gestor=${encodeURIComponent(gestorName)}&period=${currentPeriod}`)
                ]);
                const stats = await sResp.json(), ranking = await rResp.json();
                renderEliteDashboard(stats, ranking);
            } catch (e) { }
        }

        function renderEliteDashboard(stats, ranking) {
            const entregados = stats.filter(d => d.Estado === "Entregado");
            let itemCounts = {}, totalUnits = 0;
            stats.forEach(s => {
                s.Producto.toString().split(', ').forEach(p => {
                    const match = p.match(/(\d+)x (.*)/);
                    if(match) { itemCounts[match[2]] = (itemCounts[match[2]] || 0) + parseInt(match[1]); totalUnits += parseInt(match[1]); }
                });
            });

            document.getElementById('dash-money').innerText = `$${entregados.reduce((a, c) => a + (parseFloat(c.Comisi√≥n) || 0), 0).toFixed(2)}`;
            document.getElementById('dash-ok').innerText = entregados.length;
            document.getElementById('dash-units').innerText = totalUnits;
            document.getElementById('ranking-list').innerHTML = ranking.slice(0, 10).map((r, i) => `
                <div class="flex items-center justify-between p-6 ${r.isMe ? 'bg-blue-600/10 border-l-4 border-l-blue-500' : ''}">
                    <div class="flex items-center gap-5"><span class="text-[12px] font-black text-slate-700 w-4">#${i+1}</span>
                    <div><p class="text-[11px] font-black uppercase italic ${r.isMe ? 'text-blue-400' : 'text-slate-300'}">${r.name}</p><p class="text-[9px] text-slate-500 font-bold uppercase mt-1 tracking-widest">${r.units} unidades</p></div></div>
                    <p class="text-sm font-black tracking-tighter text-slate-100">$${r.sales.toFixed(0)}</p></div>`).join('');
            
            const topSorted = Object.entries(itemCounts).sort((a,b) => b[1] - a[1]);
            document.getElementById('top-items-list').innerHTML = topSorted.map(([name, qty]) => `
                <div class="flex justify-between items-center bg-white/5 p-4 rounded-2xl border border-white/5">
                    <p class="text-[10px] font-black text-slate-400 uppercase leading-tight italic">${name}</p>
                    <span class="text-xs font-black text-blue-500 bg-blue-500/10 px-3 py-1 rounded-lg">${qty}</span></div>`).join('');
        }

        // CHECKOUT
        document.getElementById('checkout-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('final-submit-btn');
            btn.disabled = true; btn.innerHTML = `Sincronizando...`;

            let eqTotal = 0, mTotal = 0, cTotal = 0;
            let pList = cart.map(item => {
                eqTotal += (item.Precio * item.qty);
                mTotal += (parseFloat(item.Mensajeria) || 0);
                cTotal += ((parseFloat(item.Comision) || 0) * item.qty);
                return `${item.qty}x ${item.Nombre}`;
            }).join(', ');

            const datos = {
                gestor: gestorName || "Venta Directa",
                cliente: document.getElementById('check-nombre').value,
                ci: document.getElementById('check-ci').value,
                telefono: document.getElementById('check-tel').value,
                direccion: document.getElementById('check-dir').value,
                producto: pList,
                total: eqTotal + mTotal,
                comision: gestorName ? cTotal : 0
            };

            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(datos) });
                const lineComm = gestorName ? `üí™üèªComisi√≥n: ${cTotal}%0A` : "";
                const text = `*ORDEN DE PEDIDO - PARA TU HOGAR*%0A%0Aüí™üèªNombre: ${datos.cliente}%0Aüí™üèªCI: ${datos.ci}%0Aüí™üèªTel: ${datos.telefono}%0Aüí™üèªDirecci√≥n: ${datos.direccion}%0A%0Aüí™üèªProducto: ${pList}%0Aüí™üèªTotal a Pagar: ${datos.total}%0A-Precio equipo: ${eqTotal}%0A-Mensajer√≠a: ${mTotal}%0A%0Aüí™üèªVuelto: ${document.getElementById('check-vuelto')?.value || "No requerido"}%0A${lineComm}üí™üèªGestor: ${gestorName || 'Directo'}%0A‚òé(${gestorTel || ''})`;
                setTimeout(() => { window.open(`https://wa.me/5356071095?text=${text}`, '_blank'); location.reload(); }, 500);
            } catch (error) { alert("Error de enlace"); btn.disabled = false; }
        };

        // GESTOR GEN
        function processGestor() {
            const pass = document.getElementById('master-pass').value;
            const name = document.getElementById('gen-name').value.trim();
            const tel = document.getElementById('gen-tel').value.trim();
            const isEditing = document.getElementById('pass-field').classList.contains('hidden');
            if(!isEditing && pass !== MASTER_KEY) return alert("C√≥digo Maestro Inv√°lido");
            if(!name || !tel) return alert("Faltan datos");
            const baseUrl = window.location.origin + window.location.pathname;
            document.getElementById('link-admin').value = `${baseUrl}?gestor=${encodeURIComponent(name)}&tel=${tel}&admin=true`;
            document.getElementById('link-client').value = `${baseUrl}?gestor=${encodeURIComponent(name)}&tel=${tel}`;
            document.getElementById('links-result').classList.remove('hidden');
        }

        // UTILIDADES
        function changeRankingPeriod(p) { currentPeriod = p; document.querySelectorAll('.btn-period').forEach(b => b.classList.remove('active')); document.getElementById('p-'+p).classList.add('active'); loadFullDashboard(); }
        function openGestorGen(isEditing = false) { document.getElementById('gestor-modal').classList.remove('hidden'); if(isEditing) { document.getElementById('gen-title').innerText = "Editar Credenciales"; document.getElementById('pass-field').classList.add('hidden'); } }
        function closeGestorGen() { document.getElementById('gestor-modal').classList.add('hidden'); }
        function generateShareText() {
            const p = selectedProduct;
            const text = `*üî• OFERTA: PARA TU HOGAR*\n\nüì¶ *${p.Nombre}*\nüí∞ Precio: $${p.Precio} USD / CUP ${Math.round(p.Precio * cupRate).toLocaleString()}\nüõ°Ô∏è Garant√≠a: ${p.Garant√≠a}\nüöõ Env√≠o: ${p.Mensajeria}\n\nüì≤ *Pedidos:* wa.me/${gestorTel || '56071095'}`;
            navigator.clipboard.writeText(text).then(() => alert("Copiado!"));
        }
        function copy(id) { const el = document.getElementById(id); el.select(); document.execCommand('copy'); alert("Link Copiado!"); }
        function fixDriveUrl(url) { if (!url) return ''; const id = url.includes('/d/') ? url.split('/d/')[1]?.split('/')[0] : (url.includes('id=') ? url.split('id=')[1] : url); return id && id.length > 15 ? `https://lh3.googleusercontent.com/u/0/d/${id}` : url; }
    </script>
</body>
</html>
