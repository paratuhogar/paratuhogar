<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>paratuhogar | Electrodom√©sticos para Cuba</title>
    
    <!-- Fuentes y Estilos Externos -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#33ccc4",
                        "background-light": "#fafaf9",
                        "background-dark": "#1e2024",
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>

    <style>
        body { font-family: 'Manrope', sans-serif; -webkit-font-smoothing: antialiased; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .category-tab.active { border-bottom: 3px solid #33ccc4; color: #33ccc4; }
        .loader { width: 40px; height: 40px; border: 4px solid #33ccc4; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</head>

<body class="bg-background-light dark:bg-background-dark text-[#121717] dark:text-gray-100">

    <!-- Header / Navbar -->
    <header class="sticky top-0 z-50 w-full border-b border-[#e5e7eb] dark:border-gray-800 bg-white/80 dark:bg-background-dark/80 backdrop-blur-md px-4 md:px-10 lg:px-20 py-3">
        <div class="max-w-[1200px] mx-auto flex items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-3xl text-primary">home_iot_device</span>
                    <h1 class="text-xl font-extrabold tracking-tight">para<span class="text-primary">tuhogar</span></h1>
                </div>
                <div class="hidden md:flex items-center bg-gray-100 dark:bg-gray-800 rounded-lg px-3 py-1.5 border border-gray-200 dark:border-gray-700">
                    <span class="material-symbols-outlined text-gray-400 text-sm">search</span>
                    <input id="search-bar" oninput="filterProducts()" type="text" placeholder="Buscar equipo..." class="bg-transparent border-none focus:ring-0 text-sm w-64">
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="toggleCurrency()" class="text-xs font-bold px-3 py-1.5 rounded-full bg-primary/10 text-primary border border-primary/20">
                    <span id="currency-label">USD</span>
                </button>
                <button onclick="toggleCartModal(true)" class="relative p-2 bg-primary/10 text-primary rounded-full">
                    <span class="material-symbols-outlined">shopping_cart</span>
                    <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center">0</span>
                </button>
                <button id="btn-open-gen" onclick="openGestorGen()" class="p-2 text-gray-400">
    <span class="material-symbols-outlined">settings</span>
</button>
                <p id="gestor-label" class="hidden lg:block text-[10px] font-bold uppercase tracking-widest text-primary"></p>
            </div>
        </div>
    </header>

    <main class="max-w-[1200px] mx-auto pb-20">
        
        <!-- 1. NAVEGACI√ìN ADMIN (Fuera de los contenedores para que nunca desaparezca) -->
        <nav id="admin-nav" class="hidden px-6 max-w-[1200px] mx-auto mt-4 flex gap-2">
            <button onclick="showSection('catalogo')" id="tab-cat" class="flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-primary text-white">Cat√°logo</button>
            <button onclick="showSection('dashboard')" id="tab-dash" class="flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-gray-100 text-gray-400">Mi Dashboard</button>
        </nav>

        <!-- 2. CONTENEDOR DEL CAT√ÅLOGO (Solo envuelve cosas del cat√°logo) -->
        <div id="sec-catalogo">
            <!-- Hero Section -->
            <section class="px-6 py-10 lg:py-16">
                <div class="max-w-2xl">
                    <h2 class="text-4xl lg:text-5xl font-black leading-tight mb-4">Equipos para tu familia en Cuba</h2>
                    <p class="text-gray-500 dark:text-gray-400 text-lg">Cat√°logo optimizado. Ordena por WhatsApp y paga al recibir en la puerta de tu casa.</p>
                    <div class="flex gap-3 mt-6">
                        <span class="flex items-center gap-1.5 px-3 py-1 bg-primary/10 text-primary rounded-full text-xs font-bold"><span class="material-symbols-outlined text-sm">bolt</span> Entrega 24-48h</span>
                        <span class="flex items-center gap-1.5 px-3 py-1 bg-primary/10 text-primary rounded-full text-xs font-bold"><span class="material-symbols-outlined text-sm">verified_user</span> Garant√≠a Real</span>
                    </div>
                </div>
            </section>

            <!-- Category Tabs (Sticky) -->
            <div class="sticky top-[65px] z-40 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur shadow-sm border-b border-gray-200 dark:border-gray-800">
                <div id="category-list" class="flex gap-8 px-6 overflow-x-auto whitespace-nowrap scrollbar-hide">
                    <button onclick="filterByCategory('TODOS')" class="category-tab active py-4 text-sm font-bold transition-all">Todos</button>
                    <button onclick="filterByCategory('REFRIGERACI√ìN')" class="category-tab py-4 text-sm font-bold text-gray-400 hover:text-primary transition-all">Refrigeraci√≥n</button>
                    <button onclick="filterByCategory('COCINA')" class="category-tab py-4 text-sm font-bold text-gray-400 hover:text-primary transition-all">Cocina</button>
                    <button onclick="filterByCategory('LAVADO')" class="category-tab py-4 text-sm font-bold text-gray-400 hover:text-primary transition-all">Lavado</button>
                    <button onclick="filterByCategory('CLIMATIZACI√ìN')" class="category-tab py-4 text-sm font-bold text-gray-400 hover:text-primary transition-all">Climatizaci√≥n</button>
                    <button onclick="filterByCategory('ENERG√çA')" class="category-tab py-4 text-sm font-bold text-gray-400 hover:text-primary transition-all">Energ√≠a</button>
                </div>
            </div>

            <!-- Product Grid -->
            <section id="productos-container" class="px-6 py-8 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 lg:gap-8">
                <div class="col-span-full py-20 text-center"><span class="loader"></span></div>
            </section>
        </div> <!-- FIN sec-catalogo -->

        <!-- 3. SECCI√ìN DASHBOARD (Independiente) -->
        <section id="sec-dashboard" class="hidden px-6 py-8 space-y-6">
            <div class="bg-primary p-8 rounded-3xl text-white shadow-xl shadow-primary/20 relative overflow-hidden">
                <p class="text-[10px] font-black uppercase opacity-80 mb-1 italic">Comisiones Acumuladas</p>
                <h2 id="dash-money" class="text-4xl font-black italic">$0.00</h2>
                <span class="material-symbols-outlined absolute -right-4 -bottom-4 text-8xl opacity-10">payments</span>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-2xl border border-gray-100 dark:bg-gray-800">
                    <p class="text-[9px] font-black text-gray-400 uppercase">Pedidos Entregados</p>
                    <p id="dash-ok" class="text-2xl font-black text-primary">0</p>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-gray-100 dark:bg-gray-800">
                    <p class="text-[9px] font-black text-gray-400 uppercase">Pedidos Pendientes</p>
                    <p id="dash-pending" class="text-2xl font-black text-orange-500">0</p>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-700 overflow-hidden">
                <div class="p-6 border-b border-gray-50 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-xs font-black uppercase tracking-widest text-gray-500">Ranking de Agentes</h3>
                </div>
                <div id="ranking-list" class="divide-y divide-gray-50 dark:divide-gray-700"></div>
            </div>
        </section>

    </main>

    <!-- MODAL DETALLE (ESTILO IMAGEN) -->
    <div id="detail-modal" class="fixed inset-0 z-[100] hidden bg-black/60 backdrop-blur-sm p-2 md:p-4 overflow-y-auto flex justify-center items-start md:items-center">
        <div class="bg-white dark:bg-background-dark w-full max-w-6xl rounded-3xl overflow-hidden shadow-2xl flex flex-col lg:flex-row relative">
            <button onclick="closeDetail()" class="absolute top-4 right-4 z-10 p-2 bg-gray-100 dark:bg-gray-800 rounded-full hover:rotate-90 transition-transform">
                <span class="material-symbols-outlined">close</span>
            </button>

            <!-- Imagen Izquierda -->
            <div class="lg:w-1/2 bg-white flex flex-col items-center border-r border-gray-100 dark:border-gray-800">
                <div class="w-full p-4 flex items-center justify-center bg-white min-h-[300px] max-h-[500px]">
                    <img id="detail-main-img" src="" class="w-full h-full object-contain">
                </div>
                <div id="detail-thumbnails" class="flex gap-2 overflow-x-auto scrollbar-hide px-4 pb-4"></div>
                <p class="mb-4 text-[10px] text-gray-400 flex items-center gap-1 uppercase tracking-widest px-4 text-center">
                    <span class="material-symbols-outlined text-sm">info</span> Imagen real del equipo en almac√©n
                </p>
            </div>

            <!-- Info Derecha -->
            <div class="lg:w-1/2 p-8 lg:p-12 flex flex-col">
                <div class="flex items-center gap-3 mb-2">
                    <span class="bg-primary/10 text-primary px-2.5 py-1 rounded-full text-[10px] font-black uppercase">En Stock</span>
                    <span id="detail-cat" class="text-[10px] text-gray-400 font-bold uppercase"></span>
                </div>
                <h2 id="detail-name" class="text-3xl font-black mb-4"></h2>
                
                <div class="flex items-baseline gap-4 mb-8">
                    <span id="detail-price" class="text-4xl font-black text-primary"></span>
                    <span id="detail-price-cup" class="text-lg text-gray-400"></span>
                </div>

                <!-- Specs Grid -->
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-700">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Garant√≠a</p>
                        <p id="detail-warranty" class="font-bold text-sm"></p>
                    </div>
                    <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-700">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Mensajer√≠a</p>
                        <p id="detail-shipping" class="font-bold text-sm"></p>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xs font-black uppercase text-gray-400 mb-3 tracking-widest">Descripci√≥n</h3>
                    <p id="detail-desc" class="text-sm leading-relaxed text-gray-600 dark:text-gray-400"></p>
                </div>

                <!-- WhatsApp Actions -->
                <div class="mt-auto space-y-3">
                    <button onclick="addItemToCart()" class="w-full bg-[#25D366] hover:bg-[#20bd5c] text-white py-4 rounded-xl font-black text-lg flex items-center justify-center gap-3 transition-all">
                        <i class="fab fa-whatsapp text-2xl"></i> Comprar por WhatsApp
                    </button>
                    <button onclick="copyOffer()" class="w-full py-3 rounded-xl border border-gray-200 dark:border-gray-700 text-sm font-bold flex items-center justify-center gap-2 hover:bg-gray-50">
                        <span class="material-symbols-outlined text-lg">content_copy</span> Copiar descripci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CARRITO / FORMULARIO -->
    <div id="cart-modal" class="fixed inset-0 z-[110] hidden bg-black/80 flex justify-end">
        <div class="bg-white dark:bg-background-dark w-full max-w-md h-full shadow-2xl flex flex-col p-6 animate-slide-left">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-black uppercase italic text-primary">Mi Pedido</h2>
                <button onclick="toggleCartModal(false)" class="p-2 bg-gray-100 rounded-full"><span class="material-symbols-outlined">close</span></button>
            </div>
            
            <div id="cart-items" class="flex-1 overflow-y-auto space-y-4 mb-6 scrollbar-hide"></div>

            <div class="border-t pt-6 mb-6">
                <div class="flex justify-between items-end mb-4">
                    <span class="text-gray-400 font-bold uppercase text-xs">Total a Pagar</span>
                    <div class="text-right">
                        <p id="cart-total" class="text-gray-400 text-xs line-through">$0.00</p>
                        <p id="total-convertido" class="text-3xl font-black text-primary">$0.00</p>
                    </div>
                </div>

                <form id="checkout-form" class="space-y-4">
                    <input type="text" id="check-nombre" placeholder="Nombre completo" class="w-full rounded-xl border-gray-200 dark:bg-gray-800 dark:border-gray-700" required>
                    <div class="flex gap-2">
                        <input type="text" id="check-ci" placeholder="Carnet (CI)" class="w-full rounded-xl border-gray-200 dark:bg-gray-800 dark:border-gray-700" required>
                        <input type="tel" id="check-tel" placeholder="Tel√©fono" class="w-full rounded-xl border-gray-200 dark:bg-gray-800 dark:border-gray-700" required>
                    </div>
                    <textarea id="check-dir" placeholder="Direcci√≥n de entrega" class="w-full rounded-xl border-gray-200 dark:bg-gray-800 dark:border-gray-700 h-20" required></textarea>
                    
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl space-y-3">
                        <div>
                            <label class="text-[10px] font-black uppercase text-gray-400">M√©todo de Pago</label>
                            <select id="check-moneda" class="w-full bg-transparent border-none font-bold text-sm p-0 focus:ring-0"></select>
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-gray-400">Vuelto (Monto exacto)</label>
                            <input type="number" id="check-vuelto" placeholder="Ej: 50" class="w-full bg-transparent border-none font-bold text-sm p-0 focus:ring-0">
                        </div>
                    </div>

                    <button type="submit" id="final-submit-btn" class="w-full bg-primary text-white py-4 rounded-xl font-black uppercase tracking-widest shadow-lg shadow-primary/20 transition-all active:scale-95">Tramitar Pedido</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL GESTORES ACTUALIZADO CON ACCESO MASTER -->
<div id="gestor-modal" class="fixed inset-0 z-[200] hidden bg-black/90 p-6 flex items-center justify-center">
    <div class="bg-white dark:bg-background-dark w-full max-w-sm rounded-3xl p-8 space-y-4">
        <h2 class="text-xl font-black uppercase text-primary text-center">Zona de Agentes</h2>
        <input type="password" id="master-pass" placeholder="C√≥digo Maestro" class="w-full rounded-xl border-gray-200">
        <input type="text" id="gen-name" placeholder="Tu Nombre" class="w-full rounded-xl border-gray-200">
        <input type="tel" id="gen-tel" placeholder="WhatsApp" class="w-full rounded-xl border-gray-200">
        <button onclick="processGestor()" class="w-full bg-primary text-white py-3 rounded-xl font-bold uppercase italic">Generar Enlaces</button>
        
        <div id="links-result" class="hidden space-y-4 pt-4 border-t border-gray-100">
            <!-- Link Privado -->
            <div>
                <p class="text-[9px] font-black text-red-500 uppercase mb-1">‚óè Mi Panel Privado (Solo para ti)</p>
                <input type="text" id="link-admin" readonly class="w-full text-[10px] bg-gray-100 p-2 rounded border-none">
                <button onclick="copy('link-admin')" class="text-[10px] font-bold text-primary mt-1">COPIAR LINK PRIVADO</button>
            </div>
            <!-- Link P√∫blico -->
            <div>
                <p class="text-[9px] font-black text-gray-400 uppercase mb-1">‚óè Link P√∫blico (Para enviar a clientes)</p>
                <input type="text" id="link-client" readonly class="w-full text-[10px] bg-gray-100 p-2 rounded border-none">
                <button onclick="copy('link-client')" class="text-[10px] font-bold text-primary mt-1">COPIAR LINK CLIENTE</button>
            </div>
        </div>

        <!-- SECCI√ìN DE CIERRE Y ACCESO SECRETO -->
        <div class="flex flex-col gap-2 pt-4 border-t border-gray-100">
            <button onclick="closeGestorGen()" class="w-full text-gray-400 text-[10px] font-black uppercase tracking-widest">Cerrar Ventana</button>
            
            <!-- BOT√ìN SECRETO PARA EL DUE√ëO -->
            <button onclick="openAdminMasterFromGestor()" class="w-full text-primary/30 hover:text-primary text-[8px] font-black uppercase tracking-[0.2em] mt-4 transition-all">
                ‚óè Acceso Administraci√≥n Central
            </button>
        </div>
    </div>
</div>

    <!-- Footer -->
    <footer class="bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 py-12 px-6">
        <div class="max-w-[1200px] mx-auto grid grid-cols-1 md:grid-cols-4 gap-8">
            <div class="col-span-1 md:col-span-1">
                <div class="flex items-center gap-2 mb-4">
                    <span class="material-symbols-outlined text-3xl text-primary">home_iot_device</span>
                    <h1 class="text-lg font-extrabold tracking-tight italic">para<span class="text-primary">tuhogar</span></h1>
                </div>
                <p class="text-gray-500 text-sm">Calidad y confort para tu hogar en Cuba. Paga seguro al recibir.</p>
            </div>
            <div>
                <h4 class="font-bold text-xs uppercase tracking-widest mb-4 text-primary">Categor√≠as</h4>
                <ul class="text-sm space-y-2 text-gray-500">
                    <li><a href="#" class="hover:text-primary">Refrigeraci√≥n</a></li>
                    <li><a href="#" class="hover:text-primary">Cocina</a></li>
                    <li><a href="#" class="hover:text-primary">Lavado</a></li>
                </ul>
            </div>
            <div>
                <h4 class="font-bold text-xs uppercase tracking-widest mb-4 text-primary">Ayuda</h4>
                <ul class="text-sm space-y-2 text-gray-500">
                    <li><a href="#" class="hover:text-primary">Garant√≠a</a></li>
                    <li><a href="#" class="hover:text-primary">C√≥mo Comprar</a></li>
                    <li><a href="#" class="hover:text-primary">WhatsApp</a></li>
                </ul>
            </div>
            <div>
                <h4 class="font-bold text-xs uppercase tracking-widest mb-4 text-primary">Contacto</h4>
                <ul class="text-sm space-y-2 text-gray-500">
                    <li class="flex items-center gap-2"><span class="material-symbols-outlined text-sm">mail</span> info@paratuhogar.cu</li>
                    <li class="flex items-center gap-2"><span class="material-symbols-outlined text-sm">location_on</span> La Habana, Cuba</li>
                </ul>
            </div>
        </div>

        <!-- PANEL MAESTRO DE ADMINISTRACI√ìN -->
<section id="sec-admin-master" class="hidden px-4 md:px-10 lg:px-20 py-10 max-w-[1400px] mx-auto bg-gray-50 dark:bg-background-dark min-h-screen">
    
    <!-- Encabezado con Tasa de Cambio -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
        <div>
            <h2 class="text-3xl font-black text-gray-900 dark:text-white uppercase tracking-tighter italic">Master<span class="text-primary">Control</span></h2>
            <p class="text-gray-500 text-[10px] font-black uppercase tracking-widest">Gesti√≥n de Log√≠stica y Finanzas</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-2xl flex items-center gap-3 border px-4">
                <span class="text-[10px] font-black text-gray-400 uppercase">Cambio S√°bado:</span>
                <input type="number" id="input-tasa-cup" value="450" onchange="loadAdminData()" class="w-20 bg-transparent border-none font-black text-primary p-0 focus:ring-0 text-xl">
                <span class="text-xs font-bold text-gray-400">CUP</span>
            </div>
            <button onclick="location.reload()" class="p-4 bg-red-50 text-red-500 rounded-2xl hover:bg-red-500 hover:text-white transition-all">
                <span class="material-symbols-outlined">power_settings_new</span>
            </button>
        </div>
    </div>

    <!-- Indicadores R√°pidos -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">Ventas Entregadas</p>
            <h3 id="m-stat-ventas" class="text-3xl font-black text-primary">$0</h3>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">Comisiones x Pagar</p>
            <h3 id="m-stat-deuda" class="text-3xl font-black text-orange-500">$0</h3>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">En Log√≠stica</p>
            <h3 id="m-stat-pendientes" class="text-3xl font-black text-gray-800 dark:text-white">0</h3>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">Gestores Activos</p>
            <h3 id="m-stat-gestores" class="text-3xl font-black text-blue-500">0</h3>
        </div>
    </div>

    <!-- Pesta√±as de Navegaci√≥n -->
    <div class="flex gap-4 mb-6 bg-white dark:bg-gray-800 p-2 rounded-2xl border shadow-sm overflow-x-auto scrollbar-hide">
        <button onclick="changeAdminTab('logistica')" id="tab-logistica" class="btn-tab-admin active flex-1 py-3 rounded-xl text-xs font-black uppercase italic tracking-widest transition-all">Log√≠stica</button>
        <button onclick="changeAdminTab('pagos')" id="tab-pagos" class="btn-tab-admin flex-1 py-3 rounded-xl text-xs font-black uppercase italic tracking-widest transition-all text-gray-400">Corte S√°bado</button>
        <button onclick="changeAdminTab('inventario')" id="tab-inventario" class="btn-tab-admin flex-1 py-3 rounded-xl text-xs font-black uppercase italic tracking-widest transition-all text-gray-400">Inventario</button>
        <button onclick="changeAdminTab('analitica')" id="tab-analitica" class="btn-tab-admin flex-1 py-3 rounded-xl text-xs font-black uppercase italic tracking-widest transition-all text-gray-400">An√°lisis</button>
    </div>

    <!-- Contenido: Log√≠stica -->
    <div id="cnt-logistica" class="tab-cnt bg-white dark:bg-gray-800 rounded-3xl border shadow-sm overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-gray-50 dark:bg-gray-900/50 text-[10px] font-black uppercase text-gray-400 border-b">
                <tr>
                    <th class="p-6">Fecha/Cliente</th>
                    <th class="p-6">Producto</th>
                    <th class="p-6">Gestor</th>
                    <th class="p-6">Total</th>
                    <th class="p-6 text-right">Estado Log√≠stico</th>
                </tr>
            </thead>
            <tbody id="list-admin-pedidos" class="divide-y dark:divide-gray-700"></tbody>
        </table>
    </div>

    <!-- Contenido: Corte de S√°bado -->
    <!-- Contenido: Corte de S√°bado (OPTIMIZADO PARA 60+ GESTORES) -->
<div id="cnt-pagos" class="tab-cnt hidden space-y-4">
    <div class="bg-white dark:bg-gray-800 p-4 rounded-3xl border shadow-sm flex items-center gap-4">
        <span class="material-symbols-outlined text-gray-400">search</span>
        <input type="text" id="search-gestor-pago" oninput="renderAdminCortes()" placeholder="Buscar gestor por nombre..." class="w-full bg-transparent border-none focus:ring-0 text-sm font-bold">
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-3xl border shadow-sm overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-gray-50 dark:bg-gray-900/50 text-[10px] font-black uppercase text-gray-400 border-b">
                <tr>
                    <th class="p-4">Gestor</th>
                    <th class="p-4">Ventas</th>
                    <th class="p-4">Total USD</th>
                    <th class="p-4 text-emerald-500">Total CUP</th>
                    <th class="p-4 text-right">Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="list-admin-cortes" class="divide-y dark:divide-gray-700 text-sm">
                <!-- Se llena con JS -->
            </tbody>
        </table>
    </div>
</div>

    <!-- Contenido: Inventario -->
    <!-- Contenido: Inventario (ACTUALIZADO) -->
    <div id="cnt-inventario" class="tab-cnt hidden space-y-6">
        <div class="flex justify-between items-center mb-6">
            <p class="text-[10px] font-black uppercase text-gray-400 italic tracking-widest">Gesti√≥n de Stock y Precios</p>
            <!-- BOT√ìN PARA ABRIR EL MODAL -->
            <button onclick="openModalProd()" class="bg-primary text-white px-6 py-3 rounded-2xl font-black text-xs uppercase tracking-tighter shadow-lg shadow-primary/30 active:scale-95 transition-transform">
                + A√±adir Producto
            </button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="list-admin-inventario">
            <!-- Los productos se cargar√°n aqu√≠ -->
        </div>
    </div>

    <!-- Contenido: An√°lisis -->
    <div id="cnt-analitica" class="tab-cnt hidden grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl border shadow-sm">
            <h4 class="font-black uppercase text-xs mb-6 text-primary italic">üî• M√°s Consultados (Tendencia)</h4>
            <div id="list-analitica-vistas" class="space-y-4"></div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl border shadow-sm">
            <h4 class="font-black uppercase text-xs mb-6 text-primary italic">üèÜ Ranking de Ventas</h4>
            <div id="list-analitica-gestores" class="space-y-4"></div>
        </div>
    </div>
</section>

<style>
    .btn-tab-admin.active { background: #33ccc4; color: white; box-shadow: 0 4px 15px rgba(51, 204, 196, 0.4); }
</style>

    </footer>

    <!-- Scripts de L√≥gica -->
    <script>
    // 1. CONFIGURACI√ìN SUPABASE
    // Cambiamos el nombre de la constante a 'supabaseClient' para evitar errores
    const SUPABASE_URL = 'https://ljqwaovevfatkiigirhf.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_DAuFcu0JjUo15yLDAev3MQ_9x5GIVXt'; // Aseg√∫rate que esta sea la 'anon key'
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const MASTER_KEY = "HOGAR2025"; 
    const ADMIN_SECRET_KEY = "PRO_ADMIN_2025"; // Solo para el due√±o

    
    let productosRaw = [], cart = [], selectedProduct = null;
    let cupRate = 450, showInCUP = false, activeCategory = 'TODOS';

    const urlParams = new URLSearchParams(window.location.search);
    const gestorName = urlParams.get('gestor');
    const gestorTel = urlParams.get('tel');
    const isAdmin = urlParams.get('admin') === 'true';

    window.addEventListener('load', () => {
        if (gestorName) {
            document.getElementById('gestor-label').innerText = `AGENTE: ${gestorName.toUpperCase()}`;
            if (isAdmin) {
                document.getElementById('admin-nav').classList.remove('hidden');
                document.getElementById('gestor-label').innerText += " (PANEL PRIVADO)";
            }
        }
        loadProducts();
    });

    // 2. CARGA DE PRODUCTOS
    async function loadProducts() {
        try {
            const { data, error } = await supabaseClient
                .from('productos')
                .select('*')
                .order('nombre', { ascending: true });

            if (error) throw error;

            productosRaw = data;
            renderProducts();
        } catch (e) { 
            console.error("Error cargando productos:", e);
            document.getElementById('productos-container').innerHTML = 
                `<div class="col-span-full py-10 text-center text-red-500">Error de conexi√≥n. Verifica la configuraci√≥n de Supabase.</div>`; 
        }
    }

    function renderProducts() {
        const query = document.getElementById('search-bar').value.toLowerCase();
        const container = document.getElementById('productos-container');
        
        const filtered = productosRaw.filter(p => {
            const matchSearch = p.nombre.toLowerCase().includes(query);
            const matchCat = activeCategory === 'TODOS' || (p.categoria && p.categoria.toUpperCase().includes(activeCategory));
            return matchSearch && matchCat && p.disponible === "SI";
        });

        if (filtered.length === 0) {
            container.innerHTML = `<div class="col-span-full py-20 text-center text-gray-400 font-bold">No se encontraron equipos.</div>`;
            return;
        }

        container.innerHTML = filtered.map(p => {
            const precio = parseFloat(p.precio) || 0;
            const pDisplay = showInCUP ? `CUP ${(precio * cupRate).toLocaleString()}` : `$${precio}`;
            const htmlGanancia = isAdmin ? `<p class="text-[10px] font-black text-emerald-500 mt-1 uppercase italic tracking-tighter">Tu Ganancia: $${p.comision || 0}</p>` : '';

            return `
            <div onclick="openDetail('${p.nombre.replace(/'/g, "\\'")}')" class="bg-white dark:bg-gray-800 rounded-2xl overflow-hidden border border-gray-100 dark:border-gray-700 group shadow-sm hover:shadow-xl transition-all cursor-pointer">
                <div class="w-full aspect-square bg-white p-4">
                    <img src="${fixDriveUrl(p.thumbnail)}" class="w-full h-full object-contain group-hover:scale-105 transition-transform duration-300">
                </div>
                <div class="p-4">
                    <h3 class="text-sm font-bold leading-tight mb-2 line-clamp-2 min-h-[40px]">${p.nombre}</h3>
                    <p class="text-primary text-xl font-black">${pDisplay}</p>
                    ${htmlGanancia}
                    <button class="mt-4 w-full bg-primary/10 text-primary py-2 rounded-xl text-xs font-black uppercase hover:bg-primary hover:text-white transition-all">Ver Detalles</button>
                </div>
            </div>`;
        }).join('');
    }

    // 3. DETALLE DE PRODUCTO
    function openDetail(name) {
        selectedProduct = productosRaw.find(p => p.nombre === name);
        const p = selectedProduct;
        if(!p) return;
        // --- AQU√ç INSERTAS LA L√çNEA DE ESTAD√çSTICAS ---
        registrarVistaAnalitica(p); 
        // ----------------------------------------------

        document.getElementById('detail-name').innerText = p.nombre;
        document.getElementById('detail-desc').innerText = p.descripcion || '';
        
        const oldBadge = document.getElementById('admin-comm-badge');
        if(oldBadge) oldBadge.remove();
        
        if(isAdmin) {
            const badge = `<div id="admin-comm-badge" class="bg-emerald-500 text-white px-3 py-2 rounded-xl font-black text-[11px] mb-4 flex justify-between items-center shadow-lg shadow-emerald-500/20 uppercase italic">
                <span>Ganancia de Agente:</span>
                <span>$${p.comision || 0}.00</span>
            </div>`;
            document.getElementById('detail-name').insertAdjacentHTML('beforebegin', badge);
        }

        document.getElementById('detail-price').innerText = `$${p.precio}.00 USD`;
        document.getElementById('detail-price-cup').innerText = `/ CUP ${(p.precio * cupRate).toLocaleString()}`;
        document.getElementById('detail-cat').innerText = p.categoria || '';
        document.getElementById('detail-warranty').innerText = p.garantia || '1 Mes';
        document.getElementById('detail-shipping').innerText = p.mensajeria || 'Consultar';
        document.getElementById('detail-main-img').src = fixDriveUrl(p.thumbnail);
        
        const thumbs = [p.thumbnail, p.image1, p.image2, p.image3].filter(url => url && url.length > 5);
        document.getElementById('detail-thumbnails').innerHTML = thumbs.map(url => `
            <img src="${fixDriveUrl(url)}" onclick="document.getElementById('detail-main-img').src=this.src" class="w-12 h-12 object-contain rounded-lg border border-gray-100 bg-white p-1 cursor-pointer">
        `).join('');

        document.getElementById('detail-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    // 4. CARRITO Y PAGOS
    function addItemToCart() {
        const existing = cart.find(item => item.nombre === selectedProduct.nombre);
        if(existing) existing.qty++; else cart.push({...selectedProduct, qty: 1});
        document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0);
        closeDetail();
        toggleCartModal(true);
    }

    function renderCart() {
        const container = document.getElementById('cart-items');
        container.innerHTML = cart.map((item, index) => `
            <div class="flex gap-4 bg-gray-50 dark:bg-gray-800 p-3 rounded-xl relative">
                <img src="${fixDriveUrl(item.thumbnail)}" class="w-12 h-12 object-contain bg-white rounded">
                <div class="flex-1">
                    <h4 class="text-xs font-bold leading-tight pr-6">${item.nombre}</h4>
                    <p class="text-primary font-black text-sm">$${item.precio * item.qty}</p>
                </div>
                <button onclick="removeFromCart(${index})" class="absolute right-2 top-2 text-gray-400"><span class="material-symbols-outlined text-sm">delete</span></button>
            </div>`).join('');
        actualizarOpcionesMoneda();
    }

    function recalcularTotalFinal() {
        const select = document.getElementById('check-moneda');
        const totalUSD = cart.reduce((acc, item) => acc + (Number(item.precio) * item.qty) + (parseMensajeria(item.mensajeria) * item.qty), 0);
        
        const opcionElegida = select.value || "USD";
        let totalFinal = totalUSD;
        let simbolo = "$";

        if (opcionElegida.toUpperCase().includes("CUP")) {
            let tasaFinal = cupRate;
            if (opcionElegida.includes("+")) {
                const incremento = parseFloat(opcionElegida.match(/\d+/) || 0);
                tasaFinal = cupRate + incremento;
            } else {
                const tasaFija = parseFloat(opcionElegida.match(/\d+/) || cupRate);
                tasaFinal = (tasaFija > 100) ? tasaFija : cupRate;
            }
            totalFinal = totalUSD * tasaFinal;
            simbolo = "CUP";
        }

        document.getElementById('cart-total').innerText = `$${totalUSD.toFixed(2)} USD`;
        document.getElementById('total-convertido').innerText = `${simbolo} ${totalFinal.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    }

    function actualizarOpcionesMoneda() {
        const select = document.getElementById('check-moneda');
        if (!select || cart.length === 0) return;
        const pagosTexto = cart[0].pagos || "USD, CUP +10, Zelle";
        const opciones = pagosTexto.split(',').map(opt => opt.trim());
        select.innerHTML = opciones.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        select.onchange = recalcularTotalFinal;
        recalcularTotalFinal();
    }

    // 5. ENV√çO DE FORMULARIO A SUPABASE
    document.getElementById('checkout-form').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('final-submit-btn');
        btn.disabled = true; btn.innerText = "REGISTRANDO...";

        const nombreC = document.getElementById('check-nombre').value;
        const ciC = document.getElementById('check-ci').value;
        const telC = document.getElementById('check-tel').value;
        const dirC = document.getElementById('check-dir').value;
        const monedaC = document.getElementById('check-moneda').value;
        const valVuelto = document.getElementById('check-vuelto').value;
        const vueltoC = (valVuelto && valVuelto > 0) ? `${valVuelto}` : "No requiere";

        let precioEquipo = 0, totalMensajeria = 0, totalComision = 0;
        cart.forEach(i => {
            precioEquipo += (Number(i.precio) * i.qty);
            totalMensajeria += (parseMensajeria(i.mensajeria) * i.qty);
            if (gestorName) { totalComision += (Number(i.comision || 0) * i.qty); }
        });

        const listaProductos = cart.map(i => `${i.qty}x ${i.nombre}`).join(', ');
        const totalConvertidoStr = document.getElementById('total-convertido').innerText;

        // Registro en Supabase
        const { error } = await supabaseClient.from('pedidos').insert([{
            gestor: gestorName || "Venta Directa",
            cliente: nombreC, ci: ciC, telefono: telC, direccion: dirC,
            producto: `${listaProductos} [${monedaC}]`,
            total: precioEquipo + totalMensajeria,
            comision_total: totalComision,
            estado: 'Pendiente'
        }]);

        if (error) console.error("Error Supabase:", error);

        // Enlace WhatsApp
        let msj = `*NUEVO PEDIDO - PARA TU HOGAR*%0A%0A` +
                  `üí™üèªNombre: ${nombreC}%0A` +
                  `üí™üèªCI: ${ciC}%0A` +
                  `üí™üèªTel√©fono: ${telC}%0A` +
                  `üí™üèªDirecci√≥n: ${dirC}%0A%0A` +
                  `üí™üèªProducto: ${listaProductos}%0A` +
                  `üí™üèªTotal a Pagar: *${totalConvertidoStr}*%0A` +
                  `üí™üèªVuelto: ${vueltoC}%0A`;
        if (gestorName) msj += `üí™üèªGestor: ${gestorName}%0A‚òé(${gestorTel})`;

        window.open(`https://wa.me/5356071095?text=${msj}`, '_blank');
        setTimeout(() => location.reload(), 1500);
    };

    // 6. FUNCIONES AUXILIARES
    function parseMensajeria(texto) {
        if (!texto) return 0;
        let t = texto.toString().toLowerCase();
        if (t.includes('gratis') && !t.includes('periferia')) return 0;
        let match = t.match(/\d+/);
        return match ? parseFloat(match[0]) : 0;
    }

    function fixDriveUrl(url) {
        if (!url) return 'https://placehold.co/400x400?text=No+Imagen';
        if (url.startsWith('http')) return url;
        return `${SUPABASE_URL}/storage/v1/object/public/productos/${url}`;
    }

    function toggleCartModal(show) { document.getElementById('cart-modal').classList.toggle('hidden', !show); if(show) renderCart(); }
    function closeDetail() { document.getElementById('detail-modal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
    function toggleCurrency() { showInCUP = !showInCUP; document.getElementById('currency-label').innerText = showInCUP ? 'CUP' : 'USD'; renderProducts(); }
    function filterByCategory(cat) { 
        activeCategory = cat; 
        document.querySelectorAll('.category-tab').forEach(b => b.classList.toggle('active', b.innerText.toUpperCase() === cat));
        renderProducts(); 
    }
    function removeFromCart(i) { cart.splice(i, 1); document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0); renderCart(); }
    function filterProducts() { renderProducts(); }
    function copyOffer() {
        const text = `üî• *OFERTA DISPONIBLE*\nüì¶ ${selectedProduct.nombre}\nüí∞ Precio: $${selectedProduct.precio} USD\nüõ°Ô∏è Garant√≠a: ${selectedProduct.garantia}\nüöõ Env√≠o: ${selectedProduct.mensajeria}`;
        navigator.clipboard.writeText(text).then(() => alert("¬°Copiado!"));
    }

    // DASHBOARD DE GESTOR (Simplificado para Supabase)
    async function loadFullDashboard() {
        const { data, error } = await supabaseClient.from('pedidos').select('*').eq('gestor', gestorName);
        if (error) return;
        
        const entregados = data.filter(p => p.estado === 'Entregado');
        const pendientes = data.filter(p => p.estado === 'Pendiente');
        
        document.getElementById('dash-money').innerText = `$${entregados.reduce((a,c) => a + (Number(c.comision_total || 0)), 0).toFixed(2)}`;
        document.getElementById('dash-ok').innerText = entregados.length;
        document.getElementById('dash-pending').innerText = pendientes.length;
    }

    function showSection(section) {
        const isCat = section === 'catalogo';
        document.getElementById('sec-catalogo').style.display = isCat ? 'block' : 'none';
        document.getElementById('sec-dashboard').classList.toggle('hidden', isCat);
        document.getElementById('tab-cat').className = isCat ? "flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-primary text-white" : "flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-gray-100 text-gray-400";
        document.getElementById('tab-dash').className = !isCat ? "flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-primary text-white" : "flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-gray-100 text-gray-400";
        if(!isCat) loadFullDashboard();
        window.scrollTo(0,0);
    }

    // GESTORES
    function openGestorGen() { document.getElementById('gestor-modal').classList.remove('hidden'); }
    function closeGestorGen() { document.getElementById('gestor-modal').classList.add('hidden'); }
    function processGestor() {
        const pass = document.getElementById('master-pass').value;
        if(pass !== MASTER_KEY) return alert("C√≥digo Maestro Incorrecto");
        const name = document.getElementById('gen-name').value.trim();
        const tel = document.getElementById('gen-tel').value.trim();
        if(!name || !tel) return alert("Faltan datos");
        const base = window.location.origin + window.location.pathname;
        document.getElementById('link-admin').value = `${base}?gestor=${encodeURIComponent(name)}&tel=${tel}&admin=true`;
        document.getElementById('link-client').value = `${base}?gestor=${encodeURIComponent(name)}&tel=${tel}`;
        document.getElementById('links-result').classList.remove('hidden');
    }
    function copy(id) { const e = document.getElementById(id); e.select(); document.execCommand('copy'); alert("Copiado"); }

    // --- L√ìGICA DEL PANEL MAESTRO ---

// CORRECCI√ìN: Funci√≥n para entrar al Panel Maestro (Due√±o)
async function openAdminMaster() {
    const pass = prompt("Acceso Administrativo. Introduce la Clave de Due√±o:");
    
    // Cambiamos MASTER_KEY por ADMIN_SECRET_KEY para que use la clave de administrador
    if (pass === ADMIN_SECRET_KEY) { 
        document.getElementById('sec-catalogo').style.display = 'none';
        document.getElementById('sec-dashboard').classList.add('hidden');
        document.getElementById('admin-nav').classList.add('hidden');
        document.getElementById('sec-admin-master').classList.remove('hidden');
        loadAdminData();
    } else if (pass !== null) {
        alert("Clave de Administrador incorrecta.");
    }
}

let pedidosRawAdmin = []; // A√±ade esta l√≠nea antes de la funci√≥n

async function loadAdminData() {
    const { data: pedidos } = await supabaseClient.from('pedidos').select('*').order('fecha', {ascending: false});
    const { data: productos } = await supabaseClient.from('productos').select('*').order('nombre', {ascending: true});
    const { data: vistas } = await supabaseClient.from('metricas_vistas').select('*');

    if (pedidos) {
        pedidosRawAdmin = pedidos; // Guardamos para el buscador
        renderAdminLogistica(pedidos);
        renderAdminCortes(); // Ahora no le pasamos par√°metros
        updateAdminStats(pedidos);
        renderAnaliticaGestores(pedidos);
    }
    if (productos) renderAdminInventario(productos);
    if (vistas) renderAnaliticaVistas(vistas);
}

function updateAdminStats(pedidos) {
    const entregados = pedidos.filter(p => p.estado === 'Entregado');
    const totalUSD = entregados.reduce((acc, p) => acc + Number(p.total || 0), 0);
    const pendientes = pedidos.filter(p => p.estado === 'Pendiente' || p.estado === 'En Camino').length;
    const deuda = pedidos.filter(p => p.estado === 'Entregado' && p.pago_gestor === 'Pendiente')
                         .reduce((acc, p) => acc + Number(p.comision_total || 0), 0);

    document.getElementById('m-stat-ventas').innerText = `$${totalUSD.toLocaleString()}`;
    document.getElementById('m-stat-pendientes').innerText = pendientes;
    document.getElementById('m-stat-deuda').innerText = `$${deuda.toLocaleString()}`;
    document.getElementById('m-stat-gestores').innerText = new Set(pedidos.map(p => p.gestor)).size;
}

function renderAdminLogistica(pedidos) {
    const container = document.getElementById('list-admin-pedidos');
    container.innerHTML = pedidos.map(p => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/40 transition-all text-xs">
            <td class="p-6 font-bold uppercase text-[10px]">
                <p class="text-gray-400">${new Date(p.fecha).toLocaleDateString()}</p>
                ${p.cliente}
            </td>
            <td class="p-6">${p.producto}</td>
            <td class="p-6"><span class="bg-primary/10 text-primary px-2 py-1 rounded-lg font-black uppercase text-[9px] italic">${p.gestor}</span></td>
            <td class="p-6 font-black text-primary">$${p.total}</td>
            <td class="p-6 text-right">
                <select onchange="updatePedidoStatus('${p.id}', this.value)" class="text-[10px] font-black uppercase rounded-xl border-gray-100 dark:bg-gray-900">
                    <option value="Pendiente" ${p.estado === 'Pendiente' ? 'selected' : ''}>‚è≥ Pendiente</option>
                    <option value="En Camino" ${p.estado === 'En Camino' ? 'selected' : ''}>üöö En Camino</option>
                    <option value="Entregado" ${p.estado === 'Entregado' ? 'selected' : ''}>‚úÖ Entregado</option>
                    <option value="Cancelado" ${p.estado === 'Cancelado' ? 'selected' : ''}>‚ùå Cancelado</option>
                </select>
            </td>
        </tr>
    `).join('');
}

function renderAdminCortes() {
    const container = document.getElementById('list-admin-cortes');
    if (!container) return;

    const searchTerm = document.getElementById('search-gestor-pago').value.toLowerCase();
    const tasa = parseFloat(document.getElementById('input-tasa-cup').value) || 450;
    
    // Filtramos solo los pedidos entregados y no pagados
    const deuda = pedidosRawAdmin.filter(p => p.estado === 'Entregado' && p.pago_gestor === 'Pendiente');

    // Agrupamos por gestor
    const porGestor = deuda.reduce((acc, p) => {
        if (!acc[p.gestor]) acc[p.gestor] = { usd: 0, count: 0, ids: [] };
        acc[p.gestor].usd += Number(p.comision_total || 0);
        acc[p.gestor].count++;
        acc[p.gestor].ids.push(p.id);
        return acc;
    }, {});

    // Filtramos por el nombre que escriba el admin en el buscador
    const entries = Object.entries(porGestor).filter(([name]) => name.toLowerCase().includes(searchTerm));

    if (entries.length === 0) {
        container.innerHTML = `<tr><td colspan="5" class="p-10 text-center text-gray-400 uppercase text-xs font-bold italic">No hay pagos pendientes con ese nombre.</td></tr>`;
        return;
    }

    container.innerHTML = entries.map(([name, data]) => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-900/40 transition-all border-b dark:border-gray-700">
            <td class="p-4 font-black text-primary uppercase italic text-xs">${name}</td>
            <td class="p-4 font-bold text-gray-400 text-xs">${data.count} ventas</td>
            <td class="p-4 font-black text-sm">$${data.usd}</td>
            <td class="p-4 font-black text-emerald-500 text-sm italic">${(data.usd * tasa).toLocaleString()} CUP</td>
            <td class="p-4 text-right">
                <button onclick="liquidarComisiones('${data.ids.join(',')}')" class="bg-gray-900 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-primary transition-all shadow-md">Liquidar</button>
            </td>
        </tr>
    `).join('');
}

async function liquidarComisiones(idsStr) {
    if (!confirm("¬øYa pagaste estas comisiones?")) return;
    await supabaseClient.from('pedidos').update({ pago_gestor: 'Pagado' }).in('id', idsStr.split(','));
    loadAdminData();
}

async function updatePedidoStatus(id, nuevoEstado) {
    await supabaseClient.from('pedidos').update({ estado: nuevoEstado }).eq('id', id);
    loadAdminData();
}

function renderAdminInventario(productos) {
    const container = document.getElementById('list-admin-inventario');
    
    // 1. Verificaci√≥n de seguridad: ¬øExiste el contenedor en el HTML?
    if (!container) {
        console.error("Error: No se encontr√≥ el contenedor 'list-admin-inventario' en el HTML.");
        return;
    }

    // 2. Verificaci√≥n: ¬øHay productos?
    if (!productos || productos.length === 0) {
        container.innerHTML = `<div class="col-span-full py-20 text-center text-gray-400 font-bold uppercase text-xs italic">No hay productos cargados en la base de datos.</div>`;
        return;
    }

    // 3. Dibujar las tarjetas
    container.innerHTML = productos.map(p => `
        <div class="bg-white dark:bg-gray-800 p-4 rounded-3xl border shadow-sm flex flex-col justify-between">
            <div>
                <img src="${fixDriveUrl(p.thumbnail)}" class="w-full h-32 object-contain mb-4 bg-gray-50 rounded-2xl p-2">
                <h6 class="text-[10px] font-black leading-tight mb-1 uppercase text-gray-700 dark:text-gray-200">${p.nombre}</h6>
                <p class="text-primary font-black text-sm mb-4">$${p.precio}</p>
            </div>
            <button onclick="toggleStockAdmin('${p.id}', '${p.disponible}')" 
                class="w-full py-2 rounded-xl text-[9px] font-black uppercase transition-all ${p.disponible === 'SI' ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white'}">
                ${p.disponible === 'SI' ? '‚óè En Stock' : '‚óã Agotado'}
            </button>
        </div>
    `).join('');
}

async function toggleStockAdmin(id, actual) {
    await supabaseClient.from('productos').update({ disponible: actual === 'SI' ? 'NO' : 'SI' }).eq('id', id);
    loadAdminData();
}

function renderAnaliticaVistas(vistas) {
    const counts = vistas.reduce((acc, v) => { acc[v.nombre_producto] = (acc[v.nombre_producto] || 0) + 1; return acc; }, {});
    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
    document.getElementById('list-analitica-vistas').innerHTML = sorted.map(([name, count]) => `
        <div class="flex justify-between items-center text-[11px] font-bold uppercase italic text-gray-500">
            <p class="truncate pr-4">${name}</p>
            <p class="text-primary">${count} clics</p>
        </div>
    `).join('');
}

function renderAnaliticaGestores(pedidos) {
    const counts = pedidos.filter(p => p.estado === 'Entregado').reduce((acc, p) => { acc[p.gestor] = (acc[p.gestor] || 0) + 1; return acc; }, {});
    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
    document.getElementById('list-analitica-gestores').innerHTML = sorted.map(([name, count]) => `
        <div class="flex justify-between items-center text-[11px] font-bold uppercase italic text-gray-500">
            <p>${name}</p>
            <p class="text-primary">${count} ventas</p>
        </div>
    `).join('');
}

function changeAdminTab(tab) {
    document.querySelectorAll('.tab-cnt').forEach(c => c.classList.add('hidden'));
    document.getElementById('cnt-' + tab).classList.remove('hidden');
    document.querySelectorAll('.btn-tab-admin').forEach(b => b.classList.remove('active', 'text-white'));
    document.getElementById('tab-' + tab).classList.add('active');
}

// Registro de estad√≠sticas
async function registrarVistaAnalitica(p) {
    await supabaseClient.from('metricas_vistas').insert([{ producto_id: p.id, nombre_producto: p.nombre }]);
}
// Funci√≥n para saltar del panel de gestores al panel de administraci√≥n maestro
// CORRECCI√ìN: Funci√≥n para saltar desde el modal de gestores

function openAdminMasterFromGestor() {
    const passInput = document.getElementById('master-pass').value;
    
    // Verificamos si la clave escrita en el recuadro es la del due√±o
    if (passInput === ADMIN_SECRET_KEY) {
        closeGestorGen(); // Cerramos el modal
        
        // Ejecutamos la apertura directamente sin volver a preguntar
        document.getElementById('sec-catalogo').style.display = 'none';
        document.getElementById('sec-dashboard').classList.add('hidden');
        document.getElementById('admin-nav').classList.add('hidden');
        document.getElementById('sec-admin-master').classList.remove('hidden');
        loadAdminData();
    } else {
        alert("Para acceder aqu√≠, escribe la Clave de Due√±o en el campo 'C√≥digo Maestro'.");
    }
}

// --- FUNCIONES PARA EL FORMULARIO DE PRODUCTOS ---

function openModalProd() { 
    document.getElementById('modal-producto').classList.remove('hidden'); 
    document.body.style.overflow = 'hidden';
}

function closeModalProd() { 
    document.getElementById('modal-producto').classList.add('hidden'); 
    document.body.style.overflow = 'auto';
}

// --- FUNCI√ìN PARA PROCESAR Y SUBIR IMAGEN ---
async function handleImageUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const msg = document.getElementById('upload-msg');
    const btn = document.getElementById('btn-upload');
    
    msg.innerText = "‚è≥ Optimizando y subiendo imagen...";
    btn.disabled = true;

    try {
        // 1. Comprimir imagen para ahorrar datos en Cuba
        const compressedBlob = await compressImage(file, 800, 800);

        // 2. Crear un nombre limpio para Supabase
        const cleanName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
        const fileName = `${Date.now()}_${cleanName}`;

        // 3. Subir al Storage
        const { data, error } = await supabaseClient.storage
            .from('productos')
            .upload(fileName, compressedBlob);

        if (error) throw error;

        // 4. GUARDAR EL NOMBRE EN EL CAMPO OCULTO (Paso Vital)
        document.getElementById('p-img-name').value = fileName;
        
        msg.innerHTML = `‚úÖ Foto lista para guardar`;
        btn.innerText = "Imagen Vinculada";
        btn.style.borderColor = "#33ccc4";
        
    } catch (e) {
        console.error(e);
        alert("Error al procesar la imagen: " + e.message);
        msg.innerText = "‚ùå Error en la subida";
        btn.disabled = false;
    }
}

// --- GUARDAR EL PRODUCTO COMPLETO EN LA TABLA ---
document.getElementById('form-nuevo-prod').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = e.target.querySelector('button');
    const imgName = document.getElementById('p-img-name').value;

    // 1. Verificamos la foto
    if (!imgName) {
        alert("‚ùå Error: Debes subir una foto primero.");
        return;
    }

    btn.disabled = true; 
    btn.innerText = "PROCESANDO REGISTRO...";

    // 2. Capturamos los valores con IDs limpios
    const nombre = document.getElementById('p-nombre').value;
    const precio = parseFloat(document.getElementById('p-precio').value);
    const comision = parseFloat(document.getElementById('p-comision').value) || 0;
    const categoria = document.getElementById('p-categoria').value;
    const garantia = document.getElementById('p-garantia').value;
    const mensajeria = document.getElementById('p-mensajeria').value;
    const descripcion = document.getElementById('p-desc').value;

    // 3. Creamos el objeto EXACTAMENTE como las columnas de Supabase
    const objetoInsertar = {
        nombre: nombre,
        precio: precio,
        comision: comision,
        categoria: categoria,
        descripcion: descripcion,
        thumbnail: imgName,
        mensajeria: mensajeria,
        disponible: 'SI',
        garantia: garantia,
        pagos: 'USD, CUP, Zelle'
    };

    console.log("Intentando insertar:", objetoInsertar);

    // 4. Intentamos insertar
    const { data, error } = await supabaseClient
        .from('productos')
        .insert([objetoInsertar])
        .select(); // El .select() es para confirmar que se cre√≥

    if (error) {
        console.error("DETALLE DEL ERROR:", error);
        alert("‚ùå ERROR DE BASE DE DATOS: " + error.message + "\nCampo con error: " + error.details);
        btn.disabled = false;
        btn.innerText = "Guardar en Cat√°logo";
    } else {
        alert("‚úÖ PRODUCTO PUBLICADO CON √âXITO");
        location.reload(); 
    }
});


// Funci√≥n m√°gica de compresi√≥n
function compressImage(file, maxWidth, maxHeight) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                } else {
                    if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Convertir a Blob (JPEG con calidad 0.7 es super ligero)
                canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.7);
            };
        };
    });
}

</script>
<!-- MODAL NUEVO PRODUCTO -->
<div id="modal-producto" class="fixed inset-0 z-[300] hidden bg-black/80 backdrop-blur-sm p-4 overflow-y-auto flex justify-center items-center">
    <div class="bg-white dark:bg-gray-800 w-full max-w-2xl rounded-[32px] p-8 shadow-2xl relative">
        <button onclick="closeModalProd()" class="absolute top-6 right-6 p-2 bg-gray-100 rounded-full"><span class="material-symbols-outlined">close</span></button>
        
        <h3 class="text-2xl font-black mb-6 italic uppercase">A√±adir Nuevo <span class="text-primary">Equipo</span></h3>
        
        <form id="form-nuevo-prod" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" id="p-nombre" placeholder="Nombre del Equipo" class="md:col-span-2 rounded-xl border-gray-100 dark:bg-gray-700 font-bold" required>
            <input type="number" id="p-precio" placeholder="Precio USD" class="rounded-xl border-gray-100 dark:bg-gray-700 font-bold" required>
            <input type="number" id="p-comision" placeholder="Comisi√≥n Gestor" class="rounded-xl border-gray-100 dark:bg-gray-700 font-bold" required>
            <select id="p-categoria" class="rounded-xl border-gray-100 dark:bg-gray-700 font-bold">
    <option value="REFRIGERACI√ìN">Refrigeraci√≥n</option>
    <option value="COCINA">Cocina</option>
    <option value="LAVADO">Lavado</option>
    <option value="CLIMATIZACI√ìN">Climatizaci√≥n</option>
    <option value="ENERG√çA">Energ√≠a</option>
    <option value="VARIOS">Varios</option>
</select>
            <input type="text" id="p-garantia" placeholder="Garant√≠a (ej: 3 meses)" class="rounded-xl border-gray-100 dark:bg-gray-700 font-bold">
            <input type="text" id="p-mensajeria" placeholder="Mensajer√≠a (ej: 5 USD)" class="rounded-xl border-gray-100 dark:bg-gray-700 font-bold">
            
            <div class="md:col-span-2 space-y-2">
                <label class="text-[10px] font-black text-gray-400 uppercase italic">Foto del Equipo (Se optimizar√° sola)</label>
                <div class="flex items-center gap-4">
                    <input type="file" id="p-file" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                    <button type="button" id="btn-upload" onclick="document.getElementById('p-file').click()" class="flex-1 bg-gray-100 dark:bg-gray-700 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl py-3 text-xs font-bold flex items-center justify-center gap-2 hover:bg-gray-200 transition-all">
                        <span class="material-symbols-outlined">add_a_photo</span> Seleccionar Foto
                    </button>
                </div>
                <!-- Texto donde aparecer√° el nombre del archivo cuando se suba -->
                <!-- Aseg√∫rate de tener el campo oculto para la imagen justo debajo del mensaje -->
<p id="upload-msg" class="text-[9px] font-black text-primary text-center uppercase tracking-widest"></p>
<input type="hidden" id="p-img-name">
            </div>

            <textarea id="p-desc" placeholder="Descripci√≥n del producto" class="md:col-span-2 rounded-xl border-gray-100 dark:bg-gray-700 h-24 font-medium"></textarea>
            
            <button type="submit" class="md:col-span-2 bg-primary text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg shadow-primary/30 mt-4">Guardar en Cat√°logo</button>
        </form>
    </div>
</div>
</body>
</html>