<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Para Tu Hogar | Business Suite v6.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #020617; --card: #0f172a; --accent: #3b82f6; }
        body { background-color: var(--bg); color: #f8fafc; font-family: ui-sans-serif, system-ui; overflow-x: hidden; }
        .nav-tab { border-radius: 12px; transition: all 0.3s; font-size: 10px; font-weight: 800; color: #64748b; }
        .nav-tab.active { background: var(--accent); color: white; box-shadow: 0 4px 20px -5px var(--accent); }
        .app-card { background: var(--card); border: 1px solid rgba(255,255,255,0.05); border-radius: 24px; }
        .glass-header { background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .category-pill { flex-shrink: 0; padding: 10px 18px; border-radius: 16px; background: #1e293b; font-size: 10px; font-weight: 800; text-transform: uppercase; color: #94a3b8; }
        .category-pill.active { border-color: #3b82f6; color: white; background: rgba(59, 130, 246, 0.2); }
        .btn-period { font-size: 9px; font-weight: 900; padding: 6px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .btn-period.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        input, textarea { background: #1e293b !important; border: 1px solid #334155 !important; color: white !important; outline: none !important; }
        .loader { width: 24px; height: 24px; border: 3px solid #3b82f6; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-scroll { max-height: 45vh; overflow-y: auto; scrollbar-width: thin; }
        @media (min-width: 768px) { .modal-scroll { max-height: none; } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="pb-32">

    <!-- Header -->
    <header class="glass-header sticky top-0 z-[100] px-5 py-4">
        <div class="container mx-auto space-y-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/40"><i class="fas fa-rocket text-white"></i></div>
                    <div>
                        <h1 class="text-sm font-black uppercase italic leading-none">Para Tu Hogar</h1>
                        <p id="gestor-label" class="text-[8px] font-black uppercase text-blue-400 mt-1 italic tracking-widest">Sincronizando...</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleCurrency()" class="bg-blue-600/10 border border-blue-500/20 px-3 py-1.5 rounded-xl text-[10px] font-black text-blue-400 uppercase"><span id="currency-label">USD</span></button>
                    <button id="btn-open-gen" onclick="openGestorGen()" class="w-9 h-9 bg-white/5 rounded-xl flex items-center justify-center border border-white/10 active:scale-90 transition-all"><i class="fas fa-link text-xs text-slate-400"></i></button>
                </div>
            </div>

            <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                <input type="text" id="search-bar" oninput="filterProducts()" placeholder="¬øQu√© equipo buscas?" class="w-full bg-slate-900 border-none rounded-2xl py-4 pl-11 pr-4 text-xs font-bold focus:ring-2 focus:ring-blue-500 transition-all">
            </div>

            <div id="category-list" class="flex gap-2 overflow-x-auto scrollbar-hide py-1">
                <button onclick="filterByCategory('TODOS')" class="category-pill active">Todos</button>
                <button onclick="filterByCategory('CLIMATIZACI√ìN')" class="category-pill">Clima</button>
                <button onclick="filterByCategory('COCINA')" class="category-pill">Cocina</button>
                <button onclick="filterByCategory('FR√çO')" class="category-pill">Fr√≠o</button>
                <button onclick="filterByCategory('ENERG√çA')" class="category-pill">Energ√≠a</button>
            </div>
        </div>
    </header>

    <nav id="main-nav" class="container mx-auto px-5 mt-4 flex gap-2">
        <button onclick="showSection('catalogo')" id="tab-cat" class="nav-tab active px-5 py-3 uppercase flex-1 border border-white/5">Cat√°logo</button>
        <button onclick="showSection('dashboard')" id="tab-dash" class="nav-tab px-5 py-3 uppercase flex-1 hidden bg-slate-900">Dashboard</button>
    </nav>

    <main class="container mx-auto px-5 pt-6">
        <!-- CAT√ÅLOGO -->
        <section id="sec-catalogo" class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div id="productos-container" class="col-span-full py-32 text-center"><span class="loader"></span></div>
        </section>

        <!-- DASHBOARD -->
        <section id="sec-dashboard" class="hidden space-y-6">
            <div class="app-card p-7 bg-gradient-to-br from-blue-600/20 to-transparent border-blue-500/20 flex justify-between items-center relative overflow-hidden">
                <div>
                    <p class="text-[10px] font-black text-blue-300 uppercase tracking-widest mb-1 italic opacity-70">Profit Acumulado</p>
                    <h2 id="dash-money" class="text-4xl font-black tracking-tighter">$0.00</h2>
                </div>
                <i class="fas fa-wallet absolute -right-4 -bottom-4 text-7xl text-white/5"></i>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="app-card p-5 border-l-4 border-blue-500">
                    <p class="text-[9px] font-bold text-slate-500 uppercase mb-1">Entregas</p>
                    <p id="dash-ok" class="text-2xl font-black italic">0</p>
                </div>
                <div class="app-card p-5 border-l-4 border-emerald-500">
                    <p class="text-[9px] font-bold text-slate-500 uppercase mb-1">Unidades</p>
                    <p id="dash-units" class="text-2xl font-black text-emerald-400">0</p>
                </div>
            </div>

            <div class="app-card overflow-hidden">
                <div class="p-6 border-b border-white/5 flex justify-between items-center">
                    <h3 class="text-[11px] font-black uppercase italic tracking-widest text-blue-400">Ranking √âlite</h3>
                    <div class="flex gap-2">
                        <button onclick="changeRankingPeriod('week')" id="p-week" class="btn-period active bg-slate-800">7D</button>
                        <button onclick="changeRankingPeriod('month')" id="p-month" class="btn-period bg-slate-800">MES</button>
                    </div>
                </div>
                <div id="ranking-list" class="divide-y divide-white/5"></div>
            </div>
        </section>
    </main>

    <!-- FAB Carrito -->
    <div onclick="toggleCartModal()" class="fixed bottom-8 right-6 bg-blue-600 text-white w-16 h-16 rounded-[24px] shadow-2xl flex items-center justify-center cursor-pointer z-[110] active:scale-90 border-2 border-white/20">
        <i class="fas fa-shopping-basket text-xl"></i>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-black w-7 h-7 rounded-xl flex items-center justify-center border-2 border-slate-950">0</span>
    </div>

    <!-- MODALES: DETALLE, CARRITO, GESTOR (Se mantienen igual pero con IDs corregidos) -->
    <!-- (Para brevedad, se integran en el script la l√≥gica de apertura) -->
    <!-- MODAL DETALLE (CORREGIDO PARA SCROLL Y BOT√ìN VISIBLE) -->
    <!-- MODAL DETALLE DEFINITIVO: SCROLL + GALERIA + BOTON COMPRAR -->
    <div id="detail-modal" class="fixed inset-0 bg-slate-950/98 backdrop-blur-xl hidden flex items-center justify-center p-2 z-[150]">
        <div class="bg-slate-900 rounded-[40px] w-full max-w-4xl max-h-[95vh] overflow-y-auto flex flex-col md:flex-row border border-white/5 relative scrollbar-hide">
            
            <!-- Bot√≥n Cerrar (Sticky para m√≥viles) -->
            <button onclick="closeDetail()" class="sticky top-5 left-[88%] md:absolute md:top-5 md:right-5 text-white w-12 h-12 rounded-full z-[170] flex items-center justify-center bg-white/10 backdrop-blur-md border border-white/10">
                <i class="fas fa-times"></i>
            </button>
            
            <!-- SECCI√ìN IZQUIERDA: IM√ÅGENES -->
            <div class="w-full md:w-5/12 bg-white flex flex-col border-r border-white/5">
                <!-- Imagen Principal -->
                <div class="p-8 flex-1 flex items-center justify-center min-h-[320px]">
                    <img id="detail-main-img" src="" class="max-w-full max-h-72 object-contain transition-all duration-500">
                </div>
                <!-- Miniaturas (Galer√≠a) -->
                <div id="detail-thumbnails" class="p-4 bg-slate-100 flex gap-2 overflow-x-auto justify-center scrollbar-hide border-t border-slate-200">
                    <!-- Las fotos se cargan aqu√≠ v√≠a JS -->
                </div>
            </div>

            <!-- SECCI√ìN DERECHA: INFO -->
            <div class="w-full md:w-7/12 p-8 md:p-12 flex flex-col bg-slate-900">
                <span id="detail-cat" class="text-blue-500 font-black text-[9px] uppercase tracking-widest mb-2"></span>
                <h2 id="detail-name" class="text-2xl md:text-3xl font-black mb-5 uppercase italic leading-tight text-white"></h2>
                
                <div class="flex items-center gap-5 mb-4">
                    <span id="detail-price" class="text-4xl font-black text-white"></span>
                    <span id="detail-price-cup" class="text-sm font-bold text-slate-500 italic"></span>
                </div>

                <div id="detail-warranty" class="mb-6 bg-blue-500/10 px-4 py-2 rounded-2xl text-[10px] font-black text-blue-400 self-start border border-blue-500/20 uppercase"></div>
                
                <div class="mb-8">
                    <p id="detail-desc" class="text-slate-400 text-[14px] leading-relaxed whitespace-pre-line font-medium"></p>
                </div>

                <!-- Bot√≥n de Compra -->
                <button onclick="addItemToCart()" class="w-full bg-blue-600 hover:bg-blue-500 py-6 rounded-[24px] font-black uppercase tracking-widest text-white shadow-xl shadow-blue-600/20 transition-all active:scale-95 mb-4">
                    <i class="fas fa-cart-plus mr-2"></i> A√±adir a la orden
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL CARRITO -->
    <div id="cart-modal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-2xl hidden flex items-center justify-end z-[160]">
        <div class="bg-slate-900 w-full max-w-md h-full p-7 overflow-y-auto">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-xs font-black uppercase text-blue-500">Mi Pedido</h2>
                <button onclick="toggleCartModal()" class="text-2xl text-slate-600">&times;</button>
            </div>
            <div id="cart-items" class="space-y-5 mb-8"></div>
            <div class="border-t border-white/10 pt-5 text-white font-black text-2xl uppercase mb-8">
                <div class="flex justify-between items-end">
    <span>TOTAL:</span> 
    <div class="text-right">
        <span id="cart-total" class="block text-sm opacity-50">$0.00</span>
        <span id="total-convertido" class="block text-blue-500 text-3xl">$0.00</span>
    </div>
</div>
            </div>
            <form id="checkout-form" class="space-y-4">
                <input type="text" id="check-nombre" placeholder="Nombre completo (Obligatorio)" class="w-full p-4 rounded-2xl" required>
                <div class="flex gap-4">
                    <input type="text" id="check-ci" placeholder="CI (Obligatorio)" class="w-full p-4 rounded-2xl" required>
                    <input type="tel" id="check-tel" placeholder="Tel√©fono (Obligatorio)" class="w-full p-4 rounded-2xl" required>
                </div>
                <textarea id="check-dir" placeholder="Direcci√≥n detallada (Obligatorio)" class="w-full p-4 rounded-2xl h-20" required></textarea>
                
                
                <!-- SELECTOR DE MONEDA DIN√ÅMICO -->
                <div class="p-4 bg-purple-900/20 rounded-2xl border border-purple-500/30 mb-4">
                    <label class="text-[10px] font-black text-purple-400 uppercase block mb-2 italic">Moneda / M√©todo de Pago</label>
                    <select id="check-moneda" class="w-full bg-slate-900 text-white border-none text-sm font-black rounded-lg p-1 outline-none">
                        <!-- Se llena autom√°ticamente con JS -->
                    </select>
                </div>

                <div class="p-4 bg-blue-900/20 rounded-2xl border border-blue-500/30">
                    <label class="text-[10px] font-black text-blue-400 uppercase block mb-1">Monto del vuelto (en la moneda elegida)</label>
                    <input type="number" id="check-vuelto" placeholder="Ej: 50 (Ponga 0 si no requiere)" class="w-full bg-transparent border-none text-sm font-black text-white p-0" min="0">
                </div>

                <button type="submit" id="final-submit-btn" class="w-full bg-emerald-600 py-5 rounded-[22px] font-black uppercase">Tramitar Pedido</button>
            </form>
        </div>
    </div>

    <!-- MODAL GESTOR -->
    <div id="gestor-modal" class="fixed inset-0 bg-slate-950/98 backdrop-blur-2xl hidden flex items-center justify-center p-6 z-[200]">
        <div class="app-card w-full max-w-md p-8">
            <h2 class="text-xl font-black mb-4 uppercase italic text-blue-400">Vincular Gestor</h2>
            <div class="space-y-4">
                <input type="password" id="master-pass" class="w-full p-4 rounded-2xl" placeholder="C√≥digo Maestro">
                <input type="text" id="gen-name" class="w-full p-4 rounded-2xl" placeholder="Tu Nombre">
                <input type="tel" id="gen-tel" class="w-full p-4 rounded-2xl" placeholder="WhatsApp (Ej: 535...)">
                <button onclick="processGestor()" class="w-full bg-blue-600 py-4.5 rounded-2xl font-black uppercase">Generar Links</button>
            </div>
            <div id="links-result" class="hidden mt-8 space-y-4">
                <input type="text" id="link-admin" readonly class="w-full text-[9px] p-3 bg-slate-950 rounded">
                <button onclick="copy('link-admin')" class="text-blue-500 font-bold text-[10px]">COPIAR PANEL CONTROL</button>
                <input type="text" id="link-client" readonly class="w-full text-[9px] p-3 bg-slate-950 rounded">
                <button onclick="copy('link-client')" class="text-white font-bold text-[10px]">COPIAR LINK P√öBLICO</button>
            </div>
            <button onclick="closeGestorGen()" class="w-full mt-6 text-slate-600 text-[10px] uppercase">Cerrar</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbw3iUQm9fNB8orXe8xt6bwufheyAeg77EPQG8H_sP6QxfoLlD8TeSPA5vwTHLjAmBfV/exec'; 
        const MASTER_KEY = "HOGAR2025"; 
        
        let productosRaw = [], cart = [], selectedProduct = null;
        let cupRate = 450, showInCUP = false, activeCategory = 'TODOS', currentPeriod = 'week';

        const urlParams = new URLSearchParams(window.location.search);
        const gestorName = urlParams.get('gestor'), gestorTel = urlParams.get('tel'), isAdmin = urlParams.get('admin') === 'true';

        window.addEventListener('load', () => {
            if (gestorName) {
                document.getElementById('gestor-label').innerText = `Agente: ${gestorName.toUpperCase()}`;
                if (isAdmin) document.getElementById('tab-dash').classList.remove('hidden');
            } else { document.getElementById('gestor-label').innerText = "Cat√°logo P√∫blico"; }
            loadProducts();
        });

        async function loadProducts() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                productosRaw = data.productos;
                cupRate = data.tasa || 450;
                renderProducts();
            } catch (e) { 
                console.error("Error cargando productos:", e);
                document.getElementById('productos-container').innerHTML = "Error al conectar con la base de datos."; 
            }
        }

        function renderProducts() {
            const query = document.getElementById('search-bar').value.toLowerCase();
            const container = document.getElementById('productos-container');
            
            const filtered = productosRaw.filter(p => {
                const matchSearch = p.Nombre.toLowerCase().includes(query);
                const matchCat = activeCategory === 'TODOS' || (p.Categoria && p.Categoria.toUpperCase().includes(activeCategory));
                return matchSearch && matchCat && p.Disponible === "SI";
            });

            container.className = "grid grid-cols-2 lg:grid-cols-4 gap-4 col-span-full";
            container.innerHTML = filtered.map(p => {
                const precio = parseFloat(p.Precio) || 0;
                const pDisplay = showInCUP ? `CUP ${(precio * cupRate).toLocaleString()}` : `$${precio}`;
                return `
                <div onclick="openDetail('${p.Nombre.replace(/'/g, "\\'")}')" class="app-card overflow-hidden cursor-pointer active:scale-95 transition-all">
                    <div class="h-40 bg-white p-4 flex items-center justify-center">
                        <img src="${fixDriveUrl(p.Thumbnail)}" class="max-w-full max-h-full object-contain">
                    </div>
                    <div class="p-4">
                        <h3 class="text-[10px] font-black uppercase mb-2 line-clamp-2 h-8">${p.Nombre}</h3>
                        <p class="text-xl font-black text-blue-500">${pDisplay}</p>
                    </div>
                </div>`;
            }).join('');
        }

        function openDetail(name) {
            selectedProduct = productosRaw.find(p => p.Nombre === name);
            const p = selectedProduct;
            if(!p) return;

            document.getElementById('detail-name').innerText = p.Nombre;
            document.getElementById('detail-desc').innerText = p.Descripcion || p.Descripci√≥n || '';
            document.getElementById('detail-price').innerText = `$${p.Precio}`;
            document.getElementById('detail-price-cup').innerText = `/ CUP ${(p.Precio * cupRate).toLocaleString()}`;
            document.getElementById('detail-cat').innerText = p.Categoria || '';
            document.getElementById('detail-warranty').innerText = `Garant√≠a: ${p.Garant√≠a || p.Garantia || 'S/G'}`;
            
            // --- Etiquetas de Env√≠o y Pagos ---
            const oldBadges = document.querySelectorAll('.detail-extra-info');
            oldBadges.forEach(b => b.remove());

            const extraInfo = `
                <div class="detail-extra-info flex flex-wrap gap-2 mb-6">
                    <div class="bg-emerald-500/10 px-3 py-1.5 rounded-xl text-[10px] font-black text-emerald-400 border border-emerald-500/20 uppercase">
                        <i class="fas fa-truck mr-1"></i> Env√≠o: ${p.Mensajeria || p.Mensajer√≠a || 'Consultar'}
                    </div>
                    <div class="bg-purple-500/10 px-3 py-1.5 rounded-xl text-[10px] font-black text-purple-400 border border-purple-500/20 uppercase">
                        <i class="fas fa-credit-card mr-1"></i> Pagos: ${p.Pagos || 'Ver detalles'}
                    </div>
                </div>
            `;
            document.getElementById('detail-warranty').insertAdjacentHTML('afterend', extraInfo);

            document.getElementById('detail-main-img').src = fixDriveUrl(p.Thumbnail);

            // Cargar Miniaturas
            const thumbsContainer = document.getElementById('detail-thumbnails');
            const photos = [p.Thumbnail, p.Image1, p.Image2, p.Image3].filter(url => url && url.length > 5);
            if (photos.length > 1) {
                thumbsContainer.classList.remove('hidden');
                thumbsContainer.innerHTML = photos.map(url => `
                    <img src="${fixDriveUrl(url)}" onclick="document.getElementById('detail-main-img').src=this.src" class="w-14 h-14 object-contain rounded-lg border-2 border-transparent bg-white p-1 cursor-pointer hover:border-blue-500 transition-all">
                `).join('');
            } else { thumbsContainer.classList.add('hidden'); }

            document.getElementById('detail-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // Funci√≥n para convertir texto de mensajer√≠a en n√∫mero
        function parseMensajeria(texto) {
            if (!texto) return 0;
            let t = texto.toString().toLowerCase();
            // Si dice gratis y no menciona precio extra de periferia, es 0
            if (t.includes('gratis') && !t.includes('periferia')) return 0;
            // Busca el primer n√∫mero en el texto (ej: "15 usd" -> 15)
            let match = t.match(/\d+/);
            return match ? parseFloat(match[0]) : 0;
        }

        document.getElementById('checkout-form').onsubmit = function(e) {
            e.preventDefault();
            const btn = document.getElementById('final-submit-btn');
            
            const nombreC = document.getElementById('check-nombre').value;
            const ciC = document.getElementById('check-ci').value;
            const telC = document.getElementById('check-tel').value;
            const dirC = document.getElementById('check-dir').value;
            const monedaC = document.getElementById('check-moneda').value; // <--- CAPTURAR MONEDA
            const valVuelto = document.getElementById('check-vuelto').value;
            const vueltoC = (valVuelto && valVuelto > 0) ? `${valVuelto} (${monedaC.split(' ')[0]})` : "No requiere";
            
            const listaProductos = cart.map(i => `${i.qty}x ${i.Nombre}`).join(', ');

            let precioEquipo = 0, totalMensajeria = 0, totalComision = 0;

            cart.forEach(i => {
                precioEquipo += (Number(i.Precio) * i.qty);
                totalMensajeria += (parseMensajeria(i.Mensajeria || i.Mensajer√≠a) * i.qty);
                if (gestorName) { totalComision += (Number(i.Comision || i['Comisi√≥n'] || 0) * i.qty); }
            });

            const granTotal = precioEquipo + totalMensajeria;
            
            // --- NUEVAS VARIABLES PARA EL MENSAJE ---
            const totalTextoConvertido = document.getElementById('total-convertido').innerText;
            const monedaElegida = document.getElementById('check-moneda').value;

            // Mensaje de WhatsApp corregido
            let msj = `*NUEVO PEDIDO - PARA TU HOGAR*%0A%0A` +
                      `üí™üèªNombre: ${nombreC}%0A` +
                      `üí™üèªCI: ${ciC}%0A` +
                      `üí™üèªTel√©fono: ${telC}%0A` +
                      `üí™üèªDirecci√≥n: ${dirC}%0A%0A` +
                      `üí™üèªProducto: ${listaProductos}%0A` +
                      `üí™üèªTotal a Pagar: *${totalTextoConvertido}*%0A` + // <--- AQU√ç USA EL CONVERTIDO (CUP/EUR)
                      `-Equivalente base: $${granTotal.toFixed(2)} USD%0A` +
                      `-Precio equipo: $${precioEquipo.toFixed(2)}%0A` +
                      `-Mensajer√≠a: $${totalMensajeria.toFixed(2)} (${cart[0].Mensajeria || 'Ver detalles'})%0A%0A` +
                      `üí™üèªM√©todo de Pago: *${monedaElegida}*%0A` + 
                      `üí™üèªVuelto: ${vueltoC}%0A`;

            if (gestorName) { msj += `üí™üèªComisi√≥n: $${totalComision.toFixed(2)}%0A`; }
            msj += `üí™üèªGestor: ${gestorName || 'Directo'}%0A‚òé(${gestorTel || 'Hogar'})`;

            const whatsappUrl = `https://wa.me/5356071095?text=${msj}`;

            window.open(whatsappUrl, '_blank');

            btn.disabled = true; btn.innerText = "REGISTRANDO...";

            fetch(API_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({
                    gestor: gestorName || "Venta Directa",
                    cliente: nombreC,
                    ci: ciC,
                    telefono: telC,
                    direccion: dirC,
                    producto: `${listaProductos} [Pago: ${monedaC}]`, // <--- REGISTRAR EN SHEET
                    total: granTotal,
                    comision: gestorName ? totalComision : 0
                })
            }).then(() => {
                setTimeout(() => { location.reload(); }, 1500);
            }).catch(() => { location.reload(); });
        };

        // --- FUNCIONES AUXILIARES RESTANTES ---
        function fixDriveUrl(url) {
            if (!url) return '';
            if (url.includes('imgur')) return url;
            const id = url.includes('/d/') ? url.split('/d/')[1]?.split('/')[0] : (url.includes('id=') ? url.split('id=')[1] : url);
            return id ? `https://lh3.googleusercontent.com/u/0/d/${id}` : url;
        }
        function toggleCartModal(force) { 
            const m = document.getElementById('cart-modal');
            if(force) m.classList.remove('hidden'); else m.classList.toggle('hidden');
            renderCart();
        }
        function updateCartCount() { document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0); }
        function renderCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = cart.map((item, index) => `
                <div class="flex gap-4 bg-white/5 p-3 rounded-xl relative">
                    <img src="${fixDriveUrl(item.Thumbnail)}" class="w-10 h-10 object-contain bg-white rounded">
                    <div>
                        <h4 class="text-[9px] font-bold uppercase text-slate-300 pr-6">${item.Nombre}</h4>
                        <p class="text-blue-500 font-black">$${item.Precio * item.qty}</p>
                    </div>
                    <button onclick="removeFromCart(${index})" class="absolute right-3 top-3 text-slate-500">√ó</button>
                </div>`).join('');
            
            // Llamamos a la funci√≥n de monedas para que actualice el total
            actualizarOpcionesMoneda(); 
        }
        function removeFromCart(i) { cart.splice(i, 1); updateCartCount(); renderCart(); }
        function addItemToCart() {
            const existing = cart.find(item => item.Nombre === selectedProduct.Nombre);
            if(existing) existing.qty++; else cart.push({...selectedProduct, qty: 1});
            updateCartCount();
            closeDetail();
            toggleCartModal(true);
        }
        function closeDetail() { document.getElementById('detail-modal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
        function toggleCurrency() { showInCUP = !showInCUP; document.getElementById('currency-label').innerText = showInCUP ? 'CUP' : 'USD'; renderProducts(); }
        function filterByCategory(cat) { 
            activeCategory = cat; 
            document.querySelectorAll('.category-pill').forEach(b => b.classList.toggle('active', b.innerText.includes(cat) || (cat==='TODOS' && b.innerText==='Todos')));
            renderProducts(); 
        }
        function showSection(s) {
            document.getElementById('sec-catalogo').classList.toggle('hidden', s!=='catalogo');
            document.getElementById('sec-dashboard').classList.toggle('hidden', s!=='dashboard');
            document.getElementById('tab-cat').classList.toggle('active', s==='catalogo');
            document.getElementById('tab-dash').classList.toggle('active', s==='dashboard');
            if(s==='dashboard') loadFullDashboard();
        }
        async function loadFullDashboard() {
            try {
                const rResp = await fetch(`${API_URL}?action=getRanking&gestor=${encodeURIComponent(gestorName)}&period=${currentPeriod}`);
                const ranking = await rResp.json();
                const sResp = await fetch(`${API_URL}?action=getStats&gestor=${encodeURIComponent(gestorName)}`);
                const stats = await sResp.json();
                const entregados = stats.filter(s => s.Estado === "Entregado");
                document.getElementById('dash-money').innerText = `$${entregados.reduce((a,c) => a + (parseFloat(c.Comision || c['Comisi√≥n'] || 0)), 0)}`;
                document.getElementById('dash-ok').innerText = entregados.length;
                document.getElementById('ranking-list').innerHTML = ranking.map((r, i) => `
                    <div class="flex items-center justify-between p-4 ${r.isMe ? 'bg-blue-600/10' : ''}">
                        <div class="text-[10px] font-bold">#${i+1} ${r.name}</div>
                        <div class="text-blue-400 font-black">$${r.sales}</div>
                    </div>`).join('');
            } catch (e) { console.log(e) }
        }
        function openGestorGen() { document.getElementById('gestor-modal').classList.remove('hidden'); }
        function closeGestorGen() { document.getElementById('gestor-modal').classList.add('hidden'); }
        function processGestor() {
            const pass = document.getElementById('master-pass').value;
            if(pass !== MASTER_KEY) return alert("C√≥digo incorrecto");
            const name = document.getElementById('gen-name').value;
            const tel = document.getElementById('gen-tel').value;
            const base = window.location.origin + window.location.pathname;
            document.getElementById('link-admin').value = `${base}?gestor=${name}&tel=${tel}&admin=true`;
            document.getElementById('link-client').value = `${base}?gestor=${name}&tel=${tel}`;
            document.getElementById('links-result').classList.remove('hidden');
        }
        function copy(id) { const e = document.getElementById(id); e.select(); document.execCommand('copy'); alert("Copiado"); }

        function actualizarOpcionesMoneda() {
            const select = document.getElementById('check-moneda');
            if (cart.length === 0) {
                select.innerHTML = '<option>Carrito vac√≠o</option>';
                return;
            }

            // Tomamos las opciones de pago del primer producto en el carrito
            // (Asumimos que los t√©rminos de pago son similares para la orden)
            const pagosTexto = cart[0].Pagos || "USD, Zelle, CUP";
            const opciones = pagosTexto.split(',').map(opt => opt.trim());

            select.innerHTML = opciones.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }

        // NUEVA FUNCI√ìN 1: Hace la cuenta matem√°tica
function recalcularTotalFinal() {
    const select = document.getElementById('check-moneda');
    // Calculamos el total base en USD incluyendo mensajer√≠a
    const totalUSD = cart.reduce((acc, item) => acc + (Number(item.Precio) * item.qty) + (parseMensajeria(item.Mensajeria || item.Mensajer√≠a) * item.qty), 0);
    
    const opcionElegida = select.value || "USD";
    let totalFinal = totalUSD;
    let simbolo = "$";

    if (opcionElegida.toUpperCase().includes("CUP")) {
        let tasaFinal = cupRate; // cupRate es el valor del Sheet (ej: 450)

        if (opcionElegida.includes("+")) {
            // L√≥gica para "CUP +10": Toma la tasa del d√≠a y le suma el n√∫mero encontrado
            const incrementoMatch = opcionElegida.match(/\d+/);
            const incremento = incrementoMatch ? parseFloat(incrementoMatch[0]) : 0;
            tasaFinal = cupRate + incremento;
        } else {
            // L√≥gica para tasa fija tipo "CUP 470":
            const tasaFijaMatch = opcionElegida.match(/\d+/);
            if (tasaFijaMatch) {
                const valorExtraido = parseFloat(tasaFijaMatch[0]);
                // Si el n√∫mero es grande (ej: 470), es una tasa fija. 
                // Si es peque√±o (ej: 10), probablemente falt√≥ el '+' pero lo usamos como tasa fija si as√≠ viene en el sheet.
                tasaFinal = valorExtraido; 
            }
        }
        
        totalFinal = totalUSD * tasaFinal;
        simbolo = "CUP";
    } 
    else if (opcionElegida.toLowerCase().includes("euro")) {
        // L√≥gica Euro: Si dice 1.05 aplica divisi√≥n, sino 1x1
        if (opcionElegida.includes("1.05")) { 
            totalFinal = totalUSD / 1.05; 
        }
        simbolo = "‚Ç¨";
    }

    // Actualizar los textos en el modal
    document.getElementById('cart-total').innerText = `$${totalUSD.toFixed(2)} USD`;
    document.getElementById('total-convertido').innerText = `${simbolo} ${totalFinal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

// NUEVA FUNCI√ìN 2: Llena el selector con lo que dice tu Excel
function actualizarOpcionesMoneda() {
    const select = document.getElementById('check-moneda');
    if (!select || cart.length === 0) return;

    // Leemos la columna "Pagos" del primer producto del carrito
    const pagosTexto = cart[0].Pagos || "USD, Zelle, CUP efectivo 470";
    const opciones = pagosTexto.split(',').map(opt => opt.trim());

    // Metemos las opciones en el <select>
    select.innerHTML = opciones.map(opt => `<option value="${opt}">${opt}</option>`).join('');
    
    // Le decimos que cuando el usuario cambie la opci√≥n, recalcule el total
    select.onchange = recalcularTotalFinal;
    
    // Calculamos el total por primera vez
    recalcularTotalFinal();
}
    </script>
</body>
</html>