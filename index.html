<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>paratuhogar | Electrodom√©sticos para Cuba</title>
    
    <!-- 1. Estilos y Fuentes -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- 2. Librer√≠as de Funcionalidad (Supabase, Excel, Editor) -->
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- Quill (Editor de Texto) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- 4. JSZip (Para descargar packs de fotos) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 5. jsPDF (Generador de PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- 3. Configuraci√≥n de Dise√±o (ANEB Theme) -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1a4789", // Azul ANEB
                        "secondary": "#2c6fb5", // Azul Claro
                        "accent": "#cbd5e1", 
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .wave-bg {
                background-color: #1a4789;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3%3Cpath fill='%232c6fb5' fill-opacity='0.4' d='M0,192L48,176C96,160,192,128,288,112C384,96,480,96,576,122.7C672,149,768,203,864,202.7C960,203,1056,149,1152,117.3C1248,85,1344,75,1392,69.3L1440,64L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z'%3E%3C/path%3E%3Cpath fill='%23ffffff' fill-opacity='0.1' d='M0,64L48,80C96,96,192,128,288,128C384,128,480,96,576,106.7C672,117,768,171,864,170.7C960,171,1056,117,1152,106.7C1248,96,1344,128,1392,144L1440,160L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z'%3E%3C/path%3E%3C/svg%3E");
                background-size: cover;
                background-position: top;
            }
            .wave-divider {
                height: 40px;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 100' preserveAspectRatio='none'%3%3Cpath fill='%231a4789' d='M0,32L60,42.7C120,53,240,75,360,74.7C480,75,600,53,720,48C840,43,960,53,1080,58.7C1200,64,1320,64,1380,64L1440,64L1440,0L1380,0C1320,0,1200,0,1080,0C960,0,840,0,720,0C600,0,480,0,360,0C240,0,120,0,60,0L0,0Z'%3E%3C/path%3E%3C/svg%3E");
                background-size: 100% 100%;
            }
        }
        body { font-family: 'Manrope', sans-serif; -webkit-font-smoothing: antialiased; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; display: inline-block; vertical-align: middle; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .category-tab.active { border-bottom: 3px solid #1a4789; color: #1a4789; }
        .loader { width: 40px; height: 40px; border: 4px solid #1a4789; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ESTILOS DEL EDITOR WORD */
        .ql-container { height: 200px; font-family: 'Manrope', sans-serif; font-size: 14px; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
        .ql-toolbar { border-top-left-radius: 12px; border-top-right-radius: 12px; background: #f9fafb; }
        
        /* CORRECCIONES M√ìVIL */
        @media (max-width: 768px) {
            #sec-admin-master .grid-cols-1, #sec-admin-master .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; gap: 8px !important; }
            .overflow-x-auto { margin: 0 -15px; padding: 0 15px; }
            table { min-width: 500px !important; }
            #list-admin-inventario { display: grid !important; grid-template-columns: repeat(2, minmax(0, 1fr)) !important; gap: 10px !important; }
            #list-admin-inventario img { height: 100px !important; }
        }

        /* Estilos recuperados para el Panel Admin */
        .btn-tab-admin.active { 
            background-color: #1a4789; 
            color: white !important; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        }
        .btn-tab-admin {
            color: #94a3b8; /* Gris suave inactivo */
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-[#121717] dark:text-gray-100">

    <!-- Header / Navbar -->
    <!-- Header con Dise√±o Wave -->
<header class="sticky top-0 z-50 w-full wave-bg px-4 md:px-10 lg:px-20 py-3 shadow-lg">
    <div class="flex items-center justify-between gap-4 max-w-[1200px] mx-auto">
        <!-- Logo -->
        <div class="flex items-center gap-8">
            <div class="flex items-center gap-2">
                <div class="text-white"><span class="material-symbols-outlined text-3xl">home_iot_device</span></div>
                <h1 class="text-white text-xl font-extrabold tracking-tight">para<span class="text-slate-200">tuhogar</span></h1>
            </div>
            
            <!-- Barra de B√∫squeda (Estilo Transparente) -->
            <div class="hidden md:flex">
                <label class="flex flex-col min-w-64 !h-10">
                    <div class="flex w-full flex-1 items-stretch rounded-lg h-full overflow-hidden border border-white/20 bg-white/10 backdrop-blur-sm">
                        <div class="text-white/80 flex items-center justify-center pl-4">
                            <span class="material-symbols-outlined text-xl">search</span>
                        </div>
                        <input id="search-bar" oninput="filterProducts()" type="text" class="form-input flex w-full min-w-0 flex-1 border-none bg-transparent text-white focus:ring-0 h-full placeholder:text-white/60 px-3 text-sm font-normal" placeholder="Buscar refrigerador, split..." />
                    </div>
                </label>
            </div>
        </div>

        <!-- Botones de Acci√≥n (Carrito, Login, Moneda) -->
        <div class="flex items-center gap-2 md:gap-4">
            <!-- Selector Moneda -->
            <button onclick="toggleCurrency()" class="h-10 px-3 rounded-lg bg-white/10 text-white border border-white/20 text-xs font-bold hover:bg-white/20 transition-all">
                <span id="currency-label">USD</span>
            </button>
            
            <!-- Carrito -->
            <button onclick="toggleCartModal(true)" class="relative flex items-center justify-center rounded-lg h-10 w-10 bg-white/20 text-white hover:bg-white/30 transition-all">
                <span class="material-symbols-outlined">shopping_cart</span>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold w-4 h-4 rounded-full flex items-center justify-center border border-white">0</span>
            </button>

            <!-- Configuraci√≥n / Gestor -->
            <button id="btn-open-gen" onclick="openGestorGen()" class="hidden flex items-center justify-center rounded-lg h-10 w-10 bg-white/10 text-white hover:bg-white/20 transition-all">
                <span class="material-symbols-outlined">settings</span>
            </button>

            <!-- Bot√≥n Salir (Logout) -->
            <button onclick="doLogout()" id="btn-logout" class="hidden flex items-center justify-center rounded-lg h-10 w-10 bg-red-500/80 text-white hover:bg-red-500 transition-all" title="Cerrar Sesi√≥n">
                <span class="material-symbols-outlined">logout</span>
            </button>
            
            <!-- Nombre Agente -->
            <p id="gestor-label" class="hidden lg:block text-[10px] font-bold text-white uppercase tracking-widest border-l pl-3 ml-1 border-white/20"></p>
        </div>
    </div>
</header>

    <main class="max-w-[1200px] mx-auto pb-20">
        
        <!-- 1. NAVEGACI√ìN ADMIN (Fuera de los contenedores para que nunca desaparezca) -->
        <nav id="admin-nav" class="hidden px-6 max-w-[1200px] mx-auto mt-4 flex gap-2">
            <button onclick="showSection('catalogo')" id="tab-cat" class="flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-primary text-white">Cat√°logo</button>
            <button onclick="showSection('dashboard')" id="tab-dash" class="flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-gray-100 text-gray-400">Mi Dashboard</button>
        </nav>

        <!-- 2. CONTENEDOR DEL CAT√ÅLOGO (Solo envuelve cosas del cat√°logo) -->
        <div id="sec-catalogo">
            <!-- Hero Section -->
            <section class="px-6 py-10 lg:py-16">
                <div class="max-w-2xl">
                    <h2 class="text-4xl lg:text-5xl font-black leading-tight mb-4">Equipos para tu familia en Cuba</h2>
                    <p class="text-gray-500 dark:text-gray-400 text-lg">Cat√°logo optimizado. Ordena por WhatsApp y paga al recibir en la puerta de tu casa.</p>
                    <div class="flex gap-3 mt-6">
                        <span class="flex items-center gap-1.5 px-3 py-1 bg-primary/10 text-primary rounded-full text-xs font-bold"><span class="material-symbols-outlined text-sm">bolt</span> Entrega 24-48h</span>
                        <span class="flex items-center gap-1.5 px-3 py-1 bg-primary/10 text-primary rounded-full text-xs font-bold"><span class="material-symbols-outlined text-sm">verified_user</span> Garant√≠a Real</span>
                    </div>
                </div>
            </section>

            <!-- Category Tabs (Sticky) & Marketing Bar -->
            <div class="sticky top-[65px] z-40 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur shadow-sm border-b border-gray-200 dark:border-gray-800">
                
                <!-- 1. Lista de Categor√≠as (Se llena sola con JS) -->
                <div id="category-list" class="flex gap-8 px-6 overflow-x-auto whitespace-nowrap scrollbar-hide">
                    <!-- El JS inyectar√° los botones aqu√≠ -->
                    <span class="py-4 text-xs text-gray-400">Cargando categor√≠as...</span>
                </div>

                <!-- 2. BARRA DE MARKETING (Solo para Gestores) -->
                <!-- Esta barra aparecer√° debajo de las categor√≠as cuando entres como gestor -->
                <!-- 2. BARRA DE MARKETING PRO (Solo para Gestores) -->
            <!-- === CENTRO DE MANDO GESTOR (DISE√ëO UNIFICADO) === -->
            <div id="gestor-command-center" class="hidden max-w-[1200px] mx-auto px-4 md:px-6 py-4">
                
                <div class="bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-2xl shadow-lg shadow-slate-200/50 dark:shadow-none p-3 flex flex-col xl:flex-row gap-4 items-center justify-between">
                    
                    <!-- 1. IZQUIERDA: Contexto -->
                    <div class="flex items-center gap-3 w-full xl:w-auto border-b xl:border-b-0 border-slate-100 dark:border-slate-800 pb-3 xl:pb-0">
                        <div class="bg-indigo-50 text-indigo-600 p-2 rounded-xl">
                            <span class="material-symbols-outlined text-xl">campaign</span>
                        </div>
                        <div>
                            <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Zona de Difusi√≥n</p>
                            <p class="text-sm font-bold text-primary dark:text-white" id="marketing-cat-label">TODOS</p>
                        </div>
                    </div>

                    <!-- 2. CENTRO: Filtros y Switches (Aqu√≠ eliminamos la redundancia) -->
                    <div class="flex items-center gap-4 bg-slate-50 dark:bg-slate-800/50 px-4 py-2 rounded-xl w-full xl:w-auto justify-center">
                        
                        <!-- Selector de Orden (Integrado) -->
                        <div class="flex items-center gap-2 border-r border-slate-200 dark:border-slate-700 pr-4">
                            <span class="text-[10px] font-black uppercase text-slate-400 hidden sm:block">Ordenar:</span>
                            <select id="sort-selector" onchange="applySort()" class="bg-transparent border-none text-xs font-bold text-slate-700 dark:text-slate-200 focus:ring-0 p-0 cursor-pointer">
                                <option value="defecto">Relevancia</option>
                                <option value="comision_desc">üí∞ Mayor Ganancia</option>
                                <option value="precio_asc">üí≤ Precio: Bajo</option>
                                <option value="nuevo">üÜï Lo Nuevo</option>
                            </select>
                        </div>

                        <!-- Switch "Modo Tibur√≥n" (Reemplaza al checkbox feo) -->
                        <label class="flex items-center gap-2 cursor-pointer select-none group">
                            <div class="relative">
                                <input type="checkbox" id="filter-high-comm" onchange="renderProducts()" class="sr-only peer">
                                <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500"></div>
                            </div>
                            <span class="text-[10px] font-black uppercase text-slate-500 group-hover:text-emerald-600 transition-colors">Ganancia > $10</span>
                        </label>
                    </div>

                    <!-- 3. DERECHA: Botones de Acci√≥n (Iconos limpios) -->
                    <div class="flex gap-2 w-full xl:w-auto">

                        <!-- 1. AQU√ç INYECTAREMOS EL BOT√ìN FLASH (Bloqueado o Desbloqueado) -->
                        <div id="container-flash-btn"></div>

                        <button onclick="copyCategoryOffers()" class="flex-1 xl:flex-none py-2.5 px-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-indigo-500 hover:text-indigo-600 hover:bg-indigo-50 transition-all flex items-center justify-center gap-2 text-slate-600 dark:text-slate-300 text-xs font-bold" title="Copiar Lista Texto">
                            <span class="material-symbols-outlined text-lg">content_copy</span> <span class="hidden sm:inline">Texto</span>
                        </button>
                        
                        <button onclick="downloadCategoryPhotos()" class="flex-1 xl:flex-none py-2.5 px-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-indigo-500 hover:text-indigo-600 hover:bg-indigo-50 transition-all flex items-center justify-center gap-2 text-slate-600 dark:text-slate-300 text-xs font-bold" title="Descargar Fotos ZIP">
                            <span class="material-symbols-outlined text-lg">folder_zip</span> <span class="hidden sm:inline">Fotos</span>
                        </button>
                        
                        <button onclick="downloadCatalogPDF()" class="flex-1 xl:flex-none py-2.5 px-4 rounded-xl bg-red-50 text-red-500 border border-red-100 hover:bg-red-500 hover:text-white transition-all flex items-center justify-center gap-2 text-xs font-bold shadow-sm" title="Descargar PDF">
                            <span class="material-symbols-outlined text-lg">picture_as_pdf</span> <span>PDF</span>
                        </button>
                    </div>

                </div>
            </div>

                <!-- 3. Filtros de Ordenamiento (Ya lo ten√≠as, lo mantenemos aqu√≠) -->
                <div id="gestor-filters" class="hidden px-6 py-2 flex items-center justify-end bg-gray-50 dark:bg-gray-900/50">
                    <div class="flex items-center gap-2">
                        <span class="text-[9px] font-black uppercase text-gray-400">Ordenar:</span>
                        <select id="sort-selector" onchange="applySort()" class="bg-transparent border-none text-[10px] font-bold text-gray-600 dark:text-gray-300 focus:ring-0 p-0 cursor-pointer">
                            <option value="defecto">Relevancia</option>
                            <option value="comision_desc">üí∞ Mayor Ganancia</option>
                            <option value="precio_asc">üí≤ Precio: Bajo a Alto</option>
                            <option value="nuevo">üÜï Lo Nuevo</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Product Grid -->
            <section id="productos-container" class="px-6 py-8 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 lg:gap-8">
                <div class="col-span-full py-20 text-center"><span class="loader"></span></div>
            </section>
        </div> <!-- FIN sec-catalogo -->

        <!-- 3. SECCI√ìN DASHBOARD (Independiente) -->
        <section id="sec-dashboard" class="hidden px-6 py-8 space-y-6">
            <!-- BLOQUE FINANCIERO DESGLOSADO -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 1. Por Cobrar (Pendiente) -->
                <div class="bg-orange-500 p-8 rounded-3xl text-white shadow-xl shadow-orange-500/20 relative overflow-hidden">
                    <p class="text-[10px] font-black uppercase opacity-80 mb-1 italic">Por Cobrar (Acumulado)</p>
                    <h2 id="dash-money-pending" class="text-4xl font-black italic">$0.00</h2>
                    <p class="text-[9px] font-bold mt-2 opacity-70">Esperando liquidaci√≥n del Admin</p>
                    <span class="material-symbols-outlined absolute -right-4 -bottom-4 text-8xl opacity-10">pending_actions</span>
                </div>

                <!-- 2. Cobrado (Liquidado) -->
                <div class="bg-emerald-500 p-8 rounded-3xl text-white shadow-xl shadow-emerald-500/20 relative overflow-hidden">
                    <p class="text-[10px] font-black uppercase opacity-80 mb-1 italic">Dinero Cobrado (Hist√≥rico)</p>
                    <h2 id="dash-money-paid" class="text-4xl font-black italic">$0.00</h2>
                    <p class="text-[9px] font-bold mt-2 opacity-70">Pagos recibidos exitosamente</p>
                    <span class="material-symbols-outlined absolute -right-4 -bottom-4 text-8xl opacity-10">savings</span>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-2xl border border-gray-100 dark:bg-gray-800">
                    <p class="text-[9px] font-black text-gray-400 uppercase">Pedidos Entregados</p>
                    <p id="dash-ok" class="text-2xl font-black text-primary">0</p>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-gray-100 dark:bg-gray-800">
                    <p class="text-[9px] font-black text-gray-400 uppercase">Pedidos Pendientes</p>
                    <p id="dash-pending" class="text-2xl font-black text-orange-500">0</p>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-700 overflow-hidden">
                <div class="p-6 border-b border-gray-50 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-xs font-black uppercase tracking-widest text-gray-500">Ranking de Agentes</h3>
                </div>
                <div id="ranking-list" class="divide-y divide-gray-50 dark:divide-gray-700"></div>
                <!-- === NUEVA SECCI√ìN: HISTORIAL DETALLADO DE PEDIDOS === -->
                <div class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-700 shadow-sm mt-6 overflow-hidden">
                    <div class="p-6 border-b border-gray-50 dark:border-gray-700 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h3 class="text-sm font-black uppercase text-primary italic">üìã Mis Pedidos Recientes</h3>
                            <p class="text-[10px] text-gray-400">Monitorea el estado log√≠stico de tus ventas en tiempo real.</p>
                        </div>
                        
                        <!-- Buscador interno -->
                        <div class="w-full md:w-auto relative">
                            <span class="material-symbols-outlined absolute left-3 top-2.5 text-gray-400 text-sm">search</span>
                            <input type="text" id="search-mi-historial" oninput="filterMyOrders()" placeholder="Buscar cliente..." class="w-full md:w-64 pl-9 pr-4 py-2 rounded-xl bg-gray-50 dark:bg-gray-900 border-none text-xs font-bold">
                        </div>
                    </div>

                    <!-- Encabezados de tabla (oculto en m√≥vil) -->
                    <div class="hidden md:grid grid-cols-12 gap-4 p-4 bg-gray-50/50 dark:bg-gray-900/30 text-[9px] font-black uppercase text-gray-400 border-b dark:border-gray-700">
                        <div class="col-span-3">Fecha / Cliente</div>
                        <div class="col-span-4">Producto</div>
                        <div class="col-span-2 text-right">Monto</div>
                        <div class="col-span-3 text-right">Estado Actual</div>
                    </div>

                    <!-- Lista de Pedidos -->
                    <div id="list-mis-pedidos" class="divide-y divide-gray-50 dark:divide-gray-700 max-h-[500px] overflow-y-auto">
                        <!-- Se llena con JS -->
                        <div class="p-8 text-center text-gray-400 text-xs">Cargando historial...</div>
                    </div>
                </div>
            </div>


            <!-- === M√ìDULO DE INTELIGENCIA Y REPORTES (Nuevo) === -->
<div class="space-y-6 mt-8">
    
    <!-- 1. ANAL√çTICA DE VENTAS (Tus horas pico y tendencias) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border border-gray-100 dark:border-gray-700">
            <h4 class="text-xs font-black uppercase text-gray-400 mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">schedule</span> Tu Mejor Horario
            </h4>
            <p id="ana-hora-pico" class="text-2xl font-black text-primary">--:--</p>
            <p class="text-[10px] text-gray-400">Hora donde m√°s cierras ventas.</p>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border border-gray-100 dark:border-gray-700">
            <h4 class="text-xs font-black uppercase text-gray-400 mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">trending_up</span> Tendencia Global
            </h4>
            <div id="ana-tendencia-global" class="text-sm font-bold text-gray-600 dark:text-gray-300">
                Cargando datos del mercado...
            </div>
        </div>
    </div>

    <!-- 2. BUZ√ìN DE INTELIGENCIA (Reportes) -->
    <div class="bg-indigo-50 dark:bg-gray-800/50 p-6 rounded-3xl border border-indigo-100 dark:border-gray-700">
        <div class="flex items-center gap-2 mb-4">
            <span class="material-symbols-outlined text-indigo-500">campaign</span>
            <h3 class="text-sm font-black uppercase text-indigo-900 dark:text-white">Buz√≥n de Inteligencia</h3>
        </div>
        <p class="text-xs text-indigo-700 dark:text-gray-400 mb-4">Ay√∫danos a mejorar. Reporta precios de competencia, pide productos o reporta fallos.</p>
        
        <form id="form-reporte-gestor" class="space-y-3">
            <select id="rep-tipo" class="w-full rounded-xl border-none bg-white dark:bg-gray-900 text-xs font-bold p-3">
                <option value="Solicitud">üì¶ Solicitar Producto (Demanda)</option>
                <option value="Competencia">üïµÔ∏è Reporte Competencia (Precios)</option>
                <option value="Problema">‚ö†Ô∏è Problema / Mensajer√≠a</option>
                <option value="Sugerencia">üí° Sugerencia General</option>
            </select>
            
            <textarea id="rep-msg" placeholder="Describe el detalle..." class="w-full rounded-xl border-none bg-white dark:bg-gray-900 text-xs p-3 h-20"></textarea>
            
            <!-- Subida de Foto Simple -->
            <div class="flex items-center gap-2">
                <label class="flex items-center gap-2 bg-white dark:bg-gray-900 px-4 py-2 rounded-xl cursor-pointer border border-dashed border-gray-300">
                    <span class="material-symbols-outlined text-gray-400 text-sm">add_a_photo</span>
                    <span class="text-[10px] font-bold text-gray-500 uppercase">Adjuntar Foto</span>
                    <input type="file" id="rep-file" accept="image/*" class="hidden" onchange="previewReportImg()">
                </label>
                <span id="rep-file-name" class="text-[10px] text-gray-400 truncate max-w-[150px]"></span>
            </div>

            <button type="button" onclick="sendGestorReport()" class="w-full bg-indigo-500 text-white py-3 rounded-xl font-black text-xs uppercase shadow-lg shadow-indigo-500/20">Enviar Informe</button>
        </form>
    </div>
</div>


        </section>

    </main>

    <!-- MODAL DETALLE (ESTILO IMAGEN) -->
    <div id="detail-modal" class="fixed inset-0 z-[100] hidden bg-black/60 backdrop-blur-sm p-2 md:p-4 overflow-y-auto flex justify-center items-start md:items-center">
        <div class="bg-white dark:bg-background-dark w-full max-w-6xl rounded-3xl overflow-hidden shadow-2xl flex flex-col lg:flex-row relative">
            <button onclick="closeDetail()" class="absolute top-4 right-4 z-10 p-2 bg-gray-100 dark:bg-gray-800 rounded-full hover:rotate-90 transition-transform">
                <span class="material-symbols-outlined">close</span>
            </button>

            <!-- Imagen Izquierda -->
            <div class="lg:w-1/2 bg-white flex flex-col items-center border-r border-gray-100 dark:border-gray-800">
                <div class="w-full p-4 flex items-center justify-center bg-white min-h-[300px] max-h-[500px]">
                    <img id="detail-main-img" src="" class="w-full h-full object-contain">
                </div>
                <div id="detail-thumbnails" class="flex gap-2 overflow-x-auto scrollbar-hide px-4 pb-4"></div>
                <p class="mb-4 text-[10px] text-gray-400 flex items-center gap-1 uppercase tracking-widest px-4 text-center">
                    <span class="material-symbols-outlined text-sm">info</span> Imagen real del equipo en almac√©n
                </p>
            </div>

            <!-- Info Derecha -->
            <div class="lg:w-1/2 p-8 lg:p-12 flex flex-col">
                <div class="flex items-center gap-3 mb-2">
                    <span class="bg-primary/10 text-primary px-2.5 py-1 rounded-full text-[10px] font-black uppercase">En Stock</span>
                    <span id="detail-cat" class="text-[10px] text-gray-400 font-bold uppercase"></span>
                </div>
                <h2 id="detail-name" class="text-3xl font-black mb-4"></h2>
                
                <div class="flex items-baseline gap-4 mb-8">
                    <span id="detail-price" class="text-4xl font-black text-primary"></span>
                    <span id="detail-price-cup" class="text-lg text-gray-400"></span>
                </div>

                <!-- Specs Grid -->
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-700">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Garant√≠a</p>
                        <p id="detail-warranty" class="font-bold text-sm"></p>
                    </div>
                    <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-700">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Mensajer√≠a</p>
                        <p id="detail-shipping" class="font-bold text-sm"></p>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xs font-black uppercase text-gray-400 mb-3 tracking-widest">Descripci√≥n</h3>
                    <p id="detail-desc" class="text-sm leading-relaxed text-gray-600 dark:text-gray-400"></p>
                </div>

                <!-- WhatsApp Actions -->
                <!-- ACCIONES DEL GESTOR -->
<div class="mt-auto space-y-3 pt-4 border-t border-gray-100 dark:border-gray-700">
    
    <!-- Fila 1: Herramientas de Marketing (Descargar y Copiar) -->
    <div class="flex gap-3">
        <button onclick="downloadProductImage()" class="flex-1 py-3 bg-white border-2 border-gray-100 dark:bg-gray-800 dark:border-gray-700 rounded-xl font-bold text-[10px] uppercase flex flex-col items-center justify-center hover:border-primary hover:text-primary transition-all text-gray-500 gap-1">
            <span class="material-symbols-outlined text-xl">download</span>
            Descargar Foto
        </button>
        
        <button onclick="copySmartOffer()" class="flex-1 py-3 bg-white border-2 border-gray-100 dark:bg-gray-800 dark:border-gray-700 rounded-xl font-bold text-[10px] uppercase flex flex-col items-center justify-center hover:border-primary hover:text-primary transition-all text-gray-500 gap-1">
            <span class="material-symbols-outlined text-xl">content_copy</span>
            Copiar Oferta
        </button>

        <!-- Bot√≥n Story -->
        <button onclick="generateStoryImage()" class="flex-1 py-3 bg-gradient-to-br from-pink-500 to-orange-400 text-white border-none rounded-xl font-bold text-[10px] uppercase flex flex-col items-center justify-center hover:opacity-90 transition-all gap-1 shadow-lg shadow-pink-500/20">
            <span class="material-symbols-outlined text-xl">fit_screen</span>
            Crear Story
        </button>
    </div>

    <!-- Fila 2: ACCI√ìN PRINCIPAL (Hacer la Orden) -->
    <!-- Este bot√≥n mantiene la funci√≥n addItemToCart() para seguir el flujo normal de venta -->
    <button onclick="addItemToCart()" class="w-full bg-[#25D366] hover:bg-[#20bd5c] text-white py-4 rounded-xl font-black text-sm uppercase tracking-widest flex items-center justify-center gap-2 transition-all shadow-lg shadow-green-500/20 active:scale-95">
        <span class="material-symbols-outlined text-2xl">shopping_cart_checkout</span>
        <span>A√±adir a la Orden / Tramitar</span>
    </button>
    
</div>
            </div>
        </div>
    </div>

    <!-- MODAL CARRITO / FORMULARIO -->
    <div id="cart-modal" class="fixed inset-0 z-[110] hidden bg-black/80 flex justify-end">
        <div class="bg-white dark:bg-background-dark w-full max-w-md h-full shadow-2xl flex flex-col p-6 animate-slide-left">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-black uppercase italic text-primary">Mi Pedido</h2>
                <button onclick="toggleCartModal(false)" class="p-2 bg-gray-100 rounded-full"><span class="material-symbols-outlined">close</span></button>
            </div>
            
            <div id="cart-items" class="flex-1 overflow-y-auto space-y-4 mb-6 scrollbar-hide"></div>

            <div class="border-t pt-6 mb-6">
                <div class="flex justify-between items-end mb-4">
                    <span class="text-gray-400 font-bold uppercase text-xs">Total a Pagar</span>
                    <div class="text-right">
                        <p id="cart-total" class="text-gray-400 text-xs line-through">$0.00</p>
                        <p id="total-convertido" class="text-3xl font-black text-primary">$0.00</p>
                    </div>
                </div>

                <form id="checkout-form" class="space-y-4">
                    <input type="text" id="check-nombre" placeholder="Nombre completo" class="w-full rounded-xl border-gray-200 dark:bg-gray-800 dark:border-gray-700" required>
                    <div class="flex gap-2">
                        <input type="text" id="check-ci" placeholder="Carnet (CI)" class="w-full rounded-xl border-gray-200 dark:bg-gray-800 dark:border-gray-700" required>
                        <input type="tel" id="check-tel" placeholder="Tel√©fono" class="w-full rounded-xl border-gray-200 dark:bg-gray-800 dark:border-gray-700" required>
                    </div>
                    <textarea id="check-dir" placeholder="Direcci√≥n de entrega" class="w-full rounded-xl border-gray-200 dark:bg-gray-800 dark:border-gray-700 h-20" required></textarea>
                    
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl space-y-3">
                        <div>
                            <label class="text-[10px] font-black uppercase text-gray-400">M√©todo de Pago</label>
                            <select id="check-moneda" class="w-full bg-transparent border-none font-bold text-sm p-0 focus:ring-0"></select>
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-gray-400">Vuelto (Monto exacto)</label>
                            <input type="number" id="check-vuelto" placeholder="Ej: 50" class="w-full bg-transparent border-none font-bold text-sm p-0 focus:ring-0">
                        </div>
                    </div>

                    <button type="submit" id="final-submit-btn" class="w-full bg-primary text-white py-4 rounded-xl font-black uppercase tracking-widest shadow-lg shadow-primary/20 transition-all active:scale-95">Tramitar Pedido</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL GESTORES ACTUALIZADO CON ACCESO MASTER -->
<div id="gestor-modal" class="fixed inset-0 z-[200] hidden bg-black/90 p-6 flex items-center justify-center">
    <div class="bg-white dark:bg-background-dark w-full max-w-sm rounded-3xl p-8 space-y-4">
        <h2 class="text-xl font-black uppercase text-primary text-center">Zona de Agentes</h2>
        <input type="password" id="master-pass" placeholder="C√≥digo Maestro" class="w-full rounded-xl border-gray-200">
        <input type="text" id="gen-name" placeholder="Tu Nombre" class="w-full rounded-xl border-gray-200">
        <input type="tel" id="gen-tel" placeholder="WhatsApp" class="w-full rounded-xl border-gray-200">
        <button onclick="processGestor()" class="w-full bg-primary text-white py-3 rounded-xl font-bold uppercase italic">Generar Enlaces</button>
        
        <div id="links-result" class="hidden space-y-4 pt-4 border-t border-gray-100">
            <!-- Link Privado -->
            <div>
                <p class="text-[9px] font-black text-red-500 uppercase mb-1">‚óè Mi Panel Privado (Solo para ti)</p>
                <input type="text" id="link-admin" readonly class="w-full text-[10px] bg-gray-100 p-2 rounded border-none">
                <button onclick="copy('link-admin')" class="text-[10px] font-bold text-primary mt-1">COPIAR LINK PRIVADO</button>
            </div>
            <!-- Link P√∫blico -->
            <div>
                <p class="text-[9px] font-black text-gray-400 uppercase mb-1">‚óè Link P√∫blico (Para enviar a clientes)</p>
                <input type="text" id="link-client" readonly class="w-full text-[10px] bg-gray-100 p-2 rounded border-none">
                <button onclick="copy('link-client')" class="text-[10px] font-bold text-primary mt-1">COPIAR LINK CLIENTE</button>
            </div>
        </div>

        <!-- SECCI√ìN DE CIERRE Y ACCESO SECRETO -->
        <div class="flex flex-col gap-2 pt-4 border-t border-gray-100">
            <button onclick="closeGestorGen()" class="w-full text-gray-400 text-[10px] font-black uppercase tracking-widest">Cerrar Ventana</button>
            
            <!-- BOT√ìN SECRETO PARA EL DUE√ëO -->
            <button onclick="openAdminMasterFromGestor()" class="w-full text-primary/30 hover:text-primary text-[8px] font-black uppercase tracking-[0.2em] mt-4 transition-all">
                ‚óè Acceso Administraci√≥n Central
            </button>
        </div>
    </div>
</div>

<section id="sec-admin-master" class="hidden px-4 md:px-10 lg:px-20 py-10 max-w-[1400px] mx-auto bg-gray-50 dark:bg-background-dark min-h-screen">
    
    <!-- Encabezado -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
        <div>
            <h2 class="text-3xl font-black text-gray-900 dark:text-white uppercase tracking-tighter italic">Master<span class="text-primary">Control</span></h2>
            <p class="text-gray-500 text-[10px] font-black uppercase tracking-widest">Gesti√≥n de Log√≠stica y Finanzas</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-2xl flex items-center gap-3 border px-4">
    <div class="flex flex-col">
        <span class="text-[8px] font-black text-gray-400 uppercase tracking-widest">Tasa del D√≠a</span>
        <div class="flex items-center gap-1">
            <span class="text-xs text-gray-400">$1 =</span>
            <!-- ID cambiado a 'daily-rate' -->
            <input type="number" id="daily-rate" value="450" onchange="updateGlobalRate(this.value)" class="w-12 bg-transparent border-none font-black text-primary p-0 focus:ring-0 text-xl text-right">
            <span class="text-xs font-bold text-gray-400">CUP</span>
        </div>
    </div>
</div>
            <button onclick="location.reload()" class="p-4 bg-red-50 text-red-500 rounded-2xl hover:bg-red-500 hover:text-white transition-all">
                <span class="material-symbols-outlined">power_settings_new</span>
            </button>
        </div>
    </div>

    <!-- Indicadores -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-8">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">Ventas Entregadas</p>
            <h3 id="m-stat-ventas" class="text-3xl font-black text-primary">$0</h3>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">Comisiones x Pagar</p>
            <h3 id="m-stat-deuda" class="text-3xl font-black text-orange-500">$0</h3>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">En Log√≠stica</p>
            <h3 id="m-stat-pendientes" class="text-3xl font-black text-gray-800 dark:text-white">0</h3>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">Gestores Activos</p>
            <h3 id="m-stat-gestores" class="text-3xl font-black text-blue-500">0</h3>
        </div>
    </div>

    <!-- Pesta√±as -->
    <div class="flex gap-2 mb-6 bg-white dark:bg-gray-800 p-2 rounded-2xl border shadow-sm overflow-x-auto scrollbar-hide whitespace-nowrap">
        <button onclick="changeAdminTab('logistica')" id="tab-logistica" class="btn-tab-admin active flex-1 py-3 rounded-xl text-xs font-black uppercase italic tracking-widest transition-all">Log√≠stica</button>
        <button onclick="changeAdminTab('pagos')" id="tab-pagos" class="btn-tab-admin flex-1 py-3 rounded-xl text-xs font-black uppercase italic tracking-widest transition-all text-gray-400">Corte S√°bado</button>
        <button onclick="changeAdminTab('inventario')" id="tab-inventario" class="btn-tab-admin flex-1 py-3 rounded-xl text-xs font-black uppercase italic tracking-widest transition-all text-gray-400">Inventario</button>
        <button onclick="changeAdminTab('analitica')" id="tab-analitica" class="btn-tab-admin flex-1 py-3 rounded-xl text-xs font-black uppercase italic tracking-widest transition-all text-gray-400">An√°lisis</button>
    </div>

    <!-- Contenido: Log√≠stica (CON EL ID CORREGIDO) -->
    <div id="cnt-logistica" class="tab-cnt bg-white dark:bg-gray-800 rounded-3xl border shadow-sm overflow-hidden">
        
       <!-- 1. SUB-NAVEGACI√ìN DE ESTADOS (CORREGIDA) -->
        <div id="filter-buttons-container" class="bg-white dark:bg-gray-800 p-2 border-b border-gray-100 dark:border-gray-700 flex flex-wrap gap-2 items-center">
            
            <!-- Bot√≥n TODOS -->
            <button onclick="filterLogisticaByStatus('TODOS', this)" class="btn-filter active px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all bg-primary text-white shadow-md">
                Todos
            </button>
            
            <!-- Bot√≥n PENDIENTE -->
            <button onclick="filterLogisticaByStatus('Pendiente', this)" class="btn-filter px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all text-gray-500 hover:bg-yellow-50 hover:text-yellow-600 border border-transparent">
                ‚è≥ Por Asignar
            </button>
            
            <!-- Bot√≥n ALMAC√âN -->
            <button onclick="filterLogisticaByStatus('Recogida Almac√©n', this)" class="btn-filter px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all text-gray-500 hover:bg-orange-50 hover:text-orange-600 border border-transparent">
                üè≠ En Almac√©n
            </button>

            <!-- Bot√≥n MENSAJERO -->
            <button onclick="filterLogisticaByStatus('Asignado Mensajero', this)" class="btn-filter px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all text-gray-500 hover:bg-blue-50 hover:text-blue-600 border border-transparent">
                üèçÔ∏è Con Mensajero
            </button>
            
            <!-- Bot√≥n HIST√ìRICO (Agrupa Entregado y Cancelado) -->
            <button onclick="filterLogisticaByStatus('FINALIZADOS', this)" class="btn-filter px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all text-gray-500 hover:bg-emerald-50 hover:text-emerald-600 border border-transparent">
                ‚úÖ Hist√≥rico (Final)
            </button>

            <!-- Etiqueta oculta para evitar el error de JS, o informativa si quieres dejarla -->
            <span id="label-estado-actual" class="hidden"></span>
        </div>

        <!-- 2. HERRAMIENTAS (BUSCAR Y EXPORTAR) -->
        <!-- PEGAR ESTO JUSTO DEBAJO DE LOS BOTONES DE FILTRO Y ANTES DE LA TABLA -->
        <div class="p-4 flex flex-col md:flex-row gap-4 justify-between items-center bg-gray-50/50 dark:bg-gray-900/20 border-b border-gray-100 dark:border-gray-700">
            
            <!-- Buscador -->
            <div class="flex items-center gap-2 bg-white dark:bg-gray-900 px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-700 w-full md:w-96 shadow-sm">
                <span class="material-symbols-outlined text-gray-400 text-sm">search</span>
                <input type="text" id="search-logistica" oninput="renderAdminLogistica()" placeholder="Buscar cliente, gestor o producto..." class="bg-transparent border-none focus:ring-0 text-xs w-full font-bold text-slate-700 dark:text-white">
            </div>
            
            <!-- Bot√≥n Excel -->
            <div class="flex gap-2 items-center">
                <span class="text-[10px] font-bold text-gray-400 uppercase hidden md:block mr-2">
                    Acciones:
                </span>
                <button onclick="exportLogisticaExcel()" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-emerald-500/20 transition-all active:scale-95">
                    <span class="material-symbols-outlined text-sm">download</span> Excel
                </button>
            </div>
        </div>
        
        <!-- 3. TABLA -->
        <div class="overflow-x-auto">
            <table id="admin-table-logistica" class="w-full text-left border-collapse">
                <!-- 3. TABLA -->
                <div class="overflow-x-auto">
                    <table id="admin-table-logistica" class="w-full text-left border-collapse">
                        
                        <!-- === AQU√ç EMPIEZA EL CAMBIO === -->
                        <thead class="bg-gray-50 dark:bg-gray-900/50 text-[10px] font-black uppercase text-gray-400 border-b">
                            <tr>
                                <th class="p-6">Fecha/Cliente</th>
                                <th class="p-6">Proveedor</th> <!-- NUEVO -->
                                <th class="p-6">Producto</th>
                                <th class="p-6">Gestor</th>
                                <!-- Nota: Hemos quitado 'Total' para hacer espacio, pero puedes volver a ponerlo si quieres -->
                                <th class="p-6 text-right">Estado Log√≠stica</th>
                            </tr>
                        </thead>
                        <!-- === AQU√ç TERMINA EL CAMBIO === -->

                        <tbody id="list-admin-pedidos" class="divide-y dark:divide-gray-700"></tbody>
                    </table>
                </div>
                <tbody id="list-admin-pedidos" class="divide-y dark:divide-gray-700"></tbody>
            </table>
        </div>
    </div>

    <!-- Contenido: Corte S√°bado (ACTUALIZADO CON EXCEL) -->
    <div id="cnt-pagos" class="tab-cnt hidden space-y-4">
        <!-- Contenedor del Buscador y Bot√≥n Excel -->
        <div class="flex gap-2">
            <div class="flex-1 bg-white dark:bg-gray-800 p-4 rounded-3xl border shadow-sm flex items-center gap-4">
                <span class="material-symbols-outlined text-gray-400">search</span>
                <input type="text" id="search-gestor-pago" oninput="renderAdminCortes()" placeholder="Buscar gestor..." class="w-full bg-transparent border-none focus:ring-0 text-sm font-bold text-gray-700 dark:text-white">
            </div>
            <!-- Bot√≥n Excel en Log√≠stica -->
            <button onclick="exportLogisticaExcel()" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-emerald-500/20 transition-all">
                <span class="material-symbols-outlined text-sm">download</span> Excel
            </button>
        </div>
        
        <!-- Tabla con ID para el Exportador -->
        <div class="bg-white dark:bg-gray-800 rounded-3xl border shadow-sm overflow-hidden">
            <table id="admin-table-pagos" class="w-full text-left border-collapse">
                <thead class="bg-gray-50 dark:bg-gray-900/50 text-[10px] font-black uppercase text-gray-400 border-b">
                    <tr>
                        <th class="p-4">Gestor</th>
                        <th class="p-4">Ventas</th>
                        <th class="p-4">Total USD</th>
                        <th class="p-4 text-emerald-500">Total CUP</th>
                        <th class="p-4 text-right">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="list-admin-cortes" class="divide-y dark:divide-gray-700">
                    <!-- JS inyecta aqu√≠ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Contenido: Inventario -->
    <div id="cnt-inventario" class="tab-cnt hidden space-y-6">
        <div class="flex justify-between items-center bg-white dark:bg-gray-800 p-4 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black uppercase text-gray-400 italic">Gesti√≥n de Cat√°logo</p>
            <!-- ENCABEZADO INVENTARIO PRO -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white dark:bg-gray-800 p-4 rounded-3xl border shadow-sm mb-6">
                
                <!-- Buscador -->
                <div class="flex items-center gap-2 bg-gray-50 dark:bg-gray-900 px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 w-full md:w-96">
                    <span class="material-symbols-outlined text-gray-400 text-sm">inventory_2</span>
                    <input type="text" id="search-inventario" oninput="renderAdminInventario()" placeholder="Buscar por Nombre, Categor√≠a o SKU..." class="bg-transparent border-none focus:ring-0 text-xs w-full font-bold">
                </div>

                <!-- Botones -->
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="exportInventoryExcel()" class="flex-1 md:flex-none bg-emerald-50 text-emerald-600 border border-emerald-200 hover:bg-emerald-100 px-4 py-2.5 rounded-xl font-black text-[10px] uppercase flex items-center justify-center gap-2 transition-all">
                        <span class="material-symbols-outlined text-sm">download</span> Excel Inventario
                    </button>
                    <button onclick="openModalProd()" class="flex-1 md:flex-none bg-primary text-white px-6 py-2.5 rounded-xl font-black text-[10px] uppercase shadow-lg shadow-primary/20 hover:bg-secondary transition-all">
                        + Nuevo Equipo
                    </button>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4" id="list-admin-inventario"></div>
    </div>

    <!-- Contenido: An√°lisis -->
<div id="cnt-analitica" class="tab-cnt hidden space-y-6">
    
    <!-- BLOQUE 1: RENDIMIENTO DE NEGOCIO -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        
        <!-- Top Proveedores (Facturaci√≥n) -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm h-full relative overflow-hidden">
            <span class="material-symbols-outlined absolute -right-4 -bottom-4 text-8xl text-indigo-50 dark:text-gray-700 opacity-50">inventory_2</span>
            <h4 class="font-black uppercase text-xs mb-4 text-indigo-600 flex items-center gap-2 relative z-10">
                Top Proveedores (Volumen USD)
            </h4>
            <div id="list-analitica-proveedores" class="space-y-3 relative z-10"></div>
        </div>

        <!-- Tasa de Cancelaci√≥n -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm h-full relative overflow-hidden">
            <span class="material-symbols-outlined absolute -right-4 -bottom-4 text-8xl text-red-50 dark:text-gray-700 opacity-50">cancel</span>
            <h4 class="font-black uppercase text-xs mb-2 text-red-500 flex items-center gap-2 relative z-10">
                Salud de las √ìrdenes
            </h4>
            <div class="flex items-end gap-2 mb-4 relative z-10">
                <span id="stat-cancel-rate" class="text-4xl font-black text-slate-800 dark:text-white">0%</span>
                <span class="text-xs text-gray-400 font-bold mb-1">Canceladas</span>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-2 mb-2 relative z-10">
                <div id="bar-cancel-rate" class="bg-red-500 h-2 rounded-full" style="width: 0%"></div>
            </div>
            <p class="text-[9px] text-gray-400 italic relative z-10">Meta ideal: Menos del 10%</p>
        </div>

        <!-- Efectividad (Conversi√≥n) -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm h-full relative overflow-hidden">
            <span class="material-symbols-outlined absolute -right-4 -bottom-4 text-8xl text-emerald-50 dark:text-gray-700 opacity-50">trending_up</span>
            <h4 class="font-black uppercase text-xs mb-4 text-emerald-600 flex items-center gap-2 relative z-10">
                Productos Estrella (Efectividad)
            </h4>
            <div id="list-analitica-conversion" class="space-y-3 relative z-10"></div>
        </div>
    </div>

    <!-- BLOQUE 2: LIMPIEZA Y GESTI√ìN -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <!-- Productos Zombie (Sin Ventas) -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm h-full">
            <h4 class="font-black uppercase text-xs mb-4 text-gray-500 flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">sentiment_very_dissatisfied</span> Productos Zombie (Sin Ventas)
            </h4>
            <p class="text-[9px] text-gray-400 mb-3">Estos productos ocupan espacio y no generan dinero. Considera eliminarlos.</p>
            <div id="list-analitica-zombies" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
        </div>

        <!-- Ranking de Gestores -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm h-full">
            <h4 class="font-black uppercase text-xs mb-4 text-orange-500 flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">groups</span> Top Gestores Activos
            </h4>
            <div id="list-analitica-gestores" class="space-y-3"></div>
        </div>
    </div>
</div>
</section>

    <!-- Footer -->
    <footer class="bg-background-light dark:bg-background-dark pt-16 pb-8 px-4 md:px-10 lg:px-40 relative mt-20">
    <!-- Onda Invertida Superior -->
    <div class="absolute top-0 left-0 w-full overflow-hidden leading-[0] transform rotate-180">
        <svg class="relative block w-full h-[30px]" viewBox="0 0 1200 120" preserveAspectRatio="none">
            <path class="fill-primary/5" d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z"></path>
        </svg>
    </div>

    <div class="max-w-[1200px] mx-auto grid grid-cols-1 md:grid-cols-4 gap-12">
        <div class="flex flex-col gap-6">
            <div class="flex items-center gap-2">
                <div class="text-primary"><span class="material-symbols-outlined text-3xl">home_iot_device</span></div>
                <h2 class="text-primary dark:text-white text-xl font-extrabold tracking-tight">para<span class="text-secondary">tuhogar</span></h2>
            </div>
            <p class="text-slate-600 dark:text-gray-400 text-sm leading-relaxed">
                Llevando calidad y confort a los hogares cubanos con el sello de profesionalismo. La tienda de confianza.
            </p>
        </div>
        <div>
            <h3 class="text-primary dark:text-white text-sm font-black uppercase tracking-widest mb-6">Categor√≠as</h3>
            <ul class="flex flex-col gap-3 text-sm text-slate-600 dark:text-gray-400">
                <li><a class="hover:text-primary transition-colors flex items-center gap-2" href="#" onclick="filterByCategory('REFRIGERACI√ìN')"><span class="w-1.5 h-1.5 rounded-full bg-primary/30"></span>Refrigeraci√≥n</a></li>
                <li><a class="hover:text-primary transition-colors flex items-center gap-2" href="#" onclick="filterByCategory('COCINA')"><span class="w-1.5 h-1.5 rounded-full bg-primary/30"></span>Cocina</a></li>
                <li><a class="hover:text-primary transition-colors flex items-center gap-2" href="#" onclick="filterByCategory('CLIMATIZACI√ìN')"><span class="w-1.5 h-1.5 rounded-full bg-primary/30"></span>Climatizaci√≥n</a></li>
            </ul>
        </div>
        <div>
            <h3 class="text-primary dark:text-white text-sm font-black uppercase tracking-widest mb-6">Informaci√≥n</h3>
            <ul class="flex flex-col gap-3 text-sm text-slate-600 dark:text-gray-400">
                <li><a class="hover:text-primary transition-colors" href="#">C√≥mo comprar</a></li>
                <li><a class="hover:text-primary transition-colors" href="#">T√©rminos de Garant√≠a</a></li>
                <li><a class="hover:text-primary transition-colors" href="#">WhatsApp</a></li>
            </ul>
        </div>
        <div>
            <h3 class="text-primary dark:text-white text-sm font-black uppercase tracking-widest mb-6">Contacto</h3>
            <ul class="flex flex-col gap-4 text-sm text-slate-600 dark:text-gray-400">
                <li class="flex items-center gap-3"><span class="material-symbols-outlined text-primary">mail</span> info@paratuhogar.cu</li>
                <li class="flex items-center gap-3"><span class="material-symbols-outlined text-primary">location_on</span> La Habana, Cuba</li>
            </ul>
        </div>
    </div>
    
    <div class="max-w-[1200px] mx-auto mt-16 pt-8 border-t border-slate-200 dark:border-gray-800 flex flex-col md:flex-row justify-between items-center gap-6">
        <p class="text-slate-500 dark:text-gray-500 text-xs font-medium">¬© 2026 paratuhogar. Todos los derechos reservados.</p>
        <div class="flex gap-3">
             <div class="h-8 w-12 bg-white border border-slate-200 rounded-md flex items-center justify-center text-[10px] font-bold text-slate-400">CUP</div>
             <div class="h-8 w-12 bg-white border border-slate-200 rounded-md flex items-center justify-center text-[10px] font-bold text-slate-400">USD</div>
        </div>
    </div>
</footer>

    <!-- MODAL NUEVO PRODUCTO -->
<div id="modal-producto" class="fixed inset-0 z-[300] hidden bg-black/80 backdrop-blur-sm p-4 overflow-y-auto flex justify-center items-center">
    <div class="bg-white dark:bg-gray-800 w-full max-w-2xl rounded-[32px] p-6 md:p-8 shadow-2xl relative my-auto">

        <button onclick="closeModalProd()" class="absolute top-6 right-6 p-2 bg-gray-100 rounded-full"><span class="material-symbols-outlined">close</span></button>
        
        <h3 class="text-2xl font-black mb-6 italic uppercase">A√±adir Nuevo <span class="text-primary">Equipo</span></h3>
        
        <form id="form-nuevo-prod" class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- ID Oculto para cuando editemos -->
    <input type="hidden" id="p-id-edit">

    <input type="text" id="p-nombre" placeholder="Nombre del Equipo" class="md:col-span-2 rounded-xl border-gray-100 font-bold" required>
    <input type="number" id="p-precio" placeholder="Precio USD" class="rounded-xl border-gray-100 font-bold" required>
    <input type="number" id="p-comision" placeholder="Comisi√≥n Gestor" class="rounded-xl border-gray-100 font-bold" required>

    <!-- ...inputs de precio y comisi√≥n... -->
    <input type="number" id="p-comision" placeholder="Comisi√≥n Gestor" class="rounded-xl border-gray-100 font-bold" required>
    
    <!-- === NUEVOS CAMPOS PROVEEDOR Y FLEXIBILIDAD === -->
    <div class="md:col-span-2 grid grid-cols-2 gap-4">
        <!-- Selector de Proveedor -->
        <div>
            <label class="text-[10px] font-black uppercase text-gray-400 ml-1">Proveedor / Almac√©n</label>
            <input type="text" id="p-proveedor" list="lista-proveedores" placeholder="Ej: Importadora A" class="w-full rounded-xl border-gray-100 font-bold text-gray-700">
            <datalist id="lista-proveedores">
                <option value="General">
                <option value="Importadora A">
                <option value="Importadora B">
                <!-- Se ir√°n guardando solos al escribir -->
            </datalist>
        </div>
        
        <!-- Selector de Flexibilidad de Precio -->
        <div>
            <label class="text-[10px] font-black uppercase text-gray-400 ml-1">¬øPrecio Subible?</label>
            <select id="p-flexible" class="w-full rounded-xl border-gray-100 font-bold text-gray-700">
                <option value="NO">üîí Precio Fijo (No subir)</option>
                <option value="SI">üìà Flexible (Gestor puede subir)</option>
            </select>
        </div>
    </div>
    <!-- ============================================== -->

    <!-- CAMPO DE CATEGOR√çA INTELIGENTE (Este ya lo tienes, sigue abajo) -->
    
    <!-- CAMPO DE CATEGOR√çA INTELIGENTE -->
    <div class="relative">
        <label class="text-[10px] font-black uppercase text-gray-400 ml-1">Categor√≠a</label>
        <input type="text" id="p-categoria" list="lista-categorias" placeholder="Escribe o selecciona..." class="w-full rounded-xl border-gray-100 font-bold text-gray-700" autocomplete="off" required>
        <datalist id="lista-categorias">
            <!-- Las opciones se llenar√°n solas con JS -->
        </datalist>
    </div>
    <input type="text" id="p-garantia" placeholder="Garant√≠a" class="rounded-xl border-gray-100 font-bold">

    <!-- SECCI√ìN DE FOTOS (4 espacios) -->
    <div class="md:col-span-2 border-y py-4 my-2">
        <p class="text-[10px] font-black text-gray-400 uppercase mb-3 italic">Galer√≠a de Im√°genes (M√°x 4)</p>
        <div class="grid grid-cols-4 gap-2">
            <!-- Espacio para 4 fotos -->
            <div onclick="document.getElementById('file-0').click()" class="aspect-square bg-gray-50 border-2 border-dashed rounded-xl flex items-center justify-center cursor-pointer relative overflow-hidden">
                <input type="file" id="file-0" accept="image/*" class="hidden" onchange="handlePowerUpload(this, 0)">
                <img id="prev-0" class="absolute inset-0 w-full h-full object-cover hidden">
                <span id="icon-0" class="material-symbols-outlined text-gray-300">add_a_photo</span>
                <input type="hidden" id="img-path-0">
            </div>
            <div onclick="document.getElementById('file-1').click()" class="aspect-square bg-gray-50 border-2 border-dashed rounded-xl flex items-center justify-center cursor-pointer relative overflow-hidden">
                <input type="file" id="file-1" accept="image/*" class="hidden" onchange="handlePowerUpload(this, 1)">
                <img id="prev-1" class="absolute inset-0 w-full h-full object-cover hidden">
                <span id="icon-1" class="material-symbols-outlined text-gray-300">add_a_photo</span>
                <input type="hidden" id="img-path-1">
            </div>
            <!-- Repetir para 2 y 3 -->
            <div onclick="document.getElementById('file-2').click()" class="aspect-square bg-gray-50 border-2 border-dashed rounded-xl flex items-center justify-center cursor-pointer relative overflow-hidden">
                <input type="file" id="file-2" accept="image/*" class="hidden" onchange="handlePowerUpload(this, 2)">
                <img id="prev-2" class="absolute inset-0 w-full h-full object-cover hidden">
                <span id="icon-2" class="material-symbols-outlined text-gray-300">add_a_photo</span>
                <input type="hidden" id="img-path-2">
            </div>
            <div onclick="document.getElementById('file-3').click()" class="aspect-square bg-gray-50 border-2 border-dashed rounded-xl flex items-center justify-center cursor-pointer relative overflow-hidden">
                <input type="file" id="file-3" accept="image/*" class="hidden" onchange="handlePowerUpload(this, 3)">
                <img id="prev-3" class="absolute inset-0 w-full h-full object-cover hidden">
                <span id="icon-3" class="material-symbols-outlined text-gray-300">add_a_photo</span>
                <input type="hidden" id="img-path-3">
            </div>
        </div>
    </div>

    <!-- EDITOR TIPO WORD -->
    <div class="md:col-span-2 space-y-2">
        <label class="text-[10px] font-black text-gray-400 uppercase italic">Descripci√≥n Detallada</label>
        <div id="editor-container"></div>
    </div>
    
    <button type="submit" id="btn-save-prod" class="md:col-span-2 bg-primary text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg shadow-primary/30 mt-4">Guardar Cambios</button>
</form>
    </div>
</div>

<!-- === PANTALLA DE ACCESO (LOGIN / REGISTRO) === -->
<div id="login-overlay" class="fixed inset-0 z-[9999] bg-background-light dark:bg-background-dark flex flex-col items-center justify-center p-6 transition-all duration-500 overflow-y-auto">
    <div class="w-full max-w-sm text-center space-y-6 my-auto">
        
        <!-- Logo -->
        <div class="flex items-center justify-center gap-2 mb-4">
            <span class="material-symbols-outlined text-5xl text-primary">home_iot_device</span>
            <h1 class="text-3xl font-extrabold tracking-tight italic">para<span class="text-primary">tuhogar</span></h1>
        </div>

        <!-- Caja Principal -->
        <div class="bg-white dark:bg-gray-800 p-8 rounded-[32px] shadow-xl border border-gray-100 dark:border-gray-700 relative overflow-hidden">
            
            <!-- Tabs Superior -->
            <div class="flex border-b border-gray-100 dark:border-gray-700 mb-6">
                <button onclick="toggleLoginMode('login')" id="tab-login-btn" class="flex-1 pb-2 font-black text-xs uppercase text-primary border-b-2 border-primary">Entrar</button>
                <button onclick="toggleLoginMode('register')" id="tab-register-btn" class="flex-1 pb-2 font-black text-xs uppercase text-gray-400">Registrarme</button>
            </div>

            <!-- FORMULARIO LOGIN -->
            <div id="form-login" class="space-y-4">
                <input type="text" id="log-user" placeholder="Tu Nombre de Usuario" class="w-full rounded-xl border-gray-200 dark:bg-gray-900 font-bold text-sm p-3">
                <input type="password" id="log-pass" placeholder="Contrase√±a" class="w-full rounded-xl border-gray-200 dark:bg-gray-900 font-bold text-sm p-3">
                <button onclick="processLogin()" class="w-full bg-primary text-white py-4 rounded-xl font-black uppercase shadow-lg shadow-primary/30">Iniciar Sesi√≥n</button>
            </div>

            <!-- FORMULARIO REGISTRO -->
            <div id="form-register" class="space-y-4 hidden">
                <input type="text" id="reg-name" placeholder="Nombre y Apellido" class="w-full rounded-xl border-gray-200 dark:bg-gray-900 font-bold text-sm p-3">
                <input type="email" id="reg-email" placeholder="Correo Electr√≥nico" class="w-full rounded-xl border-gray-200 dark:bg-gray-900 font-bold text-sm p-3">
                <input type="tel" id="reg-tel" placeholder="Tel√©fono (WhatsApp)" class="w-full rounded-xl border-gray-200 dark:bg-gray-900 font-bold text-sm p-3">
                <input type="password" id="reg-pass" placeholder="Crea una Contrase√±a" class="w-full rounded-xl border-gray-200 dark:bg-gray-900 font-bold text-sm p-3">
                <button onclick="processRegister()" class="w-full bg-gray-900 text-white py-4 rounded-xl font-black uppercase shadow-lg">Crear Cuenta</button>
            </div>

        </div>

        <button onclick="enterAsClient()" class="text-gray-400 text-xs font-bold uppercase tracking-widest hover:text-primary mt-4">
            Solo quiero ver el cat√°logo (Cliente)
        </button>
    </div>
</div>

    <!-- Scripts de L√≥gica -->
    <script>
    // 1. CONFIGURACI√ìN SUPABASE
    // Cambiamos el nombre de la constante a 'supabaseClient' para evitar errores
    const SUPABASE_URL = 'https://ljqwaovevfatkiigirhf.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_DAuFcu0JjUo15yLDAev3MQ_9x5GIVXt'; // Aseg√∫rate que esta sea la 'anon key'
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const MASTER_KEY = "HOGAR2025"; 
    const ADMIN_SECRET_KEY = "PRO_ADMIN_2025"; // Solo para el due√±o

    
    let productosRaw = [], cart = [], selectedProduct = null;
    let cupRate = 450, showInCUP = false, activeCategory = 'TODOS';
    

    const urlParams = new URLSearchParams(window.location.search);
    const gestorName = urlParams.get('gestor');
    const gestorTel = urlParams.get('tel');
    const isAdmin = urlParams.get('admin') === 'true';

    // --- L√ìGICA DE INICIO Y RECUPERACI√ìN DE SESI√ìN ---
    window.addEventListener('load', () => {
        // 1. Inicializar editor
        if(document.getElementById('editor-container')) {
            quill = new Quill('#editor-container', {
                theme: 'snow',
                placeholder: 'Descripci√≥n...',
                modules: { toolbar: [['bold', 'italic'], [{ 'color': [] }]] }
            });
        }

        // 2. INTENTAR RECUPERAR SESI√ìN GUARDADA (GESTOR)
        const savedSession = localStorage.getItem('pth_session');
        
        if (savedSession) {
            // SI HAY SESI√ìN, SALTAMOS LOGIN Y CONFIGURAMOS TODO
            const s = JSON.parse(savedSession);
            document.getElementById('login-overlay').classList.add('hidden');
            window.currentUserData = s.data || {}; 
            setupSession(s.name, s.isAdmin);
        } else {
            // SI ES UN CLIENTE (NO LOGUEADO)
            loadProducts();
            // Nota: Aqu√≠ NO activamos las herramientas de marketing para mantener la web limpia para el cliente
        }
    });

    // --- SISTEMA DE ATRIBUCI√ìN (√öLTIMO CLIC GANA) ---
    let referrerData = null;

    function initReferralSystem() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlGestor = urlParams.get('gestor');
        const urlTel = urlParams.get('tel');

        // 1. SI HAY NUEVO ENLACE -> SOBRESCRIBIMOS (Last Click Wins)
        if (urlGestor) {
            referrerData = {
                nombre: urlGestor,
                telefono: urlTel || "",
                timestamp: new Date().getTime() // Guardamos cu√°ndo ocurri√≥
            };
            // Guardamos en memoria persistente del navegador
            localStorage.setItem('pth_referrer', JSON.stringify(referrerData));
            console.log("Nuevo gestor atribuido:", urlGestor);
        } 
        // 2. SI NO HAY ENLACE -> BUSCAMOS EN MEMORIA (Hist√≥rico)
        else {
            const stored = localStorage.getItem('pth_referrer');
            if (stored) {
                referrerData = JSON.parse(stored);
                console.log("Gestor recuperado de memoria:", referrerData.nombre);
            }
        }
    }

    // Ejecutar inmediatamente al cargar el script
    initReferralSystem();

    

    // Funci√≥n para Clientes (Bot√≥n "Entrar como Cliente")
    function enterAsClient() {
        document.getElementById('login-overlay').classList.add('hidden');
        // Solo cargamos cat√°logo, sin sesi√≥n
        loadProducts();
    }

    // --- 1. L√ìGICA DE ACCESO (LOGIN/REGISTRO) ---
    
    function toggleLoginMode(mode) {
        const isLogin = mode === 'login';
        document.getElementById('form-login').classList.toggle('hidden', !isLogin);
        document.getElementById('form-register').classList.toggle('hidden', isLogin);
        
        document.getElementById('tab-login-btn').className = isLogin ? "flex-1 pb-2 font-black text-xs uppercase text-primary border-b-2 border-primary" : "flex-1 pb-2 font-black text-xs uppercase text-gray-400";
        document.getElementById('tab-register-btn').className = !isLogin ? "flex-1 pb-2 font-black text-xs uppercase text-primary border-b-2 border-primary" : "flex-1 pb-2 font-black text-xs uppercase text-gray-400";
    }

    // REGISTRO DE NUEVO GESTOR
    async function processRegister() {
        const nombre = document.getElementById('reg-name').value;
        const email = document.getElementById('reg-email').value;
        const tel = document.getElementById('reg-tel').value;
        const pass = document.getElementById('reg-pass').value;

        if(!nombre || !pass || !tel) return alert("Nombre, Tel√©fono y Contrase√±a son obligatorios.");

        const { data, error } = await supabaseClient
            .from('gestores')
            .insert([{ nombre: nombre, email: email, telefono: tel, password: pass }])
            .select();

        if (error) {
            alert("Error al registrar: " + error.message);
        } else {
            alert("‚úÖ Cuenta creada con √©xito. Ahora inicia sesi√≥n.");
            toggleLoginMode('login');
            document.getElementById('log-user').value = nombre;
        }
    }

    // INICIO DE SESI√ìN
    // 2. Proceso de Login (CORREGIDO PARA ADMIN)
    // 2. Proceso de Login (CORREGIDO Y BLINDADO)
    async function processLogin() {
        const userInput = document.getElementById('log-user');
        const passInput = document.getElementById('log-pass');
        
        const user = userInput ? userInput.value.trim() : "";
        const pass = passInput ? passInput.value.trim() : "";

        // CASO A: ADMINISTRADOR (Due√±o) - Prioridad 1
        // Verifica la contrase√±a maestra INCLUSO si el usuario est√° vac√≠o
        if (pass === ADMIN_SECRET_KEY) { 
            closeLogin();
            saveSessionToMemory("Administrador", true, {}); 
            setupSession("Administrador", true);
            return;
        }

        // CASO B: GESTOR - Validaci√≥n
        if (!user || !pass) {
            return alert("Por favor ingresa usuario y contrase√±a.");
        }

        // CASO C: Verificar en Base de Datos
        try {
            const { data, error } = await supabaseClient
                .from('gestores')
                .select('*')
                .eq('nombre', user)
                .eq('password', pass)
                .single();

            if (error || !data) {
                alert("‚ùå Usuario o contrase√±a incorrectos.");
            } else {
                closeLogin();
                window.currentUserData = data; 
                saveSessionToMemory(data.nombre, false, data);
                setupSession(data.nombre, false);
            }
        } catch (e) {
            console.error(e);
            alert("Error de conexi√≥n al intentar loguearse.");
        }
    }

    // Funci√≥n auxiliar para guardar en el navegador
    function saveSessionToMemory(name, isAdmin, data) {
        const session = {
            name: name,
            isAdmin: isAdmin,
            data: data
        };
        localStorage.setItem('pth_session', JSON.stringify(session));
    }

    function closeLogin() { document.getElementById('login-overlay').classList.add('hidden'); }
    function enterAsClient() { closeLogin(); loadProducts(); }

    function setupSession(name, adminMode) {
        window.gestorName = name;
        window.isAdmin = adminMode;
        
        const label = document.getElementById('gestor-label');
        label.innerText = adminMode ? `ADMINISTRADOR` : `AGENTE: ${name.toUpperCase()}`;
        document.getElementById('admin-nav').classList.remove('hidden');

        if (adminMode) {
            document.getElementById('sec-admin-master').classList.remove('hidden');
            document.getElementById('sec-catalogo').style.display = 'none';
            document.getElementById('admin-nav').classList.add('hidden');
            loadAdminData();
        } else {
            // 1. Mostrar Dashboard y Cargar Datos
            showSection('dashboard');
            loadProducts(); 
            loadProDashboard(name);
            
            // 2. Cargar Anal√≠ticas
            if(typeof loadAnalyticsPro === "function") loadAnalyticsPro(name);

            // 3. MOSTRAR EL NUEVO CENTRO DE MANDO (UNIFICADO)
            // Esto reemplaza a las l√≠neas antiguas de 'marketing-tools' y 'filters'
            const commandCenter = document.getElementById('gestor-command-center');
            if (commandCenter) commandCenter.classList.remove('hidden');
            checkGamificationStatus();
        }
        // ... c√≥digo anterior de la funci√≥n ...

    // FORZAR QUE SE VEA EL BOT√ìN ROJO
    const btnLogout = document.getElementById('btn-logout');
    if (btnLogout) {
        btnLogout.classList.remove('hidden');
        btnLogout.style.display = 'inline-flex'; // Fuerza bruta para que se vea
    }

    }

    // --- 2. L√ìGICA DASHBOARD PRO (Ranking + Enlaces) ---

    // Variable global para guardar los pedidos del gestor y poder filtrar
let myOrdersData = [];

async function loadProDashboard(nombreGestor) {
    // 1. Consultar TODOS los datos necesarios de los pedidos
    // Nota: Agregamos 'fecha', 'cliente', 'producto', 'total', 'proveedor' a la consulta
    const { data: allPedidos, error } = await supabaseClient
        .from('pedidos')
        .select('*') // Traemos todo para poder mostrar detalles
        .order('fecha', { ascending: false }); // Ordenar del m√°s reciente al m√°s antiguo

    if(error) { console.error(error); return; }
    
    // 2. Filtrar SOLO mis ventas
    const misVentas = allPedidos.filter(p => p.gestor === nombreGestor);
    myOrdersData = misVentas; // Guardamos para el buscador

    // 3. C√°lculos Financieros (Igual que ten√≠as)
    const misEntregados = misVentas.filter(p => p.estado === 'Entregado');
    const misPendientes = misVentas.filter(p => p.estado !== 'Entregado' && p.estado !== 'Cancelado');

    const porCobrar = misEntregados
        .filter(p => p.pago_gestor === 'Pendiente' || !p.pago_gestor)
        .reduce((acc, curr) => acc + (Number(curr.comision_total) || 0), 0);

    const cobrado = misEntregados
        .filter(p => p.pago_gestor === 'Pagado')
        .reduce((acc, curr) => acc + (Number(curr.comision_total) || 0), 0);

    // Actualizar HTML Financiero
    if(document.getElementById('dash-money-pending')) document.getElementById('dash-money-pending').innerText = `$${porCobrar.toFixed(2)}`;
    if(document.getElementById('dash-money-paid')) document.getElementById('dash-money-paid').innerText = `$${cobrado.toFixed(2)}`;
    if(document.getElementById('dash-ok')) document.getElementById('dash-ok').innerText = misEntregados.length;
    if(document.getElementById('dash-pending')) document.getElementById('dash-pending').innerText = misPendientes.length;

    // 4. RANKING (Igual que ten√≠as)
    renderRankingAnonimo(allPedidos, nombreGestor);

    // 5. NUEVO: RENDERIZAR LA LISTA DE PEDIDOS DETALLADA
    renderMyOrdersList(misVentas);

    // 6. Inyectar enlaces
    injectLinksSection(nombreGestor);
}

// Funci√≥n auxiliar para el Ranking (para mantener el c√≥digo limpio)
function renderRankingAnonimo(allPedidos, nombreGestor) {
    const rankingMap = {};
    allPedidos.forEach(p => {
        if (p.estado === 'Entregado' && p.gestor !== 'Venta Directa') {
            rankingMap[p.gestor] = (rankingMap[p.gestor] || 0) + (Number(p.comision_total) || 0);
        }
    });

    const rankingArray = Object.entries(rankingMap)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10);

    const rankingHTML = rankingArray.map(([gName, gTotal], index) => {
        const isMe = gName === nombreGestor;
        const maskedName = isMe ? `${gName} (T√∫)` : gName.substring(0, 3) + '***';
        const icon = index === 0 ? 'ü•á' : (index === 1 ? 'ü•à' : (index === 2 ? 'ü•â' : `#${index+1}`));
        
        return `
        <div class="flex justify-between items-center p-3 ${isMe ? 'bg-primary/10 border border-primary/20 rounded-xl' : ''}">
            <div class="flex items-center gap-3">
                <span class="text-lg">${icon}</span>
                <span class="text-xs font-black uppercase ${isMe ? 'text-primary' : 'text-gray-500'}">${maskedName}</span>
            </div>
            <span class="text-xs font-bold text-gray-800">$${gTotal.toFixed(0)}</span>
        </div>`;
    }).join('');

    const rankList = document.getElementById('ranking-list');
    if(rankList) rankList.innerHTML = rankingHTML;
}

// --- NUEVA FUNCI√ìN: RENDERIZAR LISTA DE MIS PEDIDOS ---
// --- FUNCI√ìN ACTUALIZADA: RENDERIZAR LISTA DE MIS PEDIDOS CON WHATSAPP ---
function renderMyOrdersList(lista) {
    const container = document.getElementById('list-mis-pedidos');
    if(!container) return;

    if (lista.length === 0) {
        container.innerHTML = `<div class="p-10 text-center flex flex-col items-center gap-2 opacity-50">
            <span class="material-symbols-outlined text-4xl">shopping_cart_off</span>
            <p class="text-xs font-bold uppercase">A√∫n no tienes pedidos registrados.</p>
        </div>`;
        return;
    }

    container.innerHTML = lista.map(p => {
        // 1. CONFIGURACI√ìN VISUAL DEL ESTADO
        let estadoBadge = '', estadoIcon = '', estadoColor = '';
        
        switch(p.estado) {
            case 'Pendiente':
                estadoBadge = '‚è≥ Pendiente'; estadoColor = 'bg-yellow-100 text-yellow-700'; estadoIcon = 'hourglass_empty';
                break;
            case 'Recogida Almac√©n':
                estadoBadge = 'üè≠ En Almac√©n'; estadoColor = 'bg-orange-100 text-orange-700'; estadoIcon = 'inventory_2';
                break;
            case 'Asignado Mensajero':
                estadoBadge = 'üèçÔ∏è En Camino'; estadoColor = 'bg-blue-100 text-blue-700'; estadoIcon = 'local_shipping';
                break;
            case 'Entregado':
                estadoBadge = '‚úÖ Entregado'; estadoColor = 'bg-emerald-100 text-emerald-700'; estadoIcon = 'check_circle';
                break;
            case 'Cancelado':
                estadoBadge = '‚ùå Cancelado'; estadoColor = 'bg-red-100 text-red-700'; estadoIcon = 'cancel';
                break;
            default:
                estadoBadge = p.estado; estadoColor = 'bg-gray-100 text-gray-600'; estadoIcon = 'info';
        }

        // 2. INDICADOR DE PAGO (SOLO ENTREGADOS)
        let pagoBadge = '';
        if(p.estado === 'Entregado') {
            pagoBadge = (p.pago_gestor === 'Pagado') 
                ? `<span class="text-[9px] font-black text-emerald-500 flex items-center gap-1"><span class="material-symbols-outlined text-[10px]">payments</span> PAGADO</span>`
                : `<span class="text-[9px] font-black text-orange-400 flex items-center gap-1"><span class="material-symbols-outlined text-[10px]">pending</span> COBRO PENDIENTE</span>`;
        }

        // 3. GENERADOR DE MENSAJE WHATSAPP INTELIGENTE
        let waButton = '';
        if (p.telefono) {
            // Limpiar tel√©fono (solo n√∫meros)
            const phoneClean = p.telefono.replace(/[^0-9]/g, '');
            // Obtener primer nombre para ser amigable
            const clienteName = p.cliente.split(' ')[0];
            // Acortar nombre del producto
            const prodShort = p.producto.substring(0, 25) + "...";
            
            let mensaje = "";
            
            if (p.estado === 'Pendiente') {
                mensaje = `Hola ${clienteName} üëã, confirmo que tu pedido de *${prodShort}* est√° registrado y en proceso de almac√©n üì¶.`;
            } 
            else if (p.estado === 'Recogida Almac√©n') {
                mensaje = `Hola ${clienteName} üè≠, buenas noticias. Tu equipo *${prodShort}* ya est√° separado y LISTO para que pases a recogerlo por el almac√©n.`;
            }
            else if (p.estado === 'Asignado Mensajero') {
                mensaje = `Hola ${clienteName} üöö, te confirmo que tu equipo *${prodShort}* YA SALI√ì con el mensajero y va en camino a tu direcci√≥n.`;
            }
            else if (p.estado === 'Entregado') {
                mensaje = `Hola ${clienteName} ‚≠ê, muchas gracias por tu compra. Espero disfrutes tu equipo. Aqu√≠ estoy para lo que necesites.`;
            }
            else if (p.estado === 'Cancelado') {
                mensaje = `Hola ${clienteName}, te confirmo que se ha procedido con la cancelaci√≥n de la orden de *${prodShort}*.`;
            }

            // Solo mostrar bot√≥n si hay mensaje definido
            if (mensaje) {
                const url = `https://wa.me/${phoneClean}?text=${encodeURIComponent(mensaje)}`;
                waButton = `
                <a href="${url}" target="_blank" class="flex items-center justify-center h-6 w-6 rounded-full bg-[#25D366] text-white hover:scale-110 transition-transform shadow-sm" title="Informar al Cliente por WhatsApp">
                    <i class="fab fa-whatsapp text-xs"></i>
                </a>`;
            }
        }

        // Formato Fecha
        const fechaStr = new Date(p.fecha).toLocaleDateString();

        // 4. HTML FINAL DE LA FILA
        return `
        <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-900/50 transition-colors flex flex-col md:grid md:grid-cols-12 gap-2 md:items-center group">
            
            <!-- Columna 1: Fecha y Cliente -->
            <div class="md:col-span-3 flex items-start gap-3">
                <div class="h-10 w-10 rounded-full flex items-center justify-center ${estadoColor} bg-opacity-20 shrink-0">
                    <span class="material-symbols-outlined text-lg">${estadoIcon}</span>
                </div>
                <div>
                    <p class="text-[10px] text-gray-400 font-bold">${fechaStr}</p>
                    <div class="flex items-center gap-2">
                        <p class="text-xs font-black text-gray-800 dark:text-white uppercase truncate w-32 md:w-auto" title="${p.cliente}">${p.cliente}</p>
                        <!-- AQUI EST√Å EL BOT√ìN DE WHATSAPP -->
                        ${waButton}
                    </div>
                </div>
            </div>

            <!-- Columna 2: Producto -->
            <div class="md:col-span-4">
                <p class="text-[10px] font-bold text-gray-500 leading-tight line-clamp-2" title="${p.producto}">${p.producto}</p>
                ${p.proveedor ? `<span class="text-[8px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded uppercase font-bold tracking-wider">${p.proveedor}</span>` : ''}
            </div>

            <!-- Columna 3: Monto -->
            <div class="md:col-span-2 md:text-right flex flex-row md:flex-col justify-between items-center md:items-end">
                <span class="md:hidden text-[10px] font-bold text-gray-400">Total:</span>
                <div>
                    <p class="text-xs font-black text-primary">$${p.total}</p>
                    <p class="text-[9px] font-bold text-emerald-500">+ $${p.comision_total} Com.</p>
                </div>
            </div>

            <!-- Columna 4: Estado -->
            <div class="md:col-span-3 flex flex-row md:flex-col justify-between items-center md:items-end gap-1">
                <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase ${estadoColor}">
                    ${estadoBadge}
                </span>
                ${pagoBadge}
            </div>
            
        </div>`;
    }).join('');
}

// Funci√≥n para buscar dentro de mis pedidos
function filterMyOrders() {
    const query = document.getElementById('search-mi-historial').value.toLowerCase();
    const filtered = myOrdersData.filter(p => 
        p.cliente.toLowerCase().includes(query) || 
        p.producto.toLowerCase().includes(query)
    );
    renderMyOrdersList(filtered);
}

    function injectLinksSection(nombre) {
        // Verificar si ya existe para no duplicar
        if(document.getElementById('sec-links-gestor')) return;

        const container = document.getElementById('sec-dashboard');
        const userData = window.currentUserData || {};
        
        // Crear Enlace Base
        const baseUrl = window.location.origin + window.location.pathname;
        const myLink = `${baseUrl}?gestor=${encodeURIComponent(nombre)}&tel=${userData.telefono || ''}`;

        const html = `
        <div id="sec-links-gestor" class="bg-white dark:bg-gray-800 p-6 rounded-3xl border border-gray-100 dark:border-gray-700 shadow-sm mt-6">
            <h3 class="text-sm font-black uppercase text-primary mb-4 italic">üîó Mi Enlace Inteligente</h3>
            <p class="text-xs text-gray-400 mb-2">Comparte este enlace. Cuando un cliente entre, la web sabr√° que viene de tu parte.</p>
            
            <div class="flex gap-2 mb-4">
                <input type="text" value="${myLink}" readonly class="w-full bg-gray-50 text-xs p-3 rounded-xl border-none font-bold text-gray-500">
                <button onclick="navigator.clipboard.writeText('${myLink}').then(()=>alert('Enlace copiado'))" class="bg-primary text-white px-4 rounded-xl font-bold text-xs uppercase">Copiar</button>
            </div>
            
            <div class="grid grid-cols-2 gap-2">
                <button onclick="window.open('https://wa.me/?text=${encodeURIComponent('¬°Mira este cat√°logo! Env√≠os a toda Cuba: ' + myLink)}')" class="py-3 bg-[#25D366] text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2">
                    <i class="fab fa-whatsapp text-lg"></i> Enviar por WhatsApp
                </button>
                <button onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(myLink)}')" class="py-3 bg-[#1877F2] text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2">
                    <i class="fab fa-facebook text-lg"></i> Compartir Facebook
                </button>
            </div>
        </div>`;
        
        // Insertar despu√©s de las tarjetas
        document.getElementById('ranking-list').parentElement.insertAdjacentHTML('afterend', html);
    }

    // 2. CARGA DE PRODUCTOS
    // 2. CARGA DE PRODUCTOS Y CATEGOR√çAS AUTOM√ÅTICAS
    async function loadProducts() {
        try {
            const { data, error } = await supabaseClient
                .from('productos')
                .select('*')
                .order('nombre', { ascending: true });

            if (error) throw error;

            productosRaw = data;
            
            // A. Generar Categor√≠as Autom√°ticamente
            renderCategories();
            
            // B. Renderizar Productos
            renderProducts();

        } catch (e) { 
            console.error("Error cargando:", e);
            document.getElementById('productos-container').innerHTML = 
                `<div class="col-span-full py-10 text-center text-red-500">Error de conexi√≥n.</div>`; 
        }
    }

    // NUEVA FUNCI√ìN: DIBUJAR PESTA√ëAS DE CATEGOR√çA
    function renderCategories() {
        // 1. Extraer categor√≠as √∫nicas de la base de datos
        // Convertimos a May√∫sculas para evitar duplicados tipo "Cocina" vs "cocina"
        const uniqueCats = [...new Set(productosRaw.map(p => p.categoria ? p.categoria.toUpperCase().trim() : 'VARIOS'))].sort();
        
        // 2. Crear lista con "TODOS" al principio
        const allCats = ['TODOS', ...uniqueCats];
        
        const container = document.getElementById('category-list');
        container.innerHTML = allCats.map(cat => {
            // Estilo activo o inactivo
            const isActive = activeCategory === cat;
            const styleClass = isActive 
                ? "category-tab active py-4 text-sm font-black border-b-4 border-primary text-primary transition-all px-2" 
                : "category-tab py-4 text-sm font-bold text-gray-400 hover:text-primary transition-all px-2 border-b-4 border-transparent hover:border-gray-200";
                
            return `<button onclick="filterByCategory('${cat}')" class="${styleClass}">${cat}</button>`;
        }).join('');
    }

    function renderProducts() {
    // 1. OBTENCI√ìN SEGURA DE ELEMENTOS
    const searchInput = document.getElementById('search-bar');
    const container = document.getElementById('productos-container');
    
    // Si por alguna raz√≥n el HTML no ha cargado, salimos para no dar error
    if (!searchInput || !container) return;

    const query = searchInput.value.toLowerCase();
    
    // 2. VARIABLES DE ESTADO
    const isGestor = window.gestorName ? true : false;
    const filterCheckbox = document.getElementById('filter-high-comm');
    const filterHighComm = filterCheckbox ? filterCheckbox.checked : false;
    
    // 3. FILTRADO
    const filtered = productosRaw.filter(p => {
        const matchSearch = p.nombre.toLowerCase().includes(query);
        const matchCat = activeCategory === 'TODOS' || (p.categoria && p.categoria.toUpperCase().includes(activeCategory));
        
        // L√≥gica del filtro "Tibur√≥n" (Ganancia > 10)
        const matchComm = !filterHighComm || (Number(p.comision || 0) > 10);

        return matchSearch && matchCat && matchComm && p.disponible === "SI";
    });

    // 4. ESTADO VAC√çO
    if (filtered.length === 0) {
        container.innerHTML = `<div class="col-span-full py-20 text-center text-gray-400 font-bold">No se encontraron equipos.</div>`;
        return;
    }

    // 5. RENDERIZADO DE TARJETAS
    container.innerHTML = filtered.map(p => {
        const precio = parseFloat(p.precio) || 0;
        
        // --- INICIO: NUEVA L√ìGICA DE PRECIOS INTELIGENTE ---
        let pDisplay = `$${precio}`; // Valor por defecto (USD)

        if (showInCUP) {
            // Usamos la funci√≥n inteligente que lee "p.pagos" y calcula seg√∫n si es fijo, +10 o tasa d√≠a
            // Nota: Aseg√∫rate de haber pegado la funci√≥n calculateProductCUP() en tu c√≥digo antes
            const precioCUP = calculateProductCUP(precio, p.pagos);
            
            if (precioCUP) {
                // Formateamos con comas (ej: 15,400)
                pDisplay = `CUP ${precioCUP.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            } else {
                // Si el producto no acepta CUP (la funci√≥n devolvi√≥ null)
                pDisplay = "<span class='text-sm text-gray-400'>Solo USD/EUR</span>";
            }
        }
        // --- FIN: NUEVA L√ìGICA ---
        
        // Etiqueta de Comisi√≥n + Indicador de Precio Flexible
        let htmlComision = isGestor ? 
            `<div class="absolute top-2 right-2 flex flex-col items-end gap-1 z-10">
                <span class="bg-emerald-500 text-white text-[10px] font-black px-2 py-1 rounded-lg shadow-md">GANAS $${p.comision || 0}</span>
                ${p.precio_flexible === 'SI' ? '<span class="bg-blue-600 text-white text-[9px] font-bold px-2 py-1 rounded-lg shadow-md border border-white">üìà PRECIO LIBRE</span>' : ''}
             </div>` : '';

        return `
        <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden border border-slate-100 dark:border-gray-700 group shadow-sm hover:shadow-xl transition-all duration-300 relative flex flex-col">
            ${htmlComision}
            
            <!-- Imagen Clickable -->
            <div onclick="openDetail('${p.nombre.replace(/'/g, "\\'")}')" class="w-full aspect-square bg-slate-50 dark:bg-gray-900 p-4 relative overflow-hidden cursor-pointer">
                <div class="absolute inset-0 bg-center bg-no-repeat bg-contain transition-transform group-hover:scale-110 duration-500" style="background-image: url('${fixDriveUrl(p.thumbnail)}');"></div>
            </div>

            <!-- Info -->
            <div class="p-5 flex flex-col gap-2 flex-1">
                <h3 class="text-slate-800 dark:text-white text-sm font-bold leading-snug line-clamp-2 min-h-[2.5rem]">${p.nombre}</h3>
                <p class="text-primary text-2xl font-black">${pDisplay}</p>
                
                <button onclick="openDetail('${p.nombre.replace(/'/g, "\\'")}')" class="mt-auto w-full flex items-center justify-center gap-2 bg-primary text-white py-2.5 rounded-lg text-xs font-extrabold hover:bg-secondary transition-colors shadow-md">
                    Ver Detalles
                </button>
            </div>

            <!-- BARRA SOCIAL -->
            <div class="grid grid-cols-2 border-t border-gray-100 dark:border-gray-700 divide-x divide-gray-100 dark:divide-gray-700 bg-gray-50 dark:bg-gray-900/50">
                <button onclick="shareProductSocial('${p.nombre.replace(/'/g, "\\'")}', 'wa')" class="py-3 flex items-center justify-center gap-1 text-gray-400 hover:text-green-500 hover:bg-green-50 transition-all">
                    <i class="fab fa-whatsapp text-lg"></i> <span class="text-[9px] font-bold uppercase">Estado</span>
                </button>
                <button onclick="shareProductSocial('${p.nombre.replace(/'/g, "\\'")}', 'fb')" class="py-3 flex items-center justify-center gap-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition-all">
                    <i class="fab fa-facebook text-lg"></i> <span class="text-[9px] font-bold uppercase">Post</span>
                </button>
            </div>
        </div>`;
    }).join('');
}

    // 3. DETALLE DE PRODUCTO
    function openDetail(name) {
    // 1. Buscar producto
    selectedProduct = productosRaw.find(p => p.nombre === name);
    const p = selectedProduct;
    if(!p) return;

    // 2. Registrar vista para anal√≠tica
    registrarVistaAnalitica(p); 

    // 3. Llenar textos b√°sicos
    document.getElementById('detail-name').innerText = p.nombre;
    
    // CORRECCI√ìN VISUAL: Usar innerHTML para que no salgan las etiquetas <p>
    document.getElementById('detail-desc').innerHTML = p.descripcion || ''; 

    // 4. Badge de Ganancia (Solo Admin)
    const oldBadge = document.getElementById('admin-comm-badge');
    if(oldBadge) oldBadge.remove();
    
    if(typeof isAdmin !== 'undefined' && isAdmin) {
        const badge = `<div id="admin-comm-badge" class="bg-emerald-500 text-white px-3 py-2 rounded-xl font-black text-[11px] mb-4 flex justify-between items-center shadow-lg shadow-emerald-500/20 uppercase italic">
            <span>Ganancia de Agente:</span>
            <span>$${p.comision || 0}.00</span>
        </div>`;
        document.getElementById('detail-name').insertAdjacentHTML('beforebegin', badge);
    }

    // 5. PRECIOS (AQU√ç EST√Å EL ARREGLO DEL CUP)
    document.getElementById('detail-price').innerText = `$${p.precio}.00 USD`;
    
    // Usamos la calculadora inteligente
    const precioCUP = calculateProductCUP(p.precio, p.pagos);
    const labelCUP = document.getElementById('detail-price-cup');

    if (precioCUP) {
        // Si acepta CUP, mostramos el c√°lculo correcto
        labelCUP.innerText = `/ CUP ${precioCUP.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
        labelCUP.classList.remove('text-red-500', 'text-xs');
        labelCUP.classList.add('text-gray-400', 'text-lg');
    } else {
        // Si no acepta CUP
        labelCUP.innerText = " (Solo USD/EUR)";
        labelCUP.classList.remove('text-gray-400', 'text-lg');
        labelCUP.classList.add('text-red-500', 'text-xs', 'font-bold', 'uppercase');
    }

    // 6. Otros detalles
    document.getElementById('detail-cat').innerText = p.categoria || '';
    document.getElementById('detail-warranty').innerText = p.garantia || '1 Mes';
    document.getElementById('detail-shipping').innerText = p.mensajeria || 'Consultar';
    
    // 7. Im√°genes
    document.getElementById('detail-main-img').src = fixDriveUrl(p.thumbnail);
    
    const thumbs = [p.thumbnail, p.image1, p.image2, p.image3].filter(url => url && url.length > 5);
    document.getElementById('detail-thumbnails').innerHTML = thumbs.map(url => `
        <img src="${fixDriveUrl(url)}" onclick="document.getElementById('detail-main-img').src=this.src" class="w-12 h-12 object-contain rounded-lg border border-gray-100 bg-white p-1 cursor-pointer hover:border-primary transition-colors">
    `).join('');

    // 8. Mostrar Modal
    document.getElementById('detail-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

    // 4. CARRITO Y PAGOS
    function addItemToCart() {
    // Buscar si el producto ya est√° en el carrito
    const existing = cart.find(item => item.nombre === selectedProduct.nombre);
    
    if(existing) {
        existing.qty++;
    } else {
        // Guardamos los valores base para referencia
        cart.push({
            ...selectedProduct, 
            qty: 1,
            // Inicializamos el precio de venta igual al original
            precio_venta: Number(selectedProduct.precio),
            // Guardamos comisi√≥n calculada inicial
            comision_actual: Number(selectedProduct.comision || 0)
        });
    }
    
    // === CORRECCI√ìN AQU√ç ===
    // Actualizamos el contador rojo directamente:
    const totalItems = cart.reduce((acc, item) => acc + item.qty, 0);
    document.getElementById('cart-count').innerText = totalItems;
    // =======================
    
    closeDetail();
    toggleCartModal(true);
}

    function renderCart() {
    const container = document.getElementById('cart-items');
    const isGestor = window.gestorName ? true : false; // Solo gestores pueden editar

    container.innerHTML = cart.map((item, index) => {
        // L√≥gica de L√≠mites
        // El precio m√≠nimo es el Costo Real (Precio Original - Comisi√≥n Base)
        // El gestor puede regalar SU comisi√≥n, pero no tocar el costo del equipo.
        const minPrice = Number(item.precio) - Number(item.comision);
        
        // El precio m√°ximo: Si es flexible, infinito. Si no, es el precio original.
        const maxPrice = (item.precio_flexible === 'SI') ? 100000 : Number(item.precio);
        
        // HTML del Input de Precio
        const precioInput = isGestor ? 
            `<div class="flex flex-col items-end">
                <label class="text-[9px] text-gray-400 font-bold uppercase">Precio Venta</label>
                <input type="number" 
                       value="${item.precio_venta}" 
                       min="${minPrice}" 
                       max="${maxPrice}" 
                       onchange="updateCartItemPrice(${index}, this.value)"
                       class="w-24 text-right font-black text-primary border-gray-200 rounded-lg py-1 px-2 text-sm focus:ring-primary focus:border-primary">
             </div>` 
            : `<p class="text-primary font-black text-sm">$${item.precio_venta}</p>`;

        // HTML de la Ganancia Din√°mica
        let colorGanancia = "text-emerald-500";
        if(item.comision_actual < item.comision) colorGanancia = "text-orange-500"; // Est√° perdiendo comisi√≥n
        if(item.comision_actual > item.comision) colorGanancia = "text-blue-600";   // Est√° ganando extra

        const gananciaDisplay = isGestor ?
            `<p class="text-[9px] font-bold ${colorGanancia} mt-1 text-right">
                Ganancia: $${item.comision_actual.toFixed(2)}
             </p>` : '';

        return `
        <div class="flex gap-4 bg-gray-50 dark:bg-gray-800 p-3 rounded-xl relative border border-gray-100 dark:border-gray-700">
            <img src="${fixDriveUrl(item.thumbnail)}" class="w-12 h-12 object-contain bg-white rounded border border-gray-200">
            
            <div class="flex-1">
                <h4 class="text-xs font-bold leading-tight pr-8 mb-2">${item.nombre}</h4>
                
                <div class="flex justify-between items-end">
                    <div class="text-[10px] text-gray-400">
                        Base: $${item.precio}
                    </div>
                    ${precioInput}
                </div>
                ${gananciaDisplay}
            </div>

            <button onclick="removeFromCart(${index})" class="absolute right-2 top-2 text-gray-300 hover:text-red-500 transition-colors">
                <span class="material-symbols-outlined text-sm">delete</span>
            </button>
        </div>`;
    }).join('');

    actualizarOpcionesMoneda(); // Esto recalcula los totales
}

    function recalcularTotalFinal() {
        const select = document.getElementById('check-moneda');
        const totalUSD = cart.reduce((acc, item) => acc + (item.precio_venta * item.qty) + (parseMensajeria(item.mensajeria) * item.qty), 0);
        
        const opcionElegida = select.value || "USD";
        let totalFinal = totalUSD;
        let simbolo = "$";

        if (opcionElegida.toUpperCase().includes("CUP")) {
            let tasaFinal = cupRate;
            if (opcionElegida.includes("+")) {
                const incremento = parseFloat(opcionElegida.match(/\d+/) || 0);
                tasaFinal = cupRate + incremento;
            } else {
                const tasaFija = parseFloat(opcionElegida.match(/\d+/) || cupRate);
                tasaFinal = (tasaFija > 100) ? tasaFija : cupRate;
            }
            totalFinal = totalUSD * tasaFinal;
            simbolo = "CUP";
        }

        document.getElementById('cart-total').innerText = `$${totalUSD.toFixed(2)} USD`;
        document.getElementById('total-convertido').innerText = `${simbolo} ${totalFinal.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    }

    function actualizarOpcionesMoneda() {
        const select = document.getElementById('check-moneda');
        if (!select || cart.length === 0) return;
        const pagosTexto = cart[0].pagos || "USD, CUP +10, Zelle";
        const opciones = pagosTexto.split(',').map(opt => opt.trim());
        select.innerHTML = opciones.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        select.onchange = recalcularTotalFinal;
        recalcularTotalFinal();
    }

    // 5. ENV√çO DE PEDIDO A SUPABASE (CON MENSAJER√çA EN WHATSAPP)
    document.getElementById('checkout-form').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('final-submit-btn');
        btn.disabled = true; 
        btn.innerText = "REGISTRANDO...";

        // DATOS DEL FORMULARIO
        const nombreC = document.getElementById('check-nombre').value;
        const ciC = document.getElementById('check-ci').value;
        const telC = document.getElementById('check-tel').value;
        const dirC = document.getElementById('check-dir').value;
        const monedaC = document.getElementById('check-moneda').value;
        const valVuelto = document.getElementById('check-vuelto').value;
        const vueltoC = (valVuelto && valVuelto > 0) ? `${valVuelto}` : "No requiere";

        // GESTI√ìN DE SESI√ìN
        // 1. ¬øEs un Gestor logueado comprando para s√≠ mismo? -> Prioridad Total
        // 2. ¬øEs un Cliente referido por un enlace? -> Usar referrerData
        // 3. Si no, es Venta Directa.

        let activeGestor = "Venta Directa";
        let activeGestorTel = "";

        if (window.gestorName) {
            // CASO A: El propio gestor est√° haciendo la compra desde su panel
            activeGestor = window.gestorName;
            activeGestorTel = window.currentUserData?.telefono || "";
        } else if (referrerData) {
            // CASO B: Es un cliente que entr√≥ con un enlace (o tiene cookie)
            activeGestor = referrerData.nombre;
            activeGestorTel = referrerData.telefono;
        }

        // --- L√ìGICA MULTI-PROVEEDOR ---
        
        // 1. Agrupar productos por proveedor
        const gruposPedidos = {};
        
        cart.forEach(item => {
            const prov = item.proveedor || 'General';
            if (!gruposPedidos[prov]) {
                gruposPedidos[prov] = { items: [], totalEquipo: 0, totalComision: 0, totalMensajeria: 0 };
            }
            gruposPedidos[prov].items.push(item);
            gruposPedidos[prov].totalEquipo += (item.precio_venta * item.qty);
            gruposPedidos[prov].totalComision += (item.comision_actual * item.qty);
            gruposPedidos[prov].totalMensajeria += (parseMensajeria(item.mensajeria) * item.qty);
        });

        // 2. Iterar sobre cada grupo y crear un pedido independiente
        const promesasInsert = [];
        let resumenWhatsApp = "";

        for (const [proveedor, datos] of Object.entries(gruposPedidos)) {
            
            const listaProductosStr = datos.items.map(i => `${i.qty}x ${i.nombre}`).join(', ');
            const totalFinalGrupo = datos.totalEquipo + datos.totalMensajeria; // Total USD de este sub-pedido

            // Insertar en Supabase
            const insertProm = supabaseClient.from('pedidos').insert([{
                gestor: activeGestor,
                cliente: nombreC, 
                ci: ciC, 
                telefono: telC, 
                direccion: dirC,
                producto: `${listaProductosStr} [${monedaC}]`,
                total: totalFinalGrupo,
                comision_total: datos.totalComision,
                estado: 'Pendiente', // Estado inicial
                pago_gestor: 'Pendiente',
                proveedor: proveedor, // <--- GUARDAMOS EL PROVEEDOR AQU√ç
                costo_mensajeria: datos.totalMensajeria
            }]);
            promesasInsert.push(insertProm);

            // Construir parte del mensaje de WhatsApp
            resumenWhatsApp += `üì¶ *Pedido (${proveedor}):*\n${listaProductosStr}\nüíµ Subtotal: $${totalFinalGrupo}\n\n`;
        }

        // 3. Ejecutar inserciones
        const resultados = await Promise.all(promesasInsert);
        const hayError = resultados.some(r => r.error);

        if (hayError) {
            alert("Error al guardar algunos pedidos. Verifique su conexi√≥n.");
            btn.disabled = false; btn.innerText = "Tramitar Pedido";
            return;
        }

        // --- ENLACE WHATSAPP GLOBAL ---
        let msj = `*NUEVA ORDEN - PARA TU HOGAR*%0A%0A` +
                  `üë§ *Cliente:* ${nombreC}%0A` +
                  `üìû *Tel√©fono:* ${telC}%0A` +
                  `üìç *Direcci√≥n:* ${dirC}%0A%0A` +
                  `------------------%0A` +
                  encodeURIComponent(resumenWhatsApp) + 
                  `üí∞ *Total Global:* *${document.getElementById('total-convertido').innerText}*%0A`;
        
        if (activeGestor !== "Venta Directa") msj += `üë®‚Äçüíª *Gestor:* ${activeGestor}`;

        window.open(`https://wa.me/5356071095?text=${msj}`, '_blank');
        
        setTimeout(() => {
            cart = [];
            toggleCartModal(false);
            location.reload();
        }, 1000);
    };

    // 6. FUNCIONES AUXILIARES
    function parseMensajeria(texto) {
        if (!texto) return 0;
        let t = texto.toString().toLowerCase();
        if (t.includes('gratis') && !t.includes('periferia')) return 0;
        let match = t.match(/\d+/);
        return match ? parseFloat(match[0]) : 0;
    }

    function fixDriveUrl(url) {
        if (!url) return 'https://placehold.co/400x400?text=No+Imagen';
        if (url.startsWith('http')) return url;
        return `${SUPABASE_URL}/storage/v1/object/public/productos/${url}`;
    }

    function toggleCartModal(show) { document.getElementById('cart-modal').classList.toggle('hidden', !show); if(show) renderCart(); }
    function closeDetail() { document.getElementById('detail-modal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
    function toggleCurrency() { showInCUP = !showInCUP; document.getElementById('currency-label').innerText = showInCUP ? 'CUP' : 'USD'; renderProducts(); }
    
    function filterByCategory(cat) { 
        activeCategory = cat; 
        
        // Re-renderizar categor√≠as para mover la clase 'active'
        renderCategories(); 
        
        // Filtrar productos
        renderProducts(); 
        
        // Actualizar etiqueta en la barra de marketing
        const label = document.getElementById('marketing-cat-label');
        if(label) label.innerText = cat;
    }
    function removeFromCart(i) { cart.splice(i, 1); document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0); renderCart(); }
    function filterProducts() { renderProducts(); }
    function copyOffer() {
        const text = `üî• *OFERTA DISPONIBLE*\nüì¶ ${selectedProduct.nombre}\nüí∞ Precio: $${selectedProduct.precio} USD\nüõ°Ô∏è Garant√≠a: ${selectedProduct.garantia}\nüöõ Env√≠o: ${selectedProduct.mensajeria}`;
        navigator.clipboard.writeText(text).then(() => alert("¬°Copiado!"));
    }

    // DASHBOARD DE GESTOR (Simplificado para Supabase)
    // DASHBOARD DE GESTOR (Corregido para Login)
    async function loadFullDashboard() {
        // Usamos window.gestorName que definimos en el Login
        const currentGestor = window.gestorName || gestorName; 

        if (!currentGestor) return;

        console.log("Cargando dashboard para:", currentGestor); // Para depurar

        // Consultamos SOLO los pedidos de este gestor
        const { data, error } = await supabaseClient
            .from('pedidos')
            .select('*')
            .eq('gestor', currentGestor);

        if (error) {
            console.error("Error cargando dashboard:", error);
            return;
        }
        
        const entregados = data.filter(p => p.estado === 'Entregado');
        const pendientes = data.filter(p => p.estado === 'Pendiente' || p.estado === 'En Camino');
        
        // Calculamos comisiones (Asumiendo que 'comision_total' es num√©rico en la BD)
        const ganancia = entregados.reduce((acc, curr) => acc + (Number(curr.comision_total) || 0), 0);

        // Actualizamos el HTML
        document.getElementById('dash-money').innerText = `$${ganancia.toFixed(2)}`;
        document.getElementById('dash-ok').innerText = entregados.length;
        document.getElementById('dash-pending').innerText = pendientes.length;

        // Ranking (Opcional: mostrar ranking global o solo tus ventas)
        renderRankingGestor(data); 
    }

    function renderRankingGestor(misVentas) {
        // Esta funci√≥n lista las √∫ltimas ventas del propio gestor en la lista de abajo
        const list = document.getElementById('ranking-list');
        list.innerHTML = misVentas.slice(0, 5).map(v => `
            <div class="p-4 flex justify-between items-center">
                <div>
                    <p class="text-[10px] font-bold text-gray-400">${new Date(v.created_at || new Date()).toLocaleDateString()}</p>
                    <p class="text-xs font-black uppercase text-gray-700">${v.producto.substring(0, 20)}...</p>
                </div>
                <span class="text-emerald-500 font-black text-xs">+$${v.comision_total}</span>
            </div>
        `).join('');
    }

    function showSection(section) {
        const isCat = section === 'catalogo';
        document.getElementById('sec-catalogo').style.display = isCat ? 'block' : 'none';
        document.getElementById('sec-dashboard').classList.toggle('hidden', isCat);
        document.getElementById('tab-cat').className = isCat ? "flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-primary text-white" : "flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-gray-100 text-gray-400";
        document.getElementById('tab-dash').className = !isCat ? "flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-primary text-white" : "flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-gray-100 text-gray-400";
        if(!isCat) loadFullDashboard();
        window.scrollTo(0,0);
    }

    // GESTORES
    function openGestorGen() { document.getElementById('gestor-modal').classList.remove('hidden'); }
    function closeGestorGen() { document.getElementById('gestor-modal').classList.add('hidden'); }
    function processGestor() {
        const pass = document.getElementById('master-pass').value;
        if(pass !== MASTER_KEY) return alert("C√≥digo Maestro Incorrecto");
        const name = document.getElementById('gen-name').value.trim();
        const tel = document.getElementById('gen-tel').value.trim();
        if(!name || !tel) return alert("Faltan datos");
        const base = window.location.origin + window.location.pathname;
        document.getElementById('link-admin').value = `${base}?gestor=${encodeURIComponent(name)}&tel=${tel}&admin=true`;
        document.getElementById('link-client').value = `${base}?gestor=${encodeURIComponent(name)}&tel=${tel}`;
        document.getElementById('links-result').classList.remove('hidden');
    }
    function copy(id) { const e = document.getElementById(id); e.select(); document.execCommand('copy'); alert("Copiado"); }

    // --- L√ìGICA DEL PANEL MAESTRO ---

// CORRECCI√ìN: Funci√≥n para entrar al Panel Maestro (Due√±o)
async function openAdminMaster() {
    const pass = prompt("Acceso Administrativo. Introduce la Clave de Due√±o:");
    
    // Cambiamos MASTER_KEY por ADMIN_SECRET_KEY para que use la clave de administrador
    if (pass === ADMIN_SECRET_KEY) { 
        document.getElementById('sec-catalogo').style.display = 'none';
        document.getElementById('sec-dashboard').classList.add('hidden');
        document.getElementById('admin-nav').classList.add('hidden');
        document.getElementById('sec-admin-master').classList.remove('hidden');
        loadAdminData();
    } else if (pass !== null) {
        alert("Clave de Administrador incorrecta.");
    }
}

let pedidosRawAdmin = []; // A√±ade esta l√≠nea antes de la funci√≥n

async function loadAdminData() {
    const { data: pedidos } = await supabaseClient.from('pedidos').select('*').order('fecha', {ascending: false});
    const { data: productos } = await supabaseClient.from('productos').select('*').order('nombre', {ascending: true});
    const { data: vistas } = await supabaseClient.from('metricas_vistas').select('*');

    if (pedidos) {
        pedidosRawAdmin = pedidos; 
        renderAdminLogistica(); // Usar√° el filtro por defecto 'TODOS'
        renderAdminCortes();
        updateAdminStats(pedidos);
        renderAnaliticaGestores(pedidos);
    }
    
    if (productos) {
        inventoryRawAdmin = productos; // <--- ESTO ES LO NUEVO IMPORTANTE
        renderAdminInventario();
    }
    
    if (vistas) renderAnaliticaVistas(vistas);
}

function updateAdminStats(pedidos) {
    const entregados = pedidos.filter(p => p.estado === 'Entregado');
    const totalUSD = entregados.reduce((acc, p) => acc + Number(p.total || 0), 0);
    const pendientes = pedidos.filter(p => p.estado === 'Pendiente' || p.estado === 'En Camino').length;
    const deuda = pedidos.filter(p => p.estado === 'Entregado' && p.pago_gestor === 'Pendiente')
                         .reduce((acc, p) => acc + Number(p.comision_total || 0), 0);

    document.getElementById('m-stat-ventas').innerText = `$${totalUSD.toLocaleString()}`;
    document.getElementById('m-stat-pendientes').innerText = pendientes;
    document.getElementById('m-stat-deuda').innerText = `$${deuda.toLocaleString()}`;
    document.getElementById('m-stat-gestores').innerText = new Set(pedidos.map(p => p.gestor)).size;
}

// --- NUEVA FUNCI√ìN DE LOG√çSTICA CON FILTRO Y BLOQUEO ---
function renderAdminLogistica() {
    const container = document.getElementById('list-admin-pedidos');
    const searchInput = document.getElementById('search-logistica');
    if (!container || !pedidosRawAdmin) return;

    const query = searchInput ? searchInput.value.toLowerCase() : "";
    
    // Filtro
    const filtrados = pedidosRawAdmin.filter(p => {
        const fecha = new Date(p.fecha).toLocaleDateString().toLowerCase();
        const textoMatch = fecha.includes(query) || 
                           (p.cliente || "").toLowerCase().includes(query) || 
                           (p.proveedor || "").toLowerCase().includes(query) || 
                           (p.gestor || "").toLowerCase().includes(query);
        
        // L√≥gica para agrupar 'Finalizados' (Entregado y Cancelado) si se filtra por historial
        /* Opcional: Si quieres ver Cancelados dentro de entregados, descomenta esto. 
           Si no, d√©jalo estricto como est√° abajo */
        
        const estadoMatch = currentStatusFilter === 'TODOS' || p.estado === currentStatusFilter;
        return textoMatch && estadoMatch;
    });

    if (filtrados.length === 0) {
        container.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-400 font-bold uppercase text-xs">No hay pedidos en: ${currentStatusFilter}</td></tr>`;
        return;
    }

    container.innerHTML = filtrados.map(p => {
        // Colores seg√∫n estado para identificaci√≥n r√°pida visual
        let colorClass = "bg-gray-100 text-gray-600"; // Default
        let borderClass = "border-l-4 border-gray-200";

        if(p.estado === 'Pendiente') {
            colorClass = "bg-yellow-100 text-yellow-700";
            borderClass = "border-l-4 border-yellow-400";
        }
        else if(p.estado === 'Recogida Almac√©n') {
            colorClass = "bg-orange-100 text-orange-700";
            borderClass = "border-l-4 border-orange-400";
        }
        else if(p.estado === 'Asignado Mensajero') {
            colorClass = "bg-blue-100 text-blue-700";
            borderClass = "border-l-4 border-blue-400";
        }
        else if(p.estado === 'Entregado') {
            colorClass = "bg-emerald-100 text-emerald-700";
            borderClass = "border-l-4 border-emerald-400";
        }
        else if(p.estado === 'Cancelado') {
            colorClass = "bg-red-100 text-red-700";
            borderClass = "border-l-4 border-red-400";
        }

        // Bloquear edici√≥n si ya es final
        const esFinal = (p.estado === 'Entregado' || p.estado === 'Cancelado');

        return `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/40 transition-all text-xs border-b dark:border-gray-700 bg-white dark:bg-gray-900 ${borderClass}">
            <td class="p-4 font-bold uppercase text-[10px]">
                <p class="text-gray-400 mb-1">${new Date(p.fecha).toLocaleDateString()}</p>
                <span class="text-primary">${p.cliente}</span>
            </td>
            <td class="p-4">
                <span class="bg-indigo-50 text-indigo-600 px-2 py-1 rounded border border-indigo-100 font-bold text-[9px] uppercase">
                    ${p.proveedor || 'General'}
                </span>
            </td>
            <td class="p-4 text-gray-500 max-w-xs truncate" title="${p.producto}">${p.producto}</td>
            <td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded text-[9px] font-bold">${p.gestor}</span></td>
            
            <!-- SELECTOR DE ESTADOS (L√ìGICA ADMINISTRADOR) -->
            <td class="p-4 text-right">
                ${esFinal ? 
                    `<span class="px-3 py-1.5 rounded-lg font-black text-[9px] uppercase ${colorClass}">
                        ${p.estado === 'Entregado' ? '‚úÖ ENTREGADO' : '‚ùå CANCELADO'}
                    </span>` 
                    :
                    `<select onchange="updatePedidoStatus('${p.id}', this.value)" class="text-[10px] font-black uppercase rounded-lg border-none ${colorClass} py-2 cursor-pointer focus:ring-0 w-40 text-center">
                        <option value="Pendiente" ${p.estado === 'Pendiente' ? 'selected' : ''}>‚è≥ Por Asignar</option>
                        <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                        <option value="Recogida Almac√©n" ${p.estado === 'Recogida Almac√©n' ? 'selected' : ''}>üè≠ En Almac√©n (Cliente Recoge)</option>
                        <option value="Asignado Mensajero" ${p.estado === 'Asignado Mensajero' ? 'selected' : ''}>üèçÔ∏è Asignar Mensajero</option>
                        <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                        <option value="Entregado">‚úÖ Marcar Entregado</option>
                        <option value="Cancelado">‚ùå Cancelar Pedido</option>
                    </select>`
                }
            </td>
        </tr>
    `; }).join('');
}

function renderAdminCortes() {
    const container = document.getElementById('list-admin-cortes');
    if (!container || !pedidosRawAdmin) return;

    const searchTerm = (document.getElementById('search-gestor-pago')?.value || "").toLowerCase();
    
    // --- CORRECCI√ìN AQU√ç ---
    // Antes buscaba 'input-tasa-cup', ahora busca 'daily-rate'
    const tasaInput = document.getElementById('daily-rate');
    const tasa = tasaInput ? parseFloat(tasaInput.value) : 450; 
    // -----------------------

    // Filtramos solo los pedidos entregados que deben comisi√≥n
    const deuda = pedidosRawAdmin.filter(p => p.estado === 'Entregado' && p.pago_gestor === 'Pendiente');

    // Agrupar por gestor
    const porGestor = deuda.reduce((acc, p) => {
        const gName = p.gestor || "Venta Directa";
        if (!acc[gName]) acc[gName] = { usd: 0, count: 0, ids: [] };
        acc[gName].usd += Number(p.comision_total || 0);
        acc[gName].count++;
        acc[gName].ids.push(p.id);
        return acc;
    }, {});

    const entries = Object.entries(porGestor).filter(([name]) => name.toLowerCase().includes(searchTerm));

    if (entries.length === 0) {
        container.innerHTML = `<tr><td colspan="5" class="p-10 text-center text-gray-400 font-bold uppercase text-xs">Todo al d√≠a. No hay comisiones pendientes de pago.</td></tr>`;
        return;
    }

    container.innerHTML = entries.map(([name, data]) => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-900/40 transition-all border-b dark:border-gray-700 bg-white dark:bg-gray-900">
            <td class="p-4 font-black text-primary uppercase italic text-xs">${name}</td>
            <td class="p-4 font-bold text-gray-400 text-xs">${data.count} ventas</td>
            <td class="p-4 font-black text-sm">$${data.usd.toFixed(2)}</td>
            
            <!-- Aqu√≠ usamos la tasa corregida -->
            <td class="p-4 font-black text-emerald-500 text-sm italic">${(data.usd * tasa).toLocaleString()} CUP</td>
            
            <td class="p-4 text-right">
                <button onclick="liquidarComisiones('${data.ids.join(',')}')" class="bg-gray-900 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-black transition-colors shadow-lg shadow-gray-900/20">
                    Liquidar (Pagar)
                </button>
            </td>
        </tr>
    `).join('');
}

async function liquidarComisiones(idsStr) {
    if (!confirm("¬øYa pagaste estas comisiones?")) return;
    await supabaseClient.from('pedidos').update({ pago_gestor: 'Pagado' }).in('id', idsStr.split(','));
    loadAdminData();
}

async function updatePedidoStatus(id, nuevoEstado) {
    await supabaseClient.from('pedidos').update({ estado: nuevoEstado }).eq('id', id);
    loadAdminData();
}

function renderAdminInventario(productos) {
    const container = document.getElementById('list-admin-inventario');
    
    if (!container) {
        console.error("Error: No se encontr√≥ el contenedor 'list-admin-inventario' en el HTML.");
        return;
    }

    if (!productos || productos.length === 0) {
        container.innerHTML = `<div class="col-span-full py-20 text-center text-gray-400 font-bold uppercase text-xs italic">No hay productos cargados en la base de datos.</div>`;
        return;
    }

    container.innerHTML = productos.map(p => `
        <div class="bg-white dark:bg-gray-800 p-4 rounded-3xl border shadow-sm flex flex-col justify-between h-full text-left">
            <div>
                <img src="${fixDriveUrl(p.thumbnail)}" class="w-full h-32 object-contain mb-4 bg-gray-50 rounded-2xl p-2">
                <h6 class="text-[10px] font-black leading-tight mb-1 uppercase text-gray-700 dark:text-gray-200">${p.nombre}</h6>
                <p class="text-primary font-black text-sm mb-4">$${p.precio}</p>
            </div>
            
            <!-- NUEVO BLOQUE DE BOTONES (STOCK + EDITAR) -->
            <div class="flex gap-2">
                <button onclick="toggleStockAdmin('${p.id}', '${p.disponible}')" 
                    class="flex-1 py-2 rounded-xl text-[9px] font-black uppercase transition-all ${p.disponible === 'SI' ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white'}">
                    ${p.disponible === 'SI' ? '‚óè En Stock' : '‚óã Agotado'}
                </button>
                <button onclick="editProduct('${p.id}')" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-xl hover:bg-primary hover:text-white transition-all shadow-sm">
                    <span class="material-symbols-outlined text-sm">edit</span>
                </button>
            </div>
        </div>
    `).join('');
}

async function toggleStockAdmin(id, actual) {
    await supabaseClient.from('productos').update({ disponible: actual === 'SI' ? 'NO' : 'SI' }).eq('id', id);
    loadAdminData();
}

function renderAnaliticaVistas(vistas) {
    const counts = vistas.reduce((acc, v) => { acc[v.nombre_producto] = (acc[v.nombre_producto] || 0) + 1; return acc; }, {});
    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
    document.getElementById('list-analitica-vistas').innerHTML = sorted.map(([name, count]) => `
        <div class="flex justify-between items-center text-[11px] font-bold uppercase italic text-gray-500">
            <p class="truncate pr-4">${name}</p>
            <p class="text-primary">${count} clics</p>
        </div>
    `).join('');
}

function renderAnaliticaGestores(pedidos) {
    const counts = pedidos.filter(p => p.estado === 'Entregado').reduce((acc, p) => { acc[p.gestor] = (acc[p.gestor] || 0) + 1; return acc; }, {});
    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
    document.getElementById('list-analitica-gestores').innerHTML = sorted.map(([name, count]) => `
        <div class="flex justify-between items-center text-[11px] font-bold uppercase italic text-gray-500">
            <p>${name}</p>
            <p class="text-primary">${count} ventas</p>
        </div>
    `).join('');
}

function changeAdminTab(tab) {
        // 1. OCULTAR TODOS
        document.querySelectorAll('.tab-cnt').forEach(c => {
            c.classList.add('hidden'); // A√±ade la clase Tailwind
            c.style.display = '';      // Limpia estilos manuales (reset)
        });
        
        // 2. MOSTRAR EL SELECCIONADO
        const target = document.getElementById('cnt-' + tab);
        if(target) {
            target.classList.remove('hidden'); // Quita la clase Tailwind
            // No forzamos 'block' ni 'grid' aqu√≠, dejamos que el HTML decida
            // (as√≠ 'cnt-analitica' usar√° su clase 'grid' y 'cnt-logistica' usar√° 'block')
        } else {
            console.error("No encuentro el tab:", 'cnt-' + tab);
        }
        
        // 3. GESTIONAR BOTONES (Visual)
        document.querySelectorAll('.btn-tab-admin').forEach(b => {
            b.classList.remove('active'); // Quita azul
            b.classList.add('text-gray-400'); // Pone gris
            b.classList.remove('text-white');
        });
        
        const btn = document.getElementById('tab-' + tab);
        if(btn) {
            btn.classList.add('active'); // Pone azul
            btn.classList.remove('text-gray-400'); // Quita gris
        }
    }

// Registro de estad√≠sticas
async function registrarVistaAnalitica(p) {
    await supabaseClient.from('metricas_vistas').insert([{ producto_id: p.id, nombre_producto: p.nombre }]);
}
// Funci√≥n para saltar del panel de gestores al panel de administraci√≥n maestro
// CORRECCI√ìN: Funci√≥n para saltar desde el modal de gestores

function openAdminMasterFromGestor() {
    const passInput = document.getElementById('master-pass').value;
    
    // Verificamos si la clave escrita en el recuadro es la del due√±o
    if (passInput === ADMIN_SECRET_KEY) {
        closeGestorGen(); // Cerramos el modal
        
        // Ejecutamos la apertura directamente sin volver a preguntar
        document.getElementById('sec-catalogo').style.display = 'none';
        document.getElementById('sec-dashboard').classList.add('hidden');
        document.getElementById('admin-nav').classList.add('hidden');
        document.getElementById('sec-admin-master').classList.remove('hidden');
        loadAdminData();
    } else {
        alert("Para acceder aqu√≠, escribe la Clave de Due√±o en el campo 'C√≥digo Maestro'.");
    }
}

// --- FUNCIONES PARA EL FORMULARIO DE PRODUCTOS ---

function openModalProd() { 
        updateFormCategories(); // <--- AGREGAR ESTA L√çNEA AQU√ç

    // 1. Limpiar el ID de edici√≥n (para que sepa que es uno NUEVO)
    const idEdit = document.getElementById('p-id-edit');
    if(idEdit) idEdit.value = "";
    
    // 2. Resetear todos los inputs del formulario (nombres, precios, etc)
    const form = document.getElementById('form-nuevo-prod');
    if(form) form.reset();
    
    // 3. Limpiar el editor de texto (Quill)
    if (typeof quill !== 'undefined' && quill !== null) {
        quill.root.innerHTML = "";
    }

    // 4. Limpiar las 4 im√°genes (Rutas, Previsualizaciones e Iconos)
    for (let i = 0; i < 4; i++) {
        const pathInput = document.getElementById(`img-path-${i}`);
        const previewImg = document.getElementById(`prev-${i}`);
        const iconSpan = document.getElementById(`icon-${i}`);

        if(pathInput) pathInput.value = "";
        if(previewImg) {
            previewImg.src = "";
            previewImg.classList.add('hidden');
        }
        if(iconSpan) {
            iconSpan.classList.remove('hidden');
            iconSpan.innerText = "add_a_photo";
        }
    }

    // 5. Asegurar que el bot√≥n diga "Guardar Cambios" y no "Actualizar"
    const btnSave = document.getElementById('btn-save-prod');
    if(btnSave) btnSave.innerText = "Guardar Cambios";
    
    // 6. Mostrar el modal
    const modal = document.getElementById('modal-producto');
    if(modal) modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeModalProd() { 
    document.getElementById('modal-producto').classList.add('hidden'); 
    document.body.style.overflow = 'auto';
}

// --- FUNCI√ìN PARA PROCESAR Y SUBIR IMAGEN ---
async function handleImageUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const msg = document.getElementById('upload-msg');
    const btn = document.getElementById('btn-upload');
    
    msg.innerText = "‚è≥ Optimizando y subiendo imagen...";
    btn.disabled = true;

    try {
        // 1. Comprimir imagen para ahorrar datos en Cuba
        const compressedBlob = await compressImage(file, 800, 800);

        // 2. Crear un nombre limpio para Supabase
        const cleanName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
        const fileName = `${Date.now()}_${cleanName}`;

        // 3. Subir al Storage
        const { data, error } = await supabaseClient.storage
            .from('productos')
            .upload(fileName, compressedBlob);

        if (error) throw error;

        // 4. GUARDAR EL NOMBRE EN EL CAMPO OCULTO (Paso Vital)
        document.getElementById('p-img-name').value = fileName;
        
        msg.innerHTML = `‚úÖ Foto lista para guardar`;
        btn.innerText = "Imagen Vinculada";
        btn.style.borderColor = "#33ccc4";
        
    } catch (e) {
        console.error(e);
        alert("Error al procesar la imagen: " + e.message);
        msg.innerText = "‚ùå Error en la subida";
        btn.disabled = false;
    }
}

// --- GUARDAR EL PRODUCTO COMPLETO EN LA TABLA ---
document.getElementById('form-nuevo-prod').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // 1. Validaciones previas
    const imgName = document.getElementById('p-img-name').value;
    if (!imgName) {
        alert("‚ùå Error: Debes subir una foto primero y esperar a que diga 'Foto lista'.");
        return;
    }

    const btn = e.target.querySelector('button');
    btn.disabled = true; 
    btn.innerText = "REGISTRANDO EN BASE DE DATOS...";

    // 2. Captura de datos (Aseg√∫rate de que los IDs existan en el HTML)
    const objetoInsertar = {
        nombre: document.getElementById('p-nombre').value,
        precio: parseFloat(document.getElementById('p-precio').value),
        comision: parseFloat(document.getElementById('p-comision').value) || 0,
        categoria: document.getElementById('p-categoria').value,
        descripcion: document.getElementById('p-desc').value,
        thumbnail: imgName, // El nombre que guard√≥ handleImageUpload
        mensajeria: document.getElementById('p-mensajeria').value,
        disponible: 'SI',
        // === NUEVOS CAMPOS ===
        proveedor: document.getElementById('p-proveedor').value || 'General',
        precio_flexible: document.getElementById('p-flexible').value,
        garantia: document.getElementById('p-garantia').value,
        pagos: 'USD, CUP, Zelle'
    };

    console.log("Enviando a Supabase:", objetoInsertar);

    // 3. Inserci√≥n en la tabla 'productos'
    const { data, error } = await supabaseClient
        .from('productos')
        .insert([objetoInsertar])
        .select();

    if (error) {
        console.error("Error detallado:", error);
        alert("‚ùå ERROR AL GUARDAR: " + error.message);
        btn.disabled = false;
        btn.innerText = "Guardar en Cat√°logo";
    } else {
        alert("‚úÖ PRODUCTO A√ëADIDO CON √âXITO");
        location.reload(); 
    }
});


// Funci√≥n m√°gica de compresi√≥n
function compressImage(file, maxWidth, maxHeight) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                } else {
                    if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Convertir a Blob (JPEG con calidad 0.7 es super ligero)
                canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.7);
            };
        };
    });
}

// --- FUNCI√ìN UNIVERSAL PARA EXPORTAR A EXCEL ---
function exportToExcel(tableId, fileName) {
    const table = document.getElementById(tableId);
    if (!table) return alert("No hay datos para exportar");

    // Creamos una hoja de trabajo a partir de la tabla HTML
    const wb = XLSX.utils.table_to_book(table, { sheet: "Reporte" });
    
    // Generamos el archivo y lo descargamos
    // Le a√±ade la fecha de hoy al nombre para que no se confundan los archivos
    const fecha = new Date().toLocaleDateString().replace(/\//g, '-');
    XLSX.writeFile(wb, `${fileName}_${fecha}.xlsx`);
}


// 2. Subida de im√°genes mejorada (para los 4 espacios)
async function handlePowerUpload(input, index) {
    const file = input.files[0];
    if (!file) return;

    const icon = document.getElementById(`icon-${index}`);
    const prev = document.getElementById(`prev-${index}`);
    icon.innerText = "sync"; // Icono de cargando

    try {
        const compressedBlob = await compressImage(file, 800, 800);
        const fileName = `${Date.now()}_${index}_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}.jpg`;

        const { error } = await supabaseClient.storage.from('productos').upload(fileName, compressedBlob);
        if (error) throw error;

        // Mostrar previsualizaci√≥n
        document.getElementById(`img-path-${index}`).value = fileName;
        prev.src = URL.createObjectURL(compressedBlob);
        prev.classList.remove('hidden');
        icon.classList.add('hidden');
    } catch (e) {
        alert("Error al subir foto " + (index + 1));
        icon.innerText = "add_a_photo";
    }
}

// 3. Funci√≥n para EDITAR producto (Cargar datos en el modal)
// 3. Funci√≥n para EDITAR producto (CORREGIDA)
    function editProduct(id) {
        // 1. Buscar el producto en la lista de Inventario (Admin) O en la de Cat√°logo
        // Esto asegura que funcione donde sea que est√©s
        const p = (typeof inventoryRawAdmin !== 'undefined' ? inventoryRawAdmin.find(prod => prod.id === id) : null) 
                  || productosRaw.find(prod => prod.id === id);
        
        if (!p) return alert("Error: No se encuentra la informaci√≥n del producto.");

        // 2. Llenar campos del formulario
        // Aseg√∫rate de que los IDs del HTML coincidan (p-id-edit, p-nombre, etc.)
        const inputs = {
            'p-id-edit': p.id,
            'p-nombre': p.nombre,
            'p-precio': p.precio,
            'p-comision': p.comision,
            'p-categoria': p.categoria,
            'p-garantia': p.garantia,
            'p-proveedor': p.proveedor,
            'p-flexible': p.precio_flexible || 'NO'
        };

        for (const [key, value] of Object.entries(inputs)) {
            const el = document.getElementById(key);
            if(el) el.value = value || "";
        }
        
        // 3. Cambiar texto del bot√≥n
        const btnSave = document.getElementById('btn-save-prod');
        if(btnSave) btnSave.innerText = "Actualizar Producto";

        // 4. Cargar Descripci√≥n en el Editor Quill
        if (typeof quill !== 'undefined' && quill) {
            quill.root.innerHTML = p.descripcion || "";
        } else {
            console.warn("Editor Quill no activo o no definido.");
            // Intento de recuperaci√≥n si no existe:
            const editorDiv = document.getElementById('editor-container');
            if(editorDiv) editorDiv.innerHTML = p.descripcion || ""; 
        }

        // 5. Cargar Fotos (Previsualizaci√≥n)
        const fotos = [p.thumbnail, p.image1, p.image2, p.image3];
        fotos.forEach((foto, i) => {
            const pathInput = document.getElementById(`img-path-${i}`);
            const prev = document.getElementById(`prev-${i}`);
            const icon = document.getElementById(`icon-${i}`);

            if (pathInput) pathInput.value = foto || "";
            
            if (foto) {
                if(prev) { prev.src = fixDriveUrl(foto); prev.classList.remove('hidden'); }
                if(icon) icon.classList.add('hidden');
            } else {
                if(prev) { prev.src = ""; prev.classList.add('hidden'); }
                if(icon) icon.classList.remove('hidden');
            }
        });

        // 6. Mostrar Modal
        document.getElementById('modal-producto').classList.remove('hidden');
    }

// 4. Guardar (Funciona para NUEVO y para EDITAR)
document.getElementById('form-nuevo-prod').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = document.getElementById('btn-save-prod');
    const editId = document.getElementById('p-id-edit').value;
    
    btn.disabled = true; btn.innerText = "GUARDANDO...";

    const datos = {
        nombre: document.getElementById('p-nombre').value,
        precio: parseFloat(document.getElementById('p-precio').value),
        comision: parseFloat(document.getElementById('p-comision').value),
        categoria: document.getElementById('p-categoria').value,
        garantia: document.getElementById('p-garantia').value,
        descripcion: quill.root.innerHTML, // Sacamos el HTML del editor Word
        thumbnail: document.getElementById('img-path-0').value,
        image1: document.getElementById('img-path-1').value,
        image2: document.getElementById('img-path-2').value,
        image3: document.getElementById('img-path-3').value,
        disponible: 'SI'
    };

    let error;
    if (editId) {
        // SI TIENE ID, ACTUALIZAMOS
        const { error: err } = await supabaseClient.from('productos').update(datos).eq('id', editId);
        error = err;
    } else {
        // SI NO TIENE ID, INSERTAMOS NUEVO
        const { error: err } = await supabaseClient.from('productos').insert([datos]);
        error = err;
    }

    if (!error) {
        alert("¬°Guardado correctamente!");
        location.reload();
    } else {
        alert("Error: " + error.message);
        btn.disabled = false;
    }
});

// --- 3. HERRAMIENTAS DE MARKETING (DESCARGAR Y COPIAR) ---

    // Funci√≥n mejorada para forzar la descarga de la imagen
    async function downloadProductImage() {
        if(!selectedProduct) return;
        
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = `<span class="loader w-4 h-4 border-2 border-primary"></span>`; // Spinner peque√±o
        
        try {
            const url = fixDriveUrl(selectedProduct.thumbnail);
            
            // 1. Obtenemos la imagen como un "blob" (archivo crudo)
            const response = await fetch(url);
            const blob = await response.blob();
            
            // 2. Creamos un enlace temporal en memoria
            const blobUrl = window.URL.createObjectURL(blob);
            
            // 3. Forzamos la descarga
            const link = document.createElement('a');
            link.href = blobUrl;
            // Limpiamos el nombre del archivo para que se guarde bonito
            const cleanName = selectedProduct.nombre.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            link.download = `foto_${cleanName}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // 4. Limpiamos memoria
            window.URL.revokeObjectURL(blobUrl);
            
            btn.innerHTML = originalText;
        } catch (error) {
            console.error(error);
            alert("No se pudo descargar la imagen directamente. Intenta mantener presionado sobre la foto.");
            btn.innerHTML = originalText;
        }
    }

    // Funci√≥n para copiar texto de venta profesional con enlace de afiliado
    function copySmartOffer() {
        if(!selectedProduct) return;
        
        const gestor = window.gestorName || '';
        const userData = window.currentUserData || {}; 
        
        // Creamos el enlace que lleva directo al producto y marca al gestor
        let trackingLink = `${window.location.origin}${window.location.pathname}?search=${encodeURIComponent(selectedProduct.nombre)}`;
        if (gestor) trackingLink += `&gestor=${encodeURIComponent(gestor)}`;
        if (userData.telefono) trackingLink += `&tel=${userData.telefono}`;

        // Texto persuasivo para redes sociales
        const textoVenta = 
`üî• *¬°OFERTA ESPECIAL!* üî•
üì¶ Modelo: *${selectedProduct.nombre}*

üí∞ Precio: *$${selectedProduct.precio} USD*
üöö Mensajer√≠a: ${selectedProduct.mensajeria || 'A consultar'}
üõ°Ô∏è Garant√≠a: ${selectedProduct.garantia || 'Garant√≠a Incluida'}

üëá *Ver fotos y detalles aqu√≠:*
${trackingLink}

‚úÖ *Pedir ahora por WhatsApp:*
https://wa.me/${userData.telefono || '5356071095'}?text=${encodeURIComponent('Hola, me interesa el equipo: ' + selectedProduct.nombre)}`;

        navigator.clipboard.writeText(textoVenta).then(() => {
            alert("¬°Oferta copiada! P√©gala en WhatsApp o Facebook.");
        });
    }

// ==========================================
// NUEVO: M√ìDULO PRO PARA GESTORES 2.0
// ==========================================

// --- 1. L√ìGICA DE FILTROS Y ORDENAMIENTO ---

function applySort() {
    const criteria = document.getElementById('sort-selector').value;
    let sorted = [...productosRaw]; // Copia para no da√±ar original

    switch (criteria) {
        case 'comision_desc':
            // Ordenar por comisi√≥n (mayor a menor)
            sorted.sort((a, b) => (parseFloat(b.comision) || 0) - (parseFloat(a.comision) || 0));
            break;
        case 'precio_asc':
            sorted.sort((a, b) => parseFloat(a.precio) - parseFloat(b.precio));
            break;
        case 'precio_desc':
            sorted.sort((a, b) => parseFloat(b.precio) - parseFloat(a.precio));
            break;
        case 'nuevo':
            // Asumimos que ID m√°s alto o fecha 'created_at' es m√°s nuevo
            sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            break;
        default:
            // Por defecto (Alfab√©tico o como venga de DB)
            sorted.sort((a, b) => a.nombre.localeCompare(b.nombre));
    }
    
    // Renderizamos pasando la lista ordenada
    renderProductsCustom(sorted);
}

function renderProductsCustom(lista) {
    const container = document.getElementById('productos-container');
    const isGestor = window.gestorName ? true : false;
    
    container.innerHTML = lista.map(p => {
        const precio = parseFloat(p.precio) || 0;
        
        // --- INICIO: NUEVA L√ìGICA DE PRECIOS INTELIGENTE (IGUAL QUE EN RENDERPRODUCTS) ---
        let pDisplay = `$${precio}`; // Valor por defecto

        if (showInCUP) {
            // Usamos la misma funci√≥n inteligente
            const precioCUP = calculateProductCUP(precio, p.pagos);
            
            if (precioCUP) {
                // Formato limpio
                pDisplay = `CUP ${precioCUP.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            } else {
                // Si el producto no acepta CUP
                pDisplay = "<span class='text-sm text-gray-400'>Solo USD/EUR</span>";
            }
        }
        // --- FIN: NUEVA L√ìGICA ---
        
        // Etiqueta de Comisi√≥n + Indicador de Precio Flexible
        let htmlComision = isGestor ? 
            `<div class="absolute top-2 right-2 flex flex-col items-end gap-1 z-10">
                <span class="bg-emerald-500 text-white text-[10px] font-black px-2 py-1 rounded-lg shadow-md">GANAS $${p.comision || 0}</span>
                ${p.precio_flexible === 'SI' ? '<span class="bg-blue-600 text-white text-[9px] font-bold px-2 py-1 rounded-lg shadow-md border border-white">üìà PRECIO LIBRE</span>' : ''}
             </div>` : '';

        return `
        <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden border border-slate-100 dark:border-gray-700 group shadow-sm hover:shadow-xl transition-all duration-300 relative flex flex-col">
            ${htmlComision}
            
            <!-- Imagen Clickable -->
            <div onclick="openDetail('${p.nombre.replace(/'/g, "\\'")}')" class="w-full aspect-square bg-slate-50 dark:bg-gray-900 p-4 relative overflow-hidden cursor-pointer">
                <div class="absolute inset-0 bg-center bg-no-repeat bg-contain transition-transform group-hover:scale-110 duration-500" style="background-image: url('${fixDriveUrl(p.thumbnail)}');"></div>
            </div>

            <!-- Info -->
            <div class="p-5 flex flex-col gap-2 flex-1">
                <h3 class="text-slate-800 dark:text-white text-sm font-bold leading-snug line-clamp-2 min-h-[2.5rem]">${p.nombre}</h3>
                <p class="text-primary text-2xl font-black">${pDisplay}</p>
                
                <button onclick="openDetail('${p.nombre.replace(/'/g, "\\'")}')" class="mt-auto w-full flex items-center justify-center gap-2 bg-primary text-white py-2.5 rounded-lg text-xs font-extrabold hover:bg-secondary transition-colors shadow-md">
                    Ver Detalles
                </button>
            </div>

            <!-- BARRA SOCIAL -->
            <div class="grid grid-cols-2 border-t border-gray-100 dark:border-gray-700 divide-x divide-gray-100 dark:divide-gray-700 bg-gray-50 dark:bg-gray-900/50">
                <button onclick="shareProductSocial('${p.nombre.replace(/'/g, "\\'")}', 'wa')" class="py-3 flex items-center justify-center gap-1 text-gray-400 hover:text-green-500 hover:bg-green-50 transition-all">
                    <i class="fab fa-whatsapp text-lg"></i> <span class="text-[9px] font-bold uppercase">Estado</span>
                </button>
                <button onclick="shareProductSocial('${p.nombre.replace(/'/g, "\\'")}', 'fb')" class="py-3 flex items-center justify-center gap-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition-all">
                    <i class="fab fa-facebook text-lg"></i> <span class="text-[9px] font-bold uppercase">Post</span>
                </button>
            </div>
        </div>`;
    }).join('');
}

// IMPORTANTE: Modificar la funci√≥n 'renderProducts' original para que use esta si no hay filtros,
// O simplemente llamar a applySort() al cargar si hay gestor.
// Agrega esto dentro de tu 'setupSession' cuando el modo NO es admin:
// document.getElementById('gestor-filters').classList.remove('hidden');

// --- 2. L√ìGICA DE ANAL√çTICA (HORARIOS Y TENDENCIAS) ---

async function loadAnalyticsPro(nombreGestor) {
    // Traer todos los pedidos entregados
    const { data: pedidos } = await supabaseClient
        .from('pedidos')
        .select('created_at, producto, gestor, estado')
        .eq('estado', 'Entregado');

    if (!pedidos) return;

    // A. CALCULAR HORA PICO DEL GESTOR
    const misPedidos = pedidos.filter(p => p.gestor === nombreGestor);
    if (misPedidos.length > 0) {
        const horas = misPedidos.map(p => new Date(p.created_at).getHours());
        const conteoHoras = {};
        let maxHora = 0, maxCount = 0;
        
        horas.forEach(h => {
            conteoHoras[h] = (conteoHoras[h] || 0) + 1;
            if (conteoHoras[h] > maxCount) {
                maxCount = conteoHoras[h];
                maxHora = h;
            }
        });
        
        // Formato 14:00 - 15:00
        document.getElementById('ana-hora-pico').innerText = `${maxHora}:00 - ${maxHora+1}:00`;
    } else {
        document.getElementById('ana-hora-pico').innerText = "Sin datos a√∫n";
    }

    // B. TENDENCIA GLOBAL (TOP 3 PRODUCTOS WEB)
    // Contamos frecuencia de nombres de productos en TODOS los pedidos
    const conteoGlobal = {};
    pedidos.forEach(p => {
        // Limpiamos el string del producto (ej: "1x Olla Reina..." -> "Olla Reina")
        // Simplificaci√≥n: tomamos los primeros 15 caracteres para agrupar
        const cleanName = p.producto.substring(3, 20); 
        conteoGlobal[cleanName] = (conteoGlobal[cleanName] || 0) + 1;
    });

    const topGlobal = Object.entries(conteoGlobal)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 3); // Top 3

    document.getElementById('ana-tendencia-global').innerHTML = topGlobal.map((item, i) => `
        <div class="flex justify-between items-center mb-1">
            <span class="text-[10px] font-black uppercase">#${i+1} ${item[0]}...</span>
            <span class="text-xs font-bold text-primary">${item[1]} vtas</span>
        </div>
    `).join('');
}

// --- 3. L√ìGICA DE REPORTES (BUZ√ìN) ---

function previewReportImg() {
    const input = document.getElementById('rep-file');
    if(input.files && input.files[0]) {
        document.getElementById('rep-file-name').innerText = "üì∑ " + input.files[0].name;
    }
}

async function sendGestorReport() {
    const gestor = window.gestorName;
    const tipo = document.getElementById('rep-tipo').value;
    const msg = document.getElementById('rep-msg').value;
    const fileInput = document.getElementById('rep-file');
    
    if (!msg) return alert("Por favor describe el detalle.");
    
    // Subir imagen si existe
    let imgUrl = null;
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const fileName = `reportes/${Date.now()}_${gestor}_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
        
        // Usamos la misma l√≥gica de upload que ya tienes, pero al bucket 'reportes' o 'productos' si no creaste otro
        // Si no creaste bucket 'reportes', usa 'productos' temporalmente
        const { data, error } = await supabaseClient.storage.from('productos').upload(fileName, file);
        if (!error) imgUrl = fileName;
    }

    // Guardar en Base de Datos
    const { error } = await supabaseClient.from('reportes_gestor').insert([{
        gestor: gestor,
        categoria: tipo,
        mensaje: msg,
        imagen_url: imgUrl,
        estado: 'Pendiente'
    }]);

    if (error) {
        alert("Error al enviar reporte: " + error.message);
    } else {
        alert("‚úÖ Gracias por tu aporte. Lo revisaremos.");
        document.getElementById('form-reporte-gestor').reset();
        document.getElementById('rep-file-name').innerText = "";
    }
}

// ==========================================
// FORZAR FUNCI√ìN DE SALIDA (GLOBAL)
// ==========================================
window.doLogout = function() {
    console.log("Bot√≥n de salir presionado..."); // Esto aparecer√° en la consola si funciona
    
    // 1. Preguntar confirmaci√≥n
    if(confirm("¬øEst√°s seguro de que quieres cerrar sesi√≥n y salir?")) {
        
        // 2. Borrar la memoria del navegador
        localStorage.removeItem('pth_session');
        
        // 3. Limpiar variables globales por si acaso
        window.gestorName = null;
        window.currentUserData = null;

        // 4. Limpiar la URL (quitar ?gestor=... si existe) y recargar
        // Esto lleva al usuario de vuelta a la pantalla de Login limpia
        window.location.href = window.location.origin + window.location.pathname;
    }
};
// ==========================================
    // HERRAMIENTAS DE MARKETING MASIVO
    // ==========================================

    // 1. COPIAR LISTA DE OFERTAS (AMETRALLADORA)
    function copyCategoryOffers() {
        const gestor = window.gestorName;
        const userData = window.currentUserData || {};
        
        // Filtramos los productos que se est√°n viendo actualmente (por categor√≠a)
        const visibleProducts = productosRaw.filter(p => {
            return (activeCategory === 'TODOS' || (p.categoria && p.categoria.toUpperCase().includes(activeCategory))) && p.disponible === "SI";
        });

        if (visibleProducts.length === 0) return alert("No hay productos en esta categor√≠a.");

        let textoFinal = `üåü *CAT√ÅLOGO DISPONIBLE - ${activeCategory}* üåü\n\n`;

        visibleProducts.forEach(p => {
            // Generar enlace trackeado
            let link = `${window.location.origin}${window.location.pathname}?search=${encodeURIComponent(p.nombre)}`;
            if (gestor) link += `&gestor=${encodeURIComponent(gestor)}`;
            if (userData.telefono) link += `&tel=${userData.telefono}`;

            textoFinal += `üì¶ *${p.nombre}*\n`;
            textoFinal += `üí∞ Precio: $${p.precio} USD\n`;
            textoFinal += `üîó Ver: ${link}\n`;
            textoFinal += `--------------------------------\n`;
        });

        textoFinal += `\n‚úÖ *Pedir aqu√≠:* https://wa.me/${userData.telefono || '5356071095'}`;

        navigator.clipboard.writeText(textoFinal).then(() => {
            alert(`¬°Copiadas ${visibleProducts.length} ofertas al portapapeles!`);
        });
    }

    // 2. DESCARGAR PACK DE FOTOS (ZIP)
    async function downloadCategoryPhotos() {
        if (typeof JSZip === 'undefined') return alert("Librer√≠a ZIP no cargada. Recarga la p√°gina.");

        const visibleProducts = productosRaw.filter(p => {
            return (activeCategory === 'TODOS' || (p.categoria && p.categoria.toUpperCase().includes(activeCategory))) && p.disponible === "SI";
        });

        if (visibleProducts.length === 0) return alert("No hay productos.");
        if (visibleProducts.length > 20) {
            if(!confirm(`Vas a descargar ${visibleProducts.length} im√°genes. Esto puede tardar unos segundos. ¬øContinuar?`)) return;
        }

        const btn = event.currentTarget;
        const oldText = btn.innerHTML;
        btn.innerHTML = `‚è≥ Comprimiendo...`;
        btn.disabled = true;

        const zip = new JSZip();
        const folder = zip.folder(`Catalogo_${activeCategory}`);

        try {
            // Recorremos productos y descargamos fotos
            const promises = visibleProducts.map(async (p) => {
                try {
                    const url = fixDriveUrl(p.thumbnail);
                    const response = await fetch(url);
                    if(!response.ok) throw new Error('Network response was not ok');
                    const blob = await response.blob();
                    
                    // Nombre del archivo limpio
                    const safeName = p.nombre.replace(/[^a-z0-9]/gi, '_').substring(0, 50);
                    folder.file(`${safeName}.jpg`, blob);
                } catch (err) {
                    console.warn("Error descargando imagen para ZIP:", p.nombre);
                }
            });

            await Promise.all(promises);

            // Generar ZIP y descargar
            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(content);
            link.download = `Pack_Fotos_${activeCategory}_${new Date().toLocaleDateString()}.zip`;
            link.click();

            alert("‚úÖ Pack descargado exitosamente.");

        } catch (e) {
            console.error(e);
            alert("Hubo un error generando el ZIP.");
        } finally {
            btn.innerHTML = oldText;
            btn.disabled = false;
        }
    }
    // ==========================================
    // FUNCIONES POWER-UP (PDF, STORY, SOCIAL)
    // ==========================================

    // 1. FILTRO TIBUR√ìN (Actualizaci√≥n de renderProducts)
    // Busca tu funci√≥n 'renderProducts' antigua y aseg√∫rate de a√±adir esta l√≥gica de filtrado:
    /*
        const filterHighComm = document.getElementById('filter-high-comm')?.checked;
        
        const filtered = productosRaw.filter(p => {
            // ... (tus filtros anteriores) ...
            const matchComm = !filterHighComm || (Number(p.comision) > 10); // L√≥gica nueva
            
            return matchSearch && matchCat && matchComm && p.disponible === "SI";
        });
    */

    // 2. COMPARTIR REDES SOCIALES
    function shareProductSocial(name, network) {
        const p = productosRaw.find(prod => prod.nombre === name);
        if(!p) return;

        const gestor = window.gestorName || '';
        const userData = window.currentUserData || {};
        
        let link = `${window.location.origin}${window.location.pathname}?search=${encodeURIComponent(p.nombre)}`;
        if (gestor) link += `&gestor=${encodeURIComponent(gestor)}&tel=${userData.telefono || ''}`;

        if (network === 'wa') {
            const text = `üî• ¬°Oferta Flash! ${p.nombre} a solo $${p.precio}. Ver aqu√≠: ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        } else if (network === 'fb') {
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`, '_blank');
        }
    }

    // ==========================================
    // 4. GENERADOR DE INSTAGRAM STORY (DISE√ëO PREMIUM)
    // ==========================================
    async function generateStoryImage() {
        if(!selectedProduct) return;
        
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = "üé® Dise√±ando...";
        btn.disabled = true;
        
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Resoluci√≥n HD (1080x1920)
            canvas.width = 1080;
            canvas.height = 1920;

            // --- 1. FONDO LIMPIO ---
            ctx.fillStyle = '#f8fafc'; // Gris muy claro (Slate-50)
            ctx.fillRect(0, 0, 1080, 1920);

            // --- 2. HEADER (MARCA) ---
            // Barra superior
            ctx.fillStyle = '#1a4789'; // Azul ANEB
            ctx.fillRect(0, 0, 1080, 180);
            
            // Texto Marca
            ctx.fillStyle = '#ffffff';
            ctx.font = '900 60px Manrope, sans-serif'; // Fuente gruesa
            ctx.textAlign = 'center';
            ctx.fillText("PARATUHOGAR", 540, 110);
            
            ctx.font = '500 30px Manrope, sans-serif';
            ctx.fillText("Env√≠os a toda Cuba | Garant√≠a Real", 540, 155);

            // --- 3. CONTENEDOR DE IMAGEN (TARJETA) ---
            // Dibujamos un cuadro blanco detr√°s de la foto para darle relieve
            const cardY = 300;
            const cardHeight = 900;
            const cardWidth = 900;
            const cardX = (1080 - cardWidth) / 2;

            // Sombra de la tarjeta
            ctx.shadowColor = "rgba(0, 0, 0, 0.15)";
            ctx.shadowBlur = 40;
            ctx.shadowOffsetY = 20;
            ctx.fillStyle = '#ffffff';
            
            // Funci√≥n para bordes redondeados
            roundRect(ctx, cardX, cardY, cardWidth, cardHeight, 40);
            ctx.fill();
            ctx.shadowColor = "transparent"; // Reset sombra

            // --- 4. IMAGEN DEL PRODUCTO ---
            const img = new Image();
            img.crossOrigin = "Anonymous"; 
            img.src = fixDriveUrl(selectedProduct.thumbnail);
            
            await new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = reject;
            });

            // Calcular proporciones para que quepa en el cuadro (padding 50px)
            const maxImgSize = 800;
            const scale = Math.min(maxImgSize / img.width, maxImgSize / img.height);
            const w = img.width * scale;
            const h = img.height * scale;
            const imgX = 540 - (w / 2); // Centrado horizontal
            const imgY = cardY + (cardHeight - h) / 2; // Centrado vertical en la tarjeta

            ctx.drawImage(img, imgX, imgY, w, h);

            // --- 5. DETALLES DEL PRODUCTO ---
            ctx.textAlign = 'center';
            const textYStart = 1350;

            // Etiqueta "OFERTA"
            ctx.fillStyle = '#2c6fb5'; // Azul secundario
            ctx.font = 'bold 40px Manrope, sans-serif';
            ctx.fillText("üî• DISPONIBLE AHORA", 540, textYStart);

            // Nombre del Producto (Wrapping inteligente)
            ctx.fillStyle = '#0f172a'; // Dark Slate
            ctx.font = '800 70px Manrope, sans-serif';
            wrapText(ctx, selectedProduct.nombre, 540, textYStart + 100, 950, 85);

            // PRECIO (Grande y llamativo)
            ctx.fillStyle = '#1a4789'; // Azul ANEB
            ctx.font = '900 130px Manrope, sans-serif';
            // Calculamos posici√≥n Y basada en el nombre (aprox)
            ctx.fillText(`$${selectedProduct.precio} USD`, 540, 1700);

            // --- 6. FOOTER (CONTACTO GESTOR) ---
            ctx.fillStyle = '#1a4789';
            ctx.fillRect(0, 1780, 1080, 140);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 45px Manrope, sans-serif';
            const gestor = window.gestorName || "Ventas";
            const tel = window.currentUserData?.telefono || "";
            
            // Icono de WhatsApp simulado con texto (o podr√≠as cargar un icono)
            ctx.fillText(`üìû Pide aqu√≠: ${tel}  |  üë§ Agente: ${gestor}`, 540, 1865);

            // --- 7. DESCARGAR ---
            const link = document.createElement('a');
            const cleanName = selectedProduct.nombre.replace(/[^a-z0-9]/gi, '_').substring(0, 15);
            link.download = `Story_${cleanName}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();

        } catch (e) {
            console.error(e);
            alert("Error generando dise√±o. Intenta 'Descargar Foto' normal.");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Funci√≥n auxiliar para dibujar rect√°ngulos redondeados
    function roundRect(ctx, x, y, width, height, radius) {
        ctx.beginPath();
        ctx.moveTo(x + radius, y);
        ctx.lineTo(x + width - radius, y);
        ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
        ctx.lineTo(x + width, y + height - radius);
        ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
        ctx.lineTo(x + radius, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
        ctx.lineTo(x, y + radius);
        ctx.quadraticCurveTo(x, y, x + radius, y);
        ctx.closePath();
    }

    // ==========================================
    // 3. GENERADOR DE PDF CON FOTOS (PROFESIONAL)
    // ==========================================
    // ==========================================
    // 3. GENERADOR DE PDF CON FOTOS (CORREGIDO)
    // ==========================================
    async function downloadCatalogPDF() {
        if (!window.jspdf) return alert("Cargando sistema PDF... Espera 5 segundos.");
        
        const { jsPDF } = window.jspdf;
        const gestor = window.gestorName || "Equipo de Ventas";
        const telefono = window.currentUserData?.telefono || "+53 5000 0000";

        // 1. Filtrar productos visibles
        const visibleProducts = productosRaw.filter(p => {
            return (activeCategory === 'TODOS' || (p.categoria && p.categoria.toUpperCase().includes(activeCategory))) && p.disponible === "SI";
        });

        if(visibleProducts.length === 0) return alert("No hay productos visibles para el PDF.");
        if(visibleProducts.length > 40) if(!confirm(`El cat√°logo tiene ${visibleProducts.length} productos. Generar las im√°genes tomar√° unos segundos. ¬øContinuar?`)) return;

        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = "‚è≥ Procesando im√°genes...";
        btn.disabled = true;

        try {
            const doc = new jsPDF();

            // 2. Preparar datos y PRE-CARGAR IM√ÅGENES (Base64)
            const tableData = [];
            
            for (let p of visibleProducts) {
                let imgData = null;
                try {
                    imgData = await getImageDataUrl(fixDriveUrl(p.thumbnail));
                } catch (err) {
                    console.warn("No se pudo cargar imagen para PDF:", p.nombre);
                }

                tableData.push({
                    image: imgData, 
                    info: {
                        name: p.nombre,
                        price: `$${p.precio} USD`,
                        shipping: p.mensajeria ? `Env√≠o: ${p.mensajeria}` : "Mensajer√≠a: Consultar",
                        warranty: p.garantia || "Garant√≠a: Oficial"
                    }
                });
            }

            // 3. Dise√±o del PDF - Encabezado
            doc.setFillColor(26, 71, 137); // #1a4789
            doc.rect(0, 0, 210, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("CAT√ÅLOGO OFICIAL", 105, 15, null, null, "center");
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Categor√≠a: ${activeCategory}`, 105, 24, null, null, "center");
            doc.setFontSize(10);
            doc.text(`Agente Autorizado: ${gestor} | WhatsApp: ${telefono}`, 105, 30, null, null, "center");

            // 4. Generar Tabla con Im√°genes
            doc.autoTable({
                startY: 40,
                head: [['FOTO', 'DETALLES DEL EQUIPO', 'PRECIO']],
                body: tableData.map(row => ['', '', '']), // Celdas vac√≠as para rellenar
                theme: 'grid',
                styles: { 
                    fontSize: 12, 
                    cellPadding: 4, 
                    valign: 'middle',
                    lineColor: [200, 200, 200],
                    lineWidth: 0.1,
                    minCellHeight: 40 // Altura m√≠nima para que quepa la foto
                },
                headStyles: { 
                    fillColor: [44, 111, 181], 
                    textColor: 255, 
                    fontStyle: 'bold',
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 40 }, 
                    1: { cellWidth: 'auto' }, 
                    2: { cellWidth: 40, fontStyle: 'bold', textColor: [26, 71, 137], halign: 'center', fontSize: 14 }
                },
                didDrawCell: function(data) {
                    // Hook para dibujar contenido
                    if (data.section === 'body') {
                        const rowIndex = data.row.index;
                        
                        // --- L√çNEA DE SEGURIDAD (CORRECCI√ìN) ---
                        // Si por alguna raz√≥n el √≠ndice no existe, salimos para evitar el error
                        if (!tableData[rowIndex]) return; 
                        
                        const rowData = tableData[rowIndex];

                        // DIBUJAR IMAGEN (Columna 0)
                        if (data.column.index === 0 && rowData.image) {
                            try {
                                doc.addImage(rowData.image, 'JPEG', data.cell.x + 2, data.cell.y + 2, 36, 36);
                            } catch(e) { /* Ignorar error de imagen corrupta */ }
                        }

                        // DIBUJAR DETALLES (Columna 1)
                        if (data.column.index === 1) {
                            doc.setFontSize(12);
                            doc.setTextColor(0, 0, 0);
                            doc.setFont("helvetica", "bold");
                            
                            // Texto con ajuste autom√°tico de ancho
                            var splitTitle = doc.splitTextToSize(rowData.info.name, data.cell.width - 4);
                            doc.text(splitTitle, data.cell.x + 2, data.cell.y + 8);
                            
                            doc.setFontSize(10);
                            doc.setTextColor(100, 100, 100);
                            doc.setFont("helvetica", "normal");
                            doc.text(rowData.info.shipping, data.cell.x + 2, data.cell.y + 28);
                            doc.text(rowData.info.warranty, data.cell.x + 2, data.cell.y + 34);
                        }

                        // DIBUJAR PRECIO (Columna 2)
                        if (data.column.index === 2) {
                            doc.text(rowData.info.price, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2, { align: 'center', baseline: 'middle' });
                        }
                    }
                }
            });

            // Pie de p√°gina
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`P√°gina ${i} de ${pageCount} - Generado por paratuhogar`, 105, 290, null, null, "center");
            }

            // Descargar
            doc.save(`Catalogo_${activeCategory}_${gestor.replace(/\s+/g, '_')}.pdf`);
            alert("‚úÖ Cat√°logo PDF descargado correctamente.");

        } catch (e) {
            console.error(e);
            alert("Error generando PDF: " + e.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Helper: Obtener imagen en Base64 para el PDF
    function getImageDataUrl(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = url;
            img.onload = () => {
                const canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL("image/jpeg"));
            };
            img.onerror = (e) => reject(e);
        });
    }

    

    // Auxiliar para texto en varias l√≠neas (Story)
    function wrapText(context, text, x, y, maxWidth, lineHeight) {
        var words = text.split(' ');
        var line = '';

        for(var n = 0; n < words.length; n++) {
          var testLine = line + words[n] + ' ';
          var metrics = context.measureText(testLine);
          var testWidth = metrics.width;
          if (testWidth > maxWidth && n > 0) {
            context.fillText(line, x, y);
            line = words[n] + ' ';
            y += lineHeight;
          }
          else {
            line = testLine;
          }
        }
        context.fillText(line, x, y);
    }

    // ==========================================
    // L√ìGICA DE ACCESO Y SEGURIDAD (RESTAURADA)
    // ==========================================

    // 1. Alternar entre Login y Registro
    function toggleLoginMode(mode) {
        const isLogin = mode === 'login';
        document.getElementById('form-login').classList.toggle('hidden', !isLogin);
        document.getElementById('form-register').classList.toggle('hidden', isLogin);
        
        document.getElementById('tab-login-btn').className = isLogin ? "flex-1 pb-2 font-black text-xs uppercase text-primary border-b-2 border-primary" : "flex-1 pb-2 font-black text-xs uppercase text-gray-400";
        document.getElementById('tab-register-btn').className = !isLogin ? "flex-1 pb-2 font-black text-xs uppercase text-primary border-b-2 border-primary" : "flex-1 pb-2 font-black text-xs uppercase text-gray-400";
    }

    // 2. Proceso de Login
    async function processLogin() {
        const user = document.getElementById('log-user').value.trim();
        const pass = document.getElementById('log-pass').value.trim();

        if (!user || !pass) return alert("Por favor ingresa usuario y contrase√±a");

        // A. Verificar si es ADMIN (Due√±o)
        if (pass === ADMIN_SECRET_KEY) {
            closeLogin();
            saveSessionToMemory("Administrador", true, {}); 
            setupSession("Administrador", true);
            return;
        }

        // B. Verificar en Base de Datos (Gestores)
        try {
            const { data, error } = await supabaseClient
                .from('gestores')
                .select('*')
                .eq('nombre', user)
                .eq('password', pass)
                .single();

            if (error || !data) {
                alert("‚ùå Usuario o contrase√±a incorrectos.");
            } else {
                closeLogin();
                window.currentUserData = data; 
                saveSessionToMemory(data.nombre, false, data);
                setupSession(data.nombre, false);
            }
        } catch (e) {
            console.error(e);
            alert("Error de conexi√≥n al intentar loguearse.");
        }
    }

    // 3. Proceso de Registro
    async function processRegister() {
        const nombre = document.getElementById('reg-name').value;
        const email = document.getElementById('reg-email').value;
        const tel = document.getElementById('reg-tel').value;
        const pass = document.getElementById('reg-pass').value;

        if(!nombre || !pass || !tel) return alert("Nombre, Tel√©fono y Contrase√±a son obligatorios.");

        const { data, error } = await supabaseClient
            .from('gestores')
            .insert([{ nombre: nombre, email: email, telefono: tel, password: pass }])
            .select();

        if (error) {
            alert("Error al registrar: " + error.message);
        } else {
            alert("‚úÖ Cuenta creada con √©xito. Ahora inicia sesi√≥n.");
            toggleLoginMode('login');
            document.getElementById('log-user').value = nombre;
        }
    }

    // 4. Funciones Auxiliares
    function saveSessionToMemory(name, isAdmin, data) {
        const session = { name: name, isAdmin: isAdmin, data: data };
        localStorage.setItem('pth_session', JSON.stringify(session));
    }

    function closeLogin() { 
        document.getElementById('login-overlay').classList.add('hidden'); 
    }

    // ==========================================
// 1. L√ìGICA DE LOG√çSTICA (PESTA√ëAS)
// ==========================================
// Variable global para controlar el filtro
let currentStatusFilter = 'TODOS';

function filterLogisticaByStatus(status, btnElement) {
    currentStatusFilter = status;
    
    // 1. Soluci√≥n al error de "innerText of null":
    // Verificamos si el elemento existe antes de intentar escribir en √©l
    const label = document.getElementById('label-estado-actual');
    if (label) {
        label.innerText = status;
    }

    // 2. Gesti√≥n Visual de los Botones (Estilo Activo)
    // Quitamos el estilo 'active' de todos y lo ponemos solo al clickeado
    if (btnElement) {
        document.querySelectorAll('.btn-filter').forEach(b => {
            // Restaurar estilo base (gris/transparente)
            b.classList.remove('bg-primary', 'text-white', 'shadow-md');
            b.classList.add('text-gray-500', 'border-transparent');
        });
        
        // Aplicar estilo activo al bot√≥n actual
        btnElement.classList.remove('text-gray-500', 'border-transparent');
        btnElement.classList.add('bg-primary', 'text-white', 'shadow-md');
    }

    // 3. Renderizar la tabla con el nuevo filtro
    renderAdminLogistica();
}

function renderAdminLogistica() {
    const container = document.getElementById('list-admin-pedidos');
    const searchInput = document.getElementById('search-logistica');
    
    // Validaci√≥n de seguridad
    if (!container || !pedidosRawAdmin) return;

    const query = searchInput ? searchInput.value.toLowerCase() : "";
    
    // --- L√ìGICA DE FILTRADO CORREGIDA ---
    const filtrados = pedidosRawAdmin.filter(p => {
        // 1. Filtro de Texto (Buscador)
        const fecha = new Date(p.fecha).toLocaleDateString().toLowerCase();
        const textoMatch = fecha.includes(query) || 
                           (p.cliente || "").toLowerCase().includes(query) || 
                           (p.proveedor || "").toLowerCase().includes(query) || 
                           (p.gestor || "").toLowerCase().includes(query);
        
        // 2. Filtro de Estado (Botones)
        let estadoMatch = false;

        if (currentStatusFilter === 'TODOS') {
            estadoMatch = true;
        } 
        else if (currentStatusFilter === 'FINALIZADOS') {
            // AQU√ç AGRUPAMOS: Si el bot√≥n es Hist√≥rico, mostramos Entregado Y Cancelado
            estadoMatch = (p.estado === 'Entregado' || p.estado === 'Cancelado');
        } 
        else {
            // Comparaci√≥n exacta para Pendiente, Recogida Almac√©n, Asignado Mensajero
            estadoMatch = (p.estado === currentStatusFilter);
        }

        return textoMatch && estadoMatch;
    });

    // Estado Vac√≠o
    if (filtrados.length === 0) {
        container.innerHTML = `<tr><td colspan="6" class="p-10 text-center text-gray-400 font-bold uppercase text-xs">No hay pedidos en esta secci√≥n.</td></tr>`;
        return;
    }

    // Renderizado de Filas
    container.innerHTML = filtrados.map(p => {
        // Definir colores para el SELECT (Visual individual)
        let colorClass = "bg-gray-100 text-gray-600";
        if(p.estado === 'Pendiente') colorClass = "bg-yellow-100 text-yellow-700";
        if(p.estado === 'Recogida Almac√©n') colorClass = "bg-orange-100 text-orange-700";
        if(p.estado === 'Asignado Mensajero') colorClass = "bg-blue-100 text-blue-700";
        if(p.estado === 'Entregado') colorClass = "bg-emerald-100 text-emerald-700";
        if(p.estado === 'Cancelado') colorClass = "bg-red-100 text-red-700";

        // Determinar si es un estado final (Bloqueado)
        const esFinal = (p.estado === 'Entregado' || p.estado === 'Cancelado');

        return `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/40 transition-all text-xs border-b dark:border-gray-700 bg-white dark:bg-gray-900">
            <td class="p-4 font-bold uppercase text-[10px]">
                <p class="text-gray-400 mb-1">${new Date(p.fecha).toLocaleDateString()}</p>
                <span class="text-primary">${p.cliente}</span>
            </td>
            <td class="p-4">
                <span class="bg-indigo-50 text-indigo-600 px-2 py-1 rounded border border-indigo-100 font-bold text-[9px] uppercase">
                    ${p.proveedor || 'General'}
                </span>
            </td>
            <td class="p-4 text-gray-500 max-w-xs truncate" title="${p.producto}">${p.producto}</td>
            <td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded text-[9px] font-bold">${p.gestor}</span></td>
            
            <td class="p-4 text-right">
                ${esFinal ? 
                    // Si est√° finalizado, mostramos solo una etiqueta (no editable)
                    `<span class="px-3 py-1.5 rounded-lg font-black text-[9px] uppercase ${colorClass}">
                        ${p.estado === 'Entregado' ? '‚úÖ ENTREGADO' : '‚ùå CANCELADO'}
                    </span>` 
                    :
                    // Si est√° activo, mostramos el SELECT completo
                    `<select onchange="updatePedidoStatus('${p.id}', this.value)" class="text-[10px] font-black uppercase rounded-lg border-none ${colorClass} py-2 cursor-pointer focus:ring-0 text-center w-full max-w-[160px]">
                        <option value="Pendiente" ${p.estado === 'Pendiente' ? 'selected' : ''}>‚è≥ Por Asignar</option>
                        <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                        <option value="Recogida Almac√©n" ${p.estado === 'Recogida Almac√©n' ? 'selected' : ''}>üè≠ En Almac√©n</option>
                        <option value="Asignado Mensajero" ${p.estado === 'Asignado Mensajero' ? 'selected' : ''}>üèçÔ∏è Con Mensajero</option>
                        <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                        <option value="Entregado">‚úÖ Marcar Entregado</option>
                        <option value="Cancelado">‚ùå Cancelar Pedido</option>
                    </select>`
                }
            </td>
        </tr>
    `; }).join('');
}

// Exportar SOLO lo que se ve en pantalla (Filtrado)
function exportLogisticaCurrentView() {
    // Reutilizamos la tabla HTML ya renderizada porque ya tiene los filtros aplicados
    exportToExcel('admin-table-logistica', `Pedidos_${currentStatusFilter}`);
}


// ==========================================
// 2. L√ìGICA DE INVENTARIO (BUSCADOR + EXPORTAR)
// ==========================================

// Variable global para inventario (necesaria para el buscador)
let inventoryRawAdmin = []; 

// Modificamos la carga de admin para llenar esta variable
/* 
   EN TU FUNCI√ìN loadAdminData(), ASEG√öRATE DE A√ëADIR ESTO:
   if (productos) {
       inventoryRawAdmin = productos; // <--- GUARDAR AQU√ç
       renderAdminInventario(); // Llamar sin argumentos
   }
*/

function renderAdminInventario() {
    // Usamos la variable global si no se pasan argumentos
    const productos = inventoryRawAdmin; 
    const container = document.getElementById('list-admin-inventario');
    const searchVal = document.getElementById('search-inventario')?.value.toLowerCase() || "";

    if (!container) return;

    // Filtrar
    const filtered = productos.filter(p => {
        // Generar SKU Virtual visual para b√∫squeda (ej: REF-1234)
        const skuVirtual = (p.categoria ? p.categoria.substring(0,3).toUpperCase() : "GEN") + "-" + p.id.substring(0,4).toUpperCase();
        
        return p.nombre.toLowerCase().includes(searchVal) || 
               (p.categoria || "").toLowerCase().includes(searchVal) ||
               skuVirtual.toLowerCase().includes(searchVal);
    });

    if (filtered.length === 0) {
        container.innerHTML = `<div class="col-span-full py-20 text-center text-gray-400 font-bold uppercase text-xs italic">No se encontraron productos.</div>`;
        return;
    }

    container.innerHTML = filtered.map(p => {
        // SKU Virtual para mostrar
        const skuDisplay = (p.categoria ? p.categoria.substring(0,3).toUpperCase() : "GEN") + "-" + p.id.substring(0,4).toUpperCase();

        return `
        <div class="bg-white dark:bg-gray-800 p-4 rounded-3xl border shadow-sm flex flex-col justify-between h-full text-left group hover:border-primary/30 transition-all relative">
            <span class="absolute top-4 right-4 text-[9px] font-mono text-gray-300">#${skuDisplay}</span>
            <div>
                <img src="${fixDriveUrl(p.thumbnail)}" class="w-full h-32 object-contain mb-4 bg-gray-50 dark:bg-gray-900 rounded-2xl p-2">
                <h6 class="text-[10px] font-black leading-tight mb-1 uppercase text-gray-700 dark:text-gray-200 line-clamp-2 h-8">${p.nombre}</h6>
                <div class="flex justify-between items-end mb-4">
                    <p class="text-primary font-black text-sm">$${p.precio}</p>
                    <p class="text-[9px] text-gray-400 font-bold uppercase">${p.categoria || 'Varios'}</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="toggleStockAdmin('${p.id}', '${p.disponible}')" 
                    class="flex-1 py-2 rounded-xl text-[9px] font-black uppercase transition-all ${p.disponible === 'SI' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}">
                    ${p.disponible === 'SI' ? 'En Stock' : 'Agotado'}
                </button>
                <button onclick="editProduct('${p.id}')" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-xl hover:bg-primary hover:text-white transition-all shadow-sm">
                    <span class="material-symbols-outlined text-sm">edit</span>
                </button>
            </div>
        </div>
    `; }).join('');
}

// Exportar Inventario a Excel (Limpio)
function exportInventoryExcel() {
    if(!inventoryRawAdmin || inventoryRawAdmin.length === 0) return alert("No hay datos");

    // Preparamos datos limpios para el Excel
    const dataForExcel = inventoryRawAdmin.map(p => ({
        SKU_Virtual: (p.categoria ? p.categoria.substring(0,3).toUpperCase() : "GEN") + "-" + p.id.substring(0,4).toUpperCase(),
        Producto: p.nombre,
        Precio_USD: p.precio,
        Comision_Gestor: p.comision,
        Categoria: p.categoria,
        Stock: p.disponible,
        Garantia: p.garantia
    }));

    const ws = XLSX.utils.json_to_sheet(dataForExcel);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventario");
    XLSX.writeFile(wb, `Inventario_ANEB_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
}

// FUNCI√ìN PARA ACTUALIZAR CATEGOR√çAS EN EL FORMULARIO
    function updateFormCategories() {
        // Usamos la lista de inventario o la de productos, la que tenga datos
        const source = (typeof inventoryRawAdmin !== 'undefined' && inventoryRawAdmin.length > 0) 
                       ? inventoryRawAdmin 
                       : productosRaw;
        
        if (!source || source.length === 0) return;

        // Extraer categor√≠as √∫nicas y ordenarlas
        const uniqueCats = [...new Set(source.map(p => p.categoria ? p.categoria.toUpperCase().trim() : 'VARIOS'))].sort();
        
        // Llenar el datalist
        const datalist = document.getElementById('lista-categorias');
        if (datalist) {
            datalist.innerHTML = uniqueCats.map(cat => `<option value="${cat}">`).join('');
        }
    }
    // --- FUNCI√ìN DE EXPORTACI√ìN EXCEL AVANZADA (LOG√çSTICA) ---
function exportLogisticaExcel() {
    // 1. Validar que haya datos
    if (!pedidosRawAdmin || pedidosRawAdmin.length === 0) {
        return alert("No hay datos cargados para exportar.");
    }

    const searchInput = document.getElementById('search-logistica');
    const query = searchInput ? searchInput.value.toLowerCase() : "";

    // 2. Aplicar los MISMOS filtros que se ven en pantalla
    const datosFiltrados = pedidosRawAdmin.filter(p => {
        // Filtro de Texto
        const fecha = new Date(p.fecha).toLocaleDateString().toLowerCase();
        const textoMatch = fecha.includes(query) || 
                           (p.cliente || "").toLowerCase().includes(query) || 
                           (p.proveedor || "").toLowerCase().includes(query) || 
                           (p.gestor || "").toLowerCase().includes(query);
        
        // Filtro de Estado
        let estadoMatch = false;
        if (currentStatusFilter === 'TODOS') estadoMatch = true;
        else if (currentStatusFilter === 'FINALIZADOS') estadoMatch = (p.estado === 'Entregado' || p.estado === 'Cancelado');
        else estadoMatch = (p.estado === currentStatusFilter);

        return textoMatch && estadoMatch;
    });

    if (datosFiltrados.length === 0) {
        return alert("No hay pedidos que coincidan con los filtros actuales.");
    }

    // 3. Formatear los datos para que el Excel se vea Profesional
    // Aqu√≠ elegimos qu√© columnas salen y con qu√© nombre
    const dataParaExcel = datosFiltrados.map(p => ({
        "Fecha": new Date(p.fecha).toLocaleDateString(),
        "Cliente": p.cliente,
        "CI": p.ci || '-',
        "Tel√©fono": p.telefono,     // ¬°Muy importante para log√≠stica!
        "Direcci√≥n": p.direccion,   // ¬°Muy importante para log√≠stica!
        "Proveedor": p.proveedor || 'General',
        "Producto": p.producto,
        "Gestor": p.gestor,
        "Total Venta": p.total,
        "Comisi√≥n Gestor": p.comision_total,
        "Estado Actual": p.estado,  // Saldr√° el texto limpio (ej: "Pendiente")
        "Pago Comisi√≥n": p.pago_gestor || 'Pendiente'
    }));

    // 4. Generar el archivo
    const ws = XLSX.utils.json_to_sheet(dataParaExcel);
    
    // Ajustar ancho de columnas autom√°ticamente (Opcional, pero se ve mejor)
    const wscols = [
        {wch: 12}, // Fecha
        {wch: 25}, // Cliente
        {wch: 15}, // CI
        {wch: 15}, // Tel√©fono
        {wch: 40}, // Direcci√≥n
        {wch: 15}, // Proveedor
        {wch: 40}, // Producto
        {wch: 20}, // Gestor
        {wch: 10}, // Total
        {wch: 10}, // Comisi√≥n
        {wch: 15}, // Estado
        {wch: 15}  // Pago
    ];
    ws['!cols'] = wscols;

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Log√≠stica");

    // Nombre del archivo con fecha y filtro
    const fechaHoy = new Date().toLocaleDateString().replace(/\//g, '-');
    XLSX.writeFile(wb, `Logistica_${currentStatusFilter}_${fechaHoy}.xlsx`);
}

// --- FUNCI√ìN PARA ACTUALIZAR PRECIO Y COMISI√ìN ---
function updateCartItemPrice(index, newValue) {
    const item = cart[index];
    let newPrice = parseFloat(newValue);

    // 1. Validaciones de Seguridad
    const minPrice = Number(item.precio) - Number(item.comision);
    const maxPrice = (item.precio_flexible === 'SI') ? 100000 : Number(item.precio);

    // Si intenta bajar del costo, lo corregimos al m√≠nimo
    if (newPrice < minPrice) {
        alert("‚ö†Ô∏è No puedes rebajar m√°s all√° de tu comisi√≥n.");
        newPrice = minPrice;
    }
    // Si intenta subir y no es flexible, lo corregimos al m√°ximo
    if (newPrice > maxPrice) {
        alert("üîí Este producto tiene precio fijo. No puedes aumentarlo.");
        newPrice = maxPrice;
    }

    // 2. Aplicar cambios
    item.precio_venta = newPrice;
    
    // 3. Recalcular Comisi√≥n
    // F√≥rmula: Comisi√≥n Original + (Sobreprecio) o - (Descuento)
    // Matem√°ticamente: Comisi√≥n Original + (PrecioVenta - PrecioOriginal)
    const diferencia = newPrice - Number(item.precio);
    item.comision_actual = Number(item.comision) + diferencia;

    // 4. Actualizar vista
    renderCart(); // Vuelve a pintar para mostrar la nueva ganancia y validar input
}
// Variable global para la tasa
let globalCUPRate = 450; 

// Al cargar la p√°gina, intentamos recuperar la tasa guardada
window.addEventListener('load', () => {
    const savedRate = localStorage.getItem('pth_daily_rate');
    if(savedRate) {
        globalCUPRate = parseFloat(savedRate);
        const input = document.getElementById('daily-rate');
        if(input) input.value = globalCUPRate;
    }
    // ... resto de tu window.load
});

function updateGlobalRate(val) {
    globalCUPRate = parseFloat(val);
    localStorage.setItem('pth_daily_rate', val); // Guardar para que no se borre al recargar
    
    // Si est√°s en el cat√°logo (vista cliente/gestor), refrescar productos
    if(!document.getElementById('sec-catalogo').classList.contains('hidden')) {
        renderProducts();
    }
    // Si est√°s en admin, refrescar tablas
    if(!document.getElementById('sec-admin-master').classList.contains('hidden')) {
        renderAdminCortes(); // Para recalcular pagos en CUP
    }
}

// --- FUNCI√ìN MAESTRA DE C√ÅLCULO DE PRECIO CUP ---
function calculateProductCUP(priceUSD, pagosString) {
    if (!pagosString) return priceUSD * globalCUPRate; // Si no hay info, usar tasa general

    const str = pagosString.toLowerCase();
    
    // CASO 1: Tasa Fija (Ej: "CUP efectivo 470", "CUP 470")
    // Buscamos un n√∫mero grande (mayor a 100) cerca de la palabra CUP
    // Regex: Busca 'cup' seguido de cualquier cosa y luego un n√∫mero de 3 d√≠gitos
    const fixedMatch = str.match(/cup.*?(\d{3,})/);
    if (fixedMatch) {
        const fixedRate = parseFloat(fixedMatch[1]);
        return priceUSD * fixedRate;
    }

    // CASO 2: Tasa Variable con Plus (Ej: "CUP +10")
    const plusMatch = str.match(/cup\s*\+\s*(\d+)/);
    if (plusMatch) {
        const extra = parseFloat(plusMatch[1]);
        return priceUSD * (globalCUPRate + extra);
    }

    // CASO 3: Solo dice "CUP" sin n√∫meros -> Usa Tasa del D√≠a
    if (str.includes('cup')) {
        return priceUSD * globalCUPRate;
    }

    // CASO 4: No acepta CUP (No dice CUP en ning√∫n lado)
    return null; // Indicador de que no acepta CUP
}

// Llamar a esto dentro de loadAdminData()
// if (pedidos && productos) { renderAnaliticaCompleta(pedidos, productos, vistas); }

function renderAnaliticaCompleta(pedidos, productos, vistasRaw) {
    renderAnaliticaProveedores(pedidos);
    renderAnaliticaCancelacion(pedidos);
    renderAnaliticaConversion(pedidos, vistasRaw);
    renderAnaliticaZombies(pedidos, productos);
    renderAnaliticaGestores(pedidos);
}

// 1. TOP PROVEEDORES (Facturaci√≥n)
function renderAnaliticaProveedores(pedidos) {
    const ventas = pedidos.filter(p => p.estado !== 'Cancelado');
    const mapProv = {};

    ventas.forEach(p => {
        const prov = p.proveedor || 'General';
        mapProv[prov] = (mapProv[prov] || 0) + Number(p.total || 0);
    });

    const sorted = Object.entries(mapProv).sort(([,a], [,b]) => b - a);

    document.getElementById('list-analitica-proveedores').innerHTML = sorted.map(([name, total], i) => `
        <div class="flex justify-between items-center text-[10px] border-b border-indigo-50 dark:border-gray-700 pb-2 last:border-0">
            <div class="flex items-center gap-2">
                <span class="font-bold text-indigo-300 w-4">#${i+1}</span>
                <span class="font-black uppercase text-gray-700 dark:text-gray-300">${name}</span>
            </div>
            <span class="font-black text-indigo-600 bg-indigo-50 dark:bg-indigo-900/50 px-2 py-0.5 rounded">$${total.toLocaleString()}</span>
        </div>
    `).join('');
}

// 2. TASA DE CANCELACI√ìN
function renderAnaliticaCancelacion(pedidos) {
    const total = pedidos.length;
    if (total === 0) return;

    const cancelados = pedidos.filter(p => p.estado === 'Cancelado').length;
    const rate = (cancelados / total) * 100;

    document.getElementById('stat-cancel-rate').innerText = `${rate.toFixed(1)}%`;
    document.getElementById('bar-cancel-rate').style.width = `${Math.min(rate, 100)}%`;
    
    // Cambiar color si es alarmante (>15%)
    const bar = document.getElementById('bar-cancel-rate');
    if(rate > 15) bar.className = "bg-red-600 h-2 rounded-full animate-pulse";
    else bar.className = "bg-emerald-500 h-2 rounded-full";
}

// 3. PRODUCTOS ZOMBIE (Sin ventas)
function renderAnaliticaZombies(pedidos, productos) {
    // Crear un Set de nombres de productos vendidos para b√∫squeda r√°pida
    const vendidosSet = new Set();
    pedidos.forEach(p => {
        // Limpieza b√°sica para coincidir nombres
        // Asumiendo formato "1x Nombre [USD]"
        let nombre = p.producto;
        if(nombre.includes('x ')) nombre = nombre.split('x ')[1];
        if(nombre.includes('[')) nombre = nombre.split('[')[0].trim();
        vendidosSet.add(nombre.toLowerCase());
    });

    // Filtrar productos que NO est√°n en el set de vendidos
    const zombies = productos.filter(prod => !vendidosSet.has(prod.nombre.toLowerCase()));

    const container = document.getElementById('list-analitica-zombies');
    
    if (zombies.length === 0) {
        container.innerHTML = `<p class="text-xs text-emerald-500 font-bold">¬°Excelente! Todo el cat√°logo tiene ventas.</p>`;
        return;
    }

    container.innerHTML = zombies.map(z => `
        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-900 p-2 rounded-lg">
            <div class="flex items-center gap-2 overflow-hidden">
                <span class="material-symbols-outlined text-gray-300 text-sm">block</span>
                <span class="text-[10px] font-bold text-gray-600 truncate uppercase">${z.nombre}</span>
            </div>
            <button onclick="editProduct('${z.id}')" class="text-[9px] font-black text-primary hover:underline">REVISAR</button>
        </div>
    `).join('');
}

// 4. EFECTIVIDAD (Ventas vs Vistas) - (Igual al anterior pero refinado)
function renderAnaliticaConversion(pedidos, vistasRaw) {
    const ventasMap = {};
    pedidos.filter(p => p.estado !== 'Cancelado').forEach(p => {
        let nombre = p.producto;
        if(nombre.includes('x ')) nombre = nombre.split('x ')[1];
        if(nombre.includes('[')) nombre = nombre.split('[')[0].trim();
        ventasMap[nombre] = (ventasMap[nombre] || 0) + 1;
    });

    const vistasMap = {};
    if(vistasRaw) {
        vistasRaw.forEach(v => {
            vistasMap[v.nombre_producto] = (vistasMap[v.nombre_producto] || 0) + 1;
        });
    }

    const ratios = [];
    for (const [prod, views] of Object.entries(vistasMap)) {
        if(views > 2) { 
            const sales = ventasMap[prod] || 0;
            const rate = (sales / views) * 100;
            ratios.push({ name: prod, rate: rate });
        }
    }
    
    const sorted = ratios.sort((a,b) => b.rate - a.rate).slice(0, 5);

    document.getElementById('list-analitica-conversion').innerHTML = sorted.map(item => `
        <div class="flex justify-between items-center text-[10px] mb-2">
            <span class="font-bold text-gray-500 truncate w-2/3" title="${item.name}">${item.name}</span>
            <div class="flex items-center gap-1">
                 <div class="w-10 h-1 bg-gray-100 rounded-full"><div class="h-full bg-emerald-500" style="width: ${item.rate}%"></div></div>
                 <span class="font-black text-emerald-600">${item.rate.toFixed(0)}%</span>
            </div>
        </div>
    `).join('');
}
// Variable global para guardar el conteo
let gestorSalesCount = 0;

function generateFlashResponse() {
    // 1. Obtener lo que el gestor escribi√≥ en el buscador
    const searchInput = document.getElementById('search-bar');
    const query = searchInput ? searchInput.value.trim() : "";
    
    // 2. Obtener los productos que est√°n visibles actualmente (Filtrados)
    // Usamos la misma l√≥gica de filtrado que ya tienes
    const isGestor = window.gestorName ? true : false;
    const filterCheckbox = document.getElementById('filter-high-comm');
    const filterHighComm = filterCheckbox ? filterCheckbox.checked : false;

    // Filtramos sobre la data cruda (productosRaw)
    const visibleProducts = productosRaw.filter(p => {
        const matchSearch = p.nombre.toLowerCase().includes(query.toLowerCase());
        const matchCat = activeCategory === 'TODOS' || (p.categoria && p.categoria.toUpperCase().includes(activeCategory));
        const matchComm = !filterHighComm || (Number(p.comision || 0) > 10);
        return matchSearch && matchCat && matchComm && p.disponible === "SI";
    });

    if (visibleProducts.length === 0) return alert("‚ùå No hay productos en pantalla para generar respuesta.");

    // 3. Construir el Enlace Directo para el Cliente
    // Este enlace llevar√° al cliente a la web YA filtrada con lo que buscaste
    const gestorParam = window.gestorName ? `&gestor=${encodeURIComponent(window.gestorName)}` : '';
    const telParam = window.currentUserData?.telefono ? `&tel=${window.currentUserData.telefono}` : '';
    // El truco: pasamos el par√°metro ?search=lo_que_buscaste
    const directLink = `${window.location.origin}${window.location.pathname}?search=${encodeURIComponent(query)}${gestorParam}${telParam}`;

    // 4. Construir el Mensaje de WhatsApp
    let mensaje = `üëã Hola! S√≠, para *"${query || activeCategory}"* tengo estas opciones disponibles ahora mismo:\n\n`;

    // Listar m√°ximo 5 productos para no saturar el chat (los m√°s relevantes)
    visibleProducts.slice(0, 5).forEach(p => {
        const precio = showInCUP ? `CUP ${calculateProductCUP(p.precio, p.pagos).toLocaleString()}` : `$${p.precio} USD`;
        mensaje += `‚ñ´Ô∏è *${p.nombre}* ‚ûù *${precio}*\n`;
    });

    if (visibleProducts.length > 5) {
        mensaje += `... y ${visibleProducts.length - 5} opciones m√°s.\n`;
    }

    mensaje += `\nüëÄ *MIRA LAS FOTOS Y DETALLES AQU√ç:* üëá\n${directLink}\n\n`;
    mensaje += `Me avisas cu√°l te gusta y te lo separo. üòâ`;

    // 5. Copiar al portapapeles
    navigator.clipboard.writeText(mensaje).then(() => {
        // Feedback visual r√°pido (Toast o Alerta)
        const btn = event.currentTarget; // El bot√≥n que presionaste
        const originalHTML = btn.innerHTML;
        btn.innerHTML = "‚úÖ ¬°COPIADO!";
        btn.classList.add("bg-green-500", "text-white", "border-green-600");
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove("bg-green-500", "text-white", "border-green-600");
        }, 2000);
    });
}

// 1. FUNCI√ìN PARA VERIFICAR NIVEL (Llamar al iniciar sesi√≥n)
async function checkGamificationStatus() {
    const gestor = window.gestorName;
    if (!gestor) return;

    // Consultamos cu√°ntas ventas "Entregado" tiene
    const { count, error } = await supabaseClient
        .from('pedidos')
        .select('*', { count: 'exact', head: true }) // 'head: true' solo cuenta, no baja datos (m√°s r√°pido)
        .eq('gestor', gestor)
        .eq('estado', 'Entregado');

    if (!error) {
        gestorSalesCount = count || 0;
        renderFlashButton(); // Dibujar el bot√≥n seg√∫n el resultado
    }
}

// 2. FUNCI√ìN PARA DIBUJAR EL BOT√ìN (Candado vs Rayo)
function renderFlashButton() {
    const container = document.getElementById('container-flash-btn');
    if (!container) return;

    const META_VENTAS = 3; // La meta para desbloquear

    if (gestorSalesCount >= META_VENTAS) {
        // --- NIVEL PRO: DESBLOQUEADO ---
        container.innerHTML = `
            <button onclick="generateFlashResponse()" class="h-full py-2.5 px-4 rounded-xl bg-amber-400 text-amber-900 border border-amber-500 hover:bg-amber-500 hover:text-white transition-all flex items-center justify-center gap-2 text-xs font-black shadow-md active:scale-95 animate-pulse" title="Generar respuesta r√°pida">
                <span class="material-symbols-outlined text-lg">flash_on</span> 
                <span class="hidden sm:inline">Flash</span>
            </button>`;
    } else {
        // --- NIVEL NOVATO: BLOQUEADO (GAMIFICACI√ìN) ---
        const faltan = META_VENTAS - gestorSalesCount;
        container.innerHTML = `
            <button onclick="alertLockedFeature(${faltan})" class="h-full py-2.5 px-4 rounded-xl bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed flex items-center justify-center gap-2 text-xs font-bold" title="Bloqueado hasta la 3ra venta">
                <span class="material-symbols-outlined text-lg">lock</span> 
                <span class="hidden sm:inline">Flash</span>
            </button>`;
    }
}

// 3. MENSAJE MOTIVACIONAL (Cuando hacen clic en el candado)
function alertLockedFeature(faltan) {
    alert(`üîí ¬°HERRAMIENTA BLOQUEADA! üîí\n\nEl "Bot√≥n Flash" te permite responder a clientes en 3 segundos.\n\nüéØ OBJETIVO: Necesitas 3 ventas entregadas.\nüìâ TE FALTAN: ${faltan} ventas.\n\n¬°Sigue vendiendo para desbloquear esta ventaja injusta! üöÄ`);
}
</script>

</body>
</html>