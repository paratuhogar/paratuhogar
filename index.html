<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>paratuhogar | Electrodom√©sticos para Cuba</title>
    
    <!-- 1. Estilos y Fuentes -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- 2. Librer√≠as de Funcionalidad (Supabase, Excel, Editor) -->
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- Quill (Editor de Texto) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- 4. JSZip (Para descargar packs de fotos) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 5. jsPDF (Generador de PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- 3. Configuraci√≥n de Dise√±o (ANEB Theme) -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1a4789", // Azul ANEB
                        "secondary": "#2c6fb5", // Azul Claro
                        "accent": "#cbd5e1", 
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>

    <style type="text/tailwindcss">

       /* === EFECTOS HIGH-END === */

/* Fondos Met√°licos para el Podio */
.bg-gold-gradient { background: linear-gradient(135deg, #FDE68A 0%, #F59E0B 50%, #B45309 100%); }
.bg-silver-gradient { background: linear-gradient(135deg, #E2E8F0 0%, #94A3B8 50%, #475569 100%); }
.bg-bronze-gradient { background: linear-gradient(135deg, #FFEDD5 0%, #F97316 50%, #C2410C 100%); }

/* Efecto Cristal (Glassmorphism) */
.glass-panel {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
}

/* Sombras de Ne√≥n (Glow) */
.glow-gold { box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); }
.glow-silver { box-shadow: 0 0 20px rgba(148, 163, 184, 0.4); }
.glow-bronze { box-shadow: 0 0 20px rgba(249, 115, 22, 0.4); }

/* Animaci√≥n de Pulso para "En Vivo" */
@keyframes live-pulse {
    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}
.live-indicator {
    animation: live-pulse 2s infinite;
}

/* Avatar Flotante */
.avatar-floating {
    transition: transform 0.3s ease;
}
.podium-card:hover .avatar-floating {
    transform: translateY(-5px) scale(1.05);
}

/* Ticker Suave */
@keyframes fade-slide-up {
    0% { opacity: 0; transform: translateY(10px); }
    20% { opacity: 1; transform: translateY(0); }
    80% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-10px); }
}
.ticker-anim { animation: fade-slide-up 5s infinite; }


/* === ESTILOS PODIUM "PRICING STYLE" === */

/* Gradientes basados en la imagen de referencia */
.grad-rank-2 { background: linear-gradient(180deg, #FDB777 0%, #FD9346 100%); } /* Naranja (Izquierda) */
.grad-rank-1 { background: linear-gradient(180deg, #E15656 0%, #753a46 100%); } /* Rojo Oscuro (Centro) */
.grad-rank-3 { background: linear-gradient(180deg, #B8D662 0%, #68A778 100%); } /* Verde (Derecha) */

/* Efecto de sombra para que floten */
.pricing-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1); }

/* Triangulito del "Best Option" (Top 1) */
.triangle-down {
    width: 0; 
    height: 0; 
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 10px solid #2d2d2d; /* Mismo color que el header top */
    position: absolute;
    bottom: -10px;
    left: 20px;
}


        @layer utilities {
            .wave-bg {
                background-color: #1a4789;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3%3Cpath fill='%232c6fb5' fill-opacity='0.4' d='M0,192L48,176C96,160,192,128,288,112C384,96,480,96,576,122.7C672,149,768,203,864,202.7C960,203,1056,149,1152,117.3C1248,85,1344,75,1392,69.3L1440,64L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z'%3E%3C/path%3E%3Cpath fill='%23ffffff' fill-opacity='0.1' d='M0,64L48,80C96,96,192,128,288,128C384,128,480,96,576,106.7C672,117,768,171,864,170.7C960,171,1056,117,1152,106.7C1248,96,1344,128,1392,144L1440,160L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z'%3E%3C/path%3E%3C/svg%3E");
                background-size: cover;
                background-position: top;
            }
            .wave-divider {
                height: 40px;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 100' preserveAspectRatio='none'%3%3Cpath fill='%231a4789' d='M0,32L60,42.7C120,53,240,75,360,74.7C480,75,600,53,720,48C840,43,960,53,1080,58.7C1200,64,1320,64,1380,64L1440,64L1440,0L1380,0C1320,0,1200,0,1080,0C960,0,840,0,720,0C600,0,480,0,360,0C240,0,120,0,60,0L0,0Z'%3E%3C/path%3E%3C/svg%3E");
                background-size: 100% 100%;
            }
        }
        body { font-family: 'Manrope', sans-serif; -webkit-font-smoothing: antialiased; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; display: inline-block; vertical-align: middle; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .category-tab.active { border-bottom: 3px solid #1a4789; color: #1a4789; }
        .loader { width: 40px; height: 40px; border: 4px solid #1a4789; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ESTILOS DEL EDITOR WORD */
        .ql-container { height: 200px; font-family: 'Manrope', sans-serif; font-size: 14px; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
        .ql-toolbar { border-top-left-radius: 12px; border-top-right-radius: 12px; background: #f9fafb; }
        
        /* CORRECCIONES M√ìVIL */
        @media (max-width: 768px) {
            #sec-admin-master .grid-cols-1, #sec-admin-master .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; gap: 8px !important; }
            .overflow-x-auto { margin: 0 -15px; padding: 0 15px; }
            table { min-width: 500px !important; }
            #list-admin-inventario { display: grid !important; grid-template-columns: repeat(2, minmax(0, 1fr)) !important; gap: 10px !important; }
            #list-admin-inventario img { height: 100px !important; }
        }

        /* Estilos recuperados para el Panel Admin */
        .btn-tab-admin.active { 
            background-color: #1a4789; 
            color: white !important; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        }
        .btn-tab-admin {
            color: #94a3b8; /* Gris suave inactivo */
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-[#121717] dark:text-gray-100">

    <!-- Header / Navbar -->
    <!-- Header con Dise√±o Wave -->
<header class="sticky top-0 z-50 w-full wave-bg px-4 md:px-10 lg:px-20 py-3 shadow-lg">
    <!-- Agregamos flex-wrap para que permita saltos de l√≠nea en m√≥vil -->
    <div class="flex flex-wrap md:flex-nowrap items-center justify-between gap-4 max-w-[1200px] mx-auto">
        <!-- Logo -->
        <div class="flex items-center gap-8">
            <div class="flex items-center gap-2">
                <div class="text-white"><span class="material-symbols-outlined text-3xl">home_iot_device</span></div>
                <h1 class="text-white text-xl font-extrabold tracking-tight">para<span class="text-slate-200">tuhogar</span></h1>
            </div>
            
            <!-- Barra de B√∫squeda (Estilo Transparente) -->
            <!-- Barra de B√∫squeda (Visible en m√≥vil, orden √∫ltimo) -->
            <div class="w-full md:w-auto order-last md:order-none mt-2 md:mt-0">
                <label class="flex flex-col w-full md:min-w-64 !h-10">
                    <div class="flex w-full flex-1 items-stretch rounded-lg h-full overflow-hidden border border-white/20 bg-white/10 backdrop-blur-sm">
                        <div class="text-white/80 flex items-center justify-center pl-4">
                            <span class="material-symbols-outlined text-xl">search</span>
                        </div>
                        <input id="search-bar" oninput="filterProducts()" type="text" class="form-input flex w-full min-w-0 flex-1 border-none bg-transparent text-white focus:ring-0 h-full placeholder:text-white/60 px-3 text-sm font-normal" placeholder="Buscar refrigerador, split..." />
                    </div>
                </label>
            </div>
        </div>

        <!-- Botones de Acci√≥n (Carrito, Login, Moneda) -->
        <div class="flex items-center gap-2 md:gap-4">
            <!-- Selector Moneda -->
            <button onclick="toggleCurrency()" class="h-10 px-3 rounded-lg bg-white/10 text-white border border-white/20 text-xs font-bold hover:bg-white/20 transition-all">
                <span id="currency-label">USD</span>
            </button>
            
            <!-- Carrito -->
            <button onclick="toggleCartModal(true)" class="relative flex items-center justify-center rounded-lg h-10 w-10 bg-white/20 text-white hover:bg-white/30 transition-all">
                <span class="material-symbols-outlined">shopping_cart</span>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold w-4 h-4 rounded-full flex items-center justify-center border border-white">0</span>
            </button>

            <!-- BOT√ìN DE LOGIN (LA PERSONITA) -->
            <button onclick="openLoginModal()" id="btn-login-open" class="flex items-center justify-center rounded-lg h-10 w-10 bg-white/10 text-white hover:bg-white/20 transition-all" title="Entrar como Agente">
                <span class="material-symbols-outlined">person</span>
            </button>

            <!-- Configuraci√≥n / Gestor -->
            <button id="btn-open-gen" onclick="openGestorGen()" class="hidden flex items-center justify-center rounded-lg h-10 w-10 bg-white/10 text-white hover:bg-white/20 transition-all">
                <span class="material-symbols-outlined">settings</span>
            </button>

            <!-- Bot√≥n Salir (Logout) -->
            <button onclick="doLogout()" id="btn-logout" class="hidden flex items-center justify-center rounded-lg h-10 w-10 bg-red-500/80 text-white hover:bg-red-500 transition-all" title="Cerrar Sesi√≥n">
                <span class="material-symbols-outlined">logout</span>
            </button>
            
            <!-- Nombre Agente -->
            <p id="gestor-label" class="hidden lg:block text-[10px] font-bold text-white uppercase tracking-widest border-l pl-3 ml-1 border-white/20"></p>
        </div>
    </div>
</header>

    <main class="max-w-[1200px] mx-auto pb-20">
        
        <!-- 1. NAVEGACI√ìN ADMIN (Fuera de los contenedores para que nunca desaparezca) -->
        <nav id="admin-nav" class="hidden px-6 max-w-[1200px] mx-auto mt-4 flex gap-2">
            <button onclick="showSection('catalogo')" id="tab-cat" class="flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-primary text-white">Cat√°logo</button>
            <button onclick="showSection('dashboard')" id="tab-dash" class="flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-gray-100 text-gray-400">Mi Dashboard</button>
        </nav>

        <!-- 2. CONTENEDOR DEL CAT√ÅLOGO (Solo envuelve cosas del cat√°logo) -->
        <div id="sec-catalogo">
            <!-- Hero Section -->
            <section class="px-6 py-10 lg:py-16">
                <div class="max-w-2xl">
                    <h2 class="text-4xl lg:text-5xl font-black leading-tight mb-4">Equipos para tu familia en Cuba</h2>
                    <p class="text-gray-500 dark:text-gray-400 text-lg">Cat√°logo optimizado. Ordena por WhatsApp y paga al recibir en la puerta de tu casa.</p>
                    <div class="flex gap-3 mt-6">
                        <span class="flex items-center gap-1.5 px-3 py-1 bg-primary/10 text-primary rounded-full text-xs font-bold"><span class="material-symbols-outlined text-sm">bolt</span> Entrega 24-48h</span>
                        <span class="flex items-center gap-1.5 px-3 py-1 bg-primary/10 text-primary rounded-full text-xs font-bold"><span class="material-symbols-outlined text-sm">verified_user</span> Garant√≠a Real</span>
                    </div>
                </div>
            </section>

            <!-- Category Tabs (Sticky) & Marketing Bar -->
            <div class="sticky top-[65px] z-40 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur shadow-sm border-b border-gray-200 dark:border-gray-800">
                
                <!-- 1. Lista de Categor√≠as (Se llena sola con JS) -->
                <div id="category-list" class="flex gap-8 px-6 overflow-x-auto whitespace-nowrap scrollbar-hide">
                    <!-- El JS inyectar√° los botones aqu√≠ -->
                    <span class="py-4 text-xs text-gray-400">Cargando categor√≠as...</span>
                </div>

                <!-- 2. BARRA DE MARKETING (Solo para Gestores) -->
                <!-- Esta barra aparecer√° debajo de las categor√≠as cuando entres como gestor -->
                <!-- 2. BARRA DE MARKETING PRO (Solo para Gestores) -->
            <!-- === CENTRO DE MANDO GESTOR (DISE√ëO UNIFICADO) === -->
            <div id="gestor-command-center" class="hidden max-w-[1200px] mx-auto px-4 md:px-6 py-4">
                
                <div class="bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-2xl shadow-lg shadow-slate-200/50 dark:shadow-none p-3 flex flex-col xl:flex-row gap-4 items-center justify-between">
                    
                    <!-- 1. IZQUIERDA: Contexto -->
                    <div class="flex items-center gap-3 w-full xl:w-auto border-b xl:border-b-0 border-slate-100 dark:border-slate-800 pb-3 xl:pb-0">
                        <div class="bg-indigo-50 text-indigo-600 p-2 rounded-xl">
                            <span class="material-symbols-outlined text-xl">campaign</span>
                        </div>
                        <div>
                            <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Zona de Difusi√≥n</p>
                            <p class="text-sm font-bold text-primary dark:text-white" id="marketing-cat-label">TODOS</p>
                        </div>
                    </div>

                    <!-- 2. CENTRO: Filtros y Switches (Aqu√≠ eliminamos la redundancia) -->
                    <div class="flex items-center gap-4 bg-slate-50 dark:bg-slate-800/50 px-4 py-2 rounded-xl w-full xl:w-auto justify-center">
                        
                        <!-- Selector de Orden (Integrado) -->
                        <div class="flex items-center gap-2 border-r border-slate-200 dark:border-slate-700 pr-4">
                            <span class="text-[10px] font-black uppercase text-slate-400 hidden sm:block">Ordenar:</span>
                            <select id="sort-selector" onchange="applySort()" class="bg-transparent border-none text-xs font-bold text-slate-700 dark:text-slate-200 focus:ring-0 p-0 cursor-pointer">
                                <option value="defecto">Relevancia</option>
                                <option value="comision_desc">üí∞ Mayor Ganancia</option>
                                <option value="precio_asc">üí≤ Precio: Bajo</option>
                                <option value="nuevo">üÜï Lo Nuevo</option>
                            </select>
                        </div>

                        <!-- Switch "Modo Tibur√≥n" (Reemplaza al checkbox feo) -->
                        <label class="flex items-center gap-2 cursor-pointer select-none group">
                            <div class="relative">
                                <input type="checkbox" id="filter-high-comm" onchange="renderProducts()" class="sr-only peer">
                                <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500"></div>
                            </div>
                            <span class="text-[10px] font-black uppercase text-slate-500 group-hover:text-emerald-600 transition-colors">Ganancia > $10</span>
                        </label>
                    </div>

                    <!-- 3. DERECHA: Botones de Acci√≥n (Iconos limpios) -->
                    <div class="flex gap-2 w-full xl:w-auto">

                        <!-- === ¬°TE FALTA ESTA L√çNEA! === -->
    <!-- Aqu√≠ es donde JS inyectar√° el bot√≥n (candado o rayo) -->
    <div id="container-flash-btn" class="flex-1 xl:flex-none"></div>
    <!-- ============================= -->

                        <!-- 1. AQU√ç INYECTAREMOS EL BOT√ìN FLASH (Bloqueado o Desbloqueado) -->
                        <div id="container-flash-btn"></div>

                        <!-- 1. Bot√≥n Texto (Masivo) -->
                        <!-- 1. Bot√≥n Texto (Masivo) -->
<button id="btn-copy-bulk" class="flex-1 xl:flex-none py-2.5 px-4 rounded-xl border border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed flex items-center justify-center gap-2 text-xs font-bold">
    <span class="material-symbols-outlined text-lg">lock</span> <span>Cargando...</span>
</button>

<!-- Bot√≥n para ir al Studio -->
<button onclick="goToStudio()" class="flex-1 xl:flex-none py-2.5 px-4 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white border border-purple-400 hover:brightness-110 cursor-pointer flex items-center justify-center gap-2 text-xs font-black shadow-lg transition-all active:scale-95">
    <span class="material-symbols-outlined text-lg">auto_fix</span> 
    <span class="hidden sm:inline">Magic Studio</span>
</button>

<!-- 2. Bot√≥n Fotos (Masivo) -->
<button id="btn-zip-bulk" class="flex-1 xl:flex-none py-2.5 px-4 rounded-xl border border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed flex items-center justify-center gap-2 text-xs font-bold">
    <span class="material-symbols-outlined text-lg">lock</span> <span>Cargando...</span>
</button>

<!-- 3. Bot√≥n PDF -->
<button id="btn-pdf-bulk" class="flex-1 xl:flex-none py-2.5 px-4 rounded-xl border border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed flex items-center justify-center gap-2 text-xs font-bold">
    <span class="material-symbols-outlined text-lg">lock</span> <span>Cargando...</span>
</button>
                    </div>

                </div>
            </div>

                <!-- 3. Filtros de Ordenamiento (Ya lo ten√≠as, lo mantenemos aqu√≠) -->
                <div id="gestor-filters" class="hidden px-6 py-2 flex items-center justify-end bg-gray-50 dark:bg-gray-900/50">
                    <div class="flex items-center gap-2">
                        <span class="text-[9px] font-black uppercase text-gray-400">Ordenar:</span>
                        <select id="sort-selector" onchange="applySort()" class="bg-transparent border-none text-[10px] font-bold text-gray-600 dark:text-gray-300 focus:ring-0 p-0 cursor-pointer">
                            <option value="defecto">Relevancia</option>
                            <option value="comision_desc">üí∞ Mayor Ganancia</option>
                            <option value="precio_asc">üí≤ Precio: Bajo a Alto</option>
                            <option value="nuevo">üÜï Lo Nuevo</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Product Grid -->
            <section id="productos-container" class="px-6 py-8 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 lg:gap-8">
                <div class="col-span-full py-20 text-center"><span class="loader"></span></div>
            </section>
        </div> <!-- FIN sec-catalogo -->

        <!-- 3. SECCI√ìN DASHBOARD (Independiente) -->
        <section id="sec-dashboard" class="hidden px-6 py-8 space-y-6">
            <!-- === NAVEGACI√ìN DASHBOARD GESTOR === -->
            <div class="flex gap-2 overflow-x-auto pb-2 mb-4">
                <button onclick="showDashSection('resumen')" id="btn-dash-resumen" class="px-4 py-2 bg-[#1a4789] text-white rounded-xl text-xs font-black uppercase shadow-md transition-all">üìä Resumen</button>
                <button onclick="showDashSection('precios')" id="btn-dash-precios" class="px-4 py-2 bg-white text-gray-500 rounded-xl text-xs font-black uppercase border border-gray-100 transition-all">üè∑Ô∏è Mis Precios (Config)</button>
            </div>

            <!-- 1. SECCI√ìN RESUMEN (Aqu√≠ envolvemos lo que ya ten√≠as) -->
            <div id="sub-dash-resumen">
            <!-- AQU√ç DENTRO DEBE QUEDAR TODO LO QUE YA TEN√çAS EN TU DASHBOARD (Tarjetas, Ranking, etc.) -->
            <!-- No borres nada de tu c√≥digo anterior, solo aseg√∫rate de que el contenido viejo del dashboard quede visualmente bajo esta l√≥gica o simplemente d√©jalo como est√° y el JS se encargar√° de ocultarlo/mostrarlo si lo envuelves en un div -->
            </div>

            <!-- 2. SECCI√ìN CONFIGURADOR DE PRECIOS (NUEVO) -->
            <div id="sub-dash-precios" class="hidden animate-fade-in">
                <div class="bg-indigo-50 border border-indigo-100 p-6 rounded-3xl mb-6">
                    <h3 class="text-lg font-black text-indigo-900 uppercase italic mb-2">Configurador de Precios</h3>
                    <p class="text-xs text-indigo-700 mb-4">
                        Aqu√≠ puedes subir el precio de los productos marcados como "Flexibles". 
                        <br>Todo lo que subas por encima del precio base es <b>100% ganancia extra para ti</b>.
                        Cuando los clientes entren por tu link, ver√°n los precios que tu estableciste. 
                    </p>
                    <div id="list-gestor-precios" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Se llena con JS -->
                    </div>
                </div>
            </div>


            <!-- === 1. TARJETA DE NIVEL (DASHBOARD) === -->
<!-- TARJETA NIVEL EST√ÅNDAR -->
        <div class="bg-gradient-to-r from-[#1a4789] to-[#2c6fb5] rounded-3xl p-6 md:p-8 text-white shadow-lg relative overflow-hidden mb-8">
            
            <div class="relative z-10 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                <!-- Info Izquierda -->
                <div class="space-y-2">
                    <div class="flex items-center gap-3">
                        <span id="lvl-badge" class="bg-white/20 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wider border border-white/30">
                            Nivel 0
                        </span>
                        <span id="lvl-name" class="text-sm font-semibold text-blue-100 opacity-90">Iniciado</span>
                    </div>
                    
                    <h2 id="lvl-title" class="text-2xl md:text-4xl font-black italic uppercase tracking-tight">
                        AGENTE INICIADO
                    </h2>
                    
                    <p class="text-sm text-blue-100 max-w-lg leading-relaxed opacity-90">
                        Tu enlace expira en <span id="lvl-link-duration" class="font-bold text-white">24 HORAS</span>. 
                        Sube de nivel para desbloquear herramientas.
                    </p>
                </div>

                <!-- Barra Derecha -->
                <div class="w-full lg:w-72 bg-black/20 p-4 rounded-2xl backdrop-blur-sm border border-white/10">
                    <div class="flex justify-between text-xs font-bold uppercase mb-2 text-white/90">
                        <span>Meta Siguiente Nivel</span>
                        <span id="lvl-counter">0 / 3 Ventas</span>
                    </div>
                    
                    <div class="h-3 bg-white/10 rounded-full overflow-hidden">
                        <div id="lvl-progress-bar" class="h-full bg-amber-400 shadow-[0_0_10px_rgba(251,191,36,0.5)] transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    
                    <button onclick="openGamificationModal()" class="mt-4 w-full bg-white text-[#1a4789] py-2.5 rounded-xl text-xs font-black uppercase hover:bg-blue-50 transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-base">upgrade</span> Ver Ascenso
                    </button>
                </div>
            </div>
        </div>
            <!-- BLOQUE FINANCIERO HOMOGENEIZADO -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 1. Por Cobrar -->
                <div class="bg-orange-500 p-6 rounded-3xl text-white shadow-xl shadow-orange-500/20 relative overflow-hidden flex flex-col justify-center min-h-[140px]">
                    <div class="relative z-10">
                        <p class="text-xs font-bold uppercase tracking-widest opacity-90 mb-1">Por Cobrar (Acumulado)</p>
                        <h2 id="dash-money-pending" class="text-4xl md:text-5xl font-black tracking-tight">$0.00</h2>
                        <p class="text-xs font-medium mt-2 opacity-80 flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">pending</span> Esperando liquidaci√≥n
                        </p>
                    </div>
                    <!-- Icono de fondo decorativo -->
                    <span class="material-symbols-outlined absolute -right-4 -bottom-4 text-9xl opacity-10 pointer-events-none">pending_actions</span>
                </div>

                <!-- 2. Cobrado -->
                <div class="bg-emerald-500 p-6 rounded-3xl text-white shadow-xl shadow-emerald-500/20 relative overflow-hidden flex flex-col justify-center min-h-[140px]">
                    <div class="relative z-10">
                        <p class="text-xs font-bold uppercase tracking-widest opacity-90 mb-1">Dinero Cobrado</p>
                        <h2 id="dash-money-paid" class="text-4xl md:text-5xl font-black tracking-tight">$0.00</h2>
                        <p class="text-xs font-medium mt-2 opacity-80 flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">check_circle</span> Pagos recibidos
                        </p>
                    </div>
                    <span class="material-symbols-outlined absolute -right-4 -bottom-4 text-9xl opacity-10 pointer-events-none">savings</span>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-2xl border border-gray-100 dark:bg-gray-800">
                    <p class="text-[9px] font-black text-gray-400 uppercase">Pedidos Entregados</p>
                    <p id="dash-ok" class="text-2xl font-black text-primary">0</p>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-gray-100 dark:bg-gray-800">
                    <p class="text-[9px] font-black text-gray-400 uppercase">Pedidos Pendientes</p>
                    <p id="dash-pending" class="text-2xl font-black text-orange-500">0</p>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-700 overflow-hidden">
                <div class="p-6 border-b border-gray-50 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-xs font-black uppercase tracking-widest text-gray-500">Ranking de Agentes</h3>
                </div>
                <div id="ranking-list" class="divide-y divide-gray-50 dark:divide-gray-700"></div>
                <!-- SECCI√ìN DE MIS PEDIDOS CON FILTROS -->
                <div class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-700 shadow-sm mt-6 overflow-hidden">
                    <div class="p-6 border-b border-gray-50 dark:border-gray-700">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                            <div class="flex items-center gap-4">
                            <div>
                                <h3 class="text-sm font-black uppercase text-primary italic">üì¶ Seguimiento de Ventas</h3>
                                <p class="text-[10px] text-gray-400 font-bold">Pedidos v√≠a tus enlaces o manuales.</p>
                            </div>
                            <!-- Alerta de Ventas Nuevas -->
                            <div id="new-orders-badge" class="hidden bg-red-500 text-white text-[9px] font-black px-3 py-1 rounded-full animate-bounce">
                                ¬°TIENES VENTAS NUEVAS!
                            </div>
                        </div>
                            <!-- Buscador -->
                            <div class="w-full md:w-auto relative">
                                <span class="material-symbols-outlined absolute left-3 top-2.5 text-gray-400 text-sm">search</span>
                                <input type="text" id="search-mi-historial" oninput="filterMyOrders()" placeholder="Buscar cliente..." class="w-full md:w-64 pl-9 pr-4 py-2 rounded-xl bg-gray-50 dark:bg-gray-900 border-none text-xs font-bold">
                            </div>
                        </div>

                        <!-- NAVEGACI√ìN POR ESTADOS (TABS) -->
                        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide" id="my-orders-tabs">
                            <button onclick="setMyOrdersFilter('TODOS', this)" class="my-order-tab active">Todos</button>
                            <button onclick="setMyOrdersFilter('Pendiente', this)" class="my-order-tab">‚è≥ Pendientes</button>
                            <button onclick="setMyOrdersFilter('Asignado Mensajero', this)" class="my-order-tab">üèçÔ∏è En Camino</button>
                            <button onclick="setMyOrdersFilter('Entregado', this)" class="my-order-tab">‚úÖ Entregados</button>
                        </div>
                    </div>

                    <!-- Lista de Pedidos -->
                    <div id="list-mis-pedidos" class="divide-y divide-gray-50 dark:divide-gray-700 max-h-[600px] overflow-y-auto">
                        <!-- Se llena con JS -->
                    </div>
                </div>

                <style>
                    .my-order-tab {
                        padding: 8px 16px;
                        border-radius: 12px;
                        font-size: 10px;
                        font-weight: 800;
                        text-transform: uppercase;
                        white-space: nowrap;
                        background: #f1f5f9;
                        color: #64748b;
                        transition: all 0.2s;
                    }
                    .my-order-tab.active {
                        background: #1a4789;
                        color: white;
                        box-shadow: 0 4px 6px -1px rgba(26, 71, 137, 0.2);
                    }
                </style>
            </div>


            <!-- === M√ìDULO DE INTELIGENCIA Y REPORTES (Nuevo) === -->
<div class="space-y-6 mt-8">
    
    <!-- 1. ANAL√çTICA DE VENTAS (Tus horas pico y tendencias) -->
   <!-- En tu secci√≥n de anal√≠tica -->
<div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border border-gray-100 dark:border-gray-700">
    <h4 class="text-[10px] font-black uppercase text-gray-400 mb-4 flex items-center gap-2">
        <span class="material-symbols-outlined text-sm">auto_graph</span> El Bloque de Oro
    </h4>
    <div id="ana-hora-pico" class="text-2xl font-black text-gray-200">--:--</div>
    <p class="text-[9px] text-gray-400 mt-2 italic">La hora exacta donde tus clientes sacan la billetera.</p>
</div>

<div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border border-gray-100 dark:border-gray-700">
    <h4 class="text-[10px] font-black uppercase text-gray-400 mb-4 flex items-center gap-2">
        <span class="material-symbols-outlined text-sm">monitoring</span> Radar de Oportunidades
    </h4>
    <div id="ana-tendencia-global" class="space-y-2">
        <!-- Contenido bloqueado o data -->
    </div>
    <p class="text-[9px] text-gray-400 mt-2 italic">No adivines qu√© publicar. Mira lo que ya tiene √©xito.</p>
</div>

    <!-- 2. BUZ√ìN DE INTELIGENCIA (Reportes) -->
    <div class="bg-indigo-50 dark:bg-gray-800/50 p-6 rounded-3xl border border-indigo-100 dark:border-gray-700">
        <div class="flex items-center gap-2 mb-4">
            <span class="material-symbols-outlined text-indigo-500">campaign</span>
            <h3 class="text-sm font-black uppercase text-indigo-900 dark:text-white">Buz√≥n de Inteligencia</h3>
        </div>
        <p class="text-xs text-indigo-700 dark:text-gray-400 mb-4">Ay√∫danos a mejorar. Reporta precios de competencia, pide productos o reporta fallos.</p>
        
        <form id="form-reporte-gestor" class="space-y-3">
            <select id="rep-tipo" class="w-full rounded-xl border-none bg-white dark:bg-gray-900 text-xs font-bold p-3">
                <option value="Solicitud">üì¶ Solicitar Producto (Demanda)</option>
                <option value="Competencia">üïµÔ∏è Reporte Competencia (Precios)</option>
                <option value="Problema">‚ö†Ô∏è Problema / Mensajer√≠a</option>
                <option value="Sugerencia">üí° Sugerencia General</option>
            </select>
            
            <textarea id="rep-msg" placeholder="Describe el detalle..." class="w-full rounded-xl border-none bg-white dark:bg-gray-900 text-xs p-3 h-20"></textarea>
            
            <!-- Subida de Foto Simple -->
            <div class="flex items-center gap-2">
                <label class="flex items-center gap-2 bg-white dark:bg-gray-900 px-4 py-2 rounded-xl cursor-pointer border border-dashed border-gray-300">
                    <span class="material-symbols-outlined text-gray-400 text-sm">add_a_photo</span>
                    <span class="text-[10px] font-bold text-gray-500 uppercase">Adjuntar Foto</span>
                    <input type="file" id="rep-file" accept="image/*" class="hidden" onchange="previewReportImg()">
                </label>
                <span id="rep-file-name" class="text-[10px] text-gray-400 truncate max-w-[150px]"></span>
            </div>

            <button type="button" onclick="sendGestorReport()" class="w-full bg-indigo-500 text-white py-3 rounded-xl font-black text-xs uppercase shadow-lg shadow-indigo-500/20">Enviar Informe</button>
        </form>
    </div>
</div>


        </section>

    </main>

    <!-- MODAL DETALLE (ESTILO IMAGEN) -->
    <div id="detail-modal" class="fixed inset-0 z-[100] hidden bg-black/60 backdrop-blur-sm p-2 md:p-4 overflow-y-auto flex justify-center items-start md:items-center">
        <div class="bg-white dark:bg-background-dark w-full max-w-6xl rounded-3xl overflow-hidden shadow-2xl flex flex-col lg:flex-row relative">
            <button onclick="closeDetail()" class="absolute top-4 right-4 z-10 p-2 bg-gray-100 dark:bg-gray-800 rounded-full hover:rotate-90 transition-transform">
                <span class="material-symbols-outlined">close</span>
            </button>

            <!-- Imagen Izquierda -->
            <div class="lg:w-1/2 bg-white flex flex-col items-center border-r border-gray-100 dark:border-gray-800">
                <div class="w-full p-4 flex items-center justify-center bg-white min-h-[300px] max-h-[500px]">
                    <img id="detail-main-img" src="" class="w-full h-full object-contain">
                </div>
                <div id="detail-thumbnails" class="flex gap-2 overflow-x-auto scrollbar-hide px-4 pb-4"></div>
                <p class="mb-4 text-[10px] text-gray-400 flex items-center gap-1 uppercase tracking-widest px-4 text-center">
                    <span class="material-symbols-outlined text-sm">info</span> Imagen real del equipo en almac√©n
                </p>
            </div>

            <!-- Info Derecha -->
            <div class="lg:w-1/2 p-8 lg:p-12 flex flex-col">
                <div class="flex items-center gap-3 mb-2">
                    <span class="bg-primary/10 text-primary px-2.5 py-1 rounded-full text-[10px] font-black uppercase">En Stock</span>
                    <span id="detail-cat" class="text-[10px] text-gray-400 font-bold uppercase"></span>
                </div>
                <h2 id="detail-name" class="text-3xl font-black mb-4"></h2>
                
                <div class="flex items-baseline gap-4 mb-8">
                    <span id="detail-price" class="text-4xl font-black text-primary"></span>
                    <span id="detail-price-cup" class="text-lg text-gray-400"></span>
                </div>

                <!-- Specs Grid -->
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-700">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Garant√≠a</p>
                        <p id="detail-warranty" class="font-bold text-sm"></p>
                    </div>
                    <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-700">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Mensajer√≠a</p>
                        <p id="detail-shipping" class="font-bold text-sm"></p>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xs font-black uppercase text-gray-400 mb-3 tracking-widest">Descripci√≥n</h3>
                    <p id="detail-desc" class="text-sm leading-relaxed text-gray-600 dark:text-gray-400"></p>
                </div>

                <!-- WhatsApp Actions -->
                <!-- ACCIONES DEL GESTOR -->
<div class="mt-auto space-y-3 pt-4 border-t border-gray-100 dark:border-gray-700">
    
    <!-- Fila de Herramientas de Marketing (DISE√ëO LIMPIO Y √öNICO) -->
     <div id="marketing-tools-container" class="hidden"> <!-- A√±adimos este ID y clase hidden -->

        <div class="flex gap-2 flex-wrap mb-4">
            
            <!-- Bot√≥n 1: Copiar Info (Nivel 0) -->
            <button onclick="copySimpleDesc(this)" class="flex-1 min-w-[80px] py-3 bg-white border-2 border-gray-100 dark:bg-gray-800 dark:border-gray-700 rounded-xl font-bold text-[10px] uppercase flex flex-col items-center justify-center hover:border-blue-400 hover:text-blue-500 transition-all text-gray-500 gap-1 shadow-sm">
                <span class="material-symbols-outlined text-xl">description</span>
                Copiar Info
            </button>

            <!-- Bot√≥n 2: Descargar Foto (Nivel 0) -->
            <button onclick="downloadProductImage(this)" class="flex-1 min-w-[80px] py-3 bg-white border-2 border-gray-100 dark:bg-gray-800 dark:border-gray-700 rounded-xl font-bold text-[10px] uppercase flex flex-col items-center justify-center hover:border-primary hover:text-primary transition-all text-gray-500 gap-1 shadow-sm">
                <span class="material-symbols-outlined text-xl">download</span>
                Foto
            </button>
            
            <!-- Bot√≥n 3: Copiar Oferta (Nivel 0) -->
            <button onclick="copySmartOffer(this)" class="flex-1 min-w-[80px] py-3 bg-white border-2 border-gray-100 dark:bg-gray-800 dark:border-gray-700 rounded-xl font-bold text-[10px] uppercase flex flex-col items-center justify-center hover:border-primary hover:text-primary transition-all text-gray-500 gap-1 shadow-sm">
                <span class="material-symbols-outlined text-xl">content_copy</span>
                Oferta
            </button>

            <!-- Bot√≥n 4: STORY MAKER (Nivel 1 - Se controla por JS) -->
            <button id="btn-story-maker" onclick="generateStoryImage()" class="flex-1 min-w-[80px] py-3 bg-gradient-to-br from-pink-500 to-orange-400 text-white border-none rounded-xl font-bold text-[10px] uppercase flex flex-col items-center justify-center hover:opacity-90 transition-all gap-1 shadow-lg shadow-pink-500/20">
                <span class="material-symbols-outlined text-xl">fit_screen</span>
                Crear Story
            </button>
        </div>
    </div>

    <!-- Fila 2: ACCI√ìN PRINCIPAL (Hacer la Orden) -->
    <!-- Este bot√≥n mantiene la funci√≥n addItemToCart() para seguir el flujo normal de venta -->
    <button onclick="addItemToCart()" class="w-full bg-[#25D366] hover:bg-[#20bd5c] text-white py-4 rounded-xl font-black text-sm uppercase tracking-widest flex items-center justify-center gap-2 transition-all shadow-lg shadow-green-500/20 active:scale-95">
        <span class="material-symbols-outlined text-2xl">shopping_cart_checkout</span>
        <span>A√±adir a la Orden / Tramitar</span>
    </button>
    
</div>
            </div>
        </div>
    </div>

    <!-- MODAL CARRITO / FORMULARIO -->
    <div id="cart-modal" class="fixed inset-0 z-[110] hidden bg-black/80 flex justify-end">
        <div class="bg-white dark:bg-background-dark w-full max-w-md h-full shadow-2xl flex flex-col p-6 animate-slide-left overflow-y-auto pb-24">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-black uppercase italic text-primary">Mi Pedido</h2>
                <button onclick="toggleCartModal(false)" class="p-2 bg-gray-100 rounded-full"><span class="material-symbols-outlined">close</span></button>
            </div>
            
            <div id="cart-items" class="space-y-4 mb-6"></div>

            <div class="border-t pt-6 mb-6">
                <div class="flex justify-between items-end mb-4">
                    <span class="text-gray-400 font-bold uppercase text-xs">Total a Pagar</span>
                    <div class="text-right">
                        <p id="cart-total" class="text-gray-400 text-xs line-through">$0.00</p>
                        <p id="total-convertido" class="text-3xl font-black text-primary">$0.00</p>
                    </div>
                </div>

                <!-- Reemplaza todo el <form id="checkout-form"> ... </form> con esto: -->

<form id="checkout-form" class="flex flex-col h-full">
    
    <!-- 1. HERRAMIENTAS GESTOR (Buscador grande) -->
    <div id="gestor-checkout-tools" class="hidden mb-6 space-y-4"> 
        <button type="button" onclick="magicPaste()" class="w-full py-4 bg-gradient-to-r from-emerald-500 to-green-600 text-white rounded-2xl font-black text-sm uppercase shadow-lg shadow-green-500/20 flex items-center justify-center gap-2 active:scale-95 transition-transform">
            <span class="material-symbols-outlined text-xl">content_paste_go</span>
            Pegar Datos de WhatsApp (Autom√°tico)
        </button>

        <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
            <label class="block text-xs font-black text-indigo-500 uppercase mb-2 ml-1">Buscar Cliente Recurrente</label>
            <div class="relative">
                <span class="material-symbols-outlined absolute left-4 top-3.5 text-indigo-400 text-xl">person_search</span> 
                <input type="text" id="crm-search" list="crm-datalist" onchange="autofillClient(this.value)" 
                    placeholder="Escribe nombre..." 
                    class="w-full pl-12 pr-4 py-3.5 bg-white border-0 rounded-xl text-base font-bold text-indigo-900 shadow-sm ring-1 ring-indigo-200 focus:ring-2 focus:ring-indigo-500 placeholder:text-indigo-300">
            </div>
            <datalist id="crm-datalist"></datalist>
        </div>
    </div>

    <!-- 2. CAMPOS DE TEXTO (Estilo Gigante - Im√°genes 2, 3, 4) -->
    <div class="space-y-5 flex-1 overflow-y-auto pb-4 px-1">
        
        <div>
            <label class="block text-sm font-bold text-gray-500 mb-1.5 ml-1">Nombre del Cliente</label>
            <input type="text" id="check-nombre" placeholder="Ej: Juan P√©rez" 
                class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-5 py-4 text-lg font-bold text-slate-800 focus:bg-white focus:border-primary focus:ring-0 transition-all placeholder:text-gray-300" required>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-bold text-gray-500 mb-1.5 ml-1">Carnet (CI)</label>
                <input type="text" id="check-ci" placeholder="Opcional" 
                    class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-5 py-4 text-lg font-bold text-slate-800 focus:bg-white focus:border-primary focus:ring-0 transition-all placeholder:text-gray-300">
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-500 mb-1.5 ml-1">Tel√©fono</label>
                <input type="tel" id="check-tel" placeholder="5xxx-xxxx" 
                    class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-5 py-4 text-lg font-bold text-slate-800 focus:bg-white focus:border-primary focus:ring-0 transition-all placeholder:text-gray-300" required>
            </div>
        </div>

        <div>
            <label class="block text-sm font-bold text-gray-500 mb-1.5 ml-1">Municipio de Entrega</label>
            <div class="relative">
                <select id="check-municipio" class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-5 py-4 text-lg font-bold text-slate-800 appearance-none focus:bg-white focus:border-primary focus:ring-0 transition-all" required>
                    <option value="" disabled selected>Seleccionar...</option>
                    <option value="Playa">Playa</option>
                    <option value="Plaza de la Revoluci√≥n">Plaza de la Revoluci√≥n</option>
                    <option value="Centro Habana">Centro Habana</option>
                    <option value="Habana Vieja">Habana Vieja</option>
                    <option value="Regla">Regla</option>
                    <option value="Diez de Octubre">Diez de Octubre</option>
                    <option value="Cerro">Cerro</option>
                    <option value="Marianao">Marianao</option>
                    <option value="La Lisa">La Lisa</option>
                    <option value="Boyeros">Boyeros</option>
                    <option value="Arroyo Naranjo">Arroyo Naranjo</option>
                    <option value="Cotorro">Cotorro</option>
                    <option value="Guanabacoa">Guanabacoa</option>
                    <option value="San Miguel del Padr√≥n">San Miguel del Padr√≥n</option>
                    <option value="Habana del Este">Habana del Este</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-500">
                    <span class="material-symbols-outlined">expand_more</span>
                </div>
            </div>
        </div>
        
        <div>
            <label class="block text-sm font-bold text-gray-500 mb-1.5 ml-1">Direcci√≥n Exacta</label>
            <textarea id="check-dir" placeholder="Calle, N√∫mero, Entre Calles..." 
                class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-5 py-4 text-lg font-bold text-slate-800 h-32 resize-none focus:bg-white focus:border-primary focus:ring-0 transition-all placeholder:text-gray-300" required></textarea>
        </div>

        <!-- PAGO Y VUELTO (Estilo Tarjeta) -->
        <div class="p-5 bg-blue-50/50 rounded-2xl border border-blue-100 space-y-4">
            <div>
                <label class="block text-xs font-black uppercase text-blue-400 mb-1">M√©todo de Pago</label>
                <select id="check-moneda" class="w-full bg-transparent border-b border-blue-200 text-xl font-black text-blue-900 py-2 focus:ring-0 focus:border-blue-500 px-0"></select>
            </div>
            <div>
                <label class="block text-xs font-black uppercase text-blue-400 mb-1">¬øNecesita Vuelto? (Escribir Billete)</label>
                <input type="number" id="check-vuelto" placeholder="No, tengo el importe exacto" class="w-full bg-transparent border-b border-blue-200 text-lg font-bold text-blue-900 py-2 focus:ring-0 focus:border-blue-500 px-0 placeholder:text-blue-300/70">
            </div>
        </div>

    </div>

    <!-- BOT√ìN FINAL GIGANTE -->
    <div class="pt-4 mt-auto">
        <button type="submit" id="final-submit-btn" class="w-full bg-[#1a4789] text-white py-5 rounded-2xl font-black text-lg uppercase tracking-widest shadow-xl shadow-blue-900/20 hover:bg-[#2c6fb5] transition-all active:scale-95 flex items-center justify-center gap-3">
            <span>Confirmar Pedido</span>
            <span class="material-symbols-outlined">arrow_forward</span>
        </button>
    </div>
</form>
            </div>
        </div>
    </div>

    <!-- MODAL GESTORES ACTUALIZADO CON ACCESO MASTER -->
<div id="gestor-modal" class="fixed inset-0 z-[200] hidden bg-black/90 p-6 flex items-center justify-center">
    <div class="bg-white dark:bg-background-dark w-full max-w-sm rounded-3xl p-8 space-y-4">
        <h2 class="text-xl font-black uppercase text-primary text-center">Zona de Agentes</h2>
        <input type="password" id="master-pass" placeholder="C√≥digo Maestro" class="w-full rounded-xl border-gray-200">
        <input type="text" id="gen-name" placeholder="Tu Nombre" class="w-full rounded-xl border-gray-200">
        <input type="tel" id="gen-tel" placeholder="WhatsApp" class="w-full rounded-xl border-gray-200">
        <button onclick="processGestor()" class="w-full bg-primary text-white py-3 rounded-xl font-bold uppercase italic">Generar Enlaces</button>
        
        <div id="links-result" class="hidden space-y-4 pt-4 border-t border-gray-100">
            <!-- Link Privado -->
            <div>
                <p class="text-[9px] font-black text-red-500 uppercase mb-1">‚óè Mi Panel Privado (Solo para ti)</p>
                <input type="text" id="link-admin" readonly class="w-full text-[10px] bg-gray-100 p-2 rounded border-none">
                <button onclick="copy('link-admin')" class="text-[10px] font-bold text-primary mt-1">COPIAR LINK PRIVADO</button>
            </div>
            <!-- Link P√∫blico -->
            <div>
                <p class="text-[9px] font-black text-gray-400 uppercase mb-1">‚óè Link P√∫blico (Para enviar a clientes)</p>
                <input type="text" id="link-client" readonly class="w-full text-[10px] bg-gray-100 p-2 rounded border-none">
                <button onclick="copy('link-client')" class="text-[10px] font-bold text-primary mt-1">COPIAR LINK CLIENTE</button>
            </div>
        </div>

        <!-- SECCI√ìN DE CIERRE Y ACCESO SECRETO -->
        <div class="flex flex-col gap-2 pt-4 border-t border-gray-100">
            <button onclick="closeGestorGen()" class="w-full text-gray-400 text-[10px] font-black uppercase tracking-widest">Cerrar Ventana</button>
            
            <!-- BOT√ìN SECRETO PARA EL DUE√ëO -->
            <button onclick="openAdminMasterFromGestor()" class="w-full text-primary/30 hover:text-primary text-[8px] font-black uppercase tracking-[0.2em] mt-4 transition-all">
                ‚óè Acceso Administraci√≥n Central
            </button>
        </div>
    </div>
</div>

<section id="sec-admin-master" class="hidden px-4 md:px-10 lg:px-20 py-10 max-w-[1400px] mx-auto bg-gray-50 dark:bg-background-dark min-h-screen">
    
    <!-- Encabezado -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
        <div>
            <h2 class="text-3xl font-black text-gray-900 dark:text-white uppercase tracking-tighter italic">Master<span class="text-primary">Control</span></h2>
            <p class="text-gray-500 text-[10px] font-black uppercase tracking-widest">Gesti√≥n de Log√≠stica y Finanzas</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-2xl flex items-center gap-3 border px-4">
    <div class="flex flex-col">
        <span class="text-[8px] font-black text-gray-400 uppercase tracking-widest">Tasa del D√≠a</span>
        <div class="flex items-center gap-1">
            <span class="text-xs text-gray-400">$1 =</span>
            <!-- ID cambiado a 'daily-rate' -->
            <input type="number" id="daily-rate" value="" onchange="updateGlobalRate(this.value)" class="w-12 bg-transparent border-none font-black text-primary p-0 focus:ring-0 text-xl text-right">
            <span class="text-xs font-bold text-gray-400">CUP</span>
        </div>
    </div>
</div>
            <button onclick="location.reload()" class="p-4 bg-red-50 text-red-500 rounded-2xl hover:bg-red-500 hover:text-white transition-all">
                <span class="material-symbols-outlined">power_settings_new</span>
            </button>
        </div>
    </div>

    <!-- Indicadores -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-8">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">Ventas Entregadas</p>
            <h3 id="m-stat-ventas" class="text-3xl font-black text-primary">$0</h3>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">Comisiones x Pagar</p>
            <h3 id="m-stat-deuda" class="text-3xl font-black text-orange-500">$0</h3>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">En Log√≠stica</p>
            <h3 id="m-stat-pendientes" class="text-3xl font-black text-gray-800 dark:text-white">0</h3>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">Gestores Activos</p>
            <h3 id="m-stat-gestores" class="text-3xl font-black text-blue-500">0</h3>
        </div>
    </div>

    <!-- Pesta√±as del Master Control (LOG√çSTICA, PAGOS, INVENTARIO, AN√ÅLISIS, TR√ÅFICO, APROBACIONES) -->
<div class="flex gap-2 mb-6 bg-white dark:bg-gray-800 p-2 rounded-2xl border shadow-sm overflow-x-auto scrollbar-hide whitespace-nowrap">
    <button onclick="changeAdminTab('logistica')" id="tab-logistica" class="btn-tab-admin active flex-1 py-3 rounded-xl text-xs font-black uppercase italic tracking-widest transition-all">Log√≠stica</button>
    <button onclick="changeAdminTab('inventario')" id="tab-inventario" class="btn-tab-admin flex-1 py-3 rounded-xl text-xs font-black uppercase italic tracking-widest transition-all text-gray-400">Inventario</button>
    <button onclick="changeAdminTab('trafico')" id="tab-trafico" class="btn-tab-admin flex-1 py-3 rounded-xl text-xs font-black uppercase italic tracking-widest transition-all text-gray-400">Tr√°fico</button>
    <button onclick="changeAdminTab('aprobaciones')" id="tab-aprobaciones" class="btn-tab-admin flex-1 py-3 rounded-xl text-xs font-black uppercase italic tracking-widest transition-all text-gray-400">Aprobar Gestores</button>
</div>


    <!-- === SECCI√ìN DE LOG√çSTICA (RECONSTRUIDA) === -->
<div id="cnt-logistica" class="tab-cnt bg-white dark:bg-gray-800 rounded-3xl border shadow-sm overflow-hidden">
    
    <!-- A. SUB-NAVEGACI√ìN DE ESTADOS -->
    <div id="filter-buttons-container" class="bg-white dark:bg-gray-800 p-2 border-b border-gray-100 dark:border-gray-700 flex flex-wrap gap-2 items-center">
        <button onclick="filterLogisticaByStatus('TODOS', this)" class="btn-filter active px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all bg-primary text-white shadow-md">Todos</button>
        <button onclick="filterLogisticaByStatus('Pendiente', this)" class="btn-filter px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all text-gray-500">‚è≥ Por Asignar</button>
        <button onclick="filterLogisticaByStatus('Recogida Almac√©n', this)" class="btn-filter px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all text-gray-500">üè≠ En Almac√©n</button>
        <button onclick="filterLogisticaByStatus('Asignado Mensajero', this)" class="btn-filter px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all text-gray-500">üèçÔ∏è Con Mensajero</button>
        <button onclick="filterLogisticaByStatus('FINALIZADOS', this)" class="btn-filter px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all text-gray-500">‚úÖ Hist√≥rico</button>
    </div>

    <!-- B. BARRA DE FILTROS AVANZADOS -->
    <div class="p-4 bg-gray-50/50 dark:bg-gray-900/20 border-b border-gray-100 dark:border-gray-700 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-3">

            <div class="flex flex-col gap-1">
                <label class="text-[9px] font-black uppercase text-gray-400">Municipio</label>
                <select id="f-municipio" onchange="renderAdminLogistica()" class="text-[10px] border-gray-200 rounded-lg p-2 font-bold dark:bg-gray-900 focus:ring-0">
                    <option value="TODOS">Todos</option>
                    <option value="Playa">Playa</option>
                    <option value="Plaza de la Revoluci√≥n">Plaza de la Revoluci√≥n</option>
                    <option value="Centro Habana">Centro Habana</option>
                    <option value="Habana Vieja">Habana Vieja</option>
                    <option value="Regla">Regla</option>
                    <option value="Diez de Octubre">Diez de Octubre</option>
                    <option value="Cerro">Cerro</option>
                    <option value="Marianao">Marianao</option>
                    <option value="La Lisa">La Lisa</option>
                    <option value="Boyeros">Boyeros</option>
                    <option value="Arroyo Naranjo">Arroyo Naranjo</option>
                    <option value="Cotorro">Cotorro</option>
                    <option value="Guanabacoa">Guanabacoa</option>
                    <option value="San Miguel del Padr√≥n">San Miguel del Padr√≥n</option>
                    <option value="Habana del Este">Habana del Este</option>
                </select>
            </div>
            
            <div class="flex flex-col gap-1 lg:col-span-2">
                <label class="text-[9px] font-black uppercase text-gray-400">Rango Fecha</label>
                <div class="flex gap-1">
                    <input type="date" id="f-desde" onchange="renderAdminLogistica()" class="w-full text-[10px] border-gray-200 rounded-lg p-2 dark:bg-gray-900">
                    <input type="date" id="f-hasta" onchange="renderAdminLogistica()" class="w-full text-[10px] border-gray-200 rounded-lg p-2 dark:bg-gray-900">
                </div>
            </div>

            <div class="flex flex-col gap-1">
                <label class="text-[9px] font-black uppercase text-gray-400">Proveedor</label>
                <select id="f-proveedor" onchange="renderAdminLogistica()" class="text-[10px] border-gray-200 rounded-lg p-2 font-bold dark:bg-gray-900 focus:ring-0">
                    <option value="TODOS">Todos</option>
                </select>
            </div>

            <div class="flex flex-col gap-1">
                <label class="text-[9px] font-black uppercase text-gray-400">Gestor</label>
                <select id="f-gestor" onchange="renderAdminLogistica()" class="text-[10px] border-gray-200 rounded-lg p-2 font-bold dark:bg-gray-900 focus:ring-0">
                    <option value="TODOS">Todos</option>
                </select>
            </div>

            <div class="flex flex-col gap-1">
                <label class="text-[9px] font-black uppercase text-gray-400">Buscar</label>
                <input type="text" id="search-logistica" oninput="renderAdminLogistica()" placeholder="Cliente..." class="w-full text-[10px] border-gray-200 rounded-lg p-2 font-bold dark:bg-gray-900">
            </div>

            <div class="flex items-end gap-1">
                <button onclick="resetLogisticaFilters()" class="p-2 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-400 rounded-lg hover:text-red-500 transition-colors">
                    <span class="material-symbols-outlined text-sm">filter_alt_off</span>
                </button>
                <button onclick="exportLogisticaExcel()" class="flex-1 bg-emerald-500 text-white p-2 rounded-lg font-black text-[10px] uppercase flex items-center justify-center gap-2 shadow-lg shadow-emerald-500/20">
                    <span class="material-symbols-outlined text-sm">download</span> Excel
                </button>
            </div>
        </div>

        <!-- C. BARRA DE TOTALES -->
        <div class="flex gap-6 border-t border-gray-100 dark:border-gray-700 pt-3">
            <div class="flex flex-col"><span class="text-[8px] font-bold text-gray-400 uppercase">Pedidos</span><span id="sum-count" class="text-sm font-black text-primary dark:text-blue-400">0</span></div>
            <div class="flex flex-col border-l pl-6 dark:border-gray-700"><span class="text-[8px] font-bold text-gray-400 uppercase">Venta Total</span><span id="sum-usd" class="text-sm font-black text-primary dark:text-blue-400">$0</span></div>
            <div class="flex flex-col border-l pl-6 dark:border-gray-700"><span class="text-[8px] font-bold text-gray-400 uppercase">Comisiones</span><span id="sum-comi" class="text-sm font-black text-orange-500">$0</span></div>
        </div>
    </div>

    <!-- D. LA TABLA DE DATOS -->
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead class="bg-gray-50 dark:bg-gray-900/50 text-[10px] font-black uppercase text-gray-400 border-b dark:border-gray-700">
                <tr>
                    <th class="p-4">Fecha/Cliente</th>
                    <th class="p-4">Proveedor</th>
                    <th class="p-4">Producto</th>
                    <th class="p-4">Gestor</th>
                    <th class="p-4 text-right">Estado Log√≠stica</th>
                </tr>
            </thead>
            <tbody id="list-admin-pedidos" class="divide-y dark:divide-gray-700">
                <!-- El JavaScript llenar√° esto autom√°ticamente -->
            </tbody>
        </table>
    </div>
</div>

    

    <!-- Contenido: Inventario -->
    <div id="cnt-inventario" class="tab-cnt hidden space-y-6">
        <div class="flex justify-between items-center bg-white dark:bg-gray-800 p-4 rounded-3xl border shadow-sm">
            <p class="text-[10px] font-black uppercase text-gray-400 italic">Gesti√≥n de Cat√°logo</p>
            <!-- ENCABEZADO INVENTARIO PRO -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white dark:bg-gray-800 p-4 rounded-3xl border shadow-sm mb-6">
                
                <!-- Buscador -->
                <div class="flex items-center gap-2 bg-gray-50 dark:bg-gray-900 px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 w-full md:w-96">
                    <span class="material-symbols-outlined text-gray-400 text-sm">inventory_2</span>
                    <input type="text" id="search-inventario" oninput="renderAdminInventario()" placeholder="Buscar por Nombre, Categor√≠a o SKU..." class="bg-transparent border-none focus:ring-0 text-xs w-full font-bold">
                </div>

                <!-- Botones -->
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="exportInventoryExcel()" class="flex-1 md:flex-none bg-emerald-50 text-emerald-600 border border-emerald-200 hover:bg-emerald-100 px-4 py-2.5 rounded-xl font-black text-[10px] uppercase flex items-center justify-center gap-2 transition-all">
                        <span class="material-symbols-outlined text-sm">download</span> Excel Inventario
                    </button>
                    <button onclick="openModalProd()" class="flex-1 md:flex-none bg-primary text-white px-6 py-2.5 rounded-xl font-black text-[10px] uppercase shadow-lg shadow-primary/20 hover:bg-secondary transition-all">
                        + Nuevo Equipo
                    </button>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4" id="list-admin-inventario"></div>
    </div>

    <!-- Contenido: An√°lisis -->


<!-- Contenido: Gesti√≥n de Gestores -->
<div id="cnt-aprobaciones" class="tab-cnt hidden space-y-8">
    
    <!-- BLOQUE 1: PENDIENTES -->
    <div class="space-y-4">
        <h4 class="text-xs font-black uppercase text-orange-500 flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">hourglass_empty</span> Solicitudes Pendientes
        </h4>
        <div class="bg-white dark:bg-gray-800 rounded-3xl border shadow-sm overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 dark:bg-gray-900/50 text-[10px] font-black uppercase text-gray-400 border-b">
                    <tr>
                        <th class="p-4">Nombre</th>
                        <th class="p-4">WhatsApp</th>
                        <th class="p-4 text-right">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="list-admin-aprobaciones" class="divide-y dark:divide-gray-700">
                    <!-- JS inyecta aqu√≠ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- BLOQUE 2: ACTIVOS -->
    <div class="space-y-4">
        <h4 class="text-xs font-black uppercase text-emerald-500 flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">verified_user</span> Gestores Activos (Equipo)
        </h4>
        <div class="bg-white dark:bg-gray-800 rounded-3xl border shadow-sm overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 dark:bg-gray-900/50 text-[10px] font-black uppercase text-gray-400 border-b">
                    <tr>
                        <th class="p-4">Nombre</th>
                        <th class="p-4">WhatsApp</th>
                        <th class="p-4 text-right">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="list-admin-activos" class="divide-y dark:divide-gray-700">
                    <!-- JS inyecta aqu√≠ -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 1. En la lista de botones de pesta√±as, a√±ade este: -->
<button onclick="changeAdminTab('trafico')" id="tab-trafico" class="btn-tab-admin flex-1 py-3 rounded-xl text-xs font-black uppercase italic tracking-widest transition-all text-gray-400">Tr√°fico</button>

<!-- 2. Al final de la secci√≥n sec-admin-master, justo ANTES del </section>, pega esto: -->
<div id="cnt-trafico" class="tab-cnt hidden space-y-6">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <div class="flex items-center gap-2 mb-6">
                <span class="material-symbols-outlined text-primary">analytics</span>
                <h4 class="font-black uppercase text-xs text-gray-700 dark:text-white">Clics por Agente</h4>
            </div>
            <div id="list-trafico-gestores" class="space-y-4"></div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border shadow-sm">
            <div class="flex items-center gap-2 mb-6">
                <span class="material-symbols-outlined text-secondary">devices</span>
                <h4 class="font-black uppercase text-xs text-gray-700 dark:text-white">Dispositivos</h4>
            </div>
            <div id="list-trafico-dispositivos" class="space-y-4"></div>
        </div>
    </div>
</div>

</section>

    <!-- Footer -->
    <footer class="bg-background-light dark:bg-background-dark pt-16 pb-8 px-4 md:px-10 lg:px-40 relative mt-20">
    <!-- Onda Invertida Superior -->
    <div class="absolute top-0 left-0 w-full overflow-hidden leading-[0] transform rotate-180">
        <svg class="relative block w-full h-[30px]" viewBox="0 0 1200 120" preserveAspectRatio="none">
            <path class="fill-primary/5" d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z"></path>
        </svg>
    </div>

    <div class="max-w-[1200px] mx-auto grid grid-cols-1 md:grid-cols-4 gap-12">
        <div class="flex flex-col gap-6">
            <div class="flex items-center gap-2">
                <div class="text-primary"><span class="material-symbols-outlined text-3xl">home_iot_device</span></div>
                <h2 class="text-primary dark:text-white text-xl font-extrabold tracking-tight">para<span class="text-secondary">tuhogar</span></h2>
            </div>
            <p class="text-slate-600 dark:text-gray-400 text-sm leading-relaxed">
                Llevando calidad y confort a los hogares cubanos con el sello de profesionalismo. La tienda de confianza.
            </p>
        </div>
        <div>
            <h3 class="text-primary dark:text-white text-sm font-black uppercase tracking-widest mb-6">Categor√≠as</h3>
            <ul class="flex flex-col gap-3 text-sm text-slate-600 dark:text-gray-400">
                <li><a class="hover:text-primary transition-colors flex items-center gap-2" href="#" onclick="filterByCategory('REFRIGERACI√ìN')"><span class="w-1.5 h-1.5 rounded-full bg-primary/30"></span>Refrigeraci√≥n</a></li>
                <li><a class="hover:text-primary transition-colors flex items-center gap-2" href="#" onclick="filterByCategory('COCINA')"><span class="w-1.5 h-1.5 rounded-full bg-primary/30"></span>Cocina</a></li>
                <li><a class="hover:text-primary transition-colors flex items-center gap-2" href="#" onclick="filterByCategory('CLIMATIZACI√ìN')"><span class="w-1.5 h-1.5 rounded-full bg-primary/30"></span>Climatizaci√≥n</a></li>
            </ul>
        </div>
        <div>
            <h3 class="text-primary dark:text-white text-sm font-black uppercase tracking-widest mb-6">Informaci√≥n</h3>
            <ul class="flex flex-col gap-3 text-sm text-slate-600 dark:text-gray-400">
                <li><a class="hover:text-primary transition-colors" href="#">C√≥mo comprar</a></li>
                <li><a class="hover:text-primary transition-colors" href="#">T√©rminos de Garant√≠a</a></li>
                <li><a class="hover:text-primary transition-colors" href="#">WhatsApp</a></li>
            </ul>
        </div>
        <div>
            <h3 class="text-primary dark:text-white text-sm font-black uppercase tracking-widest mb-6">Contacto</h3>
            <ul class="flex flex-col gap-4 text-sm text-slate-600 dark:text-gray-400">
                <li class="flex items-center gap-3"><span class="material-symbols-outlined text-primary">mail</span> info@paratuhogar.cu</li>
                <li class="flex items-center gap-3"><span class="material-symbols-outlined text-primary">location_on</span> La Habana, Cuba</li>
            </ul>
        </div>
    </div>
    
    <div class="max-w-[1200px] mx-auto mt-16 pt-8 border-t border-slate-200 dark:border-gray-800 flex flex-col md:flex-row justify-between items-center gap-6">
        <p class="text-slate-500 dark:text-gray-500 text-xs font-medium">¬© 2026 paratuhogar. Todos los derechos reservados.</p>
        <div class="flex gap-3">
             <div class="h-8 w-12 bg-white border border-slate-200 rounded-md flex items-center justify-center text-[10px] font-bold text-slate-400">CUP</div>
             <div class="h-8 w-12 bg-white border border-slate-200 rounded-md flex items-center justify-center text-[10px] font-bold text-slate-400">USD</div>
        </div>
    </div>
</footer>

    <!-- MODAL NUEVO PRODUCTO -->
<div id="modal-producto" class="fixed inset-0 z-[300] hidden bg-black/80 backdrop-blur-sm p-4 overflow-y-auto flex justify-center items-center">
    <div class="bg-white dark:bg-gray-800 w-full max-w-2xl rounded-[32px] p-6 md:p-8 shadow-2xl relative my-auto">

        <button onclick="closeModalProd()" class="absolute top-6 right-6 p-2 bg-gray-100 rounded-full"><span class="material-symbols-outlined">close</span></button>
        
        <h3 class="text-2xl font-black mb-6 italic uppercase">A√±adir Nuevo <span class="text-primary">Equipo</span></h3>

        <!-- === INICIO DEL CAMBIO: NUEVO BLOQUE DE IA === -->
        <div class="mb-6 bg-indigo-50 p-4 rounded-2xl border border-indigo-100 shadow-sm">
            <label class="text-[10px] font-black uppercase text-indigo-400 mb-2 block tracking-widest">Asistente Inteligente</label>
            <div class="flex gap-2">
                <!-- 1. Bot√≥n para elegir las fotos -->
                <button type="button" onclick="document.getElementById('file-0').click()" class="w-1/3 bg-white text-indigo-600 border border-indigo-200 py-3 rounded-xl font-bold text-xs shadow-sm active:scale-95 flex flex-col items-center justify-center gap-1 hover:bg-indigo-50 transition-colors">
                    <span class="material-symbols-outlined text-xl">add_a_photo</span>
                    1. Cargar Fotos
                </button>

                <!-- 2. EL S√öPER BOT√ìN (HACE TODO) -->
                <button type="button" onclick="superMagicAI()" class="w-2/3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-xl font-black text-sm shadow-lg shadow-indigo-500/30 active:scale-95 flex flex-col items-center justify-center gap-1 hover:brightness-110 transition-all">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-2xl">auto_awesome</span>
                        <span>AUTO-COMPLETAR</span>
                    </div>
                    <span class="text-[9px] opacity-90 font-medium">Usa Texto Copiado + Fotos</span>
                </button>
            </div>
            <p class="text-[9px] text-indigo-300 mt-2 text-center italic">Copia el texto de WhatsApp, sube las fotos y presiona el bot√≥n m√°gico.</p>
        </div>
        
        <form id="form-nuevo-prod" class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- ID Oculto para cuando editemos -->
    <input type="hidden" id="p-id-edit">
    <input type="hidden" id="p-disponible" value="SI">


    <input type="text" id="p-nombre" placeholder="Nombre del Equipo" class="md:col-span-2 rounded-xl border-gray-100 font-bold" required>
    <input type="number" id="p-precio" placeholder="Precio USD" class="rounded-xl border-gray-100 font-bold" required>
    <input type="number" id="p-comision" placeholder="Comisi√≥n Gestor" class="rounded-xl border-gray-100 font-bold" required>

    
    <!-- === NUEVOS CAMPOS PROVEEDOR Y FLEXIBILIDAD === -->
    <div class="md:col-span-2 grid grid-cols-2 gap-4">
        <!-- Selector de Proveedor -->
        <div>
            <label class="text-[10px] font-black uppercase text-gray-400 ml-1">Proveedor / Almac√©n</label>
            <input type="text" id="p-proveedor" list="lista-proveedores" placeholder="Ej: Importadora A" class="w-full rounded-xl border-gray-100 font-bold text-gray-700">
            <datalist id="lista-proveedores">
                <option value="General">
                <option value="Importadora A">
                <option value="Importadora B">
                <!-- Se ir√°n guardando solos al escribir -->
            </datalist>
        </div>
        
        <!-- Selector de Flexibilidad de Precio -->
        <div>
            <label class="text-[10px] font-black uppercase text-gray-400 ml-1">¬øPrecio Subible?</label>
            <select id="p-flexible" class="w-full rounded-xl border-gray-100 font-bold text-gray-700">
                <option value="NO">üîí Precio Fijo (No subir)</option>
                <option value="SI">üìà Flexible (Gestor puede subir)</option>
            </select>
        </div>
    </div>
    <!-- ============================================== -->

    <!-- CAMPO DE CATEGOR√çA INTELIGENTE (Este ya lo tienes, sigue abajo) -->
    
    <!-- CAMPO DE CATEGOR√çA INTELIGENTE -->
    <div class="relative">
        <label class="text-[10px] font-black uppercase text-gray-400 ml-1">Categor√≠a</label>
        <input type="text" id="p-categoria" list="lista-categorias" placeholder="Escribe o selecciona..." class="w-full rounded-xl border-gray-100 font-bold text-gray-700" autocomplete="off" required>
        <datalist id="lista-categorias">
            <!-- Las opciones se llenar√°n solas con JS -->
        </datalist>
    </div>
    <input type="text" id="p-garantia" placeholder="Garant√≠a" class="rounded-xl border-gray-100 font-bold">
    <!-- CAMPO VISIBLE PARA MENSAJER√çA -->
    <div class="md:col-span-2">
        <label class="text-[10px] font-black uppercase text-gray-400 ml-1">üöö Detalles de Mensajer√≠a</label>
        <input type="text" id="p-mensajeria" placeholder="Ej: Gratis en La Habana, 5 USD periferia..." class="w-full rounded-xl border-gray-200 font-bold text-gray-700 bg-gray-50 focus:bg-white transition-colors">
    </div>
    

    <!-- SECCI√ìN DE FOTOS (4 espacios) -->
    <!-- SECCI√ìN DE FOTOS (4 espacios con bot√≥n de borrar) -->
<div class="md:col-span-2 border-y py-4 my-2">
    <p class="text-[10px] font-black text-gray-400 uppercase mb-3 italic">Galer√≠a de Im√°genes (M√°x 4)</p>
    <div class="grid grid-cols-4 gap-2">
        <!-- Foto 0 -->
        <div onclick="document.getElementById('file-0').click()" class="aspect-square bg-gray-50 border-2 border-dashed rounded-xl flex items-center justify-center cursor-pointer relative overflow-hidden group">
            <input type="file" id="file-0" accept="image/*" class="hidden" onchange="handlePowerUpload(this, 0)">
            <img id="prev-0" class="absolute inset-0 w-full h-full object-cover hidden">
            <span id="icon-0" class="material-symbols-outlined text-gray-300">add_a_photo</span>
            <input type="hidden" id="img-path-0">
            <!-- BOT√ìN BORRAR -->
            <button type="button" onclick="clearImageSlot(event, 0)" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-0.5 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10">
                <span class="material-symbols-outlined text-xs">close</span>
            </button>
        </div>
        <!-- Foto 1 -->
        <div onclick="document.getElementById('file-1').click()" class="aspect-square bg-gray-50 border-2 border-dashed rounded-xl flex items-center justify-center cursor-pointer relative overflow-hidden group">
            <input type="file" id="file-1" accept="image/*" class="hidden" onchange="handlePowerUpload(this, 1)">
            <img id="prev-1" class="absolute inset-0 w-full h-full object-cover hidden">
            <span id="icon-1" class="material-symbols-outlined text-gray-300">add_a_photo</span>
            <input type="hidden" id="img-path-1">
            <button type="button" onclick="clearImageSlot(event, 1)" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-0.5 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10">
                <span class="material-symbols-outlined text-xs">close</span>
            </button>
        </div>
        <!-- Foto 2 -->
        <div onclick="document.getElementById('file-2').click()" class="aspect-square bg-gray-50 border-2 border-dashed rounded-xl flex items-center justify-center cursor-pointer relative overflow-hidden group">
            <input type="file" id="file-2" accept="image/*" class="hidden" onchange="handlePowerUpload(this, 2)">
            <img id="prev-2" class="absolute inset-0 w-full h-full object-cover hidden">
            <span id="icon-2" class="material-symbols-outlined text-gray-300">add_a_photo</span>
            <input type="hidden" id="img-path-2">
            <button type="button" onclick="clearImageSlot(event, 2)" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-0.5 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10">
                <span class="material-symbols-outlined text-xs">close</span>
            </button>
        </div>
        <!-- Foto 3 -->
        <div onclick="document.getElementById('file-3').click()" class="aspect-square bg-gray-50 border-2 border-dashed rounded-xl flex items-center justify-center cursor-pointer relative overflow-hidden group">
            <input type="file" id="file-3" accept="image/*" class="hidden" onchange="handlePowerUpload(this, 3)">
            <img id="prev-3" class="absolute inset-0 w-full h-full object-cover hidden">
            <span id="icon-3" class="material-symbols-outlined text-gray-300">add_a_photo</span>
            <input type="hidden" id="img-path-3">
            <button type="button" onclick="clearImageSlot(event, 3)" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-0.5 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10">
                <span class="material-symbols-outlined text-xs">close</span>
            </button>
        </div>
    </div>
</div>

    <!-- EDITOR TIPO WORD -->
    <div class="md:col-span-2 space-y-2">
        <label class="text-[10px] font-black text-gray-400 uppercase italic">Descripci√≥n Detallada</label>
        <div id="editor-container"></div>
    </div>
    
    <button type="submit" id="btn-save-prod" class="md:col-span-2 bg-primary text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg shadow-primary/30 mt-4">Guardar Cambios</button>
</form>
    </div>
</div>

<!-- === PANTALLA DE ACCESO (LOGIN / REGISTRO) === -->
<div id="login-overlay" class="fixed inset-0 z-[9999] bg-background-light dark:bg-background-dark flex flex-col items-center justify-center p-6 transition-all duration-500 overflow-y-auto hidden">
    <div class="w-full max-w-sm text-center space-y-6 my-auto">
        
        <!-- Logo -->
        <div class="flex items-center justify-center gap-2 mb-4">
            <span class="material-symbols-outlined text-5xl text-primary">home_iot_device</span>
            <h1 class="text-3xl font-extrabold tracking-tight italic">para<span class="text-primary">tuhogar</span></h1>
        </div>

        <!-- Caja Principal -->
        <div class="bg-white dark:bg-gray-800 p-8 rounded-[32px] shadow-xl border border-gray-100 dark:border-gray-700 relative overflow-hidden">
            
            <!-- Tabs Superior -->
            <div class="flex border-b border-gray-100 dark:border-gray-700 mb-6">
                <button onclick="toggleLoginMode('login')" id="tab-login-btn" class="flex-1 pb-2 font-black text-xs uppercase text-primary border-b-2 border-primary">Entrar</button>
                <button onclick="toggleLoginMode('register')" id="tab-register-btn" class="flex-1 pb-2 font-black text-xs uppercase text-gray-400">Registrarme</button>
            </div>

            <!-- FORMULARIO LOGIN -->
            <div id="form-login" class="space-y-4">
                <input type="text" id="log-user" placeholder="Tu Nombre de Usuario" class="w-full rounded-xl border-gray-200 dark:bg-gray-900 font-bold text-sm p-3">
                <input type="password" id="log-pass" placeholder="Contrase√±a" class="w-full rounded-xl border-gray-200 dark:bg-gray-900 font-bold text-sm p-3">
                <button onclick="processLogin()" class="w-full bg-primary text-white py-4 rounded-xl font-black uppercase shadow-lg shadow-primary/30">Iniciar Sesi√≥n</button>
            </div>

            <!-- FORMULARIO REGISTRO -->
            <div id="form-register" class="space-y-4 hidden">
                <input type="text" id="reg-name" placeholder="Nombre y Apellido" class="w-full rounded-xl border-gray-200 dark:bg-gray-900 font-bold text-sm p-3">
                <input type="email" id="reg-email" placeholder="Correo Electr√≥nico" class="w-full rounded-xl border-gray-200 dark:bg-gray-900 font-bold text-sm p-3">
                <input type="tel" id="reg-tel" placeholder="Tel√©fono (WhatsApp)" class="w-full rounded-xl border-gray-200 dark:bg-gray-900 font-bold text-sm p-3">
                <input type="password" id="reg-pass" placeholder="Crea una Contrase√±a" class="w-full rounded-xl border-gray-200 dark:bg-gray-900 font-bold text-sm p-3">
                <button onclick="processRegister()" class="w-full bg-gray-900 text-white py-4 rounded-xl font-black uppercase shadow-lg">Crear Cuenta</button>
            </div>

        </div>

        <button onclick="enterAsClient()" class="text-gray-400 text-xs font-bold uppercase tracking-widest hover:text-primary mt-4">
            Solo quiero ver el cat√°logo (Cliente)
        </button>
    </div>
</div>

    <!-- Scripts de L√≥gica -->
    <script>
    // 1. CONFIGURACI√ìN SUPABASE
    // Cambiamos el nombre de la constante a 'supabaseClient' para evitar errores
    const SUPABASE_URL = 'https://ljqwaovevfatkiigirhf.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_DAuFcu0JjUo15yLDAev3MQ_9x5GIVXt'; // Aseg√∫rate que esta sea la 'anon key'
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function checkShortLinks() {
    const urlParams = new URLSearchParams(window.location.search);
    const slug = urlParams.get('s');

    if (slug) {
        const { data, error } = await supabaseClient
            .from('short_links')
            .select('*')
            .eq('slug', slug)
            .single();

        if (data && !error) {
            // 1. Registrar anal√≠tica (Opcional, lo mantenemos)
            const ua = navigator.userAgent;
            supabaseClient.from('link_analytics').insert([{
                slug: slug,
                device_type: /Mobi|Android/i.test(ua) ? 'M√≥vil' : 'Escritorio',
                agent_name: data.gestor // Guardamos el nombre para el rastro
            }]);

            // 2. Extraer datos del link original
            // Intentamos sacar el tel√©fono si existe en la URL original
            let telOriginal = "";
            try {
                const urlObj = new URL(data.original_url);
                telOriginal = urlObj.searchParams.get('tel') || "";
            } catch(e) {}

            // 3. GUARDADO CR√çTICO: Guardar en LocalStorage ANTES de redirigir
            // Esto es lo que faltaba. Sin esto, el dato se pierde al recargar.
            const referrerData = {
                nombre: data.gestor,
                telefono: telOriginal,
                timestamp: new Date().getTime(),
                expiresAt: new Date().getTime() + (30 * 24 * 60 * 60 * 1000) // Validez de 30 d√≠as
            };
            
            // Guardamos en ambas variables por seguridad
            localStorage.setItem('pth_referrer_smart', JSON.stringify(referrerData));
            localStorage.setItem('pth_referrer', JSON.stringify(referrerData));

            // 4. Redirigir a la URL original
            window.location.href = data.original_url;
        }
    }
}

// IMPORTANTE: Ejecutar la funci√≥n inmediatamente
checkShortLinks();

    const MASTER_KEY = "HOGAR2025"; 

    const _0xaf21 = "NTIwMl9OSU1EQV9PUlA="; 
    const getAccess = () => atob(_0xaf21).split('').reverse().join('');

    
    let productosRaw = [], cart = [], selectedProduct = null;
    let cupRate = 450, showInCUP = false, activeCategory = 'TODOS';
    
    

    const urlParams = new URLSearchParams(window.location.search);
    const gestorName = urlParams.get('gestor');
    const gestorTel = urlParams.get('tel');
    const isAdmin = urlParams.get('admin') === 'true';

    // --- L√ìGICA DE INICIO Y RECUPERACI√ìN DE SESI√ìN ---
   window.addEventListener('load', () => {
        // 1. Inicializar editor Quill
        if(document.getElementById('editor-container')) {
            quill = new Quill('#editor-container', {
                theme: 'snow',
                placeholder: 'Descripci√≥n...',
                modules: { toolbar: [['bold', 'italic'], [{ 'color': [] }]] }
            });
        }

        // 2. Intentar recuperar sesi√≥n
        const savedSession = localStorage.getItem('pth_session');
        
        if (savedSession) {
            const s = JSON.parse(savedSession);
            
            // --- ESTA L√çNEA ES EL ARREGLO PARA EL TEL√âFONO ---
            window.currentUserData = s.data || {}; 
            // -------------------------------------------------

            setupSession(s.name, s.isAdmin);
        } else {
            // 1. Ocultamos la ventana de login por si acaso
            const overlay = document.getElementById('login-overlay');
            if (overlay) overlay.classList.add('hidden'); 
            
            // 2. Limpiamos estados
            window.gestorName = null;
            window.isAdmin = false;
            window.currentUserData = null; // Limpiar datos tambi√©n
            
            // 3. MOSTRAR EL BOT√ìN DE LA PERSONITA
            const btnLogin = document.getElementById('btn-login-open');
            if (btnLogin) btnLogin.classList.remove('hidden'); 
            
            // 4. Ocultamos cosas de gestor/admin que no deben verse
            if (document.getElementById('admin-nav')) document.getElementById('admin-nav').classList.add('hidden');
            if (document.getElementById('btn-logout')) document.getElementById('btn-logout').classList.add('hidden');
            
            loadProducts();
        }

        initAutoSaveSystem(); 
        loadClientCRM();
        initAgentFloatingButton();      
    });

    // --- SISTEMA DE ATRIBUCI√ìN (√öLTIMO CLIC GANA) ---
    let referrerData = null;

    function initReferralSystem() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlGestor = urlParams.get('gestor');
        const urlTel = urlParams.get('tel');

        // 1. SI HAY NUEVO ENLACE -> SOBRESCRIBIMOS (Last Click Wins)
        if (urlGestor) {
            referrerData = {
                nombre: urlGestor,
                telefono: urlTel || "",
                timestamp: new Date().getTime() // Guardamos cu√°ndo ocurri√≥
            };
            // Guardamos en memoria persistente del navegador
            localStorage.setItem('pth_referrer', JSON.stringify(referrerData));
            console.log("Nuevo gestor atribuido:", urlGestor);
        } 
        // 2. SI NO HAY ENLACE -> BUSCAMOS EN MEMORIA (Hist√≥rico)
        else {
            const stored = localStorage.getItem('pth_referrer');
            if (stored) {
                referrerData = JSON.parse(stored);
                console.log("Gestor recuperado de memoria:", referrerData.nombre);
            }
        }
    }
// Funci√≥n para abrir la ventana de inicio de sesi√≥n manualmente
function openLoginModal() {
    const loginOverlay = document.getElementById('login-overlay');
    if (loginOverlay) {
        loginOverlay.classList.remove('hidden');
        // Asegurarnos de que inicie en la pesta√±a de "Entrar" y no "Registrarme"
        if(typeof toggleLoginMode === 'function') toggleLoginMode('login');
    } else {
        console.error("Error: No se encontr√≥ el elemento login-overlay en el HTML");
    }
}


    // Ejecutar inmediatamente al cargar el script
    initReferralSystem();

    

    // Funci√≥n para Clientes (Bot√≥n "Entrar como Cliente")
    function enterAsClient() {
    document.getElementById('login-overlay').classList.add('hidden');
    // Si no se hab√≠an cargado los productos, los cargamos
    if (productosRaw.length === 0) loadProducts();
}

    // --- 1. L√ìGICA DE ACCESO (LOGIN/REGISTRO) ---
    
    function toggleLoginMode(mode) {
        const isLogin = mode === 'login';
        document.getElementById('form-login').classList.toggle('hidden', !isLogin);
        document.getElementById('form-register').classList.toggle('hidden', isLogin);
        
        document.getElementById('tab-login-btn').className = isLogin ? "flex-1 pb-2 font-black text-xs uppercase text-primary border-b-2 border-primary" : "flex-1 pb-2 font-black text-xs uppercase text-gray-400";
        document.getElementById('tab-register-btn').className = !isLogin ? "flex-1 pb-2 font-black text-xs uppercase text-primary border-b-2 border-primary" : "flex-1 pb-2 font-black text-xs uppercase text-gray-400";
    }

    // REGISTRO DE NUEVO GESTOR
    async function processRegister() {
    // 1. Capturar elementos y valores
    const btn = document.querySelector('#form-register button');
    const nombre = document.getElementById('reg-name').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const tel = document.getElementById('reg-tel').value.trim();
    const pass = document.getElementById('reg-pass').value.trim();

    // 2. Validaciones b√°sicas
    if(!nombre || !pass || !tel) return alert("Nombre, Tel√©fono y Contrase√±a son obligatorios.");

    // Bloquear bot√≥n para evitar m√∫ltiples clics
    btn.disabled = true;
    const originalText = btn.innerText;
    btn.innerText = "PROCESANDO...";

    try {
        // 3. VERIFICAR SI YA EXISTE (Duplicados)
        const { data: existe, error: errCheck } = await supabaseClient
            .from('gestores')
            .select('id, estado')
            .eq('telefono', tel)
            .maybeSingle();

        if (existe) {
            if (existe.estado === 'pendiente') {
                alert("‚è≥ Ya tenemos una solicitud con este n√∫mero en revisi√≥n. ¬°Ten paciencia, te avisaremos pronto!");
            } else {
                alert("‚úÖ Este n√∫mero ya tiene una cuenta activa. Ve a la pesta√±a de ENTRAR.");
            }
            btn.disabled = false;
            btn.innerText = originalText;
            return;
        }

        // 4. INSERTAR NUEVO REGISTRO
        const { error } = await supabaseClient
            .from('gestores')
            .insert([{ 
                nombre: nombre, 
                email: email, 
                telefono: tel, 
                password: pass,
                estado: 'pendiente' 
            }]);

        if (error) throw error;

        // 5. √âXITO
        alert("‚úÖ Solicitud enviada correctamente. El administrador debe aprobar tu cuenta antes de que puedas entrar. Te avisaremos por WhatsApp.");
        
        // Limpiar formulario y mandar al login
        document.getElementById('form-register').querySelectorAll('input').forEach(i => i.value = "");
        toggleLoginMode('login');

    } catch (e) {
        alert("Error al registrar: " + e.message);
    } finally {
        // Reactivar bot√≥n por si hubo error
        btn.disabled = false;
        btn.innerText = originalText;
    }
}

    // INICIO DE SESI√ìN
    

    // Funci√≥n auxiliar para guardar en el navegador
    function saveSessionToMemory(name, isAdmin, data) {
        const session = {
            name: name,
            isAdmin: isAdmin,
            data: data
        };
        localStorage.setItem('pth_session', JSON.stringify(session));
    }

    function closeLogin() { document.getElementById('login-overlay').classList.add('hidden'); }
    function enterAsClient() { closeLogin(); loadProducts(); }

    function setupSession(name, adminMode) {
    window.gestorName = name;
    window.isAdmin = adminMode;
    
    const label = document.getElementById('gestor-label');
    label.innerText = adminMode ? `ADMINISTRADOR` : `AGENTE: ${name.toUpperCase()}`;
    document.getElementById('admin-nav').classList.remove('hidden');

    if (adminMode) {
        // MODO ADMINISTRADOR (Log√≠stica)
        document.getElementById('sec-admin-master').classList.remove('hidden');
        document.getElementById('sec-catalogo').style.display = 'none';
        document.getElementById('admin-nav').classList.add('hidden');
        loadAdminData();
    } else {
        // MODO GESTOR (Ventas)
        
        // 1. Mostrar Dashboard y Cargar Datos
        showSection('dashboard');
        loadProducts(); 
        loadProDashboard(name);
        
        // 2. Cargar Anal√≠ticas
        if(typeof loadAnalyticsPro === "function") loadAnalyticsPro(name);

        // 3. MOSTRAR EL NUEVO CENTRO DE MANDO
        const commandCenter = document.getElementById('gestor-command-center');
        if (commandCenter) commandCenter.classList.remove('hidden');

        // === INICIO DE SISTEMA DE NIVELES ===
        
        // A. Aplicar CANDADOS inmediatamente
        if (typeof applyLockedFeatures === "function") {
            applyLockedFeatures();
        }

        // B. Dibujar el bot√≥n Flash
        if (typeof renderFlashButton === "function") {
            renderFlashButton();
        }
        
        // C. Consultar nivel y Coordinar Carteles
        if (typeof checkGamificationStatus === "function") {
            checkGamificationStatus();
            showAgentWelcomeModal(name);
        }
    }

    // FORZAR QUE SE VEA EL BOT√ìN ROJO DE SALIR
    const btnLogout = document.getElementById('btn-logout');
    if (btnLogout) {
        btnLogout.classList.remove('hidden');
        btnLogout.style.display = 'inline-flex'; 
    }
    
    loadClientCRM(); 

    // Ocultar bot√≥n de whatsapp si existe al entrar a modo gestor/admin
    const waBtn = document.getElementById('floating-agent-contact');
    if (waBtn) waBtn.classList.add('hidden');

    // ============================================================
    // üõ°Ô∏è L√ìGICA DE BOT√ìN MAESTRO (FINANCIERO)
    // ============================================================
    
    // 1. Recuperar datos del usuario logueado
    const userData = window.currentUserData || {};
    
    // 2. Verificar Permisos: Rol 'superadmin' O Nombres espec√≠ficos del Jefe/T√∫
    const esSuperAdmin = userData.rol === 'superadmin' || name === 'Administrador' || name === 'Marcel Montano'; 

    if (esSuperAdmin) {
        // Buscamos d√≥nde poner el bot√≥n (en el header, junto al bot√≥n de salir)
        // Usamos parentElement para mayor seguridad
        const headerContainer = btnLogout ? btnLogout.parentElement : document.querySelector('header div.flex.items-center');

        // 3. Crear e Inyectar el bot√≥n SOLO si no existe ya
        if (headerContainer && !document.getElementById('btn-master-vault')) {
            const btnMaster = document.createElement('button');
            btnMaster.id = 'btn-master-vault'; // ID √∫nico para evitar duplicados
            btnMaster.innerHTML = `<span class="material-symbols-outlined text-amber-900 font-bold">shield</span>`;
            
            // Estilos: Dorado, con sombra, pulso suave para destacar
            btnMaster.className = "flex items-center justify-center rounded-lg h-10 w-10 bg-amber-400 hover:bg-amber-300 text-amber-900 transition-all shadow-lg shadow-amber-500/50 border-2 border-amber-200 animate-pulse ml-2";
            btnMaster.title = "ACCESO A B√ìVEDA FINANCIERA";
            
            // Acci√≥n: Ir al archivo secreto
            btnMaster.onclick = () => window.location.href = 'master.html';
            
            // Insertar ANTES del bot√≥n de Salir para que quede a su izquierda
            headerContainer.insertBefore(btnMaster, btnLogout);
            
            console.log("‚úÖ Acceso Financiero Habilitado");
        }
    }
}

    // --- 2. L√ìGICA DASHBOARD PRO (Ranking + Enlaces) ---

    // Variable global para guardar los pedidos del gestor y poder filtrar
let myOrdersData = [];

async function loadProDashboard(nombreGestor) {
    // 1. Consultar TODOS los datos necesarios de los pedidos
    const { data: allPedidos, error } = await supabaseClient
        .from('pedidos')
        .select('*')
        .order('fecha', { ascending: false });

    if(error) { console.error(error); return; }
    
    // 2. Filtrar SOLO mis ventas
    const misVentas = allPedidos.filter(p => p.gestor === nombreGestor);
    myOrdersData = misVentas; // Guardamos para el buscador

    // 3. C√°lculos Financieros
    const misEntregados = misVentas.filter(p => p.estado === 'Entregado');
    const misPendientes = misVentas.filter(p => p.estado !== 'Entregado' && p.estado !== 'Cancelado');

    const porCobrar = misEntregados
        .filter(p => p.pago_gestor === 'Pendiente' || !p.pago_gestor)
        .reduce((acc, curr) => acc + (Number(curr.comision_total) || 0), 0);

    const cobrado = misEntregados
        .filter(p => p.pago_gestor === 'Pagado')
        .reduce((acc, curr) => acc + (Number(curr.comision_total) || 0), 0);

    // Actualizar HTML Financiero
    if(document.getElementById('dash-money-pending')) document.getElementById('dash-money-pending').innerText = `$${porCobrar.toFixed(2)}`;
    if(document.getElementById('dash-money-paid')) document.getElementById('dash-money-paid').innerText = `$${cobrado.toFixed(2)}`;
    if(document.getElementById('dash-ok')) document.getElementById('dash-ok').innerText = misEntregados.length;
    if(document.getElementById('dash-pending')) document.getElementById('dash-pending').innerText = misPendientes.length;

    // 4. RANKING
    renderRankingAnonimo(allPedidos, nombreGestor);

    // 5. RENDERIZAR LA LISTA DE PEDIDOS DETALLADA
    renderMyOrdersList(misVentas);
    // ... dentro de loadProDashboard ...

    // 5. RENDERIZAR LA LISTA DE PEDIDOS DETALLADA
    renderMyOrdersList(misVentas);

    // 6. NUEVO: RENDERIZAR GR√ÅFICA DE ORIGEN
    renderSourceChart(misVentas); // <--- PEGA ESTO AQU√ç
    
    // ... resto del c√≥digo ...

    // 6. INYECTAR ENLACES (Corregido: Solo una vez y con await)
    // Esto es lo que genera el link corto autom√°ticamente si eres Nivel 3+
    await injectLinksSection(nombreGestor);

    // Al final, DESPU√âS de obtener los datos de pedidos:
    renderMyOrdersList(misVentas); 
    
    // Y el ranking
    renderRankingAnonimo(allPedidos, nombreGestor);
}

// Funci√≥n auxiliar para el Ranking (para mantener el c√≥digo limpio)
// --- FUNCI√ìN ACTUALIZADA CON LAS 4 IDEAS ---
// Funci√≥n auxiliar para tiempo relativo (Ej: "Hace 5m")
function timeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return "Hace un momento";
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `Hace ${minutes} min`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `Hace ${hours}h`;
    return "Ayer";
}

// Funci√≥n principal de Ranking PRO
// Funci√≥n principal de Ranking PRO (TEXTOS GRANDES Y LEGIBLES)
// 1. FUNCI√ìN AUXILIAR PARA EL TIEMPO (P√©gala fuera de renderRankingAnonimo, al final de tu script)
function timeAgo(dateString) {
    if (!dateString) return "";
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return "Hace un momento";
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `Hace ${minutes} min`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `Hace ${hours}h`;
    return "Ayer";
}

// 2. FUNCI√ìN PRINCIPAL CORREGIDA
async function renderRankingAnonimo(allPedidos, nombreGestor) {
    const container = document.getElementById('ranking-list');
    if (!container) return;

    // --- PROCESAMIENTO DE DATOS ---
    const rankingMap = {};
    const salesFeed = []; 

    allPedidos.forEach(p => {
        if (p.estado === 'Entregado' && p.gestor !== 'Venta Directa') {
            const monto = Number(p.comision_total) || 0;
            rankingMap[p.gestor] = (rankingMap[p.gestor] || 0) + monto;
            salesFeed.push(p);
        }
    });

    // Ordenar ventas por fecha (Lo m√°s nuevo primero)
    salesFeed.sort((a, b) => new Date(b.created_at || b.fecha) - new Date(a.created_at || a.fecha));

    // Crear Array de Ranking
    const rankingArray = Object.entries(rankingMap)
        .map(([name, total]) => ({ name, total }))
        .sort((a, b) => b.total - a.total);

    const myRankIndex = rankingArray.findIndex(r => r.name === nombreGestor);
    const myData = rankingArray[myRankIndex] || { total: 0 };
    const topData = rankingArray[0] || { total: 1 }; 

    // --- CORRECCI√ìN: DATO REAL DE GESTORES ACTIVOS ---
    // Contamos cu√°nta gente hay en el ranking (gente que ha vendido algo)
    const gestoresReales = rankingArray.length;
    let liveViewText = `üë• ${gestoresReales} Gestores est√°n compitiendo ahora.`;

    // Intentamos buscar visualizaciones reales (Opcional)
    try {
        const { data: vistas } = await supabaseClient
            .from('metricas_vistas')
            .select('nombre_producto')
            .order('created_at', { ascending: false })
            .limit(1);

        if (vistas && vistas.length > 0) {
            // Si hay datos, los mostramos
            liveViewText = `üëÅÔ∏è Alguien est√° viendo <b>${vistas[0].nombre_producto.substring(0,20)}...</b>`;
        }
    } catch (e) { 
        // Si falla, se queda con el texto de "Gestores compitiendo" calculado arriba
    }

    let html = '';

    // --- A. TICKER CORREGIDO (CON TIEMPO) ---
    const lastSale = salesFeed[0];
    
    let tickerContent = `üí§ Esperando venta...`;
    
    if (lastSale) {
        // Calculamos el tiempo
        const tiempo = timeAgo(lastSale.created_at || lastSale.fecha);
        
        // Construimos el HTML
        tickerContent = `
            üöÄ <span class="text-amber-400 font-bold text-xs md:text-sm">${lastSale.gestor.substring(0,3)}***</span> 
            vendi√≥ <span class="text-cyan-300 font-bold text-xs md:text-sm">${lastSale.producto.substring(0,50)}${lastSale.producto.length > 50 ? '...' : ''}</span>
            <span class="text-gray-400 text-[10px] ml-1 whitespace-nowrap">(${tiempo})</span>
        `;
    }

    html += `
    <div class="mb-16 relative overflow-hidden rounded-xl bg-[#0f172a] shadow-lg border border-white/10 group z-0 mx-1">
        <div class="relative z-10 p-3 flex flex-col items-center gap-2">
            
            <!-- Barra de Notificaci√≥n -->
            <div class="flex items-center gap-2 bg-white/5 rounded-lg px-3 py-2 w-full border border-white/5">
                <div class="h-2 w-2 rounded-full bg-green-500 live-indicator flex-shrink-0 self-start mt-1.5 md:mt-0"></div>
                <div class="ticker-anim text-xs text-white tracking-wide w-full font-medium whitespace-normal leading-tight">
                    ${tickerContent}
                </div>
            </div>
            
            <!-- Texto de Gestores Activos -->
            <div class="text-[10px] text-blue-200 font-medium opacity-80 w-full text-center">
                ${liveViewText}
            </div>
        </div>
    </div>`;

    // B. PODIO
    html += `<div class="flex items-center justify-center gap-1 md:gap-4 mt-8 mb-12 px-0 perspective-1000 relative z-10">`;
    const [p1, p2, p3] = [rankingArray[0], rankingArray[1], rankingArray[2]];
    if (p2) html += renderHighEndPodium(p2, 2, nombreGestor);
    if (p1) html += renderHighEndPodium(p1, 1, nombreGestor);
    if (p3) html += renderHighEndPodium(p3, 3, nombreGestor);
    html += `</div>`;

    // C. BARRA RENDIMIENTO
    if (myRankIndex > 0) {
        const percentage = Math.min(100, (myData.total / topData.total) * 100);
        html += `
        <div class="glass-panel p-4 md:p-6 rounded-2xl mb-8 border border-slate-200 shadow-sm mx-1">
            <div class="flex justify-between items-end mb-2">
                <div>
                    <span class="text-[10px] font-bold uppercase text-slate-400 block">Distancia al L√≠der</span>
                    <h4 class="text-lg font-black text-slate-800 dark:text-white">Tu Rendimiento</h4>
                </div>
                <span class="text-xl font-black text-primary">${percentage.toFixed(0)}%</span>
            </div>
            <div class="h-4 w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                <div class="h-full bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-600 relative" style="width: ${percentage}%"></div>
            </div>
             <p class="text-[10px] text-slate-400 mt-2 text-center italic">
                "El l√≠der factura <b>${(topData.total / (myData.total || 1)).toFixed(1)}x</b> m√°s que t√∫."
            </p>
        </div>`;
    }

    // D. LISTA
    html += `<div class="space-y-3 px-1">`;
    rankingArray.forEach((user, index) => {
        const rank = index + 1;
        if (rank > 3) {
            const isMe = user.name === nombreGestor;
            const displayMoney = isMe ? `$${user.total.toFixed(0)}` : 'üîí';
            const displayName = isMe ? `${user.name}` : user.name.substring(0, 3) + '***';
            
            let carrotMsg = "";
            if (isMe) {
                const prevUser = rankingArray[index - 1];
                const diff = prevUser.total - user.total;
                carrotMsg = `<span class="text-xs text-orange-500 font-bold ml-2 animate-pulse">(-$${diff} para subir)</span>`;
            }

            html += `
            <div class="flex items-center justify-between p-3 rounded-xl ${isMe ? 'bg-white shadow-md border-l-4 border-blue-500' : 'bg-transparent border border-gray-100'}">
                <div class="flex items-center gap-3">
                    <span class="text-sm font-black text-slate-300 w-6">#${rank}</span>
                    <span class="text-xs font-black text-slate-700 dark:text-gray-200 uppercase">${displayName} ${isMe ? '(T√∫)' : ''}</span>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-xs font-black text-slate-800 dark:text-gray-300 bg-slate-100 px-2 py-1 rounded">
                        ${displayMoney}
                    </span>
                    ${carrotMsg}
                </div>
            </div>`;
        }
    });
    html += `</div>`;

    container.innerHTML = html;
}

// --- FUNCI√ìN UTILITARIA DE TIEMPO ---
function timeAgo(dateString) {
    if (!dateString) return "";
    
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000); // Diferencia en segundos
    
    // L√≥gica de tiempo relativo
    if (seconds < 60) return "Hace un momento";
    
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `Hace ${minutes} min`;
    
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `Hace ${hours}h`;
    
    const days = Math.floor(hours / 24);
    if (days === 1) return "Ayer";
    if (days < 7) return `Hace ${days} d√≠as`;
    
    // Si es muy antiguo, mostramos la fecha
    return date.toLocaleDateString();
}

// Renderizador del Podio High-End
// Renderizador del Podio "Pricing Style"
function renderHighEndPodium(user, rank, meName) {
    const isMe = user.name === meName;
    const nameDisplay = isMe ? 'T√ö' : user.name.split(' ')[0].substring(0, 8).toUpperCase();
    const moneyDisplay = isMe ? `$${user.total.toFixed(0)}` : '???';
    
    const config = {
        1: { 
            grad: 'grad-rank-1', 
            icon: 'military_tech', 
            title: 'L√çDER',
            height: 'h-64 md:h-96', // Menos altura en m√≥vil
            scale: 'scale-105 z-20', 
            barColor: 'bg-[#2d2d2d]',
            msg: 'DOMINANDO'
        },
        2: { 
            grad: 'grad-rank-2', 
            icon: 'lightbulb', 
            title: 'RETADOR',
            height: 'h-56 md:h-80', 
            scale: 'scale-100 z-10',
            barColor: 'bg-[#333333]', 
            msg: 'MUY CERCA'
        },
        3: { 
            grad: 'grad-rank-3', 
            icon: 'favorite', 
            title: '√âLITE',
            height: 'h-56 md:h-80', 
            scale: 'scale-100 z-10',
            barColor: 'bg-[#333333]',
            msg: 'EN EL TOP'
        }
    };
    
    const c = config[rank];
    const borderMe = isMe ? 'border-2 md:border-4 border-blue-500 transform translate-y-[-5px]' : '';

    // ETIQUETA CORREGIDA: Texto en una l√≠nea y m√°s peque√±a
    const topTag = rank === 1 
        ? `<div class="absolute -top-6 left-0 right-0 bg-[#2d2d2d] text-white text-center py-1 text-[8px] md:text-xs font-bold uppercase tracking-widest rounded-t-lg shadow-lg whitespace-nowrap z-30">
             üëë L√çDER ACTUAL
             <div class="triangle-down"></div>
           </div>` 
        : '';

    return `
    <div class="relative flex flex-col ${c.height} flex-1 min-w-[90px] max-w-[180px] pricing-shadow rounded-lg transition-all duration-300 ${c.scale} ${borderMe} bg-white">
        
        ${topTag}

        <!-- 1. CABECERA -->
        <div class="flex-1 ${c.grad} flex flex-col items-center justify-center p-1 text-white rounded-t-lg relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-white/10" style="clip-path: polygon(0 0, 100% 0, 100% 20%, 0 80%);"></div>
            
            <span class="material-symbols-outlined text-4xl md:text-7xl mb-1 drop-shadow-md">${c.icon}</span>
            <h3 class="text-sm md:text-2xl font-black uppercase tracking-tighter leading-none text-center drop-shadow-sm">
                ${c.title}
            </h3>
        </div>

        <!-- 2. BARRA PRECIO -->
        <div class="${c.barColor} py-2 md:py-4 text-center relative z-10">
            <p class="text-xl md:text-4xl font-black text-white tracking-tight leading-none">
                ${moneyDisplay}
            </p>
            <p class="text-[8px] md:text-[10px] text-gray-400 uppercase tracking-widest mt-0.5">Ventas</p>
        </div>

        <!-- 3. CUERPO -->
        <div class="bg-white flex flex-col items-center justify-center py-2 md:py-4 rounded-b-lg gap-1 md:gap-2">
            
            <p class="text-sm md:text-xl font-black text-slate-800 uppercase text-center w-full px-1 leading-tight truncate">
                ${nameDisplay}
            </p>

            <div class="space-y-0.5 md:space-y-1 w-full px-1 opacity-70 flex flex-col items-center">
                <div class="flex items-center gap-1 justify-center">
                    <span class="material-symbols-outlined text-green-500 text-[10px] md:text-sm font-bold">check</span>
                    <span class="text-[8px] md:text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">Activo Hoy</span>
                </div>
                <div class="flex items-center gap-1 justify-center">
                    <span class="material-symbols-outlined text-green-500 text-[10px] md:text-sm font-bold">check</span>
                    <span class="text-[8px] md:text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">${c.msg}</span>
                </div>
            </div>

            <!-- Bot√≥n falso -->
            <div class="mt-1 md:mt-2 w-4/5 h-6 md:h-8 ${c.grad} rounded flex items-center justify-center opacity-80 shadow-sm">
                 <span class="text-white text-[8px] md:text-[10px] font-black uppercase tracking-widest">#${rank} Ranking</span>
            </div>
        </div>
    </div>`;
}

// Funci√≥n auxiliar para renderizar el Podio
function renderPodiumItem(user, rank, meName) {
    const isMe = user.name === meName;
    const nameDisplay = isMe ? 'T√ö' : user.name.substring(0, 3);
    const moneyDisplay = isMe ? `$${user.total.toFixed(0)}` : 'üèÜ'; // Ocultamos dinero ajeno
    
    // Colores y Alturas
    const styles = {
        1: { class: 'rank-1 order-2 w-1/3 z-20', color: 'bg-yellow-400', icon: 'ü•á' },
        2: { class: 'rank-2 order-1 w-1/4 z-10 opacity-90', color: 'bg-gray-400', icon: 'ü•à' },
        3: { class: 'rank-3 order-3 w-1/4 z-10 opacity-90', color: 'bg-orange-400', icon: 'ü•â' }
    };
    
    const s = styles[rank];
    const borderClass = isMe ? 'ring-2 ring-blue-500 ring-offset-2' : '';

    return `
    <div class="podium-card ${s.class} ${borderClass}">
        <div class="absolute -top-6 flex flex-col items-center">
            <div class="avatar-circle ${s.color}">${nameDisplay.substring(0,1)}</div>
            <span class="text-lg drop-shadow-md">${s.icon}</span>
        </div>
        
        <div class="text-center mt-auto pb-2">
            <p class="text-[10px] font-black uppercase text-gray-600 mb-1">${nameDisplay}</p>
            <p class="text-xs font-black text-[#1a4789] bg-white/50 px-2 rounded-full backdrop-blur-sm">
                ${moneyDisplay}
            </p>
        </div>
    </div>`;
}

// Inicializar el Ticker (opcional si quieres que rote autom√°ticamente cada X tiempo sin recargar)
// Nota: La animaci√≥n CSS ya hace el trabajo visual.

// --- NUEVA FUNCI√ìN: RENDERIZAR LISTA DE MIS PEDIDOS ---
// --- FUNCI√ìN ACTUALIZADA: RENDERIZAR LISTA DE MIS PEDIDOS CON WHATSAPP ---
let currentMyOrdersFilter = 'TODOS';



// Variable global para almacenar tus pedidos (aseg√∫rate que esta variable exista al inicio del script)
// let myOrdersData = []; <--- Ya deber√≠a estar declarada arriba en tu c√≥digo

// 1. FUNCI√ìN DE CAMBIO DE FILTRO (Corregida)
function setMyOrdersFilter(status, btn) {
    currentMyOrdersFilter = status;
    
    // Actualizar UI de botones (Tabs)
    document.querySelectorAll('#my-orders-tabs button').forEach(b => {
        b.classList.remove('active', 'bg-[#1a4789]', 'text-white', 'shadow-md');
        b.classList.add('bg-gray-100', 'text-gray-500');
    });
    
    // Activar bot√≥n actual
    btn.classList.remove('bg-gray-100', 'text-gray-500');
    btn.classList.add('active', 'bg-[#1a4789]', 'text-white', 'shadow-md');

    // Re-renderizar usando la variable global 'myOrdersData'
    renderMyOrdersList(myOrdersData); 
}

// 2. FUNCI√ìN DE RENDERIZADO (Con letra GRANDE estilo App)
function renderMyOrdersList(lista) {
    const container = document.getElementById('list-mis-pedidos');
    
    if (!container) return;
    if (!lista) lista = [];

    // L√ìGICA DE FILTRADO
    const filteredByStatus = currentMyOrdersFilter === 'TODOS' 
        ? lista 
        : lista.filter(p => p.estado === currentMyOrdersFilter);

    // 1. CALCULAR CU√ÅNTOS VIENEN POR ENLACE
    const countLinks = filteredByStatus.filter(p => p.origen === 'Enlace Compartido').length;

    // Estado Vac√≠o
    if (filteredByStatus.length === 0) {
        container.innerHTML = `
            <div class="p-8 text-center flex flex-col items-center opacity-50">
                <span class="material-symbols-outlined text-4xl text-gray-300 mb-2">inbox</span>
                <p class="text-sm font-bold text-gray-400">No hay pedidos en esta secci√≥n.</p>
            </div>`;
        return;
    }

    // 2. CREAR EL AVISO PULS√ÅTIL (Solo si hay pedidos por enlace)
    let headerHTML = '';
    if (countLinks > 0) {
        headerHTML = `
        <div class="mb-4 bg-red-500 text-white p-2 rounded-xl flex items-center justify-center gap-2 animate-pulse shadow-lg shadow-red-500/30">
            <span class="material-symbols-outlined text-lg">link</span>
            <span class="text-xs font-black uppercase tracking-widest">¬°ATENCI√ìN! ${countLinks} PEDIDOS POR ENLACE</span>
        </div>`;
    }

    // 3. RENDERIZADO DE TARJETAS
    const cardsHTML = filteredByStatus.map(p => {
        // A. Detectar si es por Enlace para cambiar el color de fondo
        const esPorEnlace = p.origen === 'Enlace Compartido';
        
        // Si es enlace: Fondo Rojo Suave + Borde Rojo. Si no: Blanco normal.
        const cardStyle = esPorEnlace 
            ? 'bg-red-50 border border-red-200 shadow-sm' 
            : 'bg-white border border-gray-200 shadow-sm';

        // B. Estilos de Estado del Pedido
        let estadoStyle = 'bg-gray-100 text-gray-600';
        if(p.estado === 'Pendiente') estadoStyle = 'bg-amber-50 text-amber-600 border border-amber-100';
        if(p.estado === 'Asignado Mensajero') estadoStyle = 'bg-blue-50 text-blue-600 border border-blue-100';
        if(p.estado === 'Entregado') estadoStyle = 'bg-emerald-50 text-emerald-600 border border-emerald-100';
        
        // C. Datos b√°sicos
        const fechaDoc = new Date(p.fecha).toLocaleDateString();
        const primerNombre = p.cliente.split(' ')[0];
        const msjWA = `Hola ${primerNombre}, le escribo de paratuhogar por su pedido...`;
        const urlWA = `https://wa.me/${p.telefono.replace(/\D/g,'')}?text=${encodeURIComponent(msjWA)}`;

        // D. BADGE DE ORIGEN (El de enlace ahora es ROJO para combinar)
        let sourceBadge = '';
        if (esPorEnlace) {
            sourceBadge = `<span class="flex items-center gap-1 text-[9px] font-black uppercase text-red-600 bg-white px-1.5 py-0.5 rounded border border-red-200 ml-2 shadow-sm" title="Venta Autom√°tica"><span class="material-symbols-outlined text-[10px]">link</span> Enlace</span>`;
        } else if (p.origen === 'Manual (Panel)') {
            sourceBadge = `<span class="flex items-center gap-1 text-[9px] font-black uppercase text-orange-600 bg-orange-50 px-1.5 py-0.5 rounded border border-orange-100 ml-2" title="Venta Manual"><span class="material-symbols-outlined text-[10px]">edit_note</span> Manual</span>`;
        } else {
            sourceBadge = `<span class="flex items-center gap-1 text-[9px] font-black uppercase text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100 ml-2"><span class="material-symbols-outlined text-[10px]">language</span> Web</span>`;
        }

        return `
        <div class="p-3 rounded-xl mb-3 relative transition-all hover:shadow-md group ${cardStyle}">
            
            <!-- CABECERA -->
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center">
                    <span class="text-[10px] font-bold text-gray-400">${fechaDoc}</span>
                    ${sourceBadge}
                </div>
                
                <!-- BOTONES -->
                <div class="flex items-center gap-2">
                    <a href="${urlWA}" target="_blank" title="WhatsApp"
                       class="h-7 w-7 bg-[#25D366] text-white rounded-full flex items-center justify-center hover:scale-110 transition-transform shadow-sm">
                        <i class="fab fa-whatsapp text-sm"></i>
                    </a>
                    
                    <button onclick="prepararPDFDesdeHistorial('${p.id}', 'descargar')" title="PDF"
                        class="h-7 w-7 bg-red-50 text-red-500 border border-red-100 rounded-full flex items-center justify-center hover:bg-red-500 hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-sm">download</span>
                    </button>

                    <button onclick="prepararPDFDesdeHistorial('${p.id}', 'compartir')" title="Compartir"
                        class="h-7 w-7 bg-blue-50 text-blue-500 border border-blue-100 rounded-full flex items-center justify-center hover:bg-blue-500 hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-sm">share</span>
                    </button>
                </div>
            </div>

            <!-- CUERPO COMPACTO -->
            <div class="flex justify-between items-end gap-2">
                <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-black text-slate-700 uppercase truncate leading-tight mb-0.5" title="${p.cliente}">${p.cliente}</h4>
                    <p class="text-[10px] text-gray-400 truncate mb-2">${p.producto}</p>
                    
                    <span class="px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-wide ${estadoStyle}">
                        ${p.estado}
                    </span>
                </div>

                <!-- PRECIO -->
                <div class="text-right flex-shrink-0">
                    <p class="text-[10px] font-bold text-slate-400 mb-0.5">$${Number(p.total || 0).toFixed(0)}</p>
                    <p class="text-sm font-black text-emerald-600 whitespace-nowrap">+$${Number(p.comision_total).toFixed(2)}</p>
                </div>
            </div>
        </div>`;
    }).join('');

    // Insertar HEADER + TARJETAS
    container.innerHTML = headerHTML + cardsHTML;
}

    async function injectLinksSection(nombre) {
    if(document.getElementById('sec-links-gestor')) document.getElementById('sec-links-gestor').remove();

    const userData = window.currentUserData || {};
    const baseUrl = window.location.origin + window.location.pathname;
    
    // --- BYPASS MODO DIOS (Marcel siempre Nivel 5) ---
    let sales = 0;
    if (nombre === "Marcel Montano") {
        sales = 80; 
    } else {
        const today = new Date();
        today.setDate(today.getDate() - 30);
        const { count } = await supabaseClient
            .from('pedidos')
            .select('*', { count: 'exact', head: true })
            .eq('gestor', nombre)
            .eq('estado', 'Entregado')
            .gte('created_at', today.toISOString());
        sales = count || 0;
    }

    window.gestorSalesCount = sales;
    const lvlData = getLevelData(sales);
    const diasDuracion = lvlData.duration / 24;

    const myLongLink = `${baseUrl}?gestor=${encodeURIComponent(nombre)}&tel=${userData.telefono || ''}`;
    
    // ESTA ES LA VARIABLE QUE VAMOS A MOSTRAR
    let linkParaMostrar = myLongLink; 

    // --- GENERACI√ìN DEL LINK CORTO ---
    try {
        // Buscamos si ya existe
        const { data: linkData } = await supabaseClient
            .from('short_links')
            .select('slug')
            .eq('gestor', nombre)
            .eq('original_url', myLongLink)
            .maybeSingle();

        if (linkData) {
            // SI EXISTE: Actualizamos la variable con el link corto
            linkParaMostrar = `${window.location.origin}${window.location.pathname}?s=${linkData.slug}`;
        } else {
            // SI NO EXISTE: Creamos uno nuevo
            const newSlug = Math.random().toString(36).substring(2, 7);
            const { error: insError } = await supabaseClient.from('short_links').insert([{
                slug: newSlug,
                original_url: myLongLink,
                gestor: nombre
            }]);
            
            if (!insError) {
                linkParaMostrar = `${window.location.origin}${window.location.pathname}?s=${newSlug}`;
            }
        }
    } catch (e) {
        console.error("Error obteniendo link corto:", e);
    }

    const html = `
    <div id="sec-links-gestor" class="bg-white dark:bg-gray-800 p-6 rounded-3xl border border-gray-100 shadow-sm mt-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-sm font-black uppercase text-primary italic">üîó Mi Enlace Inteligente</h3>
            <span class="text-[10px] font-bold text-emerald-500 uppercase">
                ‚ö° LINK CORTO PRO ACTIVO
            </span>
        </div>
        <p class="text-xs text-gray-400 mb-4">
            Este enlace guarda tu comisi√≥n por <span class="font-black text-primary">${diasDuracion} d√≠as</span> en el navegador del cliente.
        </p>
        
        <div class="flex gap-2 mb-4">
            <!-- AQU√ç USAMOS LA VARIABLE linkParaMostrar -->
            <input type="text" id="my-link-input" value="${linkParaMostrar}" readonly class="w-full bg-gray-50 dark:bg-gray-900 text-xs p-3 rounded-xl border-none font-bold text-gray-500">
            <button onclick="copy('my-link-input')" class="bg-primary text-white px-4 rounded-xl font-bold text-xs uppercase">Copiar</button>
        </div>
        
        <div class="grid grid-cols-2 gap-2">
            <button onclick="window.open('https://wa.me/?text=${encodeURIComponent('Cat√°logo: ' + linkParaMostrar)}')" class="py-3 bg-[#25D366] text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2">
                <i class="fab fa-whatsapp"></i> WhatsApp
            </button>
            <button onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(linkParaMostrar)}')" class="py-3 bg-[#1877F2] text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2">
                <i class="fab fa-facebook"></i> Facebook
            </button>
        </div>
    </div>`;
    
    const rankingDiv = document.getElementById('ranking-list').parentElement;
    if(rankingDiv) rankingDiv.insertAdjacentHTML('afterend', html);
}



    // 2. CARGA DE PRODUCTOS
    // 2. CARGA DE PRODUCTOS Y CATEGOR√çAS AUTOM√ÅTICAS
// --- FUNCI√ìN MAESTRA DE CARGA Y FUSI√ìN DE PRECIOS ---
async function loadProducts() {
    const urlParams = new URLSearchParams(window.location.search);
    const slug = urlParams.get('s');
    let urlGestor = urlParams.get('gestor'); // Gestor en URL (Cliente)
    const sessionGestor = window.gestorName; // Gestor Logueado (T√∫)

    // 1. Prioridad de Gestor: Si estoy logueado soy yo, si no, es el de la URL
    const activeGestor = sessionGestor || urlGestor;

    // --- LOGICA LINK CORTO (Mantenida) ---
    if (slug) {
        const { data } = await supabaseClient.from('short_links').select('original_url, gestor').eq('slug', slug).single();
        if (data) {
            await registrarRastroIP(data.gestor);
            window.location.href = data.original_url;
            return;
        }
    }
    if (urlGestor) await registrarRastroIP(urlGestor);

    // --- CARGA DE DATOS ---
    try {
        // A. Cargar Productos Base
        const { data: productos, error } = await supabaseClient
            .from('productos')
            .select('*')
            .order('nombre', { ascending: true });

        if (error) throw error;
        productosRaw = productos; // Guardamos copia original cruda

        // B. FUSI√ìN DE PRECIOS (LA MAGIA)
        if (activeGestor) {
            // Buscamos si este gestor tiene precios personalizados
            const { data: preciosCustom } = await supabaseClient
                .from('precios_personalizados')
                .select('producto_id, nuevo_precio')
                .eq('gestor', activeGestor);

            if (preciosCustom && preciosCustom.length > 0) {
                // Recorremos los productos y aplicamos la m√°scara
                productosRaw.forEach(p => {
                    const custom = preciosCustom.find(c => c.producto_id === p.id);
                    if (custom) {
                        const precioBase = parseFloat(p.precio);
                        const precioNuevo = parseFloat(custom.nuevo_precio);
                        
                        // Solo aplicamos si el nuevo es mayor (seguridad)
                        if (precioNuevo >= precioBase) {
                            // 1. Calculamos la ganancia extra
                            const extra = precioNuevo - precioBase;
                            
                            // 2. SOBRESCRIBIMOS EN MEMORIA (El cliente ve esto)
                            p.precio = precioNuevo; 
                            
                            // 3. SUMAMOS A LA COMISI√ìN (El sistema sabe cu√°nto pagarte)
                            p.comision = (parseFloat(p.comision) + extra).toFixed(2);
                            
                            // Marca interna para saber que est√° modificado
                            p.is_custom = true; 
                        }
                    }
                });
                console.log("‚úÖ Precios personalizados aplicados para: " + activeGestor);
            }
        }

        // --- RENDERIZADO FINAL ---
        renderCategories();
        renderProducts();
        
        // Si estoy logueado, cargo mi configurador de precios
        if (sessionGestor) {
            renderGestorPricing(); // Funci√≥n nueva (ver abajo)
        }

        // Abrir producto si viene en URL
        const searchParam = urlParams.get('search');
        if (searchParam) {
            const existe = productosRaw.find(p => p.nombre === searchParam);
            if (existe) setTimeout(() => { openDetail(searchParam); }, 500);
        }

    } catch (e) { 
        console.error("Error cargando cat√°logo:", e);
        document.getElementById('productos-container').innerHTML = `<div class="col-span-full py-10 text-center text-gray-400">Error de conexi√≥n.</div>`;
    }
}

// --- FUNCIONES DE APOYO PARA EL RASTREO IP ---

async function registrarRastroIP(nombreGestor) {
    try {
        const res = await fetch('https://api.ipify.org?format=json');
        const { ip } = await res.json();
        
        // 1. Definir un tiempo de "bloqueo" (ej: 30 minutos)
        const hace30Minutos = new Date(Date.now() - 30 * 60 * 1000).toISOString();

        // 2. Consultar si ya existe un registro reciente para esta IP y este Gestor
        const { data: existente } = await supabaseClient
            .from('link_analytics')
            .select('id')
            .eq('agent_name', nombreGestor)
            .eq('ip_address', ip)
            .gte('timestamp', hace30Minutos)
            .limit(1);

        // 3. SOLO insertar si no hay registros recientes
        if (!existente || existente.length === 0) {
            const ua = navigator.userAgent;
            await supabaseClient.from('link_analytics').insert([{
                agent_name: nombreGestor,
                ip_address: ip,
                device_type: /Mobi|Android/i.test(ua) ? 'M√≥vil' : 'Escritorio',
                os: ua.includes("Win") ? "Windows" : ua.includes("Mac") ? "MacOS" : "M√≥vil",
                browser: ua.includes("Chrome") ? "Chrome" : ua.includes("Firefox") ? "Firefox" : "Safari"
            }]);
            console.log("üìç Rastro de IP registrado.");
        } else {
            console.log("‚è© IP ya registrada recientemente, saltando insert para evitar duplicados.");
        }
    } catch (e) { console.error("Error en rastro IP:", e); }
}

async function buscarDuenoPorIP() {
    try {
        const res = await fetch('https://api.ipify.org?format=json');
        const { ip } = await res.json();
        
        // Buscamos el √∫ltimo rastro dejado por esta IP en las √∫ltimas 48 horas
        const hace48Horas = new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString();

        const { data } = await supabaseClient
            .from('link_analytics')
            .select('agent_name')
            .eq('ip_address', ip)
            .gte('timestamp', hace48Horas)
            .order('timestamp', { ascending: false })
            .limit(1)
            .single();
            
        return data ? data.agent_name : null;
    } catch (e) { return null; }
}

function prepararPDFDesdeHistorial(pedidoId, accion) {
    const p = myOrdersData.find(item => item.id === pedidoId);
    if (!p) return alert("Error: No se encontr√≥ el registro del pedido.");

    // 1. Extraer el nombre limpio del producto
    let nombreLimpio = p.producto.split('[')[0].replace(/^\d+x\s+/, '').trim();
    
    // 2. Extraer cantidades si existen (ej: "2x Arrocera")
    let cantidad = 1;
    const qtyMatch = p.producto.match(/^(\d+)x/);
    if(qtyMatch) cantidad = parseInt(qtyMatch[1]);

    // 3. C√°lculo de precios para el desglose
    const totalVenta = Number(p.total);
    const mensajeria = Number(p.costo_mensajeria || 0);
    const precioUnitario = (totalVenta - mensajeria) / cantidad;

    const datosParaPDF = {
        cliente: p.cliente,
        ci: p.ci || "---",
        direccion: p.direccion,
        totalUSD: totalVenta,
        mensajeria: mensajeria,
        items: [{
            nombre: nombreLimpio,
            qty: cantidad,
            price: precioUnitario,
            total: totalVenta - mensajeria
        }]
    };

    generarComprobanteVenta(datosParaPDF, accion);
}

    // NUEVA FUNCI√ìN: DIBUJAR PESTA√ëAS DE CATEGOR√çA
    function renderCategories() {
        // 1. Extraer categor√≠as √∫nicas de la base de datos
        // Convertimos a May√∫sculas para evitar duplicados tipo "Cocina" vs "cocina"
        const uniqueCats = [...new Set(productosRaw.map(p => p.categoria ? p.categoria.toUpperCase().trim() : 'VARIOS'))].sort();
        
        // 2. Crear lista con "TODOS" al principio
        const allCats = ['TODOS', ...uniqueCats];
        
        const container = document.getElementById('category-list');
        container.innerHTML = allCats.map(cat => {
            // Estilo activo o inactivo
            const isActive = activeCategory === cat;
            const styleClass = isActive 
                ? "category-tab active py-4 text-sm font-black border-b-4 border-primary text-primary transition-all px-2" 
                : "category-tab py-4 text-sm font-bold text-gray-400 hover:text-primary transition-all px-2 border-b-4 border-transparent hover:border-gray-200";
                
            return `<button onclick="filterByCategory('${cat}')" class="${styleClass}">${cat}</button>`;
        }).join('');
    }

    function renderProducts() {
    // 1. OBTENCI√ìN SEGURA DE ELEMENTOS
    const searchInput = document.getElementById('search-bar');
    const container = document.getElementById('productos-container');
    
    // Si por alguna raz√≥n el HTML no ha cargado, salimos para no dar error
    if (!searchInput || !container) return;

    const query = searchInput.value.toLowerCase();
    
    // 2. VARIABLES DE ESTADO
    const isGestor = window.gestorName ? true : false;
    const filterCheckbox = document.getElementById('filter-high-comm');
    const filterHighComm = filterCheckbox ? filterCheckbox.checked : false;
    
    // 3. FILTRADO
    const filtered = productosRaw.filter(p => {
        const matchSearch = p.nombre.toLowerCase().includes(query);
        const matchCat = activeCategory === 'TODOS' || (p.categoria && p.categoria.toUpperCase().includes(activeCategory));
        
        // L√≥gica del filtro "Tibur√≥n" (Ganancia > 10)
        const matchComm = !filterHighComm || (Number(p.comision || 0) > 10);

        return matchSearch && matchCat && matchComm && p.disponible === "SI";
    });

    // 4. ESTADO VAC√çO
    if (filtered.length === 0) {
        container.innerHTML = `<div class="col-span-full py-20 text-center text-gray-400 font-bold">No se encontraron equipos.</div>`;
        return;
    }

    // 5. RENDERIZADO DE TARJETAS
    container.innerHTML = filtered.map(p => {
        const precio = parseFloat(p.precio) || 0;
        
        // --- INICIO: NUEVA L√ìGICA DE PRECIOS INTELIGENTE ---
        let pDisplay = `$${precio}`; // Valor por defecto (USD)

        if (showInCUP) {
            // Usamos la funci√≥n inteligente que lee "p.pagos" y calcula seg√∫n si es fijo, +10 o tasa d√≠a
            // Nota: Aseg√∫rate de haber pegado la funci√≥n calculateProductCUP() en tu c√≥digo antes
            const precioCUP = calculateProductCUP(precio, p.pagos);
            
            if (precioCUP) {
                // Formateamos con comas (ej: 15,400)
                pDisplay = `CUP ${precioCUP.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            } else {
                // Si el producto no acepta CUP (la funci√≥n devolvi√≥ null)
                pDisplay = "<span class='text-sm text-gray-400'>Solo USD/EUR</span>";
            }
        }
        // --- FIN: NUEVA L√ìGICA ---
        
        // Etiqueta de Comisi√≥n + Indicador de Precio Flexible
        let htmlComision = isGestor ? 
            `<div class="absolute top-2 right-2 flex flex-col items-end gap-1 z-10">
                <span class="bg-emerald-500 text-white text-[10px] font-black px-2 py-1 rounded-lg shadow-md">GANAS $${p.comision || 0}</span>
                ${p.precio_flexible === 'SI' ? '<span class="bg-blue-600 text-white text-[9px] font-bold px-2 py-1 rounded-lg shadow-md border border-white">üìà PRECIO LIBRE</span>' : ''}
             </div>` : '';

        return `
        <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden border border-slate-100 dark:border-gray-700 group shadow-sm hover:shadow-xl transition-all duration-300 relative flex flex-col">
            ${htmlComision}
            
            <!-- Imagen Clickable -->
            <div onclick="openDetail('${p.nombre.replace(/'/g, "\\'")}')" class="w-full aspect-square bg-slate-50 dark:bg-gray-900 p-4 relative overflow-hidden cursor-pointer">
                <div class="absolute inset-0 bg-center bg-no-repeat bg-contain transition-transform group-hover:scale-110 duration-500" style="background-image: url('${fixDriveUrl(p.thumbnail)}');"></div>
            </div>

            <!-- Info -->
            <div class="p-5 flex flex-col gap-2 flex-1">
                <h3 class="text-slate-800 dark:text-white text-sm font-bold leading-snug line-clamp-2 min-h-[2.5rem]">${p.nombre}</h3>
                <p class="text-primary text-2xl font-black">${pDisplay}</p>
                
                <button onclick="openDetail('${p.nombre.replace(/'/g, "\\'")}')" class="mt-auto w-full flex items-center justify-center gap-2 bg-primary text-white py-2.5 rounded-lg text-xs font-extrabold hover:bg-secondary transition-colors shadow-md">
                    Ver Detalles
                </button>
            </div>

            <!-- BARRA SOCIAL -->
            <div class="grid grid-cols-2 border-t border-gray-100 dark:border-gray-700 divide-x divide-gray-100 dark:divide-gray-700 bg-gray-50 dark:bg-gray-900/50">
                <button onclick="shareProductSocial('${p.nombre.replace(/'/g, "\\'")}', 'wa')" class="py-3 flex items-center justify-center gap-1 text-gray-400 hover:text-green-500 hover:bg-green-50 transition-all">
                    <i class="fab fa-whatsapp text-lg"></i> <span class="text-[9px] font-bold uppercase">Estado</span>
                </button>
                <button onclick="shareProductSocial('${p.nombre.replace(/'/g, "\\'")}', 'fb')" class="py-3 flex items-center justify-center gap-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition-all">
                    <i class="fab fa-facebook text-lg"></i> <span class="text-[9px] font-bold uppercase">Post</span>
                </button>
            </div>
        </div>`;
    }).join('');
}

    // 3. DETALLE DE PRODUCTO
    // 3. DETALLE DE PRODUCTO
 function openDetail(name) {
    // Esto convierte el &quot; de nuevo en " para poder buscarlo en la lista de productos
    const nombreReal = name.replace(/&quot;/g, '"');
    selectedProduct = productosRaw.find(p => p.nombre === nombreReal);
    
    if(!selectedProduct) return; 
    const p = selectedProduct;

    // 2. Registrar vista para anal√≠tica
    if (typeof registrarVistaAnalitica === "function") {
        registrarVistaAnalitica(p); 
    }

    // 3. Llenar textos b√°sicos
    document.getElementById('detail-name').innerText = p.nombre;
    document.getElementById('detail-desc').innerHTML = p.descripcion || ''; 

    // 4. Badge de Ganancia (Solo Admin)
    const oldBadge = document.getElementById('admin-comm-badge');
    if(oldBadge) oldBadge.remove();
    
    if(typeof isAdmin !== 'undefined' && isAdmin) {
        const badge = `<div id="admin-comm-badge" class="bg-emerald-500 text-white px-3 py-2 rounded-xl font-black text-[11px] mb-4 flex justify-between items-center shadow-lg shadow-emerald-500/20 uppercase italic">
            <span>Ganancia de Agente:</span>
            <span>$${p.comision || 0}.00</span>
        </div>`;
        document.getElementById('detail-name').insertAdjacentHTML('beforebegin', badge);
    }

    // 5. PRECIOS (Calculadora inteligente)
    document.getElementById('detail-price').innerText = `$${p.precio}.00 USD`;
    
    const precioCUP = typeof calculateProductCUP === "function" ? calculateProductCUP(p.precio, p.pagos) : null;
    const labelCUP = document.getElementById('detail-price-cup');

    if (precioCUP) {
        labelCUP.innerText = `/ CUP ${precioCUP.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
        labelCUP.classList.remove('text-red-500', 'text-xs', 'font-bold', 'uppercase');
        labelCUP.classList.add('text-gray-400', 'text-lg');
    } else {
        labelCUP.innerText = " (Solo USD/EUR)";
        labelCUP.classList.remove('text-gray-400', 'text-lg');
        labelCUP.classList.add('text-red-500', 'text-xs', 'font-bold', 'uppercase');
    }

    // 6. Otros detalles
    document.getElementById('detail-cat').innerText = p.categoria || '';
    document.getElementById('detail-warranty').innerText = p.garantia || '1 Mes';
    document.getElementById('detail-shipping').innerText = p.mensajeria || 'Consultar';
    
    // 7. Im√°genes
    document.getElementById('detail-main-img').src = fixDriveUrl(p.thumbnail);
    
    const thumbs = [p.thumbnail, p.image1, p.image2, p.image3].filter(url => url && url.length > 5);
    document.getElementById('detail-thumbnails').innerHTML = thumbs.map(url => `
        <img src="${fixDriveUrl(url)}" onclick="document.getElementById('detail-main-img').src=this.src" class="w-12 h-12 object-contain rounded-lg border border-gray-100 bg-white p-1 cursor-pointer hover:border-primary transition-colors">
    `).join('');

    // --- 8. L√ìGICA DE BLOQUEO DE STORY MAKER ---
    const btnStory = document.getElementById('btn-story-maker');
    const currentLevel = window.currentGestorLevel || 0;

    if (btnStory) {
        if (currentLevel < 1) {
            btnStory.onclick = () => alert("üîí BLOQUEADO: Story Maker\n\nNecesitas Nivel 1 (3 ventas) para crear dise√±os autom√°ticos.");
            btnStory.className = "flex-1 py-3 bg-gray-100 text-gray-400 border border-gray-200 rounded-xl font-bold text-[10px] uppercase flex flex-col items-center justify-center cursor-not-allowed gap-1";
            btnStory.innerHTML = `<span class="material-symbols-outlined text-xl">lock</span>Story Bloqueado`;
        } else {
            btnStory.onclick = generateStoryImage;
            btnStory.className = "flex-1 py-3 bg-gradient-to-br from-pink-500 to-orange-400 text-white border-none rounded-xl font-bold text-[10px] uppercase flex flex-col items-center justify-center hover:opacity-90 transition-all gap-1 shadow-lg shadow-pink-500/20 cursor-pointer";
            btnStory.innerHTML = `<span class="material-symbols-outlined text-xl">fit_screen</span>Crear Story`;
        }
    }

    // === NUEVA L√ìGICA DE VISIBILIDAD (A√ëADE ESTO) ===
    const session = localStorage.getItem('pth_session');
    const toolsContainer = document.getElementById('marketing-tools-container');
    if (toolsContainer) {
        if (session) {
            toolsContainer.classList.remove('hidden'); // Marcel lo ve
        } else {
            toolsContainer.classList.add('hidden');    // El cliente no lo ve
        }
    }
    // ===============================================

    // 9. Mostrar Modal
    document.getElementById('detail-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

    // 4. CARRITO Y PAGOS
    function addItemToCart() {
    const existing = cart.find(item => item.nombre === selectedProduct.nombre);
    
    // Detectamos si el producto tra√≠a un costo de mensajer√≠a por defecto en la BD
    // Si dice "Gratis" o texto, ponemos 0. Si tiene n√∫mero, ponemos ese n√∫mero.
    let defaultShipping = 0;
    if(selectedProduct.mensajeria && !isNaN(parseFloat(selectedProduct.mensajeria))) {
        defaultShipping = parseFloat(selectedProduct.mensajeria);
    }

    if(existing) {
        existing.qty++;
        // Al aumentar cantidad, sumamos otro costo de env√≠o base
        existing.shipping_linea += defaultShipping; 
    } else {
        cart.push({
            ...selectedProduct, 
            qty: 1,
            precio_venta: Number(selectedProduct.precio),
            comision_actual: Number(selectedProduct.comision || 0),
            shipping_linea: defaultShipping // NUEVO CAMPO: Env√≠o espec√≠fico para esta l√≠nea
        });
    }
    
    document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0);
    closeDetail();         
    toggleCartModal(true); 

    setTimeout(() => {
        const crmSearch = document.getElementById('crm-search');
        if(crmSearch) crmSearch.focus();
    }, 100);
}

// --- A√ëADE ESTA FUNCI√ìN NUEVA DEBAJO DE addItemToCart ---
function updateLineShipping(index, value) {
    const val = parseFloat(value);
    if(isNaN(val) || val < 0) return;
    cart[index].shipping_linea = val;
    recalcularTotalFinal(); // Actualiza los totales visuales
}

function renderCart() {
    const container = document.getElementById('cart-items');
    const isGestor = window.gestorName ? true : false;

    // 1. Renderizar Productos con INPUT DE MENSAJER√çA INDIVIDUAL
    let htmlItems = cart.map((item, index) => {
        const minPrice = Number(item.precio) - Number(item.comision);
        const maxPrice = (item.precio_flexible === 'SI') ? 100000 : Number(item.precio);
        
        // Input de Precio del Equipo
        const precioInput = isGestor ? 
            `<input type="number" value="${item.precio_venta}" min="${minPrice}" max="${maxPrice}" 
                   onchange="updateCartItemPrice(${index}, this.value)"
                   class="w-20 text-right font-black text-primary border-gray-200 rounded-lg py-0 px-1 text-xs h-6 mb-1">` 
            : `<p class="text-primary font-black text-sm mb-1">$${item.precio_venta}</p>`;

        // Input de Mensajer√≠a (AHORA EN CADA √çTEM)
        const shippingInput = `
            <div class="flex items-center justify-end gap-1 mt-1">
                <span class="text-[9px] font-bold text-gray-400 uppercase">üöö Env√≠o:</span>
                <input type="number" value="${item.shipping_linea}" min="0" 
                       onchange="updateLineShipping(${index}, this.value)"
                       class="w-16 text-right font-bold text-slate-600 border-gray-200 bg-gray-50 rounded py-0 px-1 text-[10px] h-6 focus:bg-white focus:border-primary">
            </div>
        `;

        let colorGanancia = "text-emerald-500";
        if(item.comision_actual < item.comision) colorGanancia = "text-orange-500";
        if(item.comision_actual > item.comision) colorGanancia = "text-blue-600";

        const gananciaDisplay = isGestor ?
            `<p class="text-[9px] font-bold ${colorGanancia} text-right">
                Gan: $${(item.comision_actual * item.qty).toFixed(0)}
             </p>` : '';

        return `
        <div class="flex gap-2 bg-white dark:bg-gray-800 p-3 rounded-xl relative border border-gray-100 dark:border-gray-700 mb-3 shadow-sm">
            <img src="${fixDriveUrl(item.thumbnail)}" class="w-16 h-16 object-contain bg-gray-50 rounded border border-gray-200">
            <div class="flex-1 min-w-0">
                <div class="flex justify-between items-start">
                    <h4 class="text-xs font-bold leading-tight pr-6 mb-1 truncate w-full" title="${item.nombre}">${item.nombre}</h4>
                    <button onclick="removeFromCart(${index})" class="text-gray-300 hover:text-red-500 p-0.5"><span class="material-symbols-outlined text-sm">close</span></button>
                </div>
                
                <div class="flex justify-between items-end mt-1">
                    <!-- Control Cantidad -->
                    <div class="flex items-center gap-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 px-1 h-6">
                        <button onclick="changeQty(${index}, -1)" class="w-5 flex items-center justify-center text-gray-500 font-bold text-xs">-</button>
                        <span class="text-xs font-black min-w-[15px] text-center">${item.qty}</span>
                        <button onclick="changeQty(${index}, 1)" class="w-5 flex items-center justify-center text-gray-500 font-bold text-xs">+</button>
                    </div>

                    <!-- Columna Precios -->
                    <div class="flex flex-col items-end">
                        <div class="flex flex-col items-end">
                           <label class="text-[8px] text-gray-400 font-bold uppercase">Precio Unit.</label>
                           ${precioInput}
                        </div>
                        ${shippingInput}
                        ${gananciaDisplay}
                    </div>
                </div>
            </div>
        </div>`;
    }).join('');

    // Ya no hay input global de env√≠o al final
    container.innerHTML = htmlItems;
    recalcularTotalFinal(); // Importante llamar esto para actualizar el total abajo
    actualizarOpcionesMoneda(); 
}

// Funci√≥n para sumar o restar cantidad
function changeQty(index, delta) {
    const item = cart[index];
    item.qty += delta;
    
    // Si baja de 1, preguntar si eliminar
    if (item.qty < 1) {
        if(confirm("¬øEliminar este producto?")) {
            cart.splice(index, 1);
        } else {
            item.qty = 1; // Restaurar a 1 si dice que no
        }
    }
    
    // Actualizar contador rojo
    document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0);
    
    // Volver a dibujar el carrito
    renderCart();
}

    function recalcularTotalFinal() {
    const select = document.getElementById('check-moneda');
    
    // Sumamos (Precio Venta * Cantidad) + (Env√≠o de esa L√≠nea)
    // Nota: shipping_linea ya es el total para esa l√≠nea (ej: si son 2 TVs y env√≠o es 20, shipping_linea es 20)
    const totalUSD = cart.reduce((acc, item) => {
        return acc + (item.precio_venta * item.qty) + (parseFloat(item.shipping_linea) || 0);
    }, 0);

    const opcionElegida = select.value || "USD";
    let totalFinal = totalUSD;
    let simbolo = "$";

    if (opcionElegida.toUpperCase().includes("CUP")) {
        let tasaFinal = globalCUPRate || 450;
        if (opcionElegida.includes("+")) {
            const incremento = parseFloat(opcionElegida.match(/\d+/) || 0);
            tasaFinal = tasaFinal + incremento;
        } else {
            const tasaFijaMatch = opcionElegida.match(/(\d{3,})/);
            if(tasaFijaMatch) tasaFinal = parseFloat(tasaFijaMatch[0]);
        }
        totalFinal = totalUSD * tasaFinal;
        simbolo = "CUP";
    }

    document.getElementById('cart-total').innerText = `$${totalUSD.toFixed(2)} USD`;
    document.getElementById('total-convertido').innerText = `${simbolo} ${totalFinal.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
}

    function actualizarOpcionesMoneda() {
        const select = document.getElementById('check-moneda');
        if (!select || cart.length === 0) return;
        const pagosTexto = cart[0].pagos || "USD, CUP +10, Zelle";
        const opciones = pagosTexto.split(',').map(opt => opt.trim());
        select.innerHTML = opciones.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        select.onchange = recalcularTotalFinal;
        recalcularTotalFinal();
    }

    // 5. ENV√çO DE PEDIDO (FORMATO EXACTO FOTO CON BRAZOS üí™)
// 5. ENV√çO DE PEDIDO (L√≥gica de visibilidad Gestor vs Cliente)
document.getElementById('checkout-form').onsubmit = async function(e) {
    e.preventDefault();
    const btn = document.getElementById('final-submit-btn');
    btn.disabled = true; 
    btn.innerText = "PROCESANDO PEDIDO..."; // Cambio de texto para feedback

    const session = localStorage.getItem('pth_session');
    const isLogged = !!session;

    const nombreC = document.getElementById('check-nombre').value;
    const municipioC = document.getElementById('check-municipio').value; // NUEVO
    const ciC = document.getElementById('check-ci').value || "No especificado";
    const telC = document.getElementById('check-tel').value;
    const dirC = document.getElementById('check-dir').value;
    const monedaC = document.getElementById('check-moneda').value;
    const valVuelto = document.getElementById('check-vuelto').value;
    const vueltoC = (valVuelto && valVuelto > 0) ? `${valVuelto}` : "no";

    // 1. DETERMINAR QUI√âN ES EL GESTOR (Tu l√≥gica original)
    let activeGestor = "Venta Directa";
    if (window.gestorName) {
        activeGestor = window.gestorName;
    } else {
        const duenoEterno = await checkCustomerOwnership(telC);
        if (duenoEterno) {
            activeGestor = duenoEterno;
        } else {
            const referido = await getActiveReferrer();
            if (referido) activeGestor = referido.nombre;
        }
    }

    // 2. LOGICA DE BINDEO (Tu l√≥gica original)
    const levelData = getLevelData(window.gestorSalesCount || 0);
    if (levelData.lvl >= 5 && activeGestor !== "Venta Directa") {
        try {
            await supabaseClient.from('customer_bindings').upsert({
                phone: telC.replace(/\D/g, ''), 
                agent_name: activeGestor
            });
        } catch (err) { console.error("Error en bindeo:", err); }
    }
    // === L√ìGICA DE DETECCI√ìN DE ORIGEN ===
    let origenPedido = "Directo/Web"; // Valor por defecto si falla todo

    if (isLogged) {
        origenPedido = "Manual (Panel)";
    } else {
        // Buscamos en la memoria lo que guardamos en el Paso 1
        const referrerSmart = localStorage.getItem('pth_referrer_smart');
        const referrerSimple = localStorage.getItem('pth_referrer');
        
        if (referrerSmart || referrerSimple) {
            origenPedido = "Enlace Compartido";
        }
    }
    // =====================================

    // 1. INICIALIZAR MENSAJE WHATSAPP (Con Brazo Fuerte üí™)
    let mensajeRaw = `üí™ *NUEVO PEDIDO CONFIRMADO* üí™\n\n`;
    let erroresInsert = false;
    
    // Promesas para guardar en BD
    const promesas = [];

    // 2. ITERAR SOBRE EL CARRITO (UN PEDIDO POR TIPO DE PRODUCTO)
    for (const item of cart) {
        const prov = item.proveedor || 'General';
        
        // A. Consultar Consecutivo
        const ahora = new Date();
        const inicioHoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate()).toISOString();
        
        // Nota: Esto es as√≠ncrono dentro de un loop, lo ideal es usar for..of con await
        // Para simplificar y asegurar el orden, haremos el await aqu√≠.
        const { count, error: errCount } = await supabaseClient
            .from('pedidos')
            .select('id', { count: 'exact', head: true })
            .eq('proveedor', prov)
            .gte('fecha', inicioHoy); 

        const nroConsecutivo = (errCount ? 0 : (count || 0)) + 1;
        const codPedido = `${prov}-${nroConsecutivo}`; 

        // Datos Financieros del √çtem
        const costoEquipo = item.precio_venta * item.qty;
        const costoEnvio = parseFloat(item.shipping_linea) || 0;
        const totalItem = costoEquipo + costoEnvio;
        const comisionItem = (item.comision_actual * item.qty);
        
        const strProd = `${item.qty}x ${item.nombre}`;

        // B. CONSTRUIR BLOQUE WHATSAPP (CON EMOJIS üí™)
        mensajeRaw += `üí™ Pedido: ${codPedido}\n`;
        mensajeRaw += `üí™ Cliente: ${nombreC}\n`;
        mensajeRaw += `üí™ Municipio: ${municipioC}\n`;
        mensajeRaw += `üí™ Tel√©fono: ${telC}\n`;
        mensajeRaw += `üí™ Direcci√≥n: ${dirC}\n`;
        mensajeRaw += `üí™ Equipo: ${strProd}\n`;
        // Aqu√≠ mostramos el total SUMADO (Equipo + Env√≠o) como pediste
        mensajeRaw += `üí™ Total a Pagar: ${totalItem} USD\n`; 
        mensajeRaw += `üí™ Vuelto: ${vueltoC}\n`;
        
        // Desglose interno √∫til para el proveedor
        mensajeRaw += `   (Equipo: ${costoEquipo} + Env√≠o: ${costoEnvio})\n`;

        if (isLogged) {
            mensajeRaw += `üí™ Comisi√≥n: ${comisionItem} USD\n`;
            mensajeRaw += `üí™ Gestor: ${activeGestor}\n`;
        }
        mensajeRaw += `--------------------------------\n\n`;

        // C. INSERTAR EN BD (PEDIDO INDIVIDUAL)
        const insertPromise = supabaseClient.from('pedidos').insert([{
            gestor: activeGestor,
            cliente: nombreC,
            ci: ciC,
            telefono: telC,
            direccion: dirC,
            municipio: municipioC,
            producto: `${strProd} [${monedaC}]`,
            total: totalItem, // Total con env√≠o incluido
            comision_total: comisionItem,
            estado: 'Pendiente',
            pago_gestor: 'Pendiente',
            proveedor: prov,
            costo_mensajeria: costoEnvio, // Guardamos el env√≠o espec√≠fico
            orden_dia: codPedido,
            origen: origenPedido
        }]);
        
        promesas.push(insertPromise);
    }

    // Esperar a que todo se guarde
    const resultados = await Promise.all(promesas);
    if (resultados.some(r => r.error)) {
        alert("Hubo un error guardando algunos pedidos en la base de datos, pero el WhatsApp est√° listo.");
    }

    // 3. ENVIAR WHATSAPP
    const mensajeCodificado = encodeURIComponent(mensajeRaw);
    window.open(`https://wa.me/5356071095?text=${mensajeCodificado}`, '_blank');

    // 4. GENERAR PDF UNIFICADO (UNA SOLA HOJA CON TODO)
    // Calculamos los totales globales para el PDF
    const totalGlobalProductos = cart.reduce((acc, i) => acc + (i.precio_venta * i.qty), 0);
    const totalGlobalEnvio = cart.reduce((acc, i) => acc + (parseFloat(i.shipping_linea) || 0), 0);
    const totalGlobal = totalGlobalProductos + totalGlobalEnvio;

    // Preparamos el objeto unificado para el PDF
    const datosParaPDF = {
        cliente: nombreC,
        ci: ciC,
        direccion: `${dirC} (${municipioC})`,
        totalUSD: totalGlobal,
        mensajeria: totalGlobalEnvio, // Suma de todos los env√≠os individuales
        items: cart.map(item => ({
            nombre: item.nombre,
            qty: item.qty,
            price: item.precio_venta,
            // Truco: Pasamos el 'total' de la l√≠nea como (precio*qty) para que el PDF calcule bien, 
            // la mensajer√≠a la mostramos abajo como un √≠tem separado o sumada al final.
            // Para que el PDF desglose bien, pasamos los items tal cual.
        }))
    };

    setTimeout(() => { generarComprobanteVenta(datosParaPDF); }, 1500); 

    // Limpieza final
    setTimeout(() => {
        cart = [];
        clearAutoSave();
        toggleCartModal(false);
        location.reload();
    }, 1000);
}

    // 6. FUNCIONES AUXILIARES
    function parseMensajeria(texto) {
        if (!texto) return 0;
        let t = texto.toString().toLowerCase();
        if (t.includes('gratis') && !t.includes('periferia')) return 0;
        let match = t.match(/\d+/);
        return match ? parseFloat(match[0]) : 0;
    }

    function fixDriveUrl(url) {
        if (!url) return 'https://placehold.co/400x400?text=No+Imagen';
        if (url.startsWith('http')) return url;
        return `${SUPABASE_URL}/storage/v1/object/public/productos/${url}`;
    }

    // 1. L√≥gica para decidir si mostrar el bot√≥n del Gestor (Nivel 2+)
async function initAgentFloatingButton() {
    // 1. VALIDACI√ìN CR√çTICA: Si el usuario est√° LOGUEADO (es un Gestor o Admin), no mostrar el bot√≥n
    const session = localStorage.getItem('pth_session');
    if (session) {
        console.log("üõ°Ô∏è Sesi√≥n activa detectada. Ocultando bot√≥n de contacto.");
        const container = document.getElementById('floating-agent-contact');
        if (container) container.classList.add('hidden');
        return; // Salir de la funci√≥n
    }

    // 2. Intentar obtener el gestor de la URL o de la memoria (para Clientes)
    const referrer = await getActiveReferrer();
    
    // 3. Si hay un gestor detectado y es un cliente an√≥nimo, mostrar bot√≥n
    if (referrer && referrer.nombre && referrer.telefono) {
        renderFloatingWA(referrer.nombre, referrer.telefono);
    }
}

// 2. Funci√≥n para pintar el bot√≥n con el tel√©fono del gestor
function renderFloatingWA(nombre, telefono) {
    const container = document.getElementById('floating-agent-contact');
    if (!container || !telefono) return;

    // Limpiar el tel√©fono (quitar espacios, +, etc)
    const telLimpio = telefono.replace(/\D/g, '');
    const primerNombre = nombre.split(' ')[0];

    container.innerHTML = `
        <a href="https://wa.me/${telLimpio}?text=${encodeURIComponent('Hola ' + primerNombre + ', estoy viendo el cat√°logo y me interesa un equipo.')}" 
           target="_blank" 
           class="fixed bottom-6 left-6 z-[60] flex items-center gap-3 bg-[#25D366] text-white p-2 pr-5 rounded-full shadow-2xl hover:scale-105 transition-all active:scale-95 group pulse-wa">
            
            <div class="relative">
                <div class="h-12 w-12 bg-white rounded-full flex items-center justify-center text-[#25D366] border-2 border-white">
                    <span class="material-symbols-outlined text-3xl">person</span>
                </div>
                <div class="absolute bottom-0 right-0 h-3.5 w-3.5 bg-emerald-400 border-2 border-white rounded-full"></div>
            </div>

            <div class="flex flex-col">
                <span class="text-[9px] font-black uppercase opacity-80 tracking-tighter leading-none mb-1">Comercial en l√≠nea</span>
                <span class="text-sm font-black leading-none">${nombre.toUpperCase()}</span>
            </div>

            <div class="absolute -top-12 left-0 bg-gray-900 text-white text-[10px] py-1.5 px-3 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none shadow-xl">
                ¬øTienes dudas? Chatea conmigo üëã
                <div class="absolute -bottom-1 left-4 w-2 h-2 bg-gray-900 rotate-45"></div>
            </div>
        </a>
    `;
    container.classList.remove('hidden');
}

    function toggleCartModal(show) {
    const cartModal = document.getElementById('cart-modal');
    if (!cartModal) return;

    // 1. Abre o cierra el modal
    cartModal.classList.toggle('hidden', !show);
    
    if(show) {
        // 2. Dibuja los productos del carrito
        renderCart();
        
        // 3. L√ìGICA DE VISIBILIDAD DE HERRAMIENTAS GESTOR (Pegar y CRM)
        const session = localStorage.getItem('pth_session');
        const gestorTools = document.getElementById('gestor-checkout-tools');
        
        if (gestorTools) {
            if (session) {
                // Si Marcel est√° logueado, le mostramos el bot√≥n verde de "Pegar" y el buscador CRM
                gestorTools.classList.remove('hidden');
            } else {
                // Si es un cliente, le escondemos esas herramientas profesionales
                gestorTools.classList.add('hidden');
            }
        }
    }
}
    function closeDetail() { document.getElementById('detail-modal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
    function toggleCurrency() { showInCUP = !showInCUP; document.getElementById('currency-label').innerText = showInCUP ? 'CUP' : 'USD'; renderProducts(); }
    
    function filterByCategory(cat) { 
        activeCategory = cat; 
        
        // Re-renderizar categor√≠as para mover la clase 'active'
        renderCategories(); 
        
        // Filtrar productos
        renderProducts(); 
        
        // Actualizar etiqueta en la barra de marketing
        const label = document.getElementById('marketing-cat-label');
        if(label) label.innerText = cat;
    }
    function removeFromCart(i) { cart.splice(i, 1); document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0); renderCart(); }
    function filterProducts() { renderProducts(); }
    function copyOffer() {
        const text = `üî• *OFERTA DISPONIBLE*\nüì¶ ${selectedProduct.nombre}\nüí∞ Precio: $${selectedProduct.precio} USD\nüõ°Ô∏è Garant√≠a: ${selectedProduct.garantia}\nüöõ Env√≠o: ${selectedProduct.mensajeria}`;
        navigator.clipboard.writeText(text).then(() => alert("¬°Copiado!"));
    }

    // DASHBOARD DE GESTOR (Simplificado para Supabase)
    // --- FUNCI√ìN DASHBOARD BLINDADA ---
async function loadFullDashboard() {
    const currentGestor = window.gestorName || gestorName; 
    if (!currentGestor) return;

    // Consultamos pedidos
    const { data, error } = await supabaseClient
        .from('pedidos')
        .select('*')
        .eq('gestor', currentGestor);

    if (error) {
        console.error("Error cargando dashboard:", error);
        return;
    }
    
    const entregados = data.filter(p => p.estado === 'Entregado');
    const pendientes = data.filter(p => p.estado === 'Pendiente' || p.estado === 'Asignado Mensajero' || p.estado === 'Recogida Almac√©n');
    
    // Calculamos comisiones
    const ganancia = entregados.reduce((acc, curr) => acc + (Number(curr.comision_total) || 0), 0);

    // --- AQU√ç ESTABA EL ERROR: VALIDAMOS QUE EXISTAN LOS ELEMENTOS ANTES DE ESCRIBIR ---
    
    const elMoney = document.getElementById('dash-money');
    if (elMoney) elMoney.innerText = `$${ganancia.toFixed(2)}`;

    const elOk = document.getElementById('dash-ok');
    if (elOk) elOk.innerText = entregados.length;

    const elPending = document.getElementById('dash-pending');
    if (elPending) elPending.innerText = pendientes.length;

    // Actualizamos tambi√©n los contadores de la nueva secci√≥n "Mis Pedidos Financieros" si existen
    const elMoneyPending = document.getElementById('dash-money-pending');
    const elMoneyPaid = document.getElementById('dash-money-paid');
    
    if (elMoneyPending || elMoneyPaid) {
        const porCobrar = entregados
            .filter(p => p.pago_gestor === 'Pendiente' || !p.pago_gestor)
            .reduce((acc, curr) => acc + (Number(curr.comision_total) || 0), 0);

        const cobrado = entregados
            .filter(p => p.pago_gestor === 'Pagado')
            .reduce((acc, curr) => acc + (Number(curr.comision_total) || 0), 0);
            
        if(elMoneyPending) elMoneyPending.innerText = `$${porCobrar.toFixed(2)}`;
        if(elMoneyPaid) elMoneyPaid.innerText = `$${cobrado.toFixed(2)}`;
    }

    // Ranking
    if (typeof renderRankingGestor === "function") {
        renderRankingGestor(data); 
    }
}

    function renderRankingGestor(misVentas) {
        // Esta funci√≥n lista las √∫ltimas ventas del propio gestor en la lista de abajo
        const list = document.getElementById('ranking-list');
        list.innerHTML = misVentas.slice(0, 5).map(v => `
            <div class="p-4 flex justify-between items-center">
                <div>
                    <p class="text-[10px] font-bold text-gray-400">${new Date(v.created_at || new Date()).toLocaleDateString()}</p>
                    <p class="text-xs font-black uppercase text-gray-700">${v.producto.substring(0, 20)}...</p>
                </div>
                <span class="text-emerald-500 font-black text-xs">+$${v.comision_total}</span>
            </div>
        `).join('');
    }

    function showSection(section) {
        const isCat = section === 'catalogo';
        document.getElementById('sec-catalogo').style.display = isCat ? 'block' : 'none';
        document.getElementById('sec-dashboard').classList.toggle('hidden', isCat);
        document.getElementById('tab-cat').className = isCat ? "flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-primary text-white" : "flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-gray-100 text-gray-400";
        document.getElementById('tab-dash').className = !isCat ? "flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-primary text-white" : "flex-1 py-3 rounded-xl font-bold text-xs uppercase bg-gray-100 text-gray-400";
        if(!isCat) loadFullDashboard();
        window.scrollTo(0,0);
    }

    // GESTORES
    function openGestorGen() { document.getElementById('gestor-modal').classList.remove('hidden'); }
    function closeGestorGen() { document.getElementById('gestor-modal').classList.add('hidden'); }
    function processGestor() {
        const pass = document.getElementById('master-pass').value;
        if(pass !== MASTER_KEY) return alert("C√≥digo Maestro Incorrecto");
        const name = document.getElementById('gen-name').value.trim();
        const tel = document.getElementById('gen-tel').value.trim();
        if(!name || !tel) return alert("Faltan datos");
        const base = window.location.origin + window.location.pathname;
        document.getElementById('link-admin').value = `${base}?gestor=${encodeURIComponent(name)}&tel=${tel}&admin=true`;
        document.getElementById('link-client').value = `${base}?gestor=${encodeURIComponent(name)}&tel=${tel}`;
        document.getElementById('links-result').classList.remove('hidden');
    }
    function copy(id) { const e = document.getElementById(id); e.select(); document.execCommand('copy'); alert("Copiado"); }

    // --- L√ìGICA DEL PANEL MAESTRO ---

// CORRECCI√ìN: Funci√≥n para entrar al Panel Maestro (Due√±o)
async function openAdminMaster() {
    const pass = prompt("Acceso Administrativo. Introduce la Clave de Due√±o:");
    
    // Cambiamos MASTER_KEY por ADMIN_SECRET_KEY para que use la clave de administrador
    if (pass === ADMIN_SECRET_KEY) { 
        document.getElementById('sec-catalogo').style.display = 'none';
        document.getElementById('sec-dashboard').classList.add('hidden');
        document.getElementById('admin-nav').classList.add('hidden');
        document.getElementById('sec-admin-master').classList.remove('hidden');
        loadAdminData();
    } else if (pass !== null) {
        alert("Clave de Administrador incorrecta.");
    }
}

let pedidosRawAdmin = []; // A√±ade esta l√≠nea antes de la funci√≥n


let inventoryRawAdmin = []; // Variable global vital para el inventario

async function loadAdminData() {
    // 1. CARGA PRIORITARIA: GESTORES (Para que esto nunca falle)
    loadPendingGestores();

    // 2. Cargamos los datos masivos
    const { data: pedidos } = await supabaseClient.from('pedidos').select('*').order('fecha', {ascending: false});
    const { data: productos } = await supabaseClient.from('productos').select('*').order('nombre', {ascending: true});
    const { data: vistas } = await supabaseClient.from('metricas_vistas').select('*');

    // 3. Procesar Pedidos
    if (pedidos) {
        pedidosRawAdmin = pedidos; 
        populateLogisticaFilters();
        renderAdminLogistica(); 
        renderAdminCortes();
        updateAdminStats(pedidos);
        
        // Intentamos cargar anal√≠ticas (en try-catch para que si fallan no rompan nada m√°s)
        try {
            renderAnaliticaGestores(pedidos);
            renderAnaliticaProveedores(pedidos);
            renderAnaliticaCancelacion(pedidos);
        } catch(e) { console.log("Anal√≠tica parcial pendiente de datos"); }
    }
    
    // 4. Procesar Inventario
    if (productos) {
        inventoryRawAdmin = productos; // Guardamos en global
        renderAdminInventario(productos); // Pasamos los datos
    }
    
    // 5. Procesar Cruce de datos
    if (pedidos && productos) {
        try {
            renderAnaliticaZombies(pedidos, productos);
            renderAnaliticaConversion(pedidos, vistas || []);
        } catch(e) { console.log("Cruce de datos pendiente"); }
    }
}

// --- FUNCI√ìN PARA APROBAR O RECHAZAR GESTORES ---
async function approveGestor(id, nuevoEstado, nombre = "", telefono = "") {
    const confirmacion = confirm(`¬øEst√°s seguro de que quieres cambiar el estado de ${nombre} a ${nuevoEstado}?`);
    if (!confirmacion) return;

    try {
        const { error } = await supabaseClient
            .from('gestores')
            .update({ estado: nuevoEstado })
            .eq('id', id);

        if (error) throw error;

        alert(`‚úÖ Gestor ${nombre} ha sido marcado como ${nuevoEstado}.`);
        
        // Recargar las listas del panel de administraci√≥n
        loadPendingGestores(); 
    } catch (e) {
        console.error("Error al actualizar gestor:", e);
        alert("Error al procesar la solicitud.");
    }
}

// --- FUNCI√ìN PARA ELIMINAR GESTORES ---
async function removeGestor(id, nombre) {
    if (!confirm(`¬øVas a dar de baja a ${nombre}?\n\nSi el gestor tiene ventas, no se borrar√° para proteger los datos, pero pasar√° a estado BLOQUEADO y desaparecer√° de esta lista.`)) return;

    try {
        // --- INTENTO 1: BORRADO F√çSICO ---
        // Agregamos .select() al final para verificar si realmente se borr√≥ algo
        const { data, error } = await supabaseClient
            .from('gestores')
            .delete()
            .eq('id', id)
            .select(); 

        // Verificamos si 'data' tiene contenido. Si data.length > 0, es que S√ç se borr√≥.
        if (data && data.length > 0) {
            alert("‚úÖ Gestor eliminado permanentemente (Cuenta limpia sin ventas).");
            loadPendingGestores(); // Recargamos la tabla
            return;
        }

        // Si llegamos aqu√≠, es porque NO se borr√≥ (aunque no diera error), 
        // probablemente porque tiene ventas asociadas (Foreign Key) o RLS.
        console.warn("El borrado f√≠sico fall√≥ (protecci√≥n de datos). Aplicando bloqueo...");

        // --- INTENTO 2: BLOQUEO L√ìGICO (PLAN B) ---
        const { error: updateError } = await supabaseClient
            .from('gestores')
            .update({ estado: 'bloqueado' }) // Lo marcamos como bloqueado
            .eq('id', id);

        if (updateError) throw updateError;

        alert(`‚ö†Ô∏è Este gestor tiene historial de ventas y no se puede borrar.\n‚úÖ ACCI√ìN ALTERNATIVA: Se ha cambiado su estado a 'BLOQUEADO' y ya no tendr√° acceso ni aparecer√° aqu√≠.`);
        
        loadPendingGestores(); // Recargamos la tabla

    } catch (e) {
        console.error("Error al gestionar la baja:", e);
        alert("Ocurri√≥ un error inesperado: " + e.message);
    }
}

function updateAdminStats(pedidos) {
    const entregados = pedidos.filter(p => p.estado === 'Entregado');
    const totalUSD = entregados.reduce((acc, p) => acc + Number(p.total || 0), 0);
    const pendientes = pedidos.filter(p => p.estado === 'Pendiente' || p.estado === 'En Camino').length;
    const deuda = pedidos.filter(p => p.estado === 'Entregado' && p.pago_gestor === 'Pendiente')
                         .reduce((acc, p) => acc + Number(p.comision_total || 0), 0);

    document.getElementById('m-stat-ventas').innerText = `$${totalUSD.toLocaleString()}`;
    document.getElementById('m-stat-pendientes').innerText = pendientes;
    document.getElementById('m-stat-deuda').innerText = `$${deuda.toLocaleString()}`;
    document.getElementById('m-stat-gestores').innerText = new Set(pedidos.map(p => p.gestor)).size;
}

// --- FUNCI√ìN DE LOG√çSTICA MAESTRA CON FILTROS AVANZADOS ---
// --- FUNCI√ìN DE LOG√çSTICA MAESTRA CORREGIDA ---
function renderAdminLogistica() {
    const container = document.getElementById('list-admin-pedidos');
    if (!container || !pedidosRawAdmin) return;

    // 1. Obtener valores de los filtros
    const query = document.getElementById('search-logistica').value.toLowerCase();
    const provFilter = document.getElementById('f-proveedor').value;
    const gestFilter = document.getElementById('f-gestor').value;
    const dateDesde = document.getElementById('f-desde').value;
    const dateHasta = document.getElementById('f-hasta').value;
    // Capturamos el municipio (con validaci√≥n por si no existe el elemento)
    const muniFilter = document.getElementById('f-municipio') ? document.getElementById('f-municipio').value : 'TODOS';

    // 2. Aplicar Filtro Multi-Nivel (Un solo filtro para todo)
    const filtrados = pedidosRawAdmin.filter(p => {
        // A. Filtro por Pesta√±a (Status)
        let matchStatus = false;
        if (currentStatusFilter === 'TODOS') matchStatus = true;
        else if (currentStatusFilter === 'FINALIZADOS') matchStatus = (p.estado === 'Entregado' || p.estado === 'Cancelado');
        else matchStatus = (p.estado === currentStatusFilter);

        // B. Filtro por Texto (Buscador)
        const matchText = (p.cliente || "").toLowerCase().includes(query) || 
                          (p.producto || "").toLowerCase().includes(query);

        // C. Filtro por Proveedor
        const matchProv = provFilter === 'TODOS' || p.proveedor === provFilter;

        // D. Filtro por Gestor
        const matchGest = gestFilter === 'TODOS' || p.gestor === gestFilter;

        // E. Filtro por Municipio
        const matchMuni = muniFilter === 'TODOS' || p.municipio === muniFilter;

        // F. Filtro por Rango de Fecha
        let matchDate = true;
        if (p.fecha) {
            const pFecha = p.fecha.split('T')[0]; // Obtener YYYY-MM-DD
            if (dateDesde && pFecha < dateDesde) matchDate = false;
            if (dateHasta && pFecha > dateHasta) matchDate = false;
        }

        // Combinamos todas las condiciones
        return matchStatus && matchText && matchProv && matchGest && matchMuni && matchDate;
    });

    // 3. Actualizar Sumatorias
    const totalUSD = filtrados.reduce((acc, p) => acc + Number(p.total || 0), 0);
    const totalComi = filtrados.reduce((acc, p) => acc + Number(p.comision_total || 0), 0);
    
    document.getElementById('sum-count').innerText = filtrados.length;
    document.getElementById('sum-usd').innerText = `$${totalUSD.toLocaleString()}`;
    document.getElementById('sum-comi').innerText = `$${totalComi.toLocaleString()}`;

    // 4. Renderizar Tabla
    if (filtrados.length === 0) {
        container.innerHTML = `<tr><td colspan="6" class="p-10 text-center text-gray-400 font-bold uppercase text-xs">No hay pedidos que coincidan con estos filtros.</td></tr>`;
        return;
    }

    container.innerHTML = filtrados.map(p => {
        let colorClass = "bg-gray-100 text-gray-600";
        if(p.estado === 'Pendiente') colorClass = "bg-yellow-100 text-yellow-700";
        if(p.estado === 'Recogida Almac√©n') colorClass = "bg-orange-100 text-orange-700";
        if(p.estado === 'Asignado Mensajero') colorClass = "bg-blue-100 text-blue-700";
        if(p.estado === 'Entregado') colorClass = "bg-emerald-100 text-emerald-700";
        if(p.estado === 'Cancelado') colorClass = "bg-red-100 text-red-700";

        const esFinal = (p.estado === 'Entregado' || p.estado === 'Cancelado');

        return `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/40 transition-all text-xs border-b dark:border-gray-700">
            <td class="p-4 font-bold uppercase text-[10px]">
                <p class="text-gray-400 mb-1">${new Date(p.fecha).toLocaleDateString()}</p>
                <span class="text-primary">${p.cliente}</span>
            </td>
            <td class="p-4"><span class="bg-indigo-50 text-indigo-600 px-2 py-1 rounded font-bold text-[9px] uppercase">${p.proveedor || 'General'}</span></td>
            <td class="p-4 text-gray-500 truncate max-w-xs" title="${p.producto}">${p.producto}</td>
            <td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded text-[9px] font-bold">${p.gestor}</span></td>
            <td class="p-4 text-right">
                ${esFinal ? 
                    `<span class="px-3 py-1.5 rounded-lg font-black text-[9px] uppercase ${colorClass}">${p.estado}</span>` :
                    `<select onchange="updatePedidoStatus('${p.id}', this.value)" class="text-[10px] font-black uppercase rounded-lg border-none ${colorClass} py-2 cursor-pointer focus:ring-0 text-center w-full max-w-[150px]">
                        <option value="Pendiente" ${p.estado === 'Pendiente' ? 'selected' : ''}>‚è≥ Pendiente</option>
                        <option value="Recogida Almac√©n" ${p.estado === 'Recogida Almac√©n' ? 'selected' : ''}>üè≠ En Almac√©n</option>
                        <option value="Asignado Mensajero" ${p.estado === 'Asignado Mensajero' ? 'selected' : ''}>üèçÔ∏è Mensajero</option>
                        <option value="Entregado">‚úÖ Entregado</option>
                        <option value="Cancelado">‚ùå Cancelado</option>
                    </select>`
                }
            </td>
        </tr>`;
    }).join('');
}

// FUNCION PARA LLENAR LOS SELECTS CON DATA REAL
function populateLogisticaFilters() {
    const proveedores = [...new Set(pedidosRawAdmin.map(p => p.proveedor || 'General'))].sort();
    const gestores = [...new Set(pedidosRawAdmin.map(p => p.gestor))].sort();

    const selectProv = document.getElementById('f-proveedor');
    const selectGest = document.getElementById('f-gestor');

    selectProv.innerHTML = '<option value="TODOS">Todos los Proveedores</option>' + 
                          proveedores.map(p => `<option value="${p}">${p}</option>`).join('');
    
    selectGest.innerHTML = '<option value="TODOS">Todos los Gestores</option>' + 
                          gestores.map(g => `<option value="${g}">${g}</option>`).join('');
}

function resetLogisticaFilters() {
    document.getElementById('f-desde').value = "";
    document.getElementById('f-hasta').value = "";
    document.getElementById('f-proveedor').value = "TODOS";
    document.getElementById('f-gestor').value = "TODOS";
    document.getElementById('search-logistica').value = "";
    renderAdminLogistica();
}

function renderAdminCortes() {
    const container = document.getElementById('list-admin-cortes');
    if (!container || !pedidosRawAdmin) return;

    const searchTerm = (document.getElementById('search-gestor-pago')?.value || "").toLowerCase();
    
    // --- CORRECCI√ìN AQU√ç ---
    // Antes buscaba 'input-tasa-cup', ahora busca 'daily-rate'
    const tasaInput = document.getElementById('daily-rate');
    const tasa = tasaInput ? parseFloat(tasaInput.value) : 450; 
    // -----------------------

    // Filtramos solo los pedidos entregados que deben comisi√≥n
    const deuda = pedidosRawAdmin.filter(p => p.estado === 'Entregado' && p.pago_gestor === 'Pendiente');

    // Agrupar por gestor
    const porGestor = deuda.reduce((acc, p) => {
        const gName = p.gestor || "Venta Directa";
        if (!acc[gName]) acc[gName] = { usd: 0, count: 0, ids: [] };
        acc[gName].usd += Number(p.comision_total || 0);
        acc[gName].count++;
        acc[gName].ids.push(p.id);
        return acc;
    }, {});

    const entries = Object.entries(porGestor).filter(([name]) => name.toLowerCase().includes(searchTerm));

    if (entries.length === 0) {
        container.innerHTML = `<tr><td colspan="5" class="p-10 text-center text-gray-400 font-bold uppercase text-xs">Todo al d√≠a. No hay comisiones pendientes de pago.</td></tr>`;
        return;
    }

    container.innerHTML = entries.map(([name, data]) => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-900/40 transition-all border-b dark:border-gray-700 bg-white dark:bg-gray-900">
            <td class="p-4 font-black text-primary uppercase italic text-xs">${name}</td>
            <td class="p-4 font-bold text-gray-400 text-xs">${data.count} ventas</td>
            <td class="p-4 font-black text-sm">$${data.usd.toFixed(2)}</td>
            
            <!-- Aqu√≠ usamos la tasa corregida -->
            <td class="p-4 font-black text-emerald-500 text-sm italic">${(data.usd * tasa).toLocaleString()} CUP</td>
            
            <td class="p-4 text-right">
                <button onclick="liquidarComisiones('${data.ids.join(',')}')" class="bg-gray-900 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-black transition-colors shadow-lg shadow-gray-900/20">
                    Liquidar (Pagar)
                </button>
            </td>
        </tr>
    `).join('');
}

async function liquidarComisiones(idsStr) {
    if (!confirm("¬øYa pagaste estas comisiones?")) return;
    await supabaseClient.from('pedidos').update({ pago_gestor: 'Pagado' }).in('id', idsStr.split(','));
    loadAdminData();
}

async function updatePedidoStatus(id, nuevoEstado) {
    await supabaseClient.from('pedidos').update({ estado: nuevoEstado }).eq('id', id);
    loadAdminData();
}

// PEGA ESTA FUNCI√ìN CORREGIDA
function renderAdminInventario(productosArg) {
    // 1. L√≥gica H√≠brida: Usa el argumento si existe, sino usa la variable global, sino array vac√≠o
    const listaProductos = productosArg || inventoryRawAdmin || [];
    
    const container = document.getElementById('list-admin-inventario');
    
    // Si no existe el buscador, asumimos vac√≠o
    const searchInput = document.getElementById('search-inventario');
    const searchVal = searchInput ? searchInput.value.toLowerCase() : "";

    if (!container) return;

    // 2. Filtrar
    const filtered = listaProductos.filter(p => {
        // Generar SKU Virtual visual
        const skuVirtual = (p.categoria ? p.categoria.substring(0,3).toUpperCase() : "GEN") + "-" + p.id.substring(0,4).toUpperCase();
        
        return p.nombre.toLowerCase().includes(searchVal) || 
               (p.categoria || "").toLowerCase().includes(searchVal) ||
               skuVirtual.toLowerCase().includes(searchVal);
    });

    if (filtered.length === 0) {
        container.innerHTML = `<div class="col-span-full py-20 text-center text-gray-400 font-bold uppercase text-xs italic">No hay productos cargados o no coinciden con la b√∫squeda.</div>`;
        return;
    }

    container.innerHTML = filtered.map(p => {
        const skuDisplay = (p.categoria ? p.categoria.substring(0,3).toUpperCase() : "GEN") + "-" + p.id.substring(0,4).toUpperCase();

        return `
        <div class="bg-white dark:bg-gray-800 p-4 rounded-3xl border shadow-sm flex flex-col justify-between h-full text-left group hover:border-primary/30 transition-all relative">
            <span class="absolute top-4 right-4 text-[9px] font-mono text-gray-300">#${skuDisplay}</span>
            <div>
                <img src="${fixDriveUrl(p.thumbnail)}" class="w-full h-32 object-contain mb-4 bg-gray-50 dark:bg-gray-900 rounded-2xl p-2">
                <h6 class="text-[10px] font-black leading-tight mb-1 uppercase text-gray-700 dark:text-gray-200 line-clamp-2 h-8">${p.nombre}</h6>
                <div class="flex justify-between items-end mb-4">
                    <p class="text-primary font-black text-sm">$${p.precio}</p>
                    <p class="text-[9px] text-gray-400 font-bold uppercase">${p.categoria || 'Varios'}</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="toggleStockAdmin('${p.id}', '${p.disponible}')" 
                    class="flex-1 py-2 rounded-xl text-[9px] font-black uppercase transition-all ${p.disponible === 'SI' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}">
                    ${p.disponible === 'SI' ? 'En Stock' : 'Agotado'}
                </button>
                <button onclick="editProduct('${p.id}')" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-xl hover:bg-primary hover:text-white transition-all shadow-sm">
                    <span class="material-symbols-outlined text-sm">edit</span>
                </button>
            </div>
        </div>
    `; }).join('');
}

async function toggleStockAdmin(id, actual) {
    await supabaseClient.from('productos').update({ disponible: actual === 'SI' ? 'NO' : 'SI' }).eq('id', id);
    loadAdminData();
}

function renderAnaliticaVistas(vistas) {
    const counts = vistas.reduce((acc, v) => { acc[v.nombre_producto] = (acc[v.nombre_producto] || 0) + 1; return acc; }, {});
    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
    document.getElementById('list-analitica-vistas').innerHTML = sorted.map(([name, count]) => `
        <div class="flex justify-between items-center text-[11px] font-bold uppercase italic text-gray-500">
            <p class="truncate pr-4">${name}</p>
            <p class="text-primary">${count} clics</p>
        </div>
    `).join('');
}

function renderAnaliticaGestores(pedidos) {
    const counts = pedidos.filter(p => p.estado === 'Entregado').reduce((acc, p) => { acc[p.gestor] = (acc[p.gestor] || 0) + 1; return acc; }, {});
    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
    document.getElementById('list-analitica-gestores').innerHTML = sorted.map(([name, count]) => `
        <div class="flex justify-between items-center text-[11px] font-bold uppercase italic text-gray-500">
            <p>${name}</p>
            <p class="text-primary">${count} ventas</p>
        </div>
    `).join('');
}

async function loadTrafficAnalytics() {
    const { data: analytics, error } = await supabaseClient
        .from('link_analytics')
        .select('*, short_links(gestor)');

    if (error || !analytics) return;

    const gClicks = {};
    analytics.forEach(row => {
        const name = row.short_links?.gestor || 'Directo/Eliminado';
        gClicks[name] = (gClicks[name] || 0) + 1;
    });

    document.getElementById('list-trafico-gestores').innerHTML = Object.entries(gClicks)
        .sort((a,b) => b[1] - a[1])
        .map(([name, count]) => `
            <div class="flex justify-between items-center text-[11px] border-b dark:border-gray-700 pb-2">
                <span class="font-bold text-gray-600 dark:text-gray-300 uppercase">${name}</span>
                <span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-black">${count} CLICS</span>
            </div>
        `).join('');

    const devices = {};
    analytics.forEach(row => { devices[row.device_type] = (devices[row.device_type] || 0) + 1; });
    document.getElementById('list-trafico-dispositivos').innerHTML = Object.entries(devices).map(([dev, count]) => `
        <div class="flex justify-between items-center text-[11px]">
            <span class="font-bold text-gray-500 uppercase">${dev}</span>
            <span class="font-black text-primary">${count}</span>
        </div>
    `).join('');
}

function changeAdminTab(tab) {
    // 1. Ocultar todos los contenedores de pesta√±as admin
    document.querySelectorAll('.tab-cnt').forEach(cnt => {
        cnt.classList.add('hidden');
    });

    // 2. Mostrar el contenedor espec√≠fico (ej: cnt-aprobaciones)
    const target = document.getElementById('cnt-' + tab);
    if (target) {
        target.classList.remove('hidden');
    } else {
        console.error("No se encontr√≥ el contenedor: cnt-" + tab);
    }

    // 3. Actualizar los estilos de los botones para que se vea cu√°l est√° activo
    document.querySelectorAll('.btn-tab-admin').forEach(btn => {
        btn.classList.remove('active', 'bg-primary', 'text-white');
        btn.classList.add('text-gray-400');
    });

    // 4. Resaltar el bot√≥n presionado
    const activeBtn = document.getElementById('tab-' + tab);
    if (activeBtn) {
        activeBtn.classList.add('active', 'bg-primary', 'text-white');
        activeBtn.classList.remove('text-gray-400');
    }
}

// Registro de estad√≠sticas
async function registrarVistaAnalitica(p) {
    await supabaseClient.from('metricas_vistas').insert([{ producto_id: p.id, nombre_producto: p.nombre }]);
}
// Funci√≥n para saltar del panel de gestores al panel de administraci√≥n maestro
// CORRECCI√ìN: Funci√≥n para saltar desde el modal de gestores

function openAdminMasterFromGestor() {
    const passInput = document.getElementById('master-pass').value;
    
    // Verificamos si la clave escrita en el recuadro es la del due√±o
    if (passInput === ADMIN_SECRET_KEY) {
        closeGestorGen(); // Cerramos el modal
        
        // Ejecutamos la apertura directamente sin volver a preguntar
        document.getElementById('sec-catalogo').style.display = 'none';
        document.getElementById('sec-dashboard').classList.add('hidden');
        document.getElementById('admin-nav').classList.add('hidden');
        document.getElementById('sec-admin-master').classList.remove('hidden');
        loadAdminData();
    } else {
        alert("Para acceder aqu√≠, escribe la Clave de Due√±o en el campo 'C√≥digo Maestro'.");
    }
}

// --- FUNCIONES PARA EL FORMULARIO DE PRODUCTOS ---

function openModalProd() { 
        updateFormCategories(); // <--- AGREGAR ESTA L√çNEA AQU√ç

    // 1. Limpiar el ID de edici√≥n (para que sepa que es uno NUEVO)
    const idEdit = document.getElementById('p-id-edit');
    if(idEdit) idEdit.value = "";
    document.getElementById('p-disponible').value = "SI";
    
    // 2. Resetear todos los inputs del formulario (nombres, precios, etc)
    const form = document.getElementById('form-nuevo-prod');
    if(form) form.reset();
    
    // 3. Limpiar el editor de texto (Quill)
    if (typeof quill !== 'undefined' && quill !== null) {
        quill.root.innerHTML = "";
    }

    // 4. Limpiar las 4 im√°genes (Rutas, Previsualizaciones e Iconos)
    for (let i = 0; i < 4; i++) {
        const pathInput = document.getElementById(`img-path-${i}`);
        const previewImg = document.getElementById(`prev-${i}`);
        const iconSpan = document.getElementById(`icon-${i}`);

        if(pathInput) pathInput.value = "";
        if(previewImg) {
            previewImg.src = "";
            previewImg.classList.add('hidden');
        }
        if(iconSpan) {
            iconSpan.classList.remove('hidden');
            iconSpan.innerText = "add_a_photo";
        }
    }

    // LIMPIEZA EXPRESA DE MENSAJER√çA
    const inputMensajeria = document.getElementById('p-mensajeria');
    if (inputMensajeria) inputMensajeria.value = "";

    // 5. Asegurar que el bot√≥n diga "Guardar Cambios" y no "Actualizar"
    const btnSave = document.getElementById('btn-save-prod');
    if(btnSave) btnSave.innerText = "Guardar Cambios";
    
    // 6. Mostrar el modal
    const modal = document.getElementById('modal-producto');
    if(modal) modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeModalProd() { 
    document.getElementById('modal-producto').classList.add('hidden'); 
    document.body.style.overflow = 'auto';
}

// --- FUNCI√ìN PARA PROCESAR Y SUBIR IMAGEN ---
async function handleImageUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const msg = document.getElementById('upload-msg');
    const btn = document.getElementById('btn-upload');
    
    msg.innerText = "‚è≥ Optimizando y subiendo imagen...";
    btn.disabled = true;

    try {
        // 1. Comprimir imagen para ahorrar datos en Cuba
        const compressedBlob = await compressImage(file, 800, 800);

        // 2. Crear un nombre limpio para Supabase
        const cleanName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
        const fileName = `${Date.now()}_${cleanName}`;

        // 3. Subir al Storage
        const { data, error } = await supabaseClient.storage
            .from('productos')
            .upload(fileName, compressedBlob);

        if (error) throw error;

        // 4. GUARDAR EL NOMBRE EN EL CAMPO OCULTO (Paso Vital)
        document.getElementById('p-img-name').value = fileName;
        
        msg.innerHTML = `‚úÖ Foto lista para guardar`;
        btn.innerText = "Imagen Vinculada";
        btn.style.borderColor = "#33ccc4";
        
    } catch (e) {
        console.error(e);
        alert("Error al procesar la imagen: " + e.message);
        msg.innerText = "‚ùå Error en la subida";
        btn.disabled = false;
    }
}

function getAgentPhone() {
    let rawNum = "";

    // 1. Intentar sacar el tel√©fono de la sesi√≥n activa
    if (window.currentUserData && window.currentUserData.telefono) {
        rawNum = window.currentUserData.telefono;
    } else {
        // 2. Intentar sacar el tel√©fono de la URL si no hay sesi√≥n
        rawNum = new URLSearchParams(window.location.search).get('tel') || "";
    }

    // Si no hay n√∫mero en ning√∫n lado, devolver el del due√±o
    if (!rawNum) return '5356071095';

    // LIMPIEZA Y FORMATO CUBA
    let limpio = rawNum.replace(/\D/g, ''); // Quita el + y espacios

    // Si el n√∫mero tiene 8 d√≠gitos (ej: 58183649), le ponemos el 53 delante
    if (limpio.length === 8) {
        limpio = '53' + limpio;
    }
    
    // Si el n√∫mero tiene 10 d√≠gitos y empieza con 53, est√° perfecto
    return limpio;
}

// --- GUARDAR EL PRODUCTO COMPLETO EN LA TABLA ---
// --- GUARDAR PRODUCTO CON VERIFICACI√ìN INTELIGENTE (FUZZY MATCH) ---
document.getElementById('form-nuevo-prod').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('btn-save-prod');
    const nombreInput = document.getElementById('p-nombre').value.trim();
    const categoriaInput = document.getElementById('p-categoria').value;
    const editId = document.getElementById('p-id-edit').value;
    
    // ============================================================
    // 1. DETECTOR DE DUPLICADOS INTELIGENTE (Solo si es NUEVO)
    // ============================================================
    if (!editId) { 
        // A. Limpiamos el nombre para sacar palabras clave importantes
        // Quitamos palabras comunes que la IA pone siempre (Smart, TV, de, el, con...)
        const palabrasIgnoradas = ['de', 'el', 'la', 'con', 'para', 'en', 'y', 'un', 'una', 'smart', 'nuevo', 'oferta'];
        
        // Separamos el nombre en palabras, filtramos las cortas (<3 letras) y las ignoradas
        const palabrasClave = nombreInput.toLowerCase()
            .split(/[\s\-\/\(\)]+/) // Separar por espacios o guiones
            .filter(w => w.length > 2 && !palabrasIgnoradas.includes(w));

        // Tomamos las 3 palabras m√°s "raras" o largas (generalmente Marca y Modelo)
        // Ejemplo: De "Smart TV Challenger 75 4K" -> busca "Challenger" y "75"
        const keywords = palabrasClave.slice(0, 3).join(' & '); 

        if (keywords.length > 0) {
            // B. Preguntamos a Supabase usando B√∫squeda de Texto Completo
            // Busca productos que tengan ESAS palabras en CUALQUIER orden
            const { data: similares, error: errCheck } = await supabaseClient
                .from('productos')
                .select('nombre, precio, categoria')
                .textSearch('nombre', keywords) 
                .limit(3);

            // C. Si encuentra coincidencias, ALERTA al administrador
            if (similares && similares.length > 0) {
                // Filtramos para asegurar que sean de la misma categor√≠a (para evitar falsos positivos)
                const duplicadoReal = similares.find(p => p.categoria === categoriaInput);

                if (duplicadoReal) {
                    const confirmar = confirm(
                        `‚õî POSIBLE DUPLICADO DETECTADO\n\n` +
                        `T√∫ intentas subir: "${nombreInput}"\n\n` +
                        `Pero ya existe en base de datos:\n` +
                        `üëâ "${duplicadoReal.nombre}" ($${duplicadoReal.precio})\n\n` +
                        `¬øEs el mismo equipo que subi√≥ otro admin?\n` +
                        `[Aceptar] = Cancelar subida (No duplicar)\n` +
                        `[Cancelar] = Subir de todas formas (Es diferente)`
                    );

                    if (confirmar) {
                        return; // Detiene el proceso, no guarda nada.
                    }
                }
            }
        }
    }
    // ============================================================

    // 2. Validaci√≥n de Foto
    const imgName = document.getElementById('p-img-name') ? document.getElementById('p-img-name').value : '';
    // Revisamos las 4 casillas por si acaso
    let tieneFoto = false;
    for(let i=0; i<4; i++) {
        if(document.getElementById(`img-path-${i}`).value) tieneFoto = true;
    }
    
    if (!editId && !tieneFoto && !imgName) {
         alert("‚ùå Error: Debes subir al menos una foto.");
         return;
    }

    btn.disabled = true; 
    btn.innerText = "GUARDANDO...";

    // 3. Recopilar Datos
    const datos = {
        nombre: nombreInput,
        precio: parseFloat(document.getElementById('p-precio').value),
        comision: parseFloat(document.getElementById('p-comision').value) || 0,
        categoria: categoriaInput,
        descripcion: (typeof quill !== 'undefined') ? quill.root.innerHTML : document.getElementById('p-desc').value, 
        
        thumbnail: document.getElementById('img-path-0').value || imgName,
        image1: document.getElementById('img-path-1').value,
        image2: document.getElementById('img-path-2').value,
        image3: document.getElementById('img-path-3').value,
        
        mensajeria: document.getElementById('p-mensajeria') ? document.getElementById('p-mensajeria').value : "",
        disponible: document.getElementById('p-disponible').value || 'SI',
        proveedor: document.getElementById('p-proveedor').value || 'General',
        precio_flexible: document.getElementById('p-flexible').value || 'NO',
        garantia: document.getElementById('p-garantia').value,
        pagos: 'USD, CUP, Zelle' 
    };

    let error;
    if (editId) {
        // ACTUALIZAR
        const { error: err } = await supabaseClient.from('productos').update(datos).eq('id', editId);
        error = err;
    } else {
        // INSERTAR NUEVO
        const { error: err } = await supabaseClient.from('productos').insert([datos]);
        error = err;
    }

    if (!error) {
        alert("‚úÖ ¬°Guardado correctamente!");
        
        // 1. Cerramos el modal
        closeModalProd();
        
        // 2. Refrescamos los datos del administrador sin recargar la p√°gina
        if (typeof loadAdminData === 'function') {
            await loadAdminData(); 
        }

        // 3. Reactivamos el bot√≥n por si se quiere usar de nuevo
        btn.disabled = false;
        btn.innerText = editId ? "Actualizar Producto" : "Guardar Cambios";
        
    } else {
        alert("Error: " + error.message);
        btn.disabled = false;
        btn.innerText = "Guardar Cambios";
    }
});


// Funci√≥n m√°gica de compresi√≥n
function compressImage(file, maxWidth, maxHeight) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                } else {
                    if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Convertir a Blob (JPEG con calidad 0.7 es super ligero)
                canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.7);
            };
        };
    });
}

// --- FUNCI√ìN UNIVERSAL PARA EXPORTAR A EXCEL ---
function exportToExcel(tableId, fileName) {
    const table = document.getElementById(tableId);
    if (!table) return alert("No hay datos para exportar");

    // Creamos una hoja de trabajo a partir de la tabla HTML
    const wb = XLSX.utils.table_to_book(table, { sheet: "Reporte" });
    
    // Generamos el archivo y lo descargamos
    // Le a√±ade la fecha de hoy al nombre para que no se confundan los archivos
    const fecha = new Date().toLocaleDateString().replace(/\//g, '-');
    XLSX.writeFile(wb, `${fileName}_${fecha}.xlsx`);
}


// 2. Subida de im√°genes mejorada (para los 4 espacios)
async function handlePowerUpload(input, index) {
    const file = input.files[0];
    if (!file) return;

    const icon = document.getElementById(`icon-${index}`);
    const prev = document.getElementById(`prev-${index}`);
    icon.innerText = "sync"; // Icono de cargando

    try {
        const compressedBlob = await compressImage(file, 800, 800);
        const fileName = `${Date.now()}_${index}_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}.jpg`;

        const { error } = await supabaseClient.storage.from('productos').upload(fileName, compressedBlob);
        if (error) throw error;

        // Mostrar previsualizaci√≥n
        document.getElementById(`img-path-${index}`).value = fileName;
        prev.src = URL.createObjectURL(compressedBlob);
        prev.classList.remove('hidden');
        icon.classList.add('hidden');
    } catch (e) {
        alert("Error al subir foto " + (index + 1));
        icon.innerText = "add_a_photo";
    }
}

// Funci√≥n para borrar una foto espec√≠fica
function clearImageSlot(event, index) {
    // IMPORTANTE: Evita que el clic se propague al div padre (que abrir√≠a el selector de archivos)
    event.stopPropagation();

    if (confirm("¬øQuieres quitar esta foto?")) {
        // 1. Limpiar el valor del input oculto (el que se guarda en la base de datos)
        document.getElementById(`img-path-${index}`).value = "";

        // 2. Ocultar la imagen de previsualizaci√≥n
        const prev = document.getElementById(`prev-${index}`);
        prev.src = "";
        prev.classList.add('hidden');

        // 3. Mostrar de nuevo el icono de "A√±adir foto"
        const icon = document.getElementById(`icon-${index}`);
        icon.classList.remove('hidden');
        icon.innerText = "add_a_photo";

        // 4. Resetear el input file por si quieres subir la misma foto despu√©s
        document.getElementById(`file-${index}`).value = "";
    }
}

// 3. Funci√≥n para EDITAR producto (Cargar datos en el modal)
// 3. Funci√≥n para EDITAR producto (CORREGIDA)
    function editProduct(id) {
        // 1. Buscar el producto en la lista de Inventario (Admin) O en la de Cat√°logo
        // Esto asegura que funcione donde sea que est√©s
        const p = (typeof inventoryRawAdmin !== 'undefined' ? inventoryRawAdmin.find(prod => prod.id === id) : null) 
                  || productosRaw.find(prod => prod.id === id);
        
        if (!p) return alert("Error: No se encuentra la informaci√≥n del producto.");

        // Llenamos los campos. 
    // USAR || "" es vital para que si en la DB est√° vac√≠o, el formulario se limpie
    const inputs = {
        'p-id-edit': p.id,
        'p-nombre': p.nombre,
        'p-precio': p.precio,
        'p-comision': p.comision,
        'p-categoria': p.categoria,
        'p-garantia': p.garantia,
        'p-proveedor': p.proveedor,
        'p-flexible': p.precio_flexible || 'NO',
        'p-mensajeria': p.mensajeria || "", // <--- ESTO LIMPIA EL RASTRO DEL EQUIPO ANTERIOR
        'p-disponible': p.disponible || "SI"
    };

    for (const [key, value] of Object.entries(inputs)) {
        const el = document.getElementById(key);
        if(el) el.value = value;
    }
        
        // 3. Cambiar texto del bot√≥n
        const btnSave = document.getElementById('btn-save-prod');
        if(btnSave) btnSave.innerText = "Actualizar Producto";

        // 4. Cargar Descripci√≥n en el Editor Quill
        if (typeof quill !== 'undefined' && quill) {
            quill.root.innerHTML = p.descripcion || "";
        } else {
            console.warn("Editor Quill no activo o no definido.");
            // Intento de recuperaci√≥n si no existe:
            const editorDiv = document.getElementById('editor-container');
            if(editorDiv) editorDiv.innerHTML = p.descripcion || ""; 
        }

        // 5. Cargar Fotos (Previsualizaci√≥n)
        const fotos = [p.thumbnail, p.image1, p.image2, p.image3];
        fotos.forEach((foto, i) => {
            const pathInput = document.getElementById(`img-path-${i}`);
            const prev = document.getElementById(`prev-${i}`);
            const icon = document.getElementById(`icon-${i}`);

            if (pathInput) pathInput.value = foto || "";
            
            if (foto) {
                if(prev) { prev.src = fixDriveUrl(foto); prev.classList.remove('hidden'); }
                if(icon) icon.classList.add('hidden');
            } else {
                if(prev) { prev.src = ""; prev.classList.add('hidden'); }
                if(icon) icon.classList.remove('hidden');
            }
        });

        // 6. Mostrar Modal
        document.getElementById('modal-producto').classList.remove('hidden');
    }



// --- 3. HERRAMIENTAS DE MARKETING (DESCARGAR Y COPIAR) ---

    // Funci√≥n mejorada para forzar la descarga de la imagen
    async function downloadProductImage() {
        if(!selectedProduct) return;
        
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = `<span class="loader w-4 h-4 border-2 border-primary"></span>`; // Spinner peque√±o
        
        try {
            const url = fixDriveUrl(selectedProduct.thumbnail);
            
            // 1. Obtenemos la imagen como un "blob" (archivo crudo)
            const response = await fetch(url);
            const blob = await response.blob();
            
            // 2. Creamos un enlace temporal en memoria
            const blobUrl = window.URL.createObjectURL(blob);
            
            // 3. Forzamos la descarga
            const link = document.createElement('a');
            link.href = blobUrl;
            // Limpiamos el nombre del archivo para que se guarde bonito
            const cleanName = selectedProduct.nombre.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            link.download = `foto_${cleanName}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // 4. Limpiamos memoria
            window.URL.revokeObjectURL(blobUrl);
            
            btn.innerHTML = originalText;
        } catch (error) {
            console.error(error);
            alert("No se pudo descargar la imagen directamente. Intenta mantener presionado sobre la foto.");
            btn.innerHTML = originalText;
        }
    }

    // --- FUNCI√ìN REUTILIZABLE PARA LINKS CORTOS ---
async function getOrGenerateShortLink(gestor, longLink) {
    try {
        // 1. Buscar si ya existe ese link para ese gestor
        const { data: linkData, error: fetchError } = await supabaseClient
            .from('short_links')
            .select('slug')
            .eq('gestor', gestor)
            .eq('original_url', longLink)
            .maybeSingle();

        if (linkData && linkData.slug) {
            return `${window.location.origin}${window.location.pathname}?s=${linkData.slug}`;
        }

        // 2. Si no existe, crear uno nuevo
        const newSlug = Math.random().toString(36).substring(2, 7);
        const { error: insError } = await supabaseClient.from('short_links').insert([{
            slug: newSlug,
            original_url: longLink,
            gestor: gestor
        }]);

        if (insError) throw insError;
        return `${window.location.origin}${window.location.pathname}?s=${newSlug}`;

    } catch (e) {
        console.error("Error en ShortLink:", e);
        return longLink; // Respaldo: devuelve el link largo si falla
    }
}

    // Funci√≥n para copiar texto de venta profesional con enlace de afiliado
    async function copySmartOffer(btnElement) {
    if(!selectedProduct) return;
    
    const gestor = window.gestorName || 'Ventas';
    const miTelefono = getAgentPhone(); // <--- Aqu√≠ usamos el "Cerebro"
    
    let longLink = `${window.location.origin}${window.location.pathname}?search=${encodeURIComponent(selectedProduct.nombre)}&gestor=${encodeURIComponent(gestor)}&tel=${miTelefono}`;
    const finalLink = await getOrGenerateShortLink(gestor, longLink);

    const textoVenta = 
`üî• *¬°OFERTA ESPECIAL!* üî•
üì¶ Modelo: *${selectedProduct.nombre}*

üí∞ Precio: *$${selectedProduct.precio} USD*
üöö Mensajer√≠a: ${selectedProduct.mensajeria || 'A consultar'}
üõ°Ô∏è Garant√≠a: ${selectedProduct.garantia || 'Garant√≠a Oficial'}

üëá *Ver fotos y detalles aqu√≠:*
${finalLink}

‚úÖ *Pedir ahora por WhatsApp:*
https://wa.me/${miTelefono}?text=${encodeURIComponent('Hola, me interesa el equipo: ' + selectedProduct.nombre)}`;

    navigator.clipboard.writeText(textoVenta).then(() => {
        const originalText = btnElement.innerHTML;
        btnElement.innerHTML = `<span class="material-symbols-outlined text-xl text-green-500">check</span>Copiado`;
        setTimeout(() => { btnElement.innerHTML = originalText; }, 2000);
    });
}

// ==========================================
// NUEVO: M√ìDULO PRO PARA GESTORES 2.0
// ==========================================

// --- 1. L√ìGICA DE FILTROS Y ORDENAMIENTO ---

function applySort() {
    const criteria = document.getElementById('sort-selector').value;
    let sorted = [...productosRaw]; // Copia para no da√±ar original

    switch (criteria) {
        case 'comision_desc':
            // Ordenar por comisi√≥n (mayor a menor)
            sorted.sort((a, b) => (parseFloat(b.comision) || 0) - (parseFloat(a.comision) || 0));
            break;
        case 'precio_asc':
            sorted.sort((a, b) => parseFloat(a.precio) - parseFloat(b.precio));
            break;
        case 'precio_desc':
            sorted.sort((a, b) => parseFloat(b.precio) - parseFloat(a.precio));
            break;
        case 'nuevo':
            // Asumimos que ID m√°s alto o fecha 'created_at' es m√°s nuevo
            sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            break;
        default:
            // Por defecto (Alfab√©tico o como venga de DB)
            sorted.sort((a, b) => a.nombre.localeCompare(b.nombre));
    }
    
    // Renderizamos pasando la lista ordenada
    renderProductsCustom(sorted);
}

function renderProductsCustom(lista) {
    const container = document.getElementById('productos-container');
    const isGestor = window.gestorName ? true : false;
    
    container.innerHTML = lista.map(p => {
        const precio = parseFloat(p.precio) || 0;
        
        // --- INICIO: NUEVA L√ìGICA DE PRECIOS INTELIGENTE (IGUAL QUE EN RENDERPRODUCTS) ---
        let pDisplay = `$${precio}`; // Valor por defecto

        if (showInCUP) {
            // Usamos la misma funci√≥n inteligente
            const precioCUP = calculateProductCUP(precio, p.pagos);
            
            if (precioCUP) {
                // Formato limpio
                pDisplay = `CUP ${precioCUP.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            } else {
                // Si el producto no acepta CUP
                pDisplay = "<span class='text-sm text-gray-400'>Solo USD/EUR</span>";
            }
        }
        // --- FIN: NUEVA L√ìGICA ---
        
        // Etiqueta de Comisi√≥n + Indicador de Precio Flexible
        let htmlComision = isGestor ? 
            `<div class="absolute top-2 right-2 flex flex-col items-end gap-1 z-10">
                <span class="bg-emerald-500 text-white text-[10px] font-black px-2 py-1 rounded-lg shadow-md">GANAS $${p.comision || 0}</span>
                ${p.precio_flexible === 'SI' ? '<span class="bg-blue-600 text-white text-[9px] font-bold px-2 py-1 rounded-lg shadow-md border border-white">üìà PRECIO LIBRE</span>' : ''}
             </div>` : '';

             // Esta l√≠nea limpia tanto la comilla simple como la comilla doble de las pulgadas
            const nombreSeguro = p.nombre.replace(/'/g, "\\'").replace(/"/g, "&quot;");

        return `
        <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden border border-slate-100 dark:border-gray-700 group shadow-sm hover:shadow-xl transition-all duration-300 relative flex flex-col">
            ${htmlComision}
            
            

        
            <div onclick="openDetail('${nombreSeguro}')" class="w-full aspect-square bg-slate-50 dark:bg-gray-900 p-4 relative overflow-hidden cursor-pointer">
                <div class="absolute inset-0 bg-center bg-no-repeat bg-contain transition-transform group-hover:scale-110 duration-500" style="background-image: url('${fixDriveUrl(p.thumbnail)}');"></div>
            </div>

            <!-- Info -->
            <div class="p-5 flex flex-col gap-2 flex-1">
                <h3 class="text-slate-800 dark:text-white text-sm font-bold leading-snug line-clamp-2 min-h-[2.5rem]">${p.nombre}</h3>
                <p class="text-primary text-2xl font-black">${pDisplay}</p>
                
                <!-- Aqu√≠ tambi√©n cambiamos a nombreSeguro -->
                <button onclick="openDetail('${nombreSeguro}')" class="mt-auto w-full flex items-center justify-center gap-2 bg-primary text-white py-2.5 rounded-lg text-xs font-extrabold hover:bg-secondary transition-colors shadow-md">
                    Ver Detalles
                </button>
            </div>

            <!-- BARRA SOCIAL -->
            <div class="grid grid-cols-2 border-t border-gray-100 dark:border-gray-700 divide-x divide-gray-100 dark:divide-gray-700 bg-gray-50 dark:bg-gray-900/50">
                <button onclick="shareProductSocial('${p.nombre.replace(/'/g, "\\'")}', 'wa')" class="py-3 flex items-center justify-center gap-1 text-gray-400 hover:text-green-500 hover:bg-green-50 transition-all">
                    <i class="fab fa-whatsapp text-lg"></i> <span class="text-[9px] font-bold uppercase">Estado</span>
                </button>
                <button onclick="shareProductSocial('${p.nombre.replace(/'/g, "\\'")}', 'fb')" class="py-3 flex items-center justify-center gap-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition-all">
                    <i class="fab fa-facebook text-lg"></i> <span class="text-[9px] font-bold uppercase">Post</span>
                </button>
            </div>
        </div>`;
    }).join('');
}

// IMPORTANTE: Modificar la funci√≥n 'renderProducts' original para que use esta si no hay filtros,
// O simplemente llamar a applySort() al cargar si hay gestor.
// Agrega esto dentro de tu 'setupSession' cuando el modo NO es admin:
// document.getElementById('gestor-filters').classList.remove('hidden');

// --- 2. L√ìGICA DE ANAL√çTICA (HORARIOS Y TENDENCIAS) ---

async function loadAnalyticsPro(nombreGestor) {
    const { data: pedidos, error } = await supabaseClient.from('pedidos').select('*');
    if (error || !pedidos) return;

    const level = window.currentGestorLevel || 0;
    const misPedidos = pedidos.filter(p => p.gestor === nombreGestor && p.estado !== 'Cancelado');

    // --- MEJOR HORARIO (EL OR√ÅCULO DE VENTAS) ---
    const elHorario = document.getElementById('ana-hora-pico');
    if (elHorario) {
        if (level >= 4) {
            elHorario.innerText = getPeakSalesTime(misPedidos);
            elHorario.className = "text-3xl font-black text-primary animate-pulse";
        } else {
            elHorario.innerHTML = `
                <div class="flex flex-col items-center justify-center py-2 opacity-40">
                    <span class="material-symbols-outlined text-4xl mb-2">lock_clock</span>
                    <p class="text-[10px] font-bold uppercase tracking-widest text-center">
                        <span class="text-primary">El Or√°culo</span> bloqueado<br>
                        Sube a Nivel 4 para ver tus horas de cierre.
                    </p>
                </div>`;
        }
    }

    // --- TENDENCIA GLOBAL (EL RADAR DE DINERO) ---
    const elTendencia = document.getElementById('ana-tendencia-global');
    if (elTendencia) {
        if (level >= 3) {
            const tendencias = getGlobalTrendRadar(pedidos);
            elTendencia.innerHTML = tendencias.map((t, i) => `
                <div class="flex justify-between items-center mb-1 group">
                    <span class="text-[10px] font-black uppercase text-gray-500">#${i+1} ${t.name}</span>
                    <span class="bg-emerald-100 text-emerald-600 text-[10px] font-black px-2 py-0.5 rounded-full">
                        ${t.count} VENTAS HOY
                    </span>
                </div>
            `).join('');
        } else {
            elTendencia.innerHTML = `
                <div class="flex flex-col items-center justify-center py-2">
                    <div class="relative mb-2">
                        <span class="material-symbols-outlined text-4xl text-slate-200">radar</span>
                        <span class="material-symbols-outlined absolute top-0 right-0 text-sm text-red-500 animate-ping">lock</span>
                    </div>
                    <p class="text-[10px] font-bold uppercase tracking-widest text-center text-slate-300">
                        <span class="text-slate-400">Radar de Mercado</span> Bloqueado<br>
                        Mira qu√© est√°n vendiendo los Pro en Nivel 3.
                    </p>
                </div>`;
        }
    }
}


// --- 3. L√ìGICA DE REPORTES (BUZ√ìN) ---

function previewReportImg() {
    const input = document.getElementById('rep-file');
    if(input.files && input.files[0]) {
        document.getElementById('rep-file-name').innerText = "üì∑ " + input.files[0].name;
    }
}

async function sendGestorReport() {
    const gestor = window.gestorName;
    const tipo = document.getElementById('rep-tipo').value;
    const msg = document.getElementById('rep-msg').value;
    const fileInput = document.getElementById('rep-file');
    
    if (!msg) return alert("Por favor describe el detalle.");
    
    // Subir imagen si existe
    let imgUrl = null;
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const fileName = `reportes/${Date.now()}_${gestor}_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
        
        // Usamos la misma l√≥gica de upload que ya tienes, pero al bucket 'reportes' o 'productos' si no creaste otro
        // Si no creaste bucket 'reportes', usa 'productos' temporalmente
        const { data, error } = await supabaseClient.storage.from('productos').upload(fileName, file);
        if (!error) imgUrl = fileName;
    }

    // Guardar en Base de Datos
    const { error } = await supabaseClient.from('reportes_gestor').insert([{
        gestor: gestor,
        categoria: tipo,
        mensaje: msg,
        imagen_url: imgUrl,
        estado: 'Pendiente'
    }]);

    if (error) {
        alert("Error al enviar reporte: " + error.message);
    } else {
        alert("‚úÖ Gracias por tu aporte. Lo revisaremos.");
        document.getElementById('form-reporte-gestor').reset();
        document.getElementById('rep-file-name').innerText = "";
    }
}

// ==========================================
// FORZAR FUNCI√ìN DE SALIDA (GLOBAL)
// ==========================================
window.doLogout = function() {
    console.log("Bot√≥n de salir presionado..."); // Esto aparecer√° en la consola si funciona
    
    // 1. Preguntar confirmaci√≥n
    if(confirm("¬øEst√°s seguro de que quieres cerrar sesi√≥n y salir?")) {
        
        // 2. Borrar la memoria del navegador
        localStorage.removeItem('pth_session');
        
        // 3. Limpiar variables globales por si acaso
        window.gestorName = null;
        window.currentUserData = null;

        // 4. Limpiar la URL (quitar ?gestor=... si existe) y recargar
        // Esto lleva al usuario de vuelta a la pantalla de Login limpia
        window.location.href = window.location.origin + window.location.pathname;
    }
};
// ==========================================
    // HERRAMIENTAS DE MARKETING MASIVO
    // ==========================================

    // 1. COPIAR LISTA DE OFERTAS (AMETRALLADORA)
    async function copyCategoryOffers() {
    const gestor = window.gestorName || 'Ventas';
    const miTelefono = getAgentPhone(); // <--- Aqu√≠ usamos el "Cerebro"
    
    const visibleProducts = productosRaw.filter(p => {
        return (activeCategory === 'TODOS' || (p.categoria && p.categoria.toUpperCase().includes(activeCategory))) && p.disponible === "SI";
    });

    if (visibleProducts.length === 0) return alert("No hay productos.");

    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.innerHTML = `‚è≥ Procesando links...`;

    let textoFinal = `üåü *CAT√ÅLOGO DISPONIBLE - ${activeCategory}* üåü\n\n`;

    for (const p of visibleProducts) {
        // Construimos link con TU tel√©fono
        let rawLink = `${window.location.origin}${window.location.pathname}?search=${encodeURIComponent(p.nombre)}&gestor=${encodeURIComponent(gestor)}&tel=${miTelefono}`;
        let linkInteligente = await getOrGenerateShortLink(gestor, rawLink);

        textoFinal += `üì¶ *${p.nombre}*\n`;
        textoFinal += `üí∞ Precio: $${p.precio} USD\n`;
        textoFinal += `üîó Ver: ${linkInteligente}\n`;
        textoFinal += `--------------------------------\n`;
    }

    // El link de abajo ahora usar√° TU tel√©fono obligatoriamente
    textoFinal += `\n‚úÖ *Pedir aqu√≠:* https://wa.me/${miTelefono}`;

    navigator.clipboard.writeText(textoFinal).then(() => {
        btn.innerHTML = `‚úÖ ¬°COPIADO!`;
        setTimeout(() => { btn.innerHTML = originalText; }, 2000);
    });
}

    // 2. DESCARGAR PACK DE FOTOS (ZIP)
    async function downloadCategoryPhotos() {
        if (typeof JSZip === 'undefined') return alert("Librer√≠a ZIP no cargada. Recarga la p√°gina.");

        const visibleProducts = productosRaw.filter(p => {
            return (activeCategory === 'TODOS' || (p.categoria && p.categoria.toUpperCase().includes(activeCategory))) && p.disponible === "SI";
        });

        if (visibleProducts.length === 0) return alert("No hay productos.");
        if (visibleProducts.length > 20) {
            if(!confirm(`Vas a descargar ${visibleProducts.length} im√°genes. Esto puede tardar unos segundos. ¬øContinuar?`)) return;
        }

        const btn = event.currentTarget;
        const oldText = btn.innerHTML;
        btn.innerHTML = `‚è≥ Comprimiendo...`;
        btn.disabled = true;

        const zip = new JSZip();
        const folder = zip.folder(`Catalogo_${activeCategory}`);

        try {
            // Recorremos productos y descargamos fotos
            const promises = visibleProducts.map(async (p) => {
                try {
                    const url = fixDriveUrl(p.thumbnail);
                    const response = await fetch(url);
                    if(!response.ok) throw new Error('Network response was not ok');
                    const blob = await response.blob();
                    
                    // Nombre del archivo limpio
                    const safeName = p.nombre.replace(/[^a-z0-9]/gi, '_').substring(0, 50);
                    folder.file(`${safeName}.jpg`, blob);
                } catch (err) {
                    console.warn("Error descargando imagen para ZIP:", p.nombre);
                }
            });

            await Promise.all(promises);

            // Generar ZIP y descargar
            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(content);
            link.download = `Pack_Fotos_${activeCategory}_${new Date().toLocaleDateString()}.zip`;
            link.click();

            alert("‚úÖ Pack descargado exitosamente.");

        } catch (e) {
            console.error(e);
            alert("Hubo un error generando el ZIP.");
        } finally {
            btn.innerHTML = oldText;
            btn.disabled = false;
        }
    }
    // ==========================================
    // FUNCIONES POWER-UP (PDF, STORY, SOCIAL)
    // ==========================================

    // 1. FILTRO TIBUR√ìN (Actualizaci√≥n de renderProducts)
    // Busca tu funci√≥n 'renderProducts' antigua y aseg√∫rate de a√±adir esta l√≥gica de filtrado:
    /*
        const filterHighComm = document.getElementById('filter-high-comm')?.checked;
        
        const filtered = productosRaw.filter(p => {
            // ... (tus filtros anteriores) ...
            const matchComm = !filterHighComm || (Number(p.comision) > 10); // L√≥gica nueva
            
            return matchSearch && matchCat && matchComm && p.disponible === "SI";
        });
    */

    // 2. COMPARTIR REDES SOCIALES
    async function shareProductSocial(name, network) {
    const p = productosRaw.find(prod => prod.nombre === name);
    if(!p) return;

    const gestor = window.gestorName || '';
    const userData = window.currentUserData || {};
    const miTelefono = userData.telefono || new URLSearchParams(window.location.search).get('tel') || '';
    
    let rawLink = `${window.location.origin}${window.location.pathname}?search=${encodeURIComponent(p.nombre)}`;
    if (gestor) rawLink += `&gestor=${encodeURIComponent(gestor)}&tel=${miTelefono}`;

    // Generar link corto antes de compartir
    const finalLink = await getOrGenerateShortLink(gestor, rawLink);


    if (network === 'wa') {
        const text = `üî• ¬°Oferta Flash! *${p.nombre}* a solo *$${p.precio} USD*. \n\nVer detalles aqu√≠: ${finalLink}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
    } else if (network === 'fb') {
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(finalLink)}`, '_blank');
    }
}

    // ==========================================
    // 4. GENERADOR DE INSTAGRAM STORY (DISE√ëO PREMIUM)
    // ==========================================
    async function generateStoryImage() {
        if(!selectedProduct) return;
        
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = "üé® Dise√±ando...";
        btn.disabled = true;
        
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Resoluci√≥n HD (1080x1920)
            canvas.width = 1080;
            canvas.height = 1920;

            // --- 1. FONDO LIMPIO ---
            ctx.fillStyle = '#f8fafc'; // Gris muy claro (Slate-50)
            ctx.fillRect(0, 0, 1080, 1920);

            // --- 2. HEADER (MARCA) ---
            // Barra superior
            ctx.fillStyle = '#1a4789'; // Azul ANEB
            ctx.fillRect(0, 0, 1080, 180);
            
            // Texto Marca
            ctx.fillStyle = '#ffffff';
            ctx.font = '900 60px Manrope, sans-serif'; // Fuente gruesa
            ctx.textAlign = 'center';
            ctx.fillText("PARATUHOGAR", 540, 110);
            
            ctx.font = '500 30px Manrope, sans-serif';
            ctx.fillText("Env√≠os a toda Cuba | Garant√≠a Real", 540, 155);

            // --- 3. CONTENEDOR DE IMAGEN (TARJETA) ---
            // Dibujamos un cuadro blanco detr√°s de la foto para darle relieve
            const cardY = 300;
            const cardHeight = 900;
            const cardWidth = 900;
            const cardX = (1080 - cardWidth) / 2;

            // Sombra de la tarjeta
            ctx.shadowColor = "rgba(0, 0, 0, 0.15)";
            ctx.shadowBlur = 40;
            ctx.shadowOffsetY = 20;
            ctx.fillStyle = '#ffffff';
            
            // Funci√≥n para bordes redondeados
            roundRect(ctx, cardX, cardY, cardWidth, cardHeight, 40);
            ctx.fill();
            ctx.shadowColor = "transparent"; // Reset sombra

            // --- 4. IMAGEN DEL PRODUCTO ---
            const img = new Image();
            img.crossOrigin = "Anonymous"; 
            img.src = fixDriveUrl(selectedProduct.thumbnail);
            
            await new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = reject;
            });

            // Calcular proporciones para que quepa en el cuadro (padding 50px)
            const maxImgSize = 800;
            const scale = Math.min(maxImgSize / img.width, maxImgSize / img.height);
            const w = img.width * scale;
            const h = img.height * scale;
            const imgX = 540 - (w / 2); // Centrado horizontal
            const imgY = cardY + (cardHeight - h) / 2; // Centrado vertical en la tarjeta

            ctx.drawImage(img, imgX, imgY, w, h);

            // --- 5. DETALLES DEL PRODUCTO ---
            ctx.textAlign = 'center';
            const textYStart = 1350;

            // Etiqueta "OFERTA"
            ctx.fillStyle = '#2c6fb5'; // Azul secundario
            ctx.font = 'bold 40px Manrope, sans-serif';
            ctx.fillText("üî• DISPONIBLE AHORA", 540, textYStart);

            // Nombre del Producto (Wrapping inteligente)
            ctx.fillStyle = '#0f172a'; // Dark Slate
            ctx.font = '800 70px Manrope, sans-serif';
            wrapText(ctx, selectedProduct.nombre, 540, textYStart + 100, 950, 85);

            // PRECIO (Grande y llamativo)
            ctx.fillStyle = '#1a4789'; // Azul ANEB
            ctx.font = '900 130px Manrope, sans-serif';
            // Calculamos posici√≥n Y basada en el nombre (aprox)
            ctx.fillText(`$${selectedProduct.precio} USD`, 540, 1700);

            // --- 6. FOOTER (CONTACTO GESTOR) ---
            ctx.fillStyle = '#1a4789';
            ctx.fillRect(0, 1780, 1080, 140);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 45px Manrope, sans-serif';
            const gestor = window.gestorName || "Ventas";
            const tel = window.currentUserData?.telefono || "";
            
            // Icono de WhatsApp simulado con texto (o podr√≠as cargar un icono)
            ctx.fillText(`üìû Pide aqu√≠: ${tel}  |  üë§ Agente: ${gestor}`, 540, 1865);

            // --- 7. DESCARGAR ---
            const link = document.createElement('a');
            const cleanName = selectedProduct.nombre.replace(/[^a-z0-9]/gi, '_').substring(0, 15);
            link.download = `Story_${cleanName}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();

        } catch (e) {
            console.error(e);
            alert("Error generando dise√±o. Intenta 'Descargar Foto' normal.");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Funci√≥n auxiliar para dibujar rect√°ngulos redondeados
    function roundRect(ctx, x, y, width, height, radius) {
        ctx.beginPath();
        ctx.moveTo(x + radius, y);
        ctx.lineTo(x + width - radius, y);
        ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
        ctx.lineTo(x + width, y + height - radius);
        ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
        ctx.lineTo(x + radius, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
        ctx.lineTo(x, y + radius);
        ctx.quadraticCurveTo(x, y, x + radius, y);
        ctx.closePath();
    }

    // ==========================================
    // 3. GENERADOR DE PDF CON FOTOS (PROFESIONAL)
    // ==========================================
    // ==========================================
    // 3. GENERADOR DE PDF CON FOTOS (CORREGIDO)
    // ==========================================
    async function downloadCatalogPDF() {
        if (!window.jspdf) return alert("Cargando sistema PDF... Espera 5 segundos.");
        
        const { jsPDF } = window.jspdf;
        const gestor = window.gestorName || "Equipo de Ventas";
        const telefono = window.currentUserData?.telefono || "+53 5000 0000";

        // 1. Filtrar productos visibles
        const visibleProducts = productosRaw.filter(p => {
            return (activeCategory === 'TODOS' || (p.categoria && p.categoria.toUpperCase().includes(activeCategory))) && p.disponible === "SI";
        });

        if(visibleProducts.length === 0) return alert("No hay productos visibles para el PDF.");
        if(visibleProducts.length > 40) if(!confirm(`El cat√°logo tiene ${visibleProducts.length} productos. Generar las im√°genes tomar√° unos segundos. ¬øContinuar?`)) return;

        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = "‚è≥ Procesando im√°genes...";
        btn.disabled = true;

        try {
            const doc = new jsPDF();

            // 2. Preparar datos y PRE-CARGAR IM√ÅGENES (Base64)
            const tableData = [];
            
            for (let p of visibleProducts) {
                let imgData = null;
                try {
                    imgData = await getImageDataUrl(fixDriveUrl(p.thumbnail));
                } catch (err) {
                    console.warn("No se pudo cargar imagen para PDF:", p.nombre);
                }

                tableData.push({
                    image: imgData, 
                    info: {
                        name: p.nombre,
                        price: `$${p.precio} USD`,
                        shipping: p.mensajeria ? `Env√≠o: ${p.mensajeria}` : "Mensajer√≠a: Consultar",
                        warranty: p.garantia || "Garant√≠a: Oficial"
                    }
                });
            }

            // 3. Dise√±o del PDF - Encabezado
            doc.setFillColor(26, 71, 137); // #1a4789
            doc.rect(0, 0, 210, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("CAT√ÅLOGO OFICIAL", 105, 15, null, null, "center");
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Categor√≠a: ${activeCategory}`, 105, 24, null, null, "center");
            doc.setFontSize(10);
            doc.text(`Agente Autorizado: ${gestor} | WhatsApp: ${telefono}`, 105, 30, null, null, "center");

            // 4. Generar Tabla con Im√°genes
            doc.autoTable({
                startY: 40,
                head: [['FOTO', 'DETALLES DEL EQUIPO', 'PRECIO']],
                body: tableData.map(row => ['', '', '']), // Celdas vac√≠as para rellenar
                theme: 'grid',
                styles: { 
                    fontSize: 12, 
                    cellPadding: 4, 
                    valign: 'middle',
                    lineColor: [200, 200, 200],
                    lineWidth: 0.1,
                    minCellHeight: 40 // Altura m√≠nima para que quepa la foto
                },
                headStyles: { 
                    fillColor: [44, 111, 181], 
                    textColor: 255, 
                    fontStyle: 'bold',
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 40 }, 
                    1: { cellWidth: 'auto' }, 
                    2: { cellWidth: 40, fontStyle: 'bold', textColor: [26, 71, 137], halign: 'center', fontSize: 14 }
                },
                didDrawCell: function(data) {
                    // Hook para dibujar contenido
                    if (data.section === 'body') {
                        const rowIndex = data.row.index;
                        
                        // --- L√çNEA DE SEGURIDAD (CORRECCI√ìN) ---
                        // Si por alguna raz√≥n el √≠ndice no existe, salimos para evitar el error
                        if (!tableData[rowIndex]) return; 
                        
                        const rowData = tableData[rowIndex];

                        // DIBUJAR IMAGEN (Columna 0)
                        if (data.column.index === 0 && rowData.image) {
                            try {
                                doc.addImage(rowData.image, 'JPEG', data.cell.x + 2, data.cell.y + 2, 36, 36);
                            } catch(e) { /* Ignorar error de imagen corrupta */ }
                        }

                        // DIBUJAR DETALLES (Columna 1)
                        if (data.column.index === 1) {
                            doc.setFontSize(12);
                            doc.setTextColor(0, 0, 0);
                            doc.setFont("helvetica", "bold");
                            
                            // Texto con ajuste autom√°tico de ancho
                            var splitTitle = doc.splitTextToSize(rowData.info.name, data.cell.width - 4);
                            doc.text(splitTitle, data.cell.x + 2, data.cell.y + 8);
                            
                            doc.setFontSize(10);
                            doc.setTextColor(100, 100, 100);
                            doc.setFont("helvetica", "normal");
                            doc.text(rowData.info.shipping, data.cell.x + 2, data.cell.y + 28);
                            doc.text(rowData.info.warranty, data.cell.x + 2, data.cell.y + 34);
                        }

                        // DIBUJAR PRECIO (Columna 2)
                        if (data.column.index === 2) {
                            doc.text(rowData.info.price, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2, { align: 'center', baseline: 'middle' });
                        }
                    }
                }
            });

            // Pie de p√°gina
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`P√°gina ${i} de ${pageCount} - Generado por paratuhogar`, 105, 290, null, null, "center");
            }

            // Descargar
            doc.save(`Catalogo_${activeCategory}_${gestor.replace(/\s+/g, '_')}.pdf`);
            alert("‚úÖ Cat√°logo PDF descargado correctamente.");

        } catch (e) {
            console.error(e);
            alert("Error generando PDF: " + e.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Helper: Obtener imagen en Base64 para el PDF
    function getImageDataUrl(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = url;
            img.onload = () => {
                const canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL("image/jpeg"));
            };
            img.onerror = (e) => reject(e);
        });
    }

    

    // Auxiliar para texto en varias l√≠neas (Story)
    function wrapText(context, text, x, y, maxWidth, lineHeight) {
        var words = text.split(' ');
        var line = '';

        for(var n = 0; n < words.length; n++) {
          var testLine = line + words[n] + ' ';
          var metrics = context.measureText(testLine);
          var testWidth = metrics.width;
          if (testWidth > maxWidth && n > 0) {
            context.fillText(line, x, y);
            line = words[n] + ' ';
            y += lineHeight;
          }
          else {
            line = testLine;
          }
        }
        context.fillText(line, x, y);
    }

    // ==========================================
    // L√ìGICA DE ACCESO Y SEGURIDAD (RESTAURADA)
    // ==========================================

    // 1. Alternar entre Login y Registro
    function toggleLoginMode(mode) {
        const isLogin = mode === 'login';
        document.getElementById('form-login').classList.toggle('hidden', !isLogin);
        document.getElementById('form-register').classList.toggle('hidden', isLogin);
        
        document.getElementById('tab-login-btn').className = isLogin ? "flex-1 pb-2 font-black text-xs uppercase text-primary border-b-2 border-primary" : "flex-1 pb-2 font-black text-xs uppercase text-gray-400";
        document.getElementById('tab-register-btn').className = !isLogin ? "flex-1 pb-2 font-black text-xs uppercase text-primary border-b-2 border-primary" : "flex-1 pb-2 font-black text-xs uppercase text-gray-400";
    }

    // 2. Proceso de Login
    // PROCESO DE LOGIN √öNICO Y SEGURO (ADMIN + GESTORES + ESTADOS)
// PROCESO DE LOGIN √öNICO Y SEGURO (ADMIN + GESTORES + ESTADOS)
// PROCESO DE LOGIN √öNICO Y SEGURO (ADMIN + GESTORES + ESTADOS)
async function processLogin() {
    const userInput = document.getElementById('log-user');
    const passInput = document.getElementById('log-pass');
    
    const user = userInput ? userInput.value.trim() : "";
    const pass = passInput ? passInput.value.trim() : "";

    // --- CLAVES MAESTRAS ---
    // 1. Clave de Log√≠stica (Solo ve pedidos)
    const KEY_LOGISTICA = "PRO_ADMIN_2025"; 
    
    // 2. Clave del DUE√ëO (Ve el Dinero) - ¬°CAMBIA ESTA SI QUIERES!
    const KEY_DUENO = "ANGEL_ORO"; 

    // --- CASO A: NIVEL DUE√ëO (SUPERADMIN) ---
    if (pass === KEY_DUENO) { 
        closeLogin();
        const bossData = { nombre: "√Ångel (Due√±o)", telefono: "5356071095", rol: 'superadmin' }; // Rol clave
        window.currentUserData = bossData;
        
        saveSessionToMemory("Administrador Supremo", true, bossData); 
        setupSession("Administrador Supremo", true);
        alert("üîì B√ìVEDA FINANCIERA DESBLOQUEADA");
        return;
    }

    // --- CASO B: NIVEL LOG√çSTICA (ADMIN SIMPLE) ---
    if (pass === KEY_LOGISTICA) { 
        closeLogin();
        // Nota: El rol es 'logistica', NO 'superadmin'. Esto le proh√≠be entrar al master.html
        const adminData = { nombre: "Encargado Log√≠stica", telefono: "5356071095", rol: 'logistica' }; 
        window.currentUserData = adminData;
        
        saveSessionToMemory("Log√≠stica", true, adminData); 
        setupSession("Log√≠stica", true);
        return;
    }

    // --- CASO C: GESTOR (Validaci√≥n Normal) ---
    if (!user || !pass) {
        return alert("Por favor ingresa usuario y contrase√±a.");
    }

    try {
        const { data, error } = await supabaseClient
            .from('gestores')
            .select('*')
            .eq('nombre', user)
            .eq('password', pass)
            .single();

        if (error || !data) {
            alert("‚ùå Usuario o contrase√±a incorrectos.");
        } else {
            if (data.estado === 'pendiente') return alert("‚è≥ Cuenta en revisi√≥n.");
            if (data.estado === 'bloqueado') return alert("üö´ Cuenta suspendida.");

            closeLogin();
            window.currentUserData = data; 
            saveSessionToMemory(data.nombre, false, data); 
            setupSession(data.nombre, false);
        }
    } catch (e) {
        console.error(e);
        alert("Error de conexi√≥n.");
    }
}

    // 3. Proceso de Registro
    

    // 4. Funciones Auxiliares
    function saveSessionToMemory(name, isAdmin, data) {
        const session = { name: name, isAdmin: isAdmin, data: data };
        localStorage.setItem('pth_session', JSON.stringify(session));
    }

    function closeLogin() { 
        document.getElementById('login-overlay').classList.add('hidden'); 
    }

    // ==========================================
// 1. L√ìGICA DE LOG√çSTICA (PESTA√ëAS)
// ==========================================
// Variable global para controlar el filtro
let currentStatusFilter = 'TODOS';

function filterLogisticaByStatus(status, btnElement) {
    currentStatusFilter = status;
    
    // 1. Soluci√≥n al error de "innerText of null":
    // Verificamos si el elemento existe antes de intentar escribir en √©l
    const label = document.getElementById('label-estado-actual');
    if (label) {
        label.innerText = status;
    }

    // 2. Gesti√≥n Visual de los Botones (Estilo Activo)
    // Quitamos el estilo 'active' de todos y lo ponemos solo al clickeado
    if (btnElement) {
        document.querySelectorAll('.btn-filter').forEach(b => {
            // Restaurar estilo base (gris/transparente)
            b.classList.remove('bg-primary', 'text-white', 'shadow-md');
            b.classList.add('text-gray-500', 'border-transparent');
        });
        
        // Aplicar estilo activo al bot√≥n actual
        btnElement.classList.remove('text-gray-500', 'border-transparent');
        btnElement.classList.add('bg-primary', 'text-white', 'shadow-md');
    }

    // 3. Renderizar la tabla con el nuevo filtro
    renderAdminLogistica();
}



// Exportar SOLO lo que se ve en pantalla (Filtrado)
function exportLogisticaCurrentView() {
    // Reutilizamos la tabla HTML ya renderizada porque ya tiene los filtros aplicados
    exportToExcel('admin-table-logistica', `Pedidos_${currentStatusFilter}`);
}


// ==========================================
// 2. L√ìGICA DE INVENTARIO (BUSCADOR + EXPORTAR)
// ==========================================

// Variable global para inventario (necesaria para el buscador)


// Modificamos la carga de admin para llenar esta variable
/* 
   EN TU FUNCI√ìN loadAdminData(), ASEG√öRATE DE A√ëADIR ESTO:
   if (productos) {
       inventoryRawAdmin = productos; // <--- GUARDAR AQU√ç
       renderAdminInventario(); // Llamar sin argumentos
   }
*/



// Exportar Inventario a Excel (Limpio)
function exportInventoryExcel() {
    if(!inventoryRawAdmin || inventoryRawAdmin.length === 0) return alert("No hay datos");

    // Preparamos datos limpios para el Excel
    const dataForExcel = inventoryRawAdmin.map(p => ({
        SKU_Virtual: (p.categoria ? p.categoria.substring(0,3).toUpperCase() : "GEN") + "-" + p.id.substring(0,4).toUpperCase(),
        Producto: p.nombre,
        Precio_USD: p.precio,
        Comision_Gestor: p.comision,
        Categoria: p.categoria,
        Stock: p.disponible,
        Garantia: p.garantia
    }));

    const ws = XLSX.utils.json_to_sheet(dataForExcel);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventario");
    XLSX.writeFile(wb, `Inventario_ANEB_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
}

// FUNCI√ìN PARA ACTUALIZAR CATEGOR√çAS EN EL FORMULARIO
    function updateFormCategories() {
        // Usamos la lista de inventario o la de productos, la que tenga datos
        const source = (typeof inventoryRawAdmin !== 'undefined' && inventoryRawAdmin.length > 0) 
                       ? inventoryRawAdmin 
                       : productosRaw;
        
        if (!source || source.length === 0) return;

        // Extraer categor√≠as √∫nicas y ordenarlas
        const uniqueCats = [...new Set(source.map(p => p.categoria ? p.categoria.toUpperCase().trim() : 'VARIOS'))].sort();
        
        // Llenar el datalist
        const datalist = document.getElementById('lista-categorias');
        if (datalist) {
            datalist.innerHTML = uniqueCats.map(cat => `<option value="${cat}">`).join('');
        }
    }
    // --- FUNCI√ìN DE EXPORTACI√ìN EXCEL AVANZADA (LOG√çSTICA) ---
function exportLogisticaExcel() {
    // 1. Validar que haya datos
    if (!pedidosRawAdmin || pedidosRawAdmin.length === 0) {
        return alert("No hay datos cargados para exportar.");
    }

    const searchInput = document.getElementById('search-logistica');
    const query = searchInput ? searchInput.value.toLowerCase() : "";

    // 2. Aplicar los MISMOS filtros que se ven en pantalla
    const datosFiltrados = pedidosRawAdmin.filter(p => {
        // Filtro de Texto
        const fecha = new Date(p.fecha).toLocaleDateString().toLowerCase();
        const textoMatch = fecha.includes(query) || 
                           (p.cliente || "").toLowerCase().includes(query) || 
                           (p.proveedor || "").toLowerCase().includes(query) || 
                           (p.gestor || "").toLowerCase().includes(query);
        
        // Filtro de Estado
        let estadoMatch = false;
        if (currentStatusFilter === 'TODOS') estadoMatch = true;
        else if (currentStatusFilter === 'FINALIZADOS') estadoMatch = (p.estado === 'Entregado' || p.estado === 'Cancelado');
        else estadoMatch = (p.estado === currentStatusFilter);

        return textoMatch && estadoMatch;
    });

    if (datosFiltrados.length === 0) {
        return alert("No hay pedidos que coincidan con los filtros actuales.");
    }

    // 3. Formatear los datos para que el Excel se vea Profesional
    // Aqu√≠ elegimos qu√© columnas salen y con qu√© nombre
    const dataParaExcel = datosFiltrados.map(p => ({
        "Fecha": new Date(p.fecha).toLocaleDateString(),
        "Cliente": p.cliente,
        "CI": p.ci || '-',
        "Tel√©fono": p.telefono,     // ¬°Muy importante para log√≠stica!
        "Direcci√≥n": p.direccion,   // ¬°Muy importante para log√≠stica!
        "Proveedor": p.proveedor || 'General',
        "Producto": p.producto,
        "Gestor": p.gestor,
        "Total Venta": p.total,
        "Comisi√≥n Gestor": p.comision_total,
        "Estado Actual": p.estado,  // Saldr√° el texto limpio (ej: "Pendiente")
        "Pago Comisi√≥n": p.pago_gestor || 'Pendiente'
    }));

    // 4. Generar el archivo
    const ws = XLSX.utils.json_to_sheet(dataParaExcel);
    
    // Ajustar ancho de columnas autom√°ticamente (Opcional, pero se ve mejor)
    const wscols = [
        {wch: 12}, // Fecha
        {wch: 25}, // Cliente
        {wch: 15}, // CI
        {wch: 15}, // Tel√©fono
        {wch: 40}, // Direcci√≥n
        {wch: 15}, // Proveedor
        {wch: 40}, // Producto
        {wch: 20}, // Gestor
        {wch: 10}, // Total
        {wch: 10}, // Comisi√≥n
        {wch: 15}, // Estado
        {wch: 15}  // Pago
    ];
    ws['!cols'] = wscols;

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Log√≠stica");

    // Nombre del archivo con fecha y filtro
    const fechaHoy = new Date().toLocaleDateString().replace(/\//g, '-');
    XLSX.writeFile(wb, `Logistica_${currentStatusFilter}_${fechaHoy}.xlsx`);
}

// --- FUNCI√ìN PARA ACTUALIZAR PRECIO Y COMISI√ìN ---
function updateCartItemPrice(index, newValue) {
    const item = cart[index];
    let newPrice = parseFloat(newValue);

    // 1. Validaciones de Seguridad
    const minPrice = Number(item.precio) - Number(item.comision);
    const maxPrice = (item.precio_flexible === 'SI') ? 100000 : Number(item.precio);

    // Si intenta bajar del costo, lo corregimos al m√≠nimo
    if (newPrice < minPrice) {
        alert("‚ö†Ô∏è No puedes rebajar m√°s all√° de tu comisi√≥n.");
        newPrice = minPrice;
    }
    // Si intenta subir y no es flexible, lo corregimos al m√°ximo
    if (newPrice > maxPrice) {
        alert("üîí Este producto tiene precio fijo. No puedes aumentarlo.");
        newPrice = maxPrice;
    }

    // 2. Aplicar cambios
    item.precio_venta = newPrice;
    
    // 3. Recalcular Comisi√≥n
    // F√≥rmula: Comisi√≥n Original + (Sobreprecio) o - (Descuento)
    // Matem√°ticamente: Comisi√≥n Original + (PrecioVenta - PrecioOriginal)
    const diferencia = newPrice - Number(item.precio);
    item.comision_actual = Number(item.comision) + diferencia;

    // 4. Actualizar vista
    renderCart(); // Vuelve a pintar para mostrar la nueva ganancia y validar input
}
// Variable global para la tasa
let globalCUPRate = 450; 

// Al cargar la p√°gina, intentamos recuperar la tasa guardada
window.addEventListener('load', () => {
    const savedRate = localStorage.getItem('pth_daily_rate');
    if(savedRate) {
        globalCUPRate = parseFloat(savedRate);
        const input = document.getElementById('daily-rate');
        if(input) input.value = globalCUPRate;
    }
    // ... resto de tu window.load
});

function updateGlobalRate(val) {
    globalCUPRate = parseFloat(val);
    localStorage.setItem('pth_daily_rate', val); // Guardar para que no se borre al recargar
    
    // Si est√°s en el cat√°logo (vista cliente/gestor), refrescar productos
    if(!document.getElementById('sec-catalogo').classList.contains('hidden')) {
        renderProducts();
    }
    // Si est√°s en admin, refrescar tablas
    if(!document.getElementById('sec-admin-master').classList.contains('hidden')) {
        renderAdminCortes(); // Para recalcular pagos en CUP
    }
}

// --- FUNCI√ìN MAESTRA DE C√ÅLCULO DE PRECIO CUP ---
function calculateProductCUP(priceUSD, pagosString) {
    if (!pagosString) return priceUSD * globalCUPRate; // Si no hay info, usar tasa general

    const str = pagosString.toLowerCase();
    
    // CASO 1: Tasa Fija (Ej: "CUP efectivo 470", "CUP 470")
    // Buscamos un n√∫mero grande (mayor a 100) cerca de la palabra CUP
    // Regex: Busca 'cup' seguido de cualquier cosa y luego un n√∫mero de 3 d√≠gitos
    const fixedMatch = str.match(/cup.*?(\d{3,})/);
    if (fixedMatch) {
        const fixedRate = parseFloat(fixedMatch[1]);
        return priceUSD * fixedRate;
    }

    // CASO 2: Tasa Variable con Plus (Ej: "CUP +10")
    const plusMatch = str.match(/cup\s*\+\s*(\d+)/);
    if (plusMatch) {
        const extra = parseFloat(plusMatch[1]);
        return priceUSD * (globalCUPRate + extra);
    }

    // CASO 3: Solo dice "CUP" sin n√∫meros -> Usa Tasa del D√≠a
    if (str.includes('cup')) {
        return priceUSD * globalCUPRate;
    }

    // CASO 4: No acepta CUP (No dice CUP en ning√∫n lado)
    return null; // Indicador de que no acepta CUP
}

// Llamar a esto dentro de loadAdminData()
// if (pedidos && productos) { renderAnaliticaCompleta(pedidos, productos, vistas); }

function renderAnaliticaCompleta(pedidos, productos, vistasRaw) {
    renderAnaliticaProveedores(pedidos);
    renderAnaliticaCancelacion(pedidos);
    renderAnaliticaConversion(pedidos, vistasRaw);
    renderAnaliticaZombies(pedidos, productos);
    renderAnaliticaGestores(pedidos);
}

// 1. TOP PROVEEDORES (Facturaci√≥n)
function renderAnaliticaProveedores(pedidos) {
    const ventas = pedidos.filter(p => p.estado !== 'Cancelado');
    const mapProv = {};

    ventas.forEach(p => {
        const prov = p.proveedor || 'General';
        mapProv[prov] = (mapProv[prov] || 0) + Number(p.total || 0);
    });

    const sorted = Object.entries(mapProv).sort(([,a], [,b]) => b - a);

    document.getElementById('list-analitica-proveedores').innerHTML = sorted.map(([name, total], i) => `
        <div class="flex justify-between items-center text-[10px] border-b border-indigo-50 dark:border-gray-700 pb-2 last:border-0">
            <div class="flex items-center gap-2">
                <span class="font-bold text-indigo-300 w-4">#${i+1}</span>
                <span class="font-black uppercase text-gray-700 dark:text-gray-300">${name}</span>
            </div>
            <span class="font-black text-indigo-600 bg-indigo-50 dark:bg-indigo-900/50 px-2 py-0.5 rounded">$${total.toLocaleString()}</span>
        </div>
    `).join('');
}

// 2. TASA DE CANCELACI√ìN
function renderAnaliticaCancelacion(pedidos) {
    const total = pedidos.length;
    if (total === 0) return;

    const cancelados = pedidos.filter(p => p.estado === 'Cancelado').length;
    const rate = (cancelados / total) * 100;

    document.getElementById('stat-cancel-rate').innerText = `${rate.toFixed(1)}%`;
    document.getElementById('bar-cancel-rate').style.width = `${Math.min(rate, 100)}%`;
    
    // Cambiar color si es alarmante (>15%)
    const bar = document.getElementById('bar-cancel-rate');
    if(rate > 15) bar.className = "bg-red-600 h-2 rounded-full animate-pulse";
    else bar.className = "bg-emerald-500 h-2 rounded-full";
}

// 3. PRODUCTOS ZOMBIE (Sin ventas)
function renderAnaliticaZombies(pedidos, productos) {
    // Crear un Set de nombres de productos vendidos para b√∫squeda r√°pida
    const vendidosSet = new Set();
    pedidos.forEach(p => {
        // Limpieza b√°sica para coincidir nombres
        // Asumiendo formato "1x Nombre [USD]"
        let nombre = p.producto;
        if(nombre.includes('x ')) nombre = nombre.split('x ')[1];
        if(nombre.includes('[')) nombre = nombre.split('[')[0].trim();
        vendidosSet.add(nombre.toLowerCase());
    });

    // Filtrar productos que NO est√°n en el set de vendidos
    const zombies = productos.filter(prod => !vendidosSet.has(prod.nombre.toLowerCase()));

    const container = document.getElementById('list-analitica-zombies');
    
    if (zombies.length === 0) {
        container.innerHTML = `<p class="text-xs text-emerald-500 font-bold">¬°Excelente! Todo el cat√°logo tiene ventas.</p>`;
        return;
    }

    container.innerHTML = zombies.map(z => `
        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-900 p-2 rounded-lg">
            <div class="flex items-center gap-2 overflow-hidden">
                <span class="material-symbols-outlined text-gray-300 text-sm">block</span>
                <span class="text-[10px] font-bold text-gray-600 truncate uppercase">${z.nombre}</span>
            </div>
            <button onclick="editProduct('${z.id}')" class="text-[9px] font-black text-primary hover:underline">REVISAR</button>
        </div>
    `).join('');
}

// 4. EFECTIVIDAD (Ventas vs Vistas) - (Igual al anterior pero refinado)
function renderAnaliticaConversion(pedidos, vistasRaw) {
    const ventasMap = {};
    pedidos.filter(p => p.estado !== 'Cancelado').forEach(p => {
        let nombre = p.producto;
        if(nombre.includes('x ')) nombre = nombre.split('x ')[1];
        if(nombre.includes('[')) nombre = nombre.split('[')[0].trim();
        ventasMap[nombre] = (ventasMap[nombre] || 0) + 1;
    });

    const vistasMap = {};
    if(vistasRaw) {
        vistasRaw.forEach(v => {
            vistasMap[v.nombre_producto] = (vistasMap[v.nombre_producto] || 0) + 1;
        });
    }

    const ratios = [];
    for (const [prod, views] of Object.entries(vistasMap)) {
        if(views > 2) { 
            const sales = ventasMap[prod] || 0;
            const rate = (sales / views) * 100;
            ratios.push({ name: prod, rate: rate });
        }
    }
    
    const sorted = ratios.sort((a,b) => b.rate - a.rate).slice(0, 5);

    document.getElementById('list-analitica-conversion').innerHTML = sorted.map(item => `
        <div class="flex justify-between items-center text-[10px] mb-2">
            <span class="font-bold text-gray-500 truncate w-2/3" title="${item.name}">${item.name}</span>
            <div class="flex items-center gap-1">
                 <div class="w-10 h-1 bg-gray-100 rounded-full"><div class="h-full bg-emerald-500" style="width: ${item.rate}%"></div></div>
                 <span class="font-black text-emerald-600">${item.rate.toFixed(0)}%</span>
            </div>
        </div>
    `).join('');
}
// Variable global para guardar el conteo
let gestorSalesCount = 0;

async function generateFlashResponse() {
    // 1. Obtener lo que el gestor escribi√≥ en el buscador
    const searchInput = document.getElementById('search-bar');
    const query = searchInput ? searchInput.value.trim() : "";
    
    // 2. Filtros para saber qu√© productos mostrar
    const isGestor = window.gestorName ? true : false;
    const filterCheckbox = document.getElementById('filter-high-comm');
    const filterHighComm = filterCheckbox ? filterCheckbox.checked : false;

    // Filtramos sobre la data cruda
    const visibleProducts = productosRaw.filter(p => {
        const matchSearch = p.nombre.toLowerCase().includes(query.toLowerCase());
        const matchCat = activeCategory === 'TODOS' || (p.categoria && p.categoria.toUpperCase().includes(activeCategory));
        const matchComm = !filterHighComm || (Number(p.comision || 0) > 10);
        return matchSearch && matchCat && matchComm && p.disponible === "SI";
    });

    if (visibleProducts.length === 0) return alert("‚ùå No hay productos en pantalla para generar respuesta.");

    // --- EFECTO VISUAL DE CARGA EN EL BOT√ìN ---
    const btn = event.currentTarget;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = `<span class="loader w-4 h-4 border-amber-800"></span>`; 
    btn.disabled = true;

    try {
        // 3. DEFINIR LA URL BASE CORRECTA
        // Si est√°s abriendo el archivo local (file://), usamos tu web real. Si no, usamos la actual.
        let baseUrl = window.location.origin + window.location.pathname;
        if (window.location.protocol === 'file:') {
            baseUrl = "https://paratuhogar.github.io/paratuhogar/"; // TU URL REAL AQU√ç
        }

        // 4. CONSTRUIR EL LINK LARGO
        const gestor = window.gestorName || '';
        const tel = window.currentUserData?.telefono || '';
        const longLink = `${baseUrl}?search=${encodeURIComponent(query)}&gestor=${encodeURIComponent(gestor)}&tel=${tel}`;

        // 5. ¬°MAGIA! GENERAR EL LINK CORTO (Esperamos a Supabase)
        const shortLink = await getOrGenerateShortLink(gestor, longLink);

        // 6. CONSTRUIR EL MENSAJE
        let mensaje = `üëã Hola! S√≠, para *"${query || activeCategory}"* tengo estas opciones disponibles ahora mismo:\n\n`;

        // Listar m√°ximo 5 productos
        visibleProducts.slice(0, 5).forEach(p => {
            const precio = showInCUP ? `CUP ${calculateProductCUP(p.precio, p.pagos).toLocaleString()}` : `$${p.precio} USD`;
            mensaje += `‚ñ´Ô∏è *${p.nombre}* ‚ûù *${precio}*\n`;
        });

        if (visibleProducts.length > 5) {
            mensaje += `... y ${visibleProducts.length - 5} opciones m√°s.\n`;
        }

        mensaje += `\nüëÄ *MIRA LAS FOTOS Y DETALLES AQU√ç:* üëá\n${shortLink}\n\n`;
        mensaje += `Me avisas cu√°l te gusta y te lo separo. üòâ`;

        // 7. COPIAR AL PORTAPAPELES
        await navigator.clipboard.writeText(mensaje);

        // Feedback de √©xito
        btn.innerHTML = "‚úÖ ¬°LISTO!";
        btn.classList.remove("bg-amber-400", "text-amber-900");
        btn.classList.add("bg-green-500", "text-white");

    } catch (e) {
        console.error(e);
        alert("Error generando el link corto. Se copiar√° el largo.");
    } finally {
        // Restaurar bot√≥n despu√©s de 2 segundos
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.add("bg-amber-400", "text-amber-900");
            btn.classList.remove("bg-green-500", "text-white");
            btn.disabled = false;
        }, 2000);
    }
}



// 2. FUNCI√ìN PARA DIBUJAR EL BOT√ìN (Candado vs Rayo)
function renderFlashButton() {
    const container = document.getElementById('container-flash-btn');
    if (!container) return;

    const META_VENTAS = 3; // La meta para desbloquear

    if (gestorSalesCount >= META_VENTAS) {
        // --- NIVEL PRO: DESBLOQUEADO ---
        container.innerHTML = `
            <button onclick="generateFlashResponse()" class="h-full py-2.5 px-4 rounded-xl bg-amber-400 text-amber-900 border border-amber-500 hover:bg-amber-500 hover:text-white transition-all flex items-center justify-center gap-2 text-xs font-black shadow-md active:scale-95 animate-pulse" title="Generar respuesta r√°pida">
                <span class="material-symbols-outlined text-lg">flash_on</span> 
                <span class="hidden sm:inline">Flash</span>
            </button>`;
    } else {
        // --- NIVEL NOVATO: BLOQUEADO (GAMIFICACI√ìN) ---
        const faltan = META_VENTAS - gestorSalesCount;
        container.innerHTML = `
            <button onclick="alertLockedFeature(${faltan})" class="h-full py-2.5 px-4 rounded-xl bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed flex items-center justify-center gap-2 text-xs font-bold" title="Bloqueado hasta la 3ra venta">
                <span class="material-symbols-outlined text-lg">lock</span> 
                <span class="hidden sm:inline">Flash</span>
            </button>`;
    }
}





// Helper: Bloquear Bot√≥n (Mantiene el nombre y a√±ade candado)
function lockButton(btn, toolName, reqLevel, salesPitch) {
    if (!btn) return;
    
    // Estilo visual gris
    btn.className = "flex-1 xl:flex-none py-2.5 px-4 rounded-xl border border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed flex items-center justify-center gap-2 text-xs font-bold transition-all";
    
    // Muestra: Candado + Nombre Herramienta (Ya no dice solo "Nivel X")
    btn.innerHTML = `<span class="material-symbols-outlined text-lg">lock</span> <span class="hidden sm:inline">${toolName}</span>`;
    
    // Alerta de ventas
    btn.onclick = (e) => {
        e.preventDefault();
        alert(`üîí HERRAMIENTA BLOQUEADA: ${toolName}\n\n${salesPitch}`);
    };
    btn.removeAttribute("onclick"); 
    btn.title = `Bloqueado - Requiere Nivel ${reqLevel}`;
}

// Helper: Desbloquear Bot√≥n
function unlockButton(btn, icon, label, actionStr, colorClasses) {
    if (!btn) return;
    btn.className = `flex-1 xl:flex-none py-2.5 px-4 rounded-xl border transition-all flex items-center justify-center gap-2 text-xs font-bold cursor-pointer ${colorClasses}`;
    btn.innerHTML = `<span class="material-symbols-outlined text-lg">${icon}</span> <span class="hidden sm:inline">${label}</span>`;
    btn.setAttribute("onclick", actionStr);
    btn.onclick = null; 
    btn.title = label;
}

// Helper: Bloquear Bot√≥n
function lockButton(btn, label, reqLevel) {
    if (!btn) return;
    // Reseteamos clases para forzar el gris
    btn.className = "flex-1 xl:flex-none py-2.5 px-4 rounded-xl border border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed flex items-center justify-center gap-2 text-xs font-bold transition-all";
    btn.innerHTML = `<span class="material-symbols-outlined text-lg">lock</span> <span class="hidden sm:inline">Nivel ${reqLevel}</span>`;
    btn.onclick = (e) => {
        e.preventDefault();
        alert(`üîí HERRAMIENTA BLOQUEADA\n\nNecesitas Nivel ${reqLevel} para usar '${label}'.\n¬°Sigue vendiendo para desbloquear!`);
    };
    btn.removeAttribute("onclick"); // Quitamos cualquier onclick inline antiguo
}

// Helper: Desbloquear Bot√≥n
function unlockButton(btn, icon, label, actionStr, colorClasses) {
    if (!btn) return;
    // Aplicamos estilos "vivos"
    btn.className = `flex-1 xl:flex-none py-2.5 px-4 rounded-xl border transition-all flex items-center justify-center gap-2 text-xs font-bold cursor-pointer ${colorClasses}`;
    btn.innerHTML = `<span class="material-symbols-outlined text-lg">${icon}</span> <span class="hidden sm:inline">${label}</span>`;
    
    // Asignamos la funci√≥n
    btn.setAttribute("onclick", actionStr);
    btn.onclick = null; // Limpiamos el bloqueo manual para dejar que act√∫e el atributo onclick
}

// Helper para restaurar el estilo original
function restoreButtonStyle(btn, icon, label, action, colorClasses) {
    if (!btn) return;
    // Restauramos las clases base + los colores espec√≠ficos
    btn.className = `flex-1 xl:flex-none py-2.5 px-4 rounded-xl transition-all flex items-center justify-center gap-2 text-xs font-bold ${colorClasses}`;
    btn.innerHTML = `<span class="material-symbols-outlined text-lg">${icon}</span> <span class="hidden sm:inline">${label}</span>`;
    btn.setAttribute('onclick', action);
    btn.onclick = null; // Limpiamos el evento bloqueado para que el atributo onclick funcione
    btn.title = label;
}



// 3. MENSAJE MOTIVACIONAL (Cuando hacen clic en el candado)
function alertLockedFeature(faltan) {
    alert(`üîí ¬°HERRAMIENTA BLOQUEADA! üîí\n\nEl "Bot√≥n Flash" te permite responder a clientes en 3 segundos.\n\nüéØ OBJETIVO: Necesitas 3 ventas entregadas.\nüìâ TE FALTAN: ${faltan} ventas.\n\n¬°Sigue vendiendo para desbloquear esta ventaja injusta! üöÄ`);
}
// ==========================================
// üöÄ NUEVAS FUNCIONES PRO: CRM Y PERSISTENCIA
// ==========================================



// 1. CARGA DE CLIENTES (CRM) - VERSI√ìN PRIVADA
let crmClients = [];

async function loadClientCRM() {
    // Obtenemos qui√©n est√° conectado
    const gestorActual = window.gestorName; 
    const esAdmin = window.isAdmin;

    // Si nadie ha iniciado sesi√≥n (es cliente p√∫blico), no cargamos nada por seguridad
    if (!gestorActual && !esAdmin) {
        crmClients = [];
        return;
    }

    // Preparamos la consulta
    let query = supabaseClient
        .from('pedidos')
        .select('cliente, ci, telefono, direccion')
        .order('fecha', { ascending: false })
        .limit(1000); // Revisamos los √∫ltimos 1000

    // FILTRO DE ORO: Si NO es admin, filtra solo sus ventas
    if (!esAdmin && gestorActual) {
        query = query.eq('gestor', gestorActual);
    }

    const { data, error } = await query;

    if (!data) return;

    // Filtramos duplicados por Tel√©fono (igual que antes)
    const uniqueMap = new Map();
    data.forEach(p => {
        if (p.telefono && !uniqueMap.has(p.telefono)) {
            uniqueMap.set(p.telefono, p);
        }
    });

    crmClients = Array.from(uniqueMap.values());
    
    // Llenar el Datalist del HTML
    const dataList = document.getElementById('crm-datalist');
    if(dataList) {
        dataList.innerHTML = crmClients.map(c => 
            `<option value="${c.cliente} | ${c.telefono}">${c.direccion ? c.direccion.substring(0,30) + '...' : ''}</option>`
        ).join('');
    }
    
    console.log(`CRM Cargado: ${crmClients.length} clientes encontrados para ${gestorActual || 'Admin'}.`);
}

// 2. AUTO-RELLENADO (Al seleccionar en el buscador)
function autofillClient(val) {
    if(!val) return;

    // Intentamos buscar en la base de datos
    const phoneKey = val.split('|')[1]?.trim();
    const client = crmClients.find(c => c.telefono === phoneKey);

    if (client) {
        // CASO 1: CLIENTE RECURRENTE (EXISTE)
        document.getElementById('check-nombre').value = client.cliente || '';
        document.getElementById('check-ci').value = client.ci || '';
        document.getElementById('check-tel').value = client.telefono || '';
        document.getElementById('check-dir').value = client.direccion || '';
    } else {
        // CASO 2: CLIENTE NUEVO (NO EXISTE EN LA LISTA)
        // Si lo que escribiste en el buscador no es un cliente viejo, 
        // asumimos que es el NOMBRE del nuevo cliente.
        
        // Solo copiamos si el campo nombre est√° vac√≠o para no borrar lo que hayas pegado
        if(document.getElementById('check-nombre').value === "") {
             document.getElementById('check-nombre').value = val.replace('|', '').trim();
        }
    }
}

// 3. SISTEMA DE AUTO-GUARDADO (Anti-p√©rdida de datos)
function initAutoSaveSystem() {
    // Campos a vigilar
    const fields = ['check-nombre', 'check-ci', 'check-tel', 'check-dir', 'check-vuelto'];
    
    fields.forEach(id => {
        const el = document.getElementById(id);
        if(!el) return;

        // A. Recuperar al cargar
        const saved = localStorage.getItem('autosave_' + id);
        if(saved) el.value = saved;

        // B. Guardar al escribir
        el.addEventListener('input', () => {
            localStorage.setItem('autosave_' + id, el.value);
        });
    });
}

function clearAutoSave() {
    // Borrar datos despu√©s de una venta exitosa
    const fields = ['check-nombre', 'check-ci', 'check-tel', 'check-dir', 'check-vuelto'];
    fields.forEach(id => {
        localStorage.removeItem('autosave_' + id);
        const el = document.getElementById(id);
        if(el) el.value = "";
    });
    // Limpiar buscador
    const search = document.getElementById('crm-search');
    if(search) search.value = "";
}
// ==========================================
// ‚ö° MODO FLASH: PEGADO INTELIGENTE
// ==========================================

// ==========================================
// ‚ö° MODO FLASH 4.0: CORRECCI√ìN DE TEL√âFONO
// ==========================================

async function magicPaste() {
    try {
        const text = await navigator.clipboard.readText();
        if (!text) return alert("‚ö†Ô∏è El portapapeles est√° vac√≠o.");

        // 1. LIMPIEZA INICIAL
        let raw = text
            .replace(/(Nombre|Nom|Cliente|Direcci√≥n|Dir|Direccion|Tel√©fono|Telefono|Telf|Cel|M√≥vil|WhatsApp|CI|Carnet|Id):?/gi, " ")
            .replace(/\t/g, " ")
            .trim();

        // ---------------------------------------------------------
        // PASO A: EXTRACCI√ìN DE DATOS
        // ---------------------------------------------------------

        // A1. CARNET DE IDENTIDAD (11 d√≠gitos)
        const ciMatch = raw.match(/\b\d{11}\b/);
        let ci = ciMatch ? ciMatch[0] : "";
        if (ci) raw = raw.replace(ci, " "); 

        // A2. TEL√âFONO (CORREGIDO)
        // Esta nueva regex busca: Opcional (+53 o 53) + Bloque que empieza por 5 y tiene entre 7 y 15 caracteres (digitos, espacios o guiones)
        const phoneRegex = /(?:\+?53)?\s*[\.\-]?\s*(5[\d\s\-\.]{7,15})/;
        const phoneMatch = raw.match(phoneRegex);
        let phone = "";
        
        if (phoneMatch) {
            // Limpiamos todo lo que no sea n√∫mero
            let digits = phoneMatch[0].replace(/\D/g, ''); 
            
            // Si empieza con 53 y es largo (10 d√≠gitos), quitamos el 53
            if (digits.length === 10 && digits.startsWith('53')) digits = digits.substring(2);
            
            // VALIDACI√ìN FINAL: Solo aceptamos si quedaron 8 d√≠gitos exactos
            if (digits.length === 8 && digits.startsWith('5')) {
                phone = digits;
                raw = raw.replace(phoneMatch[0], " "); // Borramos el tel√©fono del texto original
            }
        }

        // ---------------------------------------------------------
        // PASO B: SEPARACI√ìN DE NOMBRE Y DIRECCI√ìN
        // ---------------------------------------------------------
        
        let cleanText = raw.replace(/\r\n|\n|\r/g, " , ").replace(/\s+/g, " ").trim();
        
        const addressKeywords = [
            'calle', 'ave', 'avenida', 'av.', 'entre', 'esq', 'esquina', 
            'pto', 'reparto', 'rpto', 'edif', 'edificio', 'apto', 'apartamento',
            'carretera', 'finca', 'zona', 'municipio', 'provincia', 'habana', 
            'bajos', 'altos', 'km', 'no.', 'n√∫mero', '#'
        ];

        let nombre = "";
        let direccion = "";

        // ESTRATEGIA: Buscar d√≥nde empieza la direcci√≥n
        let splitIndex = -1;
        const lowerText = cleanText.toLowerCase();

        for (let word of addressKeywords) {
            // Buscamos la palabra clave con espacio antes o despu√©s para no confundir (ej: "Calle")
            const idx = lowerText.indexOf(word + " ") !== -1 ? lowerText.indexOf(word + " ") : lowerText.indexOf(" " + word);
            
            if (idx !== -1) {
                // Si encontramos "Calle", cortamos ah√≠.
                // Verificaci√≥n extra: Si el √≠ndice es muy peque√±o (< 3), es que el texto EMPIEZA con la direcci√≥n.
                if (idx < 3) {
                     // Caso raro: "Calle 23... Juan Perez". Asumimos que nombre est√° al final si hay comas, o es un caso dif√≠cil.
                     // Para tu ejemplo, el nombre est√° ANTES, as√≠ que el idx ser√° > 3.
                } else {
                    splitIndex = idx;
                    break; // Nos quedamos con la primera coincidencia
                }
            }
        }

        if (splitIndex > -1) {
            nombre = cleanText.substring(0, splitIndex).trim();
            direccion = cleanText.substring(splitIndex).trim();
        } else {
            // Si no hay palabras clave, usamos comas
            if (cleanText.includes(",")) {
                const parts = cleanText.split(",");
                // El m√°s largo suele ser direcci√≥n
                parts.sort((a, b) => a.length - b.length);
                nombre = parts[0];
                direccion = parts.slice(1).join(", ");
            } else {
                // Fallback final: Mitad y mitad
                nombre = cleanText; 
            }
        }

        // ---------------------------------------------------------
        // PASO C: RELLENADO
        // ---------------------------------------------------------

        // Limpieza final
        const cleanStr = (s) => s ? s.replace(/^[\s,.-]+|[\s,.-]+$/g, "").trim() : "";
        nombre = cleanStr(nombre);
        direccion = cleanStr(direccion);

        // Convertir nombre a May√∫sculas Bonitas
        if (nombre) document.getElementById('check-nombre').value = nombre.replace(/\w\S*/g, w => w.charAt(0).toUpperCase() + w.substr(1).toLowerCase());
        
        if (phone) document.getElementById('check-tel').value = phone;
        if (ci) document.getElementById('check-ci').value = ci;
        if (direccion) document.getElementById('check-dir').value = direccion;

        // Disparar evento
        document.getElementById('check-nombre').dispatchEvent(new Event('input'));

        // Toast de confirmaci√≥n
        // alert(`‚úÖ Datos Detectados:\nüë§ ${nombre}\nüìû ${phone}\nüè† ${direccion.substring(0, 20)}...`);

    } catch (err) {
        console.error(err);
        alert("‚ö†Ô∏è Error al analizar. Pega manualmente.");
    }
}

// Funci√≥n auxiliar para poner May√∫sculas Bonitas
function toTitleCase(str) {
    return str.replace(/\w\S*/g, function(txt){
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
    });
}

/* ============================================== */
/*    SISTEMA DE GAMIFICACI√ìN "SOLO LEVELING"     */
/*           L√ìGICA DE VENTANA DESLIZANTE         */
/* ============================================== */

// Datos Maestros de Niveles
function getLevelData(sales) {
    if (sales >= 70) return { 
        lvl: 5, name: "Emperador", next: 1000, color: "text-purple-600", 
        duration: 8760, // 1 A√ëO (365 d√≠as)
        hasShortLink: true,
        power: "Bindeo de Cliente" // "Amarrar" el tel√©fono del cliente
    };
    if (sales >= 40) return { 
        lvl: 4, name: "Monarca", next: 70, color: "text-emerald-500", 
        duration: 4320, // 6 MESES (180 d√≠as)
        hasShortLink: true 
    };
    if (sales >= 20) return { 
        lvl: 3, name: "√âlite", next: 40, color: "text-indigo-500", 
        duration: 2160, // 3 MESES (90 d√≠as)
        hasShortLink: true 
    };
    if (sales >= 10) return { 
        lvl: 2, name: "Experto", next: 20, color: "text-blue-500", 
        duration: 720, // 1 MES (30 d√≠as)
        hasShortLink: true 
    };
    if (sales >= 3)  return { 
        lvl: 1, name: "Novato", next: 10, color: "text-orange-500", 
        duration: 720, // 1 MES (30 d√≠as)
        hasShortLink: true 
    };
    return { 
        lvl: 0, name: "Iniciado", next: 3, color: "text-red-500", 
        duration: 168, // 1 SEMANA (7 d√≠as)
        hasShortLink: true // Todos tienen link corto ahora
    };
}

async function showAgentWelcomeModal(nombre) {
    const modal = document.getElementById('modal-welcome-agent');
    if(!modal) return;

    try {
        let salesCount = 0; 

        // L√≥gica de conteo de ventas (Igual que ten√≠as)
        if (nombre === "Marcel Montano") {
            salesCount = 80; 
        } else {
            const { count, error } = await supabaseClient
                .from('pedidos')
                .select('id', { count: 'exact', head: true })
                .eq('gestor', nombre)
                .eq('estado', 'Entregado');
            if (error) throw error;
            salesCount = count || 0;
        }

        const lvlData = getLevelData(salesCount);
        const currentLvl = lvlData.lvl;
        
        // Guardamos nivel global
        window.currentGestorLevel = currentLvl; 

        // === AQU√ç EST√Å LA CORRECCI√ìN ===
        const lastSeenLevel = localStorage.getItem('pth_last_seen_level');

        // Si el nivel actual es IGUAL al √∫ltimo que vio...
        if (lastSeenLevel && parseInt(lastSeenLevel) === currentLvl) {
            console.log("El usuario sigue en el mismo nivel. Pasando al cartel de precios...");
            
            // ¬°ESTA ES LA L√çNEA QUE TE FALTABA! 
            // Si no muestra nivel, intenta mostrar precios.
            showPriceIntro(); 
            
            return; // Salimos para que NO salga el cartel azul de nivel
        }
        // ==============================

        // (El resto de tu c√≥digo para dibujar el cartel azul sigue aqu√≠ igual...)
        const tiers = [
            { lvl: 1, name: "Novato", tool: "Flash & Story Maker", boost: 1.5, phrase: "Cerrar√°s clientes en segundos con las respuestas autom√°ticas." },
            { lvl: 2, name: "Experto", tool: "Pack Fotos & Texto Masivo", boost: 2.2, phrase: "Inundar√°s los grupos de compra/venta con un solo clic." },
            { lvl: 3, name: "√âlite", tool: "Radar de Tendencias", boost: 2.8, phrase: "Publicar√°s exactamente lo que los clientes est√°n buscando hoy." },
            { lvl: 4, name: "Monarca", tool: "Cat√°logo PDF Pro", boost: 3.5, phrase: "Tu imagen profesional ser√° irresistible para clientes de alto valor." },
            { lvl: 5, name: "Emperador", tool: "Amarre Total", boost: 5.0, phrase: "Has alcanzado el poder m√°ximo. Tu red de clientes es ahora un activo eterno." }
        ];

        // DIBUJAR LISTA (Copia esto tal cual ten√≠as)
        const listHTML = tiers.map(t => {
            const isUnlocked = currentLvl >= t.lvl;
            return `
            <div class="flex items-center gap-4 py-1 ${isUnlocked ? 'opacity-100' : 'opacity-40'}">
                <span class="material-symbols-outlined ${isUnlocked ? 'text-emerald-400' : 'text-slate-700'} text-xl">
                    ${isUnlocked ? 'check_circle' : 'lock'}
                </span>
                <div class="flex-1 border-b border-white/5 pb-2">
                    <div class="flex justify-between items-center">
                        <p class="text-[11px] font-black uppercase tracking-wide text-white">${t.tool}</p>
                        <span class="text-[10px] font-black ${isUnlocked ? 'text-emerald-400' : 'text-slate-500'}">LVL ${t.lvl}</span>
                    </div>
                </div>
            </div>`;
        }).join('');

        const nextTier = tiers.find(t => t.lvl === currentLvl + 1) || tiers[4];
        let baseline = salesCount === 0 ? 1.5 : salesCount;
        let extraSales = Math.ceil(baseline * nextTier.boost);
        let totalPotential = Math.ceil(salesCount + extraSales);

        document.getElementById('welcome-features-list').innerHTML = listHTML;
        document.getElementById('welcome-next-tier-name').innerText = nextTier.tool;
        document.getElementById('welcome-extra-sales').innerText = extraSales;
        document.getElementById('welcome-total-potential').innerText = totalPotential;
        document.getElementById('welcome-motivational-phrase').innerText = `"${nextTier.phrase}"`;
        document.getElementById('welcome-rank-tag').innerText = "RANGO: " + lvlData.name;
        
        let durationText = lvlData.lvl === 5 ? "365 D√çAS" : (lvlData.lvl === 0 ? "7 D√çAS" : (lvlData.duration / 720) + " MESES");
        document.getElementById('welcome-link-duration').innerText = durationText;
        document.getElementById('welcome-next-power').innerText = "NIVEL " + (currentLvl < 5 ? currentLvl + 1 : 5);

        // Mostrar Modal Azul
        setTimeout(() => { modal.classList.remove('hidden'); }, 800);

    } catch (e) { console.error("Error en Bienvenida:", e); }
}

function closeWelcomeAgent() {
    // 1. Ocultar modal azul
    const modal = document.getElementById('modal-welcome-agent');
    if(modal) modal.classList.add('hidden');

    // 2. Guardar nivel actual
    if (window.currentGestorLevel !== undefined) {
        localStorage.setItem('pth_last_seen_level', window.currentGestorLevel);
    }

    // 3. PUENTE: Llamar al siguiente cartel
    console.log("Cerrando nivel. Intentando mostrar noticias...");
    setTimeout(() => {
        showPriceIntro();
    }, 500);
}

// --- FUNCI√ìN DE BLOQUEO DE HERRAMIENTAS (FALTABA ESTO) ---
// --- CORRECCI√ìN: FUNCI√ìN PARA DESBLOQUEAR BOTONES ---
function applyLockedFeatures() {
    const level = window.currentGestorLevel || 0; // Usar la variable global
    
    const btnCopy = document.getElementById('btn-copy-bulk');
    const btnZip = document.getElementById('btn-zip-bulk');
    const btnPdf = document.getElementById('btn-pdf-bulk');

    // NIVEL 2+: Texto y Fotos
    if (level >= 2) {
        if(btnCopy) {
            btnCopy.className = "flex-1 xl:flex-none py-2.5 px-4 rounded-xl border border-indigo-200 bg-white text-indigo-600 cursor-pointer flex items-center justify-center gap-2 text-xs font-bold hover:bg-indigo-50";
            btnCopy.innerHTML = `<span class="material-symbols-outlined">content_copy</span> Texto`;
            btnCopy.onclick = copyCategoryOffers;
        }
        if(btnZip) {
            btnZip.className = "flex-1 xl:flex-none py-2.5 px-4 rounded-xl border border-indigo-200 bg-white text-indigo-600 cursor-pointer flex items-center justify-center gap-2 text-xs font-bold hover:bg-indigo-50";
            btnZip.innerHTML = `<span class="material-symbols-outlined">folder_zip</span> Fotos`;
            btnZip.onclick = downloadCategoryPhotos;
        }
    } else {
        if(btnCopy) lockButtonDirect(btnCopy, "Texto Masivo", 2);
        if(btnZip) lockButtonDirect(btnZip, "Pack Fotos", 2);
    }

    // NIVEL 4+: PDF
    if (level >= 4) {
        if(btnPdf) {
            btnPdf.className = "flex-1 xl:flex-none py-2.5 px-4 rounded-xl bg-red-50 text-red-600 border border-red-100 cursor-pointer flex items-center justify-center gap-2 text-xs font-bold hover:bg-red-500 hover:text-white";
            btnPdf.innerHTML = `<span class="material-symbols-outlined">picture_as_pdf</span> PDF`;
            btnPdf.onclick = downloadCatalogPDF;
        }
    } else {
        if(btnPdf) lockButtonDirect(btnPdf, "Cat√°logo PDF", 4);
    }
}

// Funci√≥n auxiliar simple para bloquear
function lockButtonDirect(btn, name, lvl) {
    btn.className = "flex-1 xl:flex-none py-2.5 px-4 rounded-xl border border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed flex items-center justify-center gap-2 text-xs font-bold";
    btn.innerHTML = `<span class="material-symbols-outlined text-lg">lock</span> <span class="hidden sm:inline">${name}</span>`;
    btn.onclick = function(e) { 
        e.preventDefault(); 
        alert(`üîí Bloqueado: Sube a Nivel ${lvl} para usar ${name}.`); 
    };
}

// Helper simple para bloquear
function lockButtonDirect(btn, toolName, reqLevel) {
    if (!btn) return;
    btn.className = "flex-1 xl:flex-none py-2.5 px-4 rounded-xl border border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed flex items-center justify-center gap-2 text-xs font-bold transition-all";
    btn.innerHTML = `<span class="material-symbols-outlined text-lg">lock</span> <span class="hidden sm:inline">${toolName}</span>`;
    btn.onclick = function(e) {
        e.preventDefault();
        alert(`üîí HERRAMIENTA BLOQUEADA: ${toolName}\n\nNecesitas Nivel ${reqLevel} para usar esto.\n¬°Sigue vendiendo!`);
    };
}

// Helper simple solo para bloquear (el desbloqueo ya lo hicimos arriba manual)
function lockButton(btn, toolName, reqLevel, salesPitch) {
    if (!btn) return;
    btn.className = "flex-1 xl:flex-none py-2.5 px-4 rounded-xl border border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed flex items-center justify-center gap-2 text-xs font-bold transition-all";
    btn.innerHTML = `<span class="material-symbols-outlined text-lg">lock</span> <span class="hidden sm:inline">${toolName}</span>`;
    btn.onclick = (e) => {
        e.preventDefault();
        alert(`üîí HERRAMIENTA BLOQUEADA: ${toolName}\n\n${salesPitch}\n\nüéØ Necesitas Nivel ${reqLevel}.`);
    };
    btn.title = `Bloqueado - Requiere Nivel ${reqLevel}`;
}

// Helpers visuales (Necesarios para que funcione lo de arriba)
function lockButtonVisual(btn, icon, text, lockText) {
    if(!btn) return;
    btn.onclick = () => alert(`‚ö†Ô∏è HERRAMIENTA BLOQUEADA\n\nNecesitas subir de nivel para usar '${text}'.\nSigue vendiendo para desbloquear.`);
    btn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-100');
    btn.classList.remove('hover:border-indigo-500', 'hover:text-indigo-600', 'hover:bg-indigo-50');
    btn.innerHTML = `<span class="material-symbols-outlined text-lg">lock</span> <span class="hidden sm:inline">${lockText}</span>`;
}

/* ============================================== */
/*    L√ìGICA DE BLOQUEO DE HERRAMIENTAS (PRO)     */
/* ============================================== */



// Helper: Bloquear Bot√≥n (Mantiene el nombre y a√±ade candado)
function lockButton(btn, toolName, reqLevel, salesPitch) {
    if (!btn) return;
    
    // Forzamos el estilo GRIS y Cursor de bloqueo
    btn.className = "flex-1 xl:flex-none py-2.5 px-4 rounded-xl border border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed flex items-center justify-center gap-2 text-xs font-bold transition-all";
    
    // Ponemos el nombre de la herramienta (NO "Nivel X")
    btn.innerHTML = `<span class="material-symbols-outlined text-lg">lock</span> <span class="hidden sm:inline">${toolName}</span>`;
    
    // Eliminamos onclick anterior y ponemos la alerta nueva
    btn.removeAttribute("onclick");
    btn.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        alert(`üîí HERRAMIENTA BLOQUEADA: ${toolName}\n\n${salesPitch}`);
    };
    btn.title = `Bloqueado - Requiere Nivel ${reqLevel}`;
}

// Helper: Desbloquear Bot√≥n
function unlockButton(btn, icon, label, actionStr, colorClasses) {
    if (!btn) return;
    // Restauramos estilo de color
    btn.className = `flex-1 xl:flex-none py-2.5 px-4 rounded-xl border transition-all flex items-center justify-center gap-2 text-xs font-bold cursor-pointer ${colorClasses}`;
    btn.innerHTML = `<span class="material-symbols-outlined text-lg">${icon}</span> <span class="hidden sm:inline">${label}</span>`;
    
    // Restauramos la funci√≥n original
    btn.setAttribute("onclick", actionStr);
    btn.onclick = null; 
    btn.title = label;
}

// 1. CHEQUEO PRINCIPAL (Se llama al cargar el Dashboard)
// 1. CHEQUEO PRINCIPAL (Se llama al cargar el Dashboard)
// 1. CHEQUEO PRINCIPAL (Se llama al cargar el Dashboard)
// --- CORRECCI√ìN: FUNCI√ìN PARA VERIFICAR NIVEL ---
async function checkGamificationStatus() {
    const gestor = window.gestorName;
    if (!gestor) return;

    // --- MODO DIOS (Para ti) ---
    if (gestor === "Marcel Montano") {
        window.currentGestorLevel = 5;
        updateGamificationUI(80);
        renderFlashButton();
        applyLockedFeatures();
        return;
    }

    // Consulta de ventas (Sin filtros de fecha agresivos para evitar errores de zona horaria en pruebas)
    const { data, count, error } = await supabaseClient
        .from('pedidos')
        .select('id', { count: 'exact' }) 
        .eq('gestor', gestor)
        .eq('estado', 'Entregado');

    if (error) {
        console.error("Error obteniendo nivel:", error);
        return;
    }

    const sales = count || 0;
    
    // 1. Guardar el nivel en una variable global para que todos la vean
    const levelData = getLevelData(sales);
    window.currentGestorLevel = levelData.lvl;
    window.gestorSalesCount = sales;

    // 2. Actualizar la tarjeta azul de arriba
    updateGamificationUI(sales);

    // 3. ¬°IMPORTANTE! Forzar el desbloqueo de los botones
    renderFlashButton();     // Desbloquea el rayito amarillo
    applyLockedFeatures();   // Desbloquea Texto, Fotos y PDF
    
    console.log(`Nivel detectado: ${window.currentGestorLevel} con ${sales} ventas.`);
}

// 2. ACTUALIZACI√ìN VISUAL (Tarjeta Dashboard + Modal Carrera)
function updateGamificationUI(sales) {
    const data = getLevelData(sales);
    
    // --- A. Actualizar Tarjeta Dashboard ---
    const badge = document.getElementById('lvl-badge');
    if(badge) {
        badge.innerText = `Nivel ${data.lvl}`;
        document.getElementById('lvl-name').innerText = data.name;
        document.getElementById('lvl-title').innerText = `AGENTE ${data.name.toUpperCase()}`;
        
        // C√ÅLCULO DIN√ÅMICO DE D√çAS (Corregido para nivel 5)
        const diasReales = data.duration / 24;
        const durationText = data.lvl === 0 ? "24 HORAS" : `${diasReales} D√çAS`;
        
        const linkSpan = document.getElementById('lvl-link-duration');
        if (linkSpan) {
            linkSpan.innerText = durationText;
            
            // Colores din√°micos seg√∫n nivel
            linkSpan.className = "font-black"; // Limpiamos clases previas
            if (data.lvl === 0) linkSpan.classList.add("text-red-300");
            else if (data.lvl === 5) linkSpan.classList.add("text-purple-300"); // Color Emperador
            else if (data.lvl === 4) linkSpan.classList.add("text-emerald-300");
            else linkSpan.classList.add("text-amber-300");
        }

        // Barra de Progreso
        const counterEl = document.getElementById('lvl-counter');
        if (counterEl) counterEl.innerText = `${sales} / ${data.next} Ventas`;
        
        const barEl = document.getElementById('lvl-progress-bar');
        if (barEl) {
            const percent = Math.min(100, (sales / data.next) * 100);
            barEl.style.width = `${percent}%`;
            
            // Si es nivel 5, la barra brilla en purpura
            if (data.lvl === 5) barEl.style.backgroundColor = "#a855f7"; 
            else barEl.style.backgroundColor = "#fbbf24"; // √Åmbar normal
        }
    }

    // --- B. Actualizar Modal Maestro (Desbloquear Cartas del 0 al 5) ---
    // Cambiamos el l√≠mite a 5 para incluir al Emperador
    for (let i = 0; i <= 5; i++) {
        const card = document.getElementById(`card-lvl-${i}`);
        if (!card) continue;

        // Limpiar clases de estado
        card.classList.remove('active', 'current', 'locked');

        if (i < data.lvl) {
            // Niveles ya superados
            card.classList.add('active');
            if (typeof unlockButtonsInCard === 'function') unlockButtonsInCard(card);
        } else if (i === data.lvl) {
            // Nivel actual
            card.classList.add('active', 'current');
            if (typeof unlockButtonsInCard === 'function') unlockButtonsInCard(card);
        } else {
            // Niveles bloqueados
            card.classList.add('locked');
            if (typeof lockButtonsInCard === 'function') lockButtonsInCard(card);
        }
    }
}

// --- FUNCI√ìN PARA DIBUJAR EL BOT√ìN FLASH (CANDADO O RAYO) ---
function renderFlashButton() {
    const container = document.getElementById('container-flash-btn');
    if (!container) return; // Si no encuentra el hueco, no hace nada

    // Obtenemos el nivel actual guardado en la variable global (o 0 por defecto)
    const currentLvl = window.currentGestorLevel || 0;
    
    // REGLA: El Flash se desbloquea a partir de NIVEL 1
    const NIVEL_DESBLOQUEO = 1;

    if (currentLvl >= NIVEL_DESBLOQUEO) {
        // --- DESBLOQUEADO (AMARILLO/RAYO) ---
        container.innerHTML = `
            <button onclick="generateFlashResponse()" class="w-full h-full py-2.5 px-4 rounded-xl bg-amber-400 text-amber-900 border border-amber-500 hover:bg-amber-500 hover:text-white transition-all flex items-center justify-center gap-2 text-xs font-black shadow-md active:scale-95 animate-pulse" title="Generar respuesta r√°pida">
                <span class="material-symbols-outlined text-lg">flash_on</span> 
                <span class="hidden sm:inline">Flash</span>
            </button>`;
    } else {
        // --- BLOQUEADO (GRIS/CANDADO) ---
        container.innerHTML = `
            <button onclick="alert('üîí BLOQUEADO: Sube a NIVEL 1 (3 ventas) para desbloquear la Respuesta Flash.')" class="w-full h-full py-2.5 px-4 rounded-xl bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed flex items-center justify-center gap-2 text-xs font-bold" title="Bloqueado - Nivel Insuficiente">
                <span class="material-symbols-outlined text-lg">lock</span> 
                <span class="hidden sm:inline">Flash</span>
            </button>`;
    }
}

// Helpers visuales para el modal
function unlockButtonsInCard(card) {
    const btns = card.querySelectorAll('button');
    btns.forEach(btn => {
        btn.classList.remove('btn-tool-locked');
        btn.classList.add('text-xs', 'font-bold', 'text-gray-700', 'bg-white', 'border', 'border-gray-200', 'shadow-sm', 'px-3', 'py-2', 'rounded-lg', 'w-full', 'flex', 'items-center', 'gap-2', 'hover:bg-blue-50', 'hover:text-primary', 'transition-all');
        // Quitamos la alerta de bloqueo
        btn.onclick = null; 
        // Aqu√≠ podr√≠as poner la funci√≥n real si existiera, ej: btn.onclick = functionRef;
    });
}

function lockButtonsInCard(card) {
    // Ya vienen con la clase btn-tool-locked del HTML
}

// Funciones del Modal
function openGamificationModal() {
    document.getElementById('modal-gamification').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}
function closeGamificationModal() {
    document.getElementById('modal-gamification').classList.add('hidden');
    document.body.style.overflow = 'auto';
}
function alertLockedInfo(title, desc) {
    alert(`üîí ¬°HERRAMIENTA BLOQUEADA!\n\n${title}\n${desc}\n\nSube de nivel para desbloquear.`);
}

/* ============================================== */
/*        L√ìGICA DEL "ENLACE VITAL"               */
/* ============================================== */

// 1. Guardar Referido al entrar (INIT)
async function initSmartReferral() {
    const urlParams = new URLSearchParams(window.location.search);
    const urlGestor = urlParams.get('gestor');
    const urlTel = urlParams.get('tel');

    if (urlGestor) {
        const today = new Date();
        today.setDate(today.getDate() - 30);
        
        // CORRECCI√ìN: Quitamos 'head: true' aqu√≠ tambi√©n
        const { count, error } = await supabaseClient
            .from('pedidos')
            .select('id', { count: 'exact' })
            .eq('gestor', urlGestor)
            .eq('estado', 'Entregado')
            .gte('created_at', today.toISOString());
        
        const sales = count || 0;
        const data = getLevelData(sales);
        const hours = data.duration;

        const now = new Date().getTime();
        const expirationTime = now + (hours * 60 * 60 * 1000);

        const referrerData = {
            nombre: urlGestor,
            telefono: urlTel || "",
            timestamp: now,
            expiresAt: expirationTime
        };

        localStorage.setItem('pth_referrer_smart', JSON.stringify(referrerData));
    }
}

// 2. Recuperar Referido al comprar (VALIDACI√ìN SEVERA)
async function getActiveReferrer() {
    const stored = localStorage.getItem('pth_referrer_smart');
    if (!stored) return null;

    const data = JSON.parse(stored);
    const now = new Date().getTime();

    // A. ¬øCaduc√≥ por fecha fija?
    if (now > data.expiresAt) {
        console.log("‚ùå Enlace caducado por tiempo.");
        localStorage.removeItem('pth_referrer_smart');
        return null;
    }

    // B. VALIDACI√ìN DOBLE: ¬øEl gestor sigue manteniendo el nivel?
    // Si baj√≥ de nivel ayer, hoy su enlace antiguo podr√≠a ser inv√°lido.
    const today = new Date();
    today.setDate(today.getDate() - 30);
    
    const { count } = await supabaseClient
        .from('pedidos')
        .select('*', { count: 'exact', head: true })
        .eq('gestor', data.nombre)
        .eq('estado', 'Entregado')
        .gte('created_at', today.toISOString());
    
    const currentSales = count || 0;
    const currentData = getLevelData(currentSales);
    const allowedHours = currentData.duration;

    // Calcular horas reales transcurridas desde el clic original
    const hoursElapsed = (now - data.timestamp) / (1000 * 60 * 60);

    if (hoursElapsed > allowedHours) {
        console.log(`‚ùå PENALIZACI√ìN: El gestor baj√≥ de nivel. Enlace invalidado retroactivamente.`);
        localStorage.removeItem('pth_referrer_smart');
        return null;
    }

    return data;
}

// EJECUTAR AL CARGAR
window.addEventListener('load', () => {
    initSmartReferral(); // Revisar URL al entrar
    // ... tus otros inits ...
});

async function magicPasteProduct() {
    try {
        const text = await navigator.clipboard.readText();
        if (!text) return alert("‚ö†Ô∏è El portapapeles est√° vac√≠o.");

        const cleanText = text.trim();
        const lines = cleanText.split('\n').filter(line => line.trim() !== '');

        // 1. NOMBRE (Primera l√≠nea limpia)
        let nombre = lines[0].replace(/\*/g, '').trim();

        // 2. PRECIO (Busca n√∫meros grandes o 'usd')
        const priceMatch = cleanText.match(/Precio\s*[:\s]*(\d+)|(\d+)\s*usd/i);
        let precio = priceMatch ? (priceMatch[1] || priceMatch[2]) : "";

        // 3. MENSAJER√çA (L√ìGICA MEJORADA: Captura la frase completa)
        let envio = "";
        // Buscamos l√≠nea por l√≠nea alguna que hable de mensajer√≠a
        for (let line of lines) {
            const lower = line.toLowerCase();
            if (lower.includes('mensajer√≠a') || lower.includes('env√≠o') || lower.includes('transporte')) {
                // Borramos la palabra "Mensajer√≠a:" del inicio y guardamos el resto
                envio = line.replace(/^(mensajer√≠a|env√≠o|transporte)\s*[:.-]*\s*/i, '').trim();
                break; // Ya la encontramos, dejamos de buscar
            }
        }
        // Si no encontr√≥ nada en las l√≠neas, busca si dice "gratis" en alg√∫n lado
        if (!envio && cleanText.toLowerCase().includes('gratis')) {
            envio = "Gratis (Consultar zonas)";
        }
        if (!envio) envio = "Consultar"; // Valor por defecto

        // 4. GARANT√çA
        const warMatch = cleanText.match(/Garant√≠a\s*[:\s]*(.+)/i);
        let garantia = warMatch ? warMatch[1].trim() : "S√≠";

        // 5. CATEGOR√çA AUTOM√ÅTICA
        let cat = "VARIOS";
        const lowerText = cleanText.toLowerCase();
        if(lowerText.includes('lavadora') || lowerText.includes('secadora')) cat = "LAVADO";
        else if(lowerText.includes('nevera') || lowerText.includes('freezer')) cat = "REFRIGERACI√ìN";
        else if(lowerText.includes('split') || lowerText.includes('aire')) cat = "CLIMATIZACI√ìN";
        else if(lowerText.includes('cocina') || lowerText.includes('horno')) cat = "COCINA";

        // 6. RELLENAR EL FORMULARIO
        document.getElementById('p-nombre').value = nombre;
        document.getElementById('p-precio').value = precio;
        document.getElementById('p-categoria').value = cat;
        document.getElementById('p-garantia').value = garantia;
        
        // AQUI RELLENAMOS EL NUEVO CAMPO VISIBLE
        document.getElementById('p-mensajeria').value = envio; 

        // Comisi√≥n sugerida
        document.getElementById('p-comision').value = (precio > 100) ? 15 : 5;

        // Descripci√≥n en Editor
        if (typeof quill !== 'undefined') {
            quill.root.innerHTML = cleanText.replace(/\n/g, '<br>');
        }

    } catch (err) {
        console.error(err);
        alert("‚ö†Ô∏è Error al leer portapapeles.");
    }
}

// --- SISTEMA DE PERSISTENCIA DE TASA ---

// 1. Ejecutar al cargar la p√°gina
window.addEventListener('load', () => {
    initCurrencyPersistence();
});

function initCurrencyPersistence() {
    // Intentar recuperar de la memoria
    const savedRate = localStorage.getItem('pth_daily_rate');
    
    // Si existe, actualizamos la variable global y el input visual
    if (savedRate) {
        globalCUPRate = parseFloat(savedRate);
        const inputRate = document.getElementById('daily-rate');
        if (inputRate) inputRate.value = savedRate;
        console.log("Tasa recuperada:", savedRate);
    } else {
        // Si no existe, usamos 450 por defecto
        globalCUPRate = 450;
        const inputRate = document.getElementById('daily-rate');
        if (inputRate) inputRate.value = "450";
    }
}

// 2. Modificar la funci√≥n updateGlobalRate existente
function updateGlobalRate(val) {
    if(!val) return;
    globalCUPRate = parseFloat(val);
    
    // GUARDAR EN MEMORIA PARA SIEMPRE (Hasta que borres cach√©)
    localStorage.setItem('pth_daily_rate', val);
    
    // Refrescar vistas
    if(!document.getElementById('sec-catalogo').classList.contains('hidden')) {
        renderProducts();
    }
    if(!document.getElementById('sec-admin-master').classList.contains('hidden')) {
        renderAdminCortes();
    }
    
    // Feedback visual opcional
    // alert("Tasa actualizada a: " + val); 
}

// --- FUNCI√ìN COPIAR DESCRIPCI√ìN SIMPLE (NIVEL 0) ---
// --- FUNCI√ìN COPIAR DESCRIPCI√ìN SIMPLE (CORREGIDA) ---
// Ahora recibimos el bot√≥n (btnElement) como par√°metro
function copySimpleDesc(btnElement) {
    if(!selectedProduct) return;

    // 1. Limpiar HTML
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = selectedProduct.descripcion || "Sin descripci√≥n detallada.";
    const descLimpia = tempDiv.textContent || tempDiv.innerText || "";

    // 2. Texto
    const texto = 
`üì¶ *${selectedProduct.nombre}*

üìù *Detalles:*
${descLimpia.trim()}

üí∞ *Precio:* $${selectedProduct.precio} USD
üõ°Ô∏è *Garant√≠a:* ${selectedProduct.garantia || 'S√≠'}
üöö *Mensajer√≠a:* ${selectedProduct.mensajeria || 'Consultar'}`;

    // 3. Copiar
    navigator.clipboard.writeText(texto).then(() => {
        // AQUI ESTABA EL ERROR: Ahora usamos btnElement que recibimos arriba
        const original = btnElement.innerHTML;
        
        // Cambiamos el texto del bot√≥n temporalmente
        btnElement.innerHTML = `<span class="material-symbols-outlined text-xl text-green-500">check</span>Copiado`;
        btnElement.classList.add("border-green-500", "text-green-500"); // Ponerlo verde
        
        setTimeout(() => {
            btnElement.innerHTML = original;
            btnElement.classList.remove("border-green-500", "text-green-500"); // Quitar verde
        }, 2000);
        
    }).catch(err => {
        alert("Error al copiar: " + err);
    });
}

// --- S√öPER FUNCI√ìN IA: MULTI-FOTO + CATEGOR√çAS INTELIGENTES ---
async function superMagicAI() {
    const btn = event.currentTarget;
    const originalContent = btn.innerHTML;

    // --- 1. OBTENER CATEGOR√çAS ---
    const listaOrigen = (typeof inventoryRawAdmin !== 'undefined' && inventoryRawAdmin.length > 0) ? inventoryRawAdmin : productosRaw;
    let categoriasTexto = "VARIOS";
    if (listaOrigen && listaOrigen.length > 0) {
        const catsUnicas = [...new Set(listaOrigen.map(p => p.categoria ? p.categoria.toUpperCase().trim() : 'VARIOS'))];
        categoriasTexto = catsUnicas.join(', ');
    }

    // --- 2. DATOS DE ENTRADA ---
    let clipboardText = "";
    try { clipboardText = await navigator.clipboard.readText(); } catch (e) { }

    const imageParts = [];
    let photosFound = 0;
    for (let i = 0; i < 4; i++) {
        const input = document.getElementById(`file-${i}`);
        if (input && input.files && input.files[0]) {
            const base64Data = await fileToBase64(input.files[0]);
            imageParts.push({ inline_data: { mime_type: input.files[0].type, data: base64Data } });
            photosFound++;
        }
    }

    if (!clipboardText && photosFound === 0) {
        return alert("‚ö†Ô∏è Falta informaci√≥n: Copia texto o sube fotos.");
    }

    btn.disabled = true;
    btn.innerHTML = `<div class="flex items-center gap-2"><span class="loader w-4 h-4 border-white"></span><span>Contactando Google...</span></div>`;

    try {
        // --- 3. PROMPT ---
        const parts = [];
        let prompt = `Eres un asistente experto en inventario.
        CATEGOR√çAS EXISTENTES: [ ${categoriasTexto} ].
        INSTRUCCIONES:
        1. Analiza Texto y Fotos.
        2. Elige una categor√≠a de la lista o crea una nueva si es muy diferente.
        3. Si hay datos t√©cnicos en las fotos, √∫salos en la descripci√≥n.
        
        Responde SOLO con este JSON:
        {
            "nombre": "Nombre producto", "precio": 0, "categoria": "CATEGORIA",
            "garantia": "Garant√≠a", "mensajeria": "Info env√≠o",
            "descripcion_html": "HTML con detalles"
        }`;

        parts.push({ text: prompt });
        if (clipboardText) parts.push({ text: `TEXTO: ${clipboardText}` });
        imageParts.forEach(imgPart => parts.push(imgPart));

        // --- 4. PETICI√ìN A GOOGLE (URL CORREGIDA) ---
        // ¬°¬°¬° NO OLVIDES PONER TU CLAVE REAL AQU√ç !!!
        const API_KEY = "AIzaSyDSZSF1Br9P1trG98UjF7fqq-0ucBpoYpc"; 
        
        if(API_KEY.includes("TU_CLAVE_REAL") || API_KEY.length < 10) {
            throw new Error("¬°Falta poner la API KEY en el c√≥digo!");
        }

        // *** AQU√ç EST√Å EL CAMBIO (A√ëADIDO -latest) ***
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${API_KEY}`;

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: parts }] })
        });

        if (!response.ok) {
            const errorData = await response.json();
            console.error("ERROR GOOGLE:", errorData);
            throw new Error(`Google dice: ${errorData.error.message} (C√≥digo: ${response.status})`);
        }

        const data = await response.json();
        
        // --- 5. PROCESAR ---
        const rawText = data.candidates[0].content.parts[0].text;
        const jsonString = rawText.replace(/```json|```/g, '').trim();
        const resultado = JSON.parse(jsonString);

        // Rellenar campos
        document.getElementById('p-nombre').value = resultado.nombre || "";
        document.getElementById('p-precio').value = resultado.precio || "";
        document.getElementById('p-categoria').value = resultado.categoria || "VARIOS";
        document.getElementById('p-garantia').value = resultado.garantia || "";
        if(document.getElementById('p-mensajeria')) document.getElementById('p-mensajeria').value = resultado.mensajeria || "";
        
        const precioNum = parseFloat(resultado.precio) || 0;
        document.getElementById('p-comision').value = (precioNum > 100) ? 15 : 5;

        if (typeof quill !== 'undefined') quill.root.innerHTML = resultado.descripcion_html || "";

        btn.className = "w-2/3 bg-green-500 text-white py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
        btn.innerHTML = `¬°√âXITO!`;
        setTimeout(() => { btn.className = originalContent; btn.innerHTML = originalContent; btn.disabled = false; }, 2000);

    } catch (error) {
        console.error(error);
        alert("‚ùå FALL√ì LA IA:\n\n" + error.message);
        btn.innerHTML = originalContent;
        btn.disabled = false;
    }
}

// Funci√≥n auxiliar (Aseg√∫rate de tenerla en el c√≥digo, si ya la tienes no la dupliques)
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// --- L√ìGICA NIVEL 4: MEJOR HORARIO (Basado en pedidos del gestor) ---
function getPeakSalesTime(misPedidos) {
    if (!misPedidos || misPedidos.length === 0) return "Sin datos";

    // Creamos un mapa de 24 horas
    const horasConteo = Array(24).fill(0);

    misPedidos.forEach(p => {
        const fecha = new Date(p.fecha || p.created_at);
        const hora = fecha.getHours();
        horasConteo[hora]++;
    });

    // Encontramos la hora con m√°s pedidos
    const maxVentas = Math.max(...horasConteo);
    const horaPico = horasConteo.indexOf(maxVentas);

    // Formateamos el rango (Ej: 14:00 - 16:00)
    const inicio = horaPico;
    const fin = (horaPico + 2) % 24;
    
    const format = (h) => h === 0 ? "12 AM" : h > 12 ? `${h - 12} PM` : `${h} AM`;
    
    return `${format(inicio)} - ${format(fin)}`;
}

// --- L√ìGICA NIVEL 3: RADAR DE TENDENCIAS (Global - √öltimos 7 d√≠as) ---
function getGlobalTrendRadar(todosLosPedidos) {
    if (!todosLosPedidos || todosLosPedidos.length === 0) return "Analizando mercado...";

    const hace7Dias = new Date();
    hace7Dias.setDate(hace7Dias.getDate() - 7);

    // Filtramos solo pedidos recientes para detectar "Tendencia", no historia
    const pedidosRecientes = todosLosPedidos.filter(p => new Date(p.fecha || p.created_at) >= hace7Dias);

    const conteoProductos = {};
    pedidosRecientes.forEach(p => {
        // Limpiamos el nombre del producto (ej: "1x Split..." -> "Split")
        let nombre = p.producto.replace(/^\d+x\s+/, '').split('[')[0].trim();
        conteoProductos[nombre] = (conteoProductos[nombre] || 0) + 1;
    });

    // Ordenamos y tomamos los 3 mejores
    return Object.entries(conteoProductos)
        .sort(([, a], [, b]) => b - a)
        .slice(0, 3)
        .map(([name, count]) => ({ name, count }));
}

// 1. Cargar gestores pendientes (Llamar esto dentro de loadAdminData)
async function loadPendingGestores() {
    // Usamos supabaseClient
    const { data, error } = await supabaseClient
        .from('gestores')
        .select('*')
        .in('estado', ['pendiente', 'activo', 'bloqueado'])
        .order('nombre', { ascending: true });

    if (error) return console.error("Error cargando gestores:", error);

    const containerPendientes = document.getElementById('list-admin-aprobaciones');
    const containerActivos = document.getElementById('list-admin-activos');
    
    if (!containerPendientes || !containerActivos) return;

    // Filtrar
    const pendientes = data.filter(g => g.estado === 'pendiente');
    const activos = data.filter(g => g.estado === 'activo');

    // --- RENDERIZAR PENDIENTES ---
    if (pendientes.length === 0) {
        containerPendientes.innerHTML = `<tr><td colspan="3" class="p-6 text-center text-gray-400 text-[10px] font-bold uppercase italic">No hay solicitudes nuevas.</td></tr>`;
    } else {
        containerPendientes.innerHTML = pendientes.map(g => `
            <tr class="text-xs border-b dark:border-gray-700 bg-white dark:bg-gray-900">
                <td class="p-4 font-bold text-primary uppercase">${g.nombre}</td>
                <td class="p-4 font-medium text-gray-500">${g.telefono}</td>
                <td class="p-4 text-right">
                    <button onclick="approveGestor('${g.id}', 'activo', '${g.nombre}')" class="bg-emerald-500 text-white px-3 py-1.5 rounded-lg font-black uppercase text-[9px] hover:bg-emerald-600">Activar</button>
                    <button onclick="approveGestor('${g.id}', 'bloqueado')" class="bg-red-50 text-red-500 px-3 py-1.5 rounded-lg font-black uppercase text-[9px] ml-1">Rechazar</button>
                </td>
            </tr>
        `).join('');
    }

    // --- RENDERIZAR ACTIVOS ---
    if (activos.length === 0) {
        containerActivos.innerHTML = `<tr><td colspan="3" class="p-6 text-center text-gray-400 text-[10px] font-bold uppercase italic">A√∫n no tienes equipo activo.</td></tr>`;
    } else {
        containerActivos.innerHTML = activos.map(g => `
            <tr class="text-xs border-b dark:border-gray-700 bg-white dark:bg-gray-900">
                <td class="p-4 font-bold text-slate-700 dark:text-white uppercase">${g.nombre}</td>
                <td class="p-4 font-medium text-gray-500">${g.telefono}</td>
                <td class="p-4 text-right">
                    <button onclick="removeGestor('${g.id}', '${g.nombre}')" class="text-red-400 hover:text-red-600 p-2 transition-colors">
                        <span class="material-symbols-outlined text-sm">delete</span>
                    </button>
                </td>
            </tr>
        `).join('');
    }
}

async function generarComprobanteVenta(datosPedido, accion) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // PALETA DE COLORES PREMIUM
    const cPrimary = [26, 71, 137];   // Azul Profundo
    const cSecondary = [44, 111, 181]; // Azul Accento
    const cSlate = [30, 41, 59];      // Gris Oscuro para textos
    const cLight = [100, 116, 139];   // Gris suave para etiquetas

    const nombreGestor = window.gestorName || "Asesor de Ventas";
    const telfGestor = getAgentPhone();
    const slug = window.location.search.includes('s=') ? new URLSearchParams(window.location.search).get('s') : 'oficial';
    const linkPersonal = `${window.location.origin}${window.location.pathname}?s=${slug}`;

    // --- 1. CABECERA (HEADER PREMIUM) ---
    doc.setFillColor(...cPrimary);
    doc.rect(0, 0, 210, 50, 'F'); 

    doc.setTextColor(255, 255, 255);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(40);
    doc.text("PREFACTURA", 15, 35);

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    const fechaActual = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' });
    doc.text(`EMITIDA EL: ${fechaActual.toUpperCase()}`, 195, 33, { align: "right" });

    // --- 2. BLOQUES DE DATOS (CLIENTE VS GESTOR) ---
    // Etiquetas
    doc.setTextColor(...cLight);
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.text("DATOS DEL CLIENTE (FACTURADO A)", 15, 65);
    doc.text("DATOS DEL COMERCIAL (ATENDIDO POR)", 120, 65);

    // Separador visual fino
    doc.setDrawColor(226, 232, 240);
    doc.line(15, 67, 195, 67);

    // Informaci√≥n del Cliente
    doc.setTextColor(...cSlate);
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.text(datosPedido.cliente.toUpperCase(), 15, 75);
    
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text(`Carnet ID: ${datosPedido.ci || 'No especificado'}`, 15, 81);
    doc.setTextColor(...cLight);
    doc.text("Direcci√≥n de Entrega:", 15, 87);
    doc.setTextColor(...cSlate);
    doc.text(datosPedido.direccion, 15, 92, { maxWidth: 85 });

    // Informaci√≥n del Gestor
    doc.setFont("helvetica", "bold");
    doc.text(nombreGestor.toUpperCase(), 120, 75);
    
    doc.setFont("helvetica", "normal");
    doc.text(`WhatsApp: +${telfGestor}`, 120, 81);
    doc.text(`Correo: ${window.currentUserData?.email || 'ventas@paratuhogar.cu'}`, 120, 86);
    
    // Bot√≥n / Link Interactivo
    doc.setTextColor(...cSecondary);
    doc.setFont("helvetica", "bold");
    doc.text("VISITAR MI TIENDA ONLINE", 120, 95);
    doc.setDrawColor(...cSecondary);
    doc.line(120, 96, 172, 96); // Subrayado est√©tico
    doc.link(120, 92, 60, 6, { url: linkPersonal });

    // --- 3. TABLA DE PRODUCTOS (ESTILO LIMPIO) ---
    const filasTabla = datosPedido.items.map(i => [
        i.nombre.toUpperCase(), 
        i.qty, 
        `$${i.price.toLocaleString()}.00`, 
        `$${(i.price * i.qty).toLocaleString()}.00`
    ]);

    if (Number(datosPedido.mensajeria) > 0) {
        filasTabla.push([
            'SERVICIO DE ENTREGA Y LOG√çSTICA A DOMICILIO', 
            '1', 
            `$${datosPedido.mensajeria.toLocaleString()}.00`, 
            `$${datosPedido.mensajeria.toLocaleString()}.00`
        ]);
    }

    doc.autoTable({
        startY: 110,
        head: [['DESCRIPCI√ìN DEL EQUIPO / SERVICIO', 'CANT', 'PRECIO UNIT.', 'SUBTOTAL']],
        body: filasTabla,
        theme: 'striped',
        headStyles: { fillColor: cPrimary, textColor: 255, fontStyle: 'bold', fontSize: 9 },
        bodyStyles: { textColor: cSlate, fontSize: 10 },
        columnStyles: {
            0: { cellWidth: 'auto' },
            1: { halign: 'center', cellWidth: 15 },
            2: { halign: 'right', cellWidth: 35 },
            3: { halign: 'right', cellWidth: 35, fontStyle: 'bold' }
        },
        alternateRowStyles: { fillColor: [248, 250, 252] }
    });

    // --- 4. RESUMEN FINANCIERO ---
    const finalY = doc.lastAutoTable.finalY + 10;
    
    // Caja de Total
    doc.setFillColor(...cPrimary);
    doc.rect(125, finalY, 70, 15, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(10);
    doc.text("TOTAL A PAGAR:", 130, finalY + 9.5);
    doc.setFontSize(14);
    doc.text(`$${datosPedido.totalUSD.toLocaleString()}.00`, 190, finalY + 9.5, { align: "right" });

    // --- 5. NOTAS Y PIE DE P√ÅGINA ---
    doc.setTextColor(...cLight);
    doc.setFontSize(8);
    doc.setFont("helvetica", "bold");
    doc.text("NOTAS E INSTRUCCIONES DE PAGO:", 15, finalY + 10);
    
    doc.setFont("helvetica", "normal");
    const notas = [
        "‚Ä¢ El pago se realiza en efectivo al momento de recibir el equipo.",
        "‚Ä¢ Verifique el estado del producto antes de que el mensajero se retire.",
        "‚Ä¢ Esta prefactura reserva el producto por un periodo de 24 horas."
    ];
    doc.text(notas, 15, finalY + 16);

    // Firma de Calidad
    doc.setFontSize(22);
    doc.setTextColor(...cPrimary);
    doc.setFont("helvetica", "bold");
    doc.text("¬°Gracias por elegirnos!", 195, finalY + 45, { align: "right" });
    
    doc.setFontSize(8);
    doc.setTextColor(...cLight);
    doc.text("Generado autom√°ticamente por el Sistema de Gesti√≥n paratuhogar.cu", 105, 285, { align: "center" });

    // --- 6. SALIDA ---
    const nombreArchivo = `Prefactura_${datosPedido.cliente.replace(/\s+/g, '_')}.pdf`;

    if (accion === 'compartir' && navigator.share) {
        const pdfBlob = doc.output('blob');
        const file = new File([pdfBlob], nombreArchivo, { type: 'application/pdf' });
        try {
            await navigator.share({ files: [file], title: 'Su Prefactura - paratuhogar' });
        } catch (err) { doc.save(nombreArchivo); }
    } else {
        doc.save(nombreArchivo);
    }
}

// Funci√≥n para verificar si un tel√©fono ya pertenece a un Gestor Nivel 5
async function checkCustomerOwnership(phone) {
    if (!phone) return null;
    try {
        const { data, error } = await supabaseClient
            .from('customer_bindings')
            .select('agent_name')
            .eq('phone', phone.replace(/\D/g, ''))
            .single();
        
        if (data && data.agent_name) {
            console.log("üíé Cliente vinculado permanentemente a:", data.agent_name);
            return data.agent_name;
        }
    } catch (e) {
        // console.log("Cliente sin due√±o previo");
    }
    return null;
}

// Funci√≥n para dejar rastro de IP al usar un link
async function registrarRastroIP(nombreGestor) {
    try {
        const res = await fetch('https://api.ipify.org?format=json');
        const { ip } = await res.json();
        
        // Guardamos en la tabla de anal√≠tica
        await supabaseClient.from('link_analytics').insert([{
            agent_name: nombreGestor,
            ip_address: ip
        }]);
    } catch (e) { console.error("Rastro IP fallido (VPN o Bloqueo)"); }
}

// Funci√≥n para buscar si una IP tiene due√±o en las √∫ltimas 48 horas
async function buscarDuenoPorIP() {
    try {
        const res = await fetch('https://api.ipify.org?format=json');
        const { ip } = await res.json();
        
        // Buscamos el rastro m√°s reciente de esta IP (m√°ximo 48h de antig√ºedad)
        const limiteTiempo = new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString();

        const { data, error } = await supabaseClient
            .from('link_analytics')
            .select('agent_name')
            .eq('ip_address', ip)
            .gte('timestamp', limiteTiempo) // Filtro de 48 horas
            .order('timestamp', { ascending: false })
            .limit(1)
            .maybeSingle();
            
        return data ? data.agent_name : null;
    } catch (e) { return null; }
}

// --- NUEVA FUNCI√ìN: GR√ÅFICA DE ORIGEN DE VENTAS ---
function renderSourceChart(ventas) {
    // 1. Calcular Datos
    const total = ventas.length;
    if (total === 0) return;

    const manuales = ventas.filter(v => v.origen === 'Manual (Panel)').length;
    const enlaces = ventas.filter(v => v.origen === 'Enlace Compartido').length;
    const otros = total - manuales - enlaces;

    // Porcentajes para las barras
    const pEnlace = Math.round((enlaces / total) * 100);
    const pManual = Math.round((manuales / total) * 100);
    const pOtros = 100 - pEnlace - pManual;

    // 2. Insertar HTML antes de la lista
    const listContainer = document.getElementById('list-mis-pedidos');
    const existingChart = document.getElementById('chart-sources-container');
    if (existingChart) existingChart.remove(); // Evitar duplicados

    const advice = pEnlace > pManual 
        ? "¬°Tus enlaces funcionan genial! Sigue compartiendo." 
        : "Eres fuerte en venta manual. Intenta mover m√°s tu enlace para ingresos pasivos.";

    const html = `
    <div id="chart-sources-container" class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-700 p-6 mb-8 shadow-sm">
        <!-- T√≠tulo m√°s grande y oscuro -->
        <h3 class="text-sm md:text-base font-black uppercase text-slate-700 dark:text-white mb-5 flex items-center gap-2">
            <span class="material-symbols-outlined text-primary text-2xl">pie_chart</span> Fuentes de Tr√°fico
        </h3>
        
        <!-- Barra Visual m√°s gruesa (h-6 en vez de h-4) -->
        <div class="flex h-6 w-full rounded-full overflow-hidden mb-6 bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
            <div style="width: ${pEnlace}%" class="bg-blue-600 h-full shadow-inner" title="Enlaces"></div>
            <div style="width: ${pManual}%" class="bg-orange-500 h-full shadow-inner" title="Manual"></div>
            <div style="width: ${pOtros}%" class="bg-gray-400 h-full shadow-inner" title="Otros"></div>
        </div>

        <!-- Leyenda con Letras Grandes y Alto Contraste -->
        <div class="flex flex-col sm:flex-row justify-between text-center gap-4">
            
            <!-- Caja Enlaces -->
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-2xl flex-1 border border-blue-100 dark:border-blue-800/50">
                <p class="text-xs font-black uppercase text-blue-700 dark:text-blue-300 mb-1 tracking-wider">üîó Enlaces</p>
                <div class="flex items-baseline justify-center gap-2">
                    <p class="text-4xl font-black text-blue-900 dark:text-blue-100">${enlaces}</p> 
                    <span class="text-sm font-bold text-blue-600 dark:text-blue-400">(${pEnlace}%)</span>
                </div>
            </div>

            <!-- Caja Manual -->
            <div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-2xl flex-1 border border-orange-100 dark:border-orange-800/50">
                <p class="text-xs font-black uppercase text-orange-700 dark:text-orange-300 mb-1 tracking-wider">‚úçÔ∏è Manual</p>
                <div class="flex items-baseline justify-center gap-2">
                    <p class="text-4xl font-black text-orange-800 dark:text-orange-100">${manuales}</p> 
                    <span class="text-sm font-bold text-orange-600 dark:text-orange-400">(${pManual}%)</span>
                </div>
            </div>
        </div>
        
        <!-- Consejo IA m√°s legible -->
        <div class="mt-5 pt-3 border-t border-gray-100 dark:border-gray-700">
            <p class="text-xs md:text-sm font-medium text-slate-600 dark:text-gray-300 text-center flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-amber-500 text-lg">lightbulb</span>
                ${advice}
            </p>
        </div>
    </div>`;
    
    // Insertamos la gr√°fica ANTES de la lista de pedidos
    listContainer.insertAdjacentHTML('beforebegin', html);
}
function esMensajeriaAmbigua(texto) {
    if (!texto) return false;
    const t = texto.toLowerCase();
    // Palabras clave que indican que no hay un precio fijo simple
    return t.includes('consultar') || t.includes('adicional') || t.includes('periferia') || t.includes('depende') || t.includes('variable');
}

// --- L√ìGICA DE PESTA√ëAS DEL DASHBOARD ---
function showDashSection(section) {
    // Ocultar todo
    document.getElementById('sub-dash-resumen').classList.add('hidden');
    document.getElementById('sub-dash-precios').classList.add('hidden');
    
    // Desactivar botones
    document.getElementById('btn-dash-resumen').className = "px-4 py-2 bg-white text-gray-500 rounded-xl text-xs font-black uppercase border border-gray-100 transition-all";
    document.getElementById('btn-dash-precios').className = "px-4 py-2 bg-white text-gray-500 rounded-xl text-xs font-black uppercase border border-gray-100 transition-all";

    // Activar selecci√≥n
    if(section === 'resumen') {
        document.getElementById('sub-dash-resumen').classList.remove('hidden');
        document.getElementById('btn-dash-resumen').className = "px-4 py-2 bg-[#1a4789] text-white rounded-xl text-xs font-black uppercase shadow-md transition-all";
    } else {
        document.getElementById('sub-dash-precios').classList.remove('hidden');
        document.getElementById('btn-dash-precios').className = "px-4 py-2 bg-indigo-600 text-white rounded-xl text-xs font-black uppercase shadow-md transition-all";
        renderGestorPricing(); // Refrescar lista
    }
}

// --- RENDERIZAR LISTA DE EDICI√ìN DE PRECIOS ---
// --- RENDERIZAR LISTA DE EDICI√ìN DE PRECIOS ---
async function renderGestorPricing() {
    const container = document.getElementById('list-gestor-precios');
    if(!container) return;

    // 1. Filtrar productos flexibles Y DISPONIBLES
    const { data: productosBase } = await supabaseClient
        .from('productos')
        .select('*')
        .eq('precio_flexible', 'SI')
        .eq('disponible', 'SI')
        .order('nombre');

    if(!productosBase || productosBase.length === 0) {
        container.innerHTML = `<p class="text-gray-400 col-span-full text-center">No hay productos flexibles en stock.</p>`;
        return;
    }

    // 2. Obtener mis precios actuales
    const { data: misPrecios } = await supabaseClient
        .from('precios_personalizados')
        .select('*')
        .eq('gestor', window.gestorName);

    container.innerHTML = productosBase.map(p => {
        // Encontrar precio guardado (p.id es UUID string)
        const saved = misPrecios.find(c => c.producto_id === p.id);
        const precioActual = saved ? parseFloat(saved.nuevo_precio) : parseFloat(p.precio);
        const gananciaBase = parseFloat(p.comision);
        // Calculo inicial de ganancia
        const gananciaTotal = gananciaBase + (precioActual - parseFloat(p.precio));

        // Limpieza de nombre para evitar errores con comillas
        const nombreSafe = p.nombre.replace(/"/g, '&quot;');

        // OJO AQU√ç: He puesto comillas simples '${p.id}' dentro de las funciones onclick y oninput
        return `
        <div class="bg-white p-4 rounded-2xl border border-indigo-50 shadow-sm flex flex-col gap-3">
            <div class="flex gap-3">
                <img src="${fixDriveUrl(p.thumbnail)}" class="w-12 h-12 rounded-lg object-contain bg-gray-50">
                <div class="overflow-hidden">
                    <p class="text-[10px] font-bold text-gray-400 uppercase truncate">${p.categoria}</p>
                    <p class="text-xs font-black text-slate-700 leading-tight truncate">${nombreSafe}</p>
                    <p class="text-[10px] text-gray-500">Base: $${p.precio} | Comi: $${p.comision}</p>
                </div>
            </div>

            <div class="bg-gray-50 p-3 rounded-xl">
                <div class="flex justify-between items-center mb-1">
                    <label class="text-[9px] font-black uppercase text-indigo-400">Tu Precio de Venta</label>
                    <span id="gain-label-${p.id}" class="text-[9px] font-bold text-emerald-500">
                        Ganancia: $${gananciaTotal.toFixed(0)}
                    </span>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="input-price-${p.id}" value="${precioActual}" min="${p.precio}" 
                        oninput="calcGainUI('${p.id}', ${p.precio}, ${p.comision})"
                        class="w-full rounded-lg border-gray-200 text-sm font-black text-slate-700 px-3 py-2">
                    
                    <button onclick="saveMyPrice('${p.id}', ${p.precio})" 
                        class="bg-indigo-600 text-white px-4 rounded-lg font-bold text-xs shadow-md active:scale-95 transition-colors">
                        <span class="material-symbols-outlined text-lg">save</span>
                    </button>
                </div>
            </div>
        </div>`;
    }).join('');
}

// Hacemos la funci√≥n global asign√°ndola a window expl√≠citamente por si acaso
window.calcGainUI = function(id, basePrice, baseComm) {
    const input = document.getElementById(`input-price-${id}`);
    const label = document.getElementById(`gain-label-${id}`);
    
    const val = parseFloat(input.value);
    
    // Si est√° vac√≠o o no es n√∫mero
    if(isNaN(val)) {
        label.innerText = "...";
        return;
    }

    const diff = val - basePrice;
    const totalGain = baseComm + diff;

    if (val < basePrice) {
        label.innerText = `‚ö†Ô∏è Pierdes $${Math.abs(diff).toFixed(0)}`;
        label.classList.remove('text-emerald-500');
        label.classList.add('text-red-500');
    } else {
        label.innerText = `Ganancia: $${totalGain.toFixed(0)}`;
        label.classList.remove('text-red-500');
        label.classList.add('text-emerald-500');
    }
}

// Hacemos la funci√≥n global asign√°ndola a window
window.saveMyPrice = async function(prodId, basePrice) {
    const input = document.getElementById(`input-price-${prodId}`);
    const newPrice = parseFloat(input.value);
    const gestorActual = window.gestorName;

    // VALIDACIONES
    if (!gestorActual) return alert("Error de sesi√≥n. Recarga la p√°gina.");
    if (isNaN(newPrice)) return alert("El precio no es v√°lido.");
    if (newPrice < basePrice) return alert(`El precio m√≠nimo es $${basePrice}`);

    // UI DE CARGA
    const btn = event.currentTarget;
    const originalContent = btn.innerHTML;
    btn.innerHTML = `<span class="loader" style="width:15px;height:15px;border:2px solid white;border-bottom-color:transparent;border-radius:50%;display:inline-block;animation:rotation 1s linear infinite"></span>`;
    btn.disabled = true;

    try {
        console.log("Guardando para:", prodId); // Debug

        // 1. Buscar si existe (Usando UUID)
        const { data: existing, error: searchError } = await supabaseClient
            .from('precios_personalizados')
            .select('id')
            .eq('gestor', gestorActual)
            .eq('producto_id', prodId) // prodId ya es string UUID
            .maybeSingle();

        if (searchError) throw searchError;

        let errorGuardado;

        if (existing) {
            // UPDATE
            const { error } = await supabaseClient
                .from('precios_personalizados')
                .update({ nuevo_precio: newPrice })
                .eq('id', existing.id); // existing.id es UUID
            errorGuardado = error;
        } else {
            // INSERT
            const { error } = await supabaseClient
                .from('precios_personalizados')
                .insert([{ 
                    gestor: gestorActual, 
                    producto_id: prodId, 
                    nuevo_precio: newPrice 
                }]);
            errorGuardado = error;
        }

        if (errorGuardado) throw errorGuardado;

        // √âXITO
        btn.innerHTML = `<span class="material-symbols-outlined">check</span>`;
        btn.classList.replace('bg-indigo-600', 'bg-emerald-500');

        setTimeout(() => {
            btn.innerHTML = `<span class="material-symbols-outlined text-lg">save</span>`;
            btn.classList.replace('bg-emerald-500', 'bg-indigo-600');
            btn.disabled = false;
        }, 2000);

    } catch (e) {
        console.error(e);
        alert("Error al guardar: " + e.message);
        btn.innerHTML = originalContent;
        btn.disabled = false;
    }
}

// Funci√≥n para actualizar la etiqueta de ganancia en tiempo real
function calcGainUI(id, basePrice, baseComm) {
    const input = document.getElementById(`input-price-${id}`);
    const label = document.getElementById(`gain-label-${id}`);
    
    // Parseamos el nuevo precio. Si est√° vac√≠o, asumimos el precio base.
    const newVal = parseFloat(input.value) || basePrice;
    
    // Calculamos la ganancia total: Comisi√≥n Base + (Sobreprecio)
    const extra = newVal - basePrice;
    const total = baseComm + extra;

    if (newVal < basePrice) {
        label.innerText = `‚ö†Ô∏è Pierdes $${Math.abs(extra).toFixed(0)}`;
        label.classList.remove('text-emerald-500');
        label.classList.add('text-red-500');
    } else {
        label.innerText = `Ganancia: $${total.toFixed(0)}`;
        label.classList.remove('text-red-500');
        label.classList.add('text-emerald-500');
    }
}

// --- CONFIGURACI√ìN DE NOTICIAS ---
// Cambia este texto cuando pongas una funcionalidad nueva para que le salga a todos de nuevo
const CURRENT_CAMPAIGN = 'info_precios_v1'; 

function showPriceIntro() {
    // Verificamos si el usuario ya vio ESTA campa√±a espec√≠fica
    const yaVisto = localStorage.getItem(CURRENT_CAMPAIGN);
    
    if (!yaVisto) {
        console.log("Mostrando cartel de informaci√≥n: " + CURRENT_CAMPAIGN);
        const modal = document.getElementById('modal-intro-precios');
        if (modal) {
            modal.classList.remove('hidden');
        } else {
            console.error("No se encontr√≥ el modal-intro-precios en el HTML");
        }
    } else {
        console.log("El usuario ya vio la campa√±a: " + CURRENT_CAMPAIGN);
    }
}

function closePriceIntro() {
    document.getElementById('modal-intro-precios').classList.add('hidden');
    
    // Guardamos que ya vio ESTA versi√≥n del cartel
    localStorage.setItem(CURRENT_CAMPAIGN, 'true');
    
    // Opcional: Llevarlo a la secci√≥n correspondiente
    showDashSection('precios'); 
}

// Funci√≥n para saltar al Studio con los filtros actuales
function goToStudio() {
    // 1. Capturar qu√© est√° viendo el gestor ahora mismo
    const searchInput = document.getElementById('search-bar');
    const query = searchInput ? searchInput.value.trim() : "";
    
    // 'activeCategory' es la variable global que ya usas en tu c√≥digo actual
    const category = activeCategory || "TODOS";

    // 2. Construir la URL con par√°metros
    // Ejemplo: studio.html?q=refrigerador&cat=LINEA%20BLANCA
    const params = new URLSearchParams();
    if (query) params.append('q', query);
    if (category && category !== 'TODOS') params.append('cat', category);

    // 3. Viajar al Studio
    window.location.href = `studio.html?${params.toString()}`;
}

</script>

<!-- === 2. MODAL SISTEMA DE GAMIFICACI√ìN (PLAN DE CARRERA) === -->
<!-- === 2. MODAL SISTEMA DE GAMIFICACI√ìN (VERSI√ìN EDUCATIVA PRO) === -->
<div id="modal-gamification" class="fixed inset-0 z-[250] hidden bg-[#0f172a]/95 backdrop-blur-md overflow-y-auto animate-fade-in">
    <div class="min-h-screen px-4 py-12 flex items-center justify-center">
        <div class="w-full max-w-6xl bg-[#f8fafc] dark:bg-[#1e293b] rounded-[40px] shadow-2xl overflow-hidden border border-white/10 relative">
            
            <button onclick="closeGamificationModal()" class="absolute top-6 right-6 z-20 h-10 w-10 bg-white dark:bg-gray-700 rounded-full flex items-center justify-center shadow-lg hover:rotate-90 transition-transform">
                <span class="material-symbols-outlined text-gray-600 dark:text-white">close</span>
            </button>

            <!-- Header -->
            <div class="bg-[#1a4789] px-6 py-12 md:px-12 md:py-16 text-white text-center relative overflow-hidden">
                <span class="material-symbols-outlined text-6xl mb-4 text-amber-400 drop-shadow-lg">workspace_premium</span>
                <h2 class="text-3xl md:text-5xl font-black italic uppercase tracking-tighter mb-4">Tu Carrera <span class="text-blue-300">Profesional</span></h2>
                <p class="text-sm md:text-base text-blue-100 max-w-2xl mx-auto">
                    Asciende de rango para desbloquear herramientas que multiplicar√°n tus ventas y asegura tus comisiones por m√°s tiempo.
                </p>
            </div>

            <!-- Cuerpo -->
            <div class="p-6 md:p-10 space-y-8">
                
                <!-- GRID DE NIVELES -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    
                    <!-- Nivel 0 -->
                    <div id="card-lvl-0" class="level-card active current group">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-sm font-black uppercase text-[#1a4789]">Nivel 0: Iniciado</h4>
                                <p class="text-[10px] font-bold text-gray-400 mt-1">Requisito: 0 - 2 Ventas</p>
                            </div>
                            <span class="material-symbols-outlined text-3xl text-gray-300">water_drop</span>
                        </div>
                        <div class="mb-5">
                            <p class="text-[9px] font-black uppercase text-gray-400 mb-1 flex justify-between">
                                <span>Duraci√≥n Enlace</span>
                                <span class="text-red-500">1 SEMANA</span>
                            </p>
                            <div class="vital-link-bar"><div class="vital-link-fill bg-red-400" style="width: 10%"></div></div>
                        </div>
                        <div class="space-y-2">
                            <p class="text-[9px] font-black uppercase text-gray-400">Herramientas Base:</p>
                            <div class="flex items-center gap-2 text-xs font-bold text-gray-600 bg-gray-100 p-2 rounded-lg">
                                <span class="material-symbols-outlined text-emerald-500 text-sm">check_circle</span> Compartir Enlace
                            </div>
                            <div class="flex items-center gap-2 text-xs font-bold text-gray-600 bg-gray-100 p-2 rounded-lg">
                                <span class="material-symbols-outlined text-emerald-500 text-sm">check_circle</span> Descarga 1 Foto
                            </div>
                        </div>
                    </div>

                    <!-- Nivel 1 -->
                    <div id="card-lvl-1" class="level-card locked group">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-sm font-black uppercase text-gray-500">Nivel 1: Novato</h4>
                                <p class="text-[10px] font-bold text-gray-400 mt-1">Requisito: 3 - 9 Ventas</p>
                            </div>
                            <span class="material-symbols-outlined text-3xl text-gray-300">bolt</span>
                        </div>
                        <div class="mb-5">
                            <p class="text-[9px] font-black uppercase text-gray-400 mb-1 flex justify-between">
                                <span>Duraci√≥n Enlace</span>
                                <span class="text-orange-500">1 MES</span>
                            </p>
                            <div class="vital-link-bar"><div class="vital-link-fill bg-orange-400" style="width: 25%"></div></div>
                        </div>
                        <div class="space-y-2">
                            <p class="text-[9px] font-black uppercase text-gray-400">Desbloqueas:</p>
                            <button onclick="alertLockedInfo('Respuesta Flash', 'Con un clic, el sistema escribe por ti un mensaje de WhatsApp perfecto para el cliente: Hola, tengo este equipo, cuesta tanto... ¬°Ahorra escribir!')" class="btn-tool-locked">
                                <span class="material-symbols-outlined text-gray-400 text-base">flash_on</span> Respuesta Flash
                            </button>
                            <button onclick="alertLockedInfo('Story Maker', 'Dise√±a autom√°ticamente una imagen vertical para tus Estados de WhatsApp e Instagram, con el precio y la foto bien puestos.')" class="btn-tool-locked">
                                <span class="material-symbols-outlined text-gray-400 text-base">fit_screen</span> Story Maker
                            </button>
                        </div>
                    </div>

                    <!-- Nivel 2 -->
                    <div id="card-lvl-2" class="level-card locked group">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-sm font-black uppercase text-gray-500">Nivel 2: Experto</h4>
                                <p class="text-[10px] font-bold text-gray-400 mt-1">Requisito: 10 - 19 Ventas</p>
                            </div>
                            <span class="material-symbols-outlined text-3xl text-gray-300">bubble_chart</span>
                        </div>
                        <div class="mb-5">
                            <p class="text-[9px] font-black uppercase text-gray-400 mb-1 flex justify-between">
                                <span>Duraci√≥n Enlace</span>
                                <span class="text-blue-500">1 MES</span>
                            </p>
                            <div class="vital-link-bar"><div class="vital-link-fill bg-blue-400" style="width: 40%"></div></div>
                        </div>
                        <div class="space-y-2">
                            <p class="text-[9px] font-black uppercase text-gray-400">Desbloqueas:</p>
                            <button onclick="alertLockedInfo('Pack Fotos ZIP', '¬øCansado de bajar fotos una por una? Este bot√≥n descarga 50 fotos de ollas o neveras en un solo archivo comprimido.')" class="btn-tool-locked">
                                <span class="material-symbols-outlined text-gray-400 text-base">folder_zip</span> Pack Fotos ZIP
                            </button>
                            <button onclick="alertLockedInfo('Copiado Masivo', 'Copia la descripci√≥n y precio de 20 productos a la vez. Perfecto para publicar en modo r√°faga en grupos de Facebook.')" class="btn-tool-locked">
                                <span class="material-symbols-outlined text-gray-400 text-base">content_copy</span> Copiado Masivo
                            </button>
                        </div>
                    </div>

                    <!-- Nivel 3 -->
                    <div id="card-lvl-3" class="level-card locked group">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-sm font-black uppercase text-gray-500">Nivel 3: √âlite</h4>
                                <p class="text-[10px] font-bold text-gray-400 mt-1">Requisito: 20 - 39 Ventas</p>
                            </div>
                            <span class="material-symbols-outlined text-3xl text-gray-300">military_tech</span>
                        </div>
                        <div class="mb-5">
                            <p class="text-[9px] font-black uppercase text-gray-400 mb-1 flex justify-between">
                                <span>Duraci√≥n Enlace</span>
                                <span class="text-indigo-500">3 MESES</span>
                            </p>
                            <div class="vital-link-bar"><div class="vital-link-fill bg-indigo-400" style="width: 65%"></div></div>
                        </div>
                        <div class="space-y-2">
                            <p class="text-[9px] font-black uppercase text-gray-400">Desbloqueas:</p>
                            <button onclick="alertLockedInfo('Radar Tendencias', 'Te muestra en tiempo real qu√© equipos se est√°n vendiendo m√°s hoy en la web, para que t√∫ tambi√©n los ofrezcas.')" class="btn-tool-locked">
                                <span class="material-symbols-outlined text-gray-400 text-base">radar</span> Radar Tendencias
                            </button>
                            <button onclick="alertLockedInfo('Anti-Spam Text', 'Facebook te bloquea si publicas lo mismo. Esta herramienta reescribe tus textos autom√°ticamente con IA.')" class="btn-tool-locked">
                                <span class="material-symbols-outlined text-gray-400 text-base">autorenew</span> Anti-Spam Text
                            </button>
                        </div>
                    </div>

                    <!-- Nivel 4 -->
                    <div id="card-lvl-4" class="level-card locked group border-dashed border-2">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-sm font-black uppercase text-gray-500">Nivel 4: Monarca</h4>
                                <p class="text-[10px] font-bold text-gray-400 mt-1">Requisito: 40+ Ventas</p>
                            </div>
                            <span class="material-symbols-outlined text-3xl text-gray-300">crown</span>
                        </div>
                        <div class="mb-5">
                            <p class="text-[9px] font-black uppercase text-gray-400 mb-1 flex justify-between">
                                <span>Duraci√≥n Enlace</span>
                                <span class="text-emerald-500">6 MESES</span>
                            </p>
                            <div class="vital-link-bar"><div class="vital-link-fill bg-emerald-500" style="width: 100%"></div></div>
                        </div>
                        <div class="space-y-2">
                            <p class="text-[9px] font-black uppercase text-gray-400">Desbloqueas:</p>
                            <button onclick="alertLockedInfo('Cat√°logo PDF Pro', 'Crea un archivo PDF oficial con las fotos y precios, pero incrustando TU NOMBRE y TU WHATSAPP en la portada.')" class="btn-tool-locked">
                                <span class="material-symbols-outlined text-gray-400 text-base">picture_as_pdf</span> Cat√°logo PDF Pro
                            </button>
                            <button onclick="alertLockedInfo('Reporte Contable', 'Descarga un documento formal con todas tus comisiones pagadas y pendientes para tu control.')" class="btn-tool-locked">
                                <span class="material-symbols-outlined text-gray-400 text-base">receipt_long</span> Reporte Contable
                            </button>
                        </div>
                    </div>

                    <!-- Nivel 5: Emperador -->
                <div id="card-lvl-5" class="level-card locked group border-double border-4 border-purple-400 bg-purple-50/10">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-sm font-black uppercase text-purple-600">Nivel 5: Emperador</h4>
                            <p class="text-[10px] font-bold text-gray-400 mt-1">Requisito: 70+ Ventas</p>
                        </div>
                        <span class="material-symbols-outlined text-3xl text-purple-300">diamond</span>
                    </div>
                    <div class="mb-5">
                        <p class="text-[9px] font-black uppercase text-gray-400 mb-1 flex justify-between">
                            <span>Duraci√≥n Enlace</span>
                            <span class="text-purple-600">1 A√ëO (ULTRA)</span>
                        </p>
                        <div class="w-full h-1.5 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-purple-500" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[9px] font-black uppercase text-gray-400">Poder M√°ximo:</p>
                        
                    </div>
                </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Bot√≥n Flotante de Contacto con Gestor -->
<div id="floating-agent-contact" class="hidden"></div>

<style>
    /* Efecto de pulso para que el cliente lo vea s√≠ o s√≠ */
    @keyframes pulse-green {
        0% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(37, 211, 102, 0); }
        100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); }
    }
    .pulse-wa { 
        animation: pulse-green 2s infinite; 
        border: 2px solid white;
    }
</style>

<!-- MODAL DE BIENVENIDA GESTOR (CORREGIDO CON SCROLL) -->
<div id="modal-welcome-agent" class="fixed inset-0 z-[300] hidden bg-[#0f172a]/95 backdrop-blur-md flex items-start justify-center p-4 overflow-y-auto">
    
    <!-- Contenedor Principal con margen arriba y abajo para que no se pegue -->
    <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-[2.5rem] overflow-hidden shadow-[0_0_50px_rgba(26,71,137,0.3)] relative my-8 animate-pop-in">
        
        <!-- BOT√ìN X DE CIERRE R√ÅPIDO -->
        <button onclick="closeWelcomeAgent()" class="absolute top-6 right-6 z-[310] h-10 w-10 bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white border border-white/20 transition-all">
            <span class="material-symbols-outlined">close</span>
        </button>

        <!-- Header con Gradiente -->
        <div class="bg-gradient-to-br from-[#1a4789] to-[#2c6fb5] p-10 text-center relative overflow-hidden">
            <div class="relative z-10">
                <div class="bg-white/20 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 backdrop-blur-md border border-white/30 shadow-xl">
                    <span class="material-symbols-outlined text-4xl text-white animate-bounce">rocket_launch</span>
                </div>
                <h2 class="text-white text-3xl font-black italic uppercase tracking-tighter">¬°Sistema Actualizado!</h2>
                <p class="text-blue-100 text-[10px] font-black uppercase tracking-[0.2em] opacity-80">Rango de Agente Detectado</p>
            </div>
        </div>

        <!-- Contenido -->
        <div class="p-8 space-y-8">
            
            <!-- Bot√≥n WA Activo -->
            <div class="flex items-center gap-4 bg-emerald-50 dark:bg-emerald-500/10 p-5 rounded-3xl border border-emerald-100 dark:border-emerald-500/20">
                <div class="h-12 w-12 bg-[#25D366] rounded-2xl flex items-center justify-center text-white shadow-lg shadow-green-500/40">
                    <span class="material-symbols-outlined">chat</span>
                </div>
                <div>
                    <h4 class="text-xs font-black text-emerald-700 dark:text-emerald-400 uppercase">Bot√≥n WhatsApp Activo</h4>
                    <p class="text-[10px] text-emerald-600/70 font-bold">Tus clientes ya pueden contactarte directamente.</p>
                </div>
            </div>

            <!-- Retenci√≥n -->
            <div class="grid grid-cols-2 gap-4">
                <div class="p-5 rounded-[2rem] bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 text-center">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-2">Tu Link Dura</p>
                    <p id="welcome-link-duration" class="text-xl font-black text-[#1a4789] dark:text-blue-400">---</p>
                </div>
                <div class="p-5 rounded-[2rem] bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 text-center">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-2">Siguiente Nivel</p>
                    <p id="welcome-next-power" class="text-xl font-black text-amber-500">---</p>
                </div>
            </div>

            <!-- √ÅRBOL DE HABILIDADES (Copiado de tu dise√±o anterior) -->
            <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white relative overflow-hidden border border-white/5">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <p class="text-[10px] font-bold text-blue-400 uppercase tracking-[0.2em] mb-1">Evoluci√≥n de Carrera</p>
                        <h3 class="text-xl font-black italic">√ÅRBOL DE HABILIDADES</h3>
                    </div>
                    <div id="welcome-rank-tag" class="bg-blue-600 px-4 py-1.5 rounded-full text-[10px] font-black uppercase">NIVEL 0</div>
                </div>
                <div id="welcome-features-list" class="space-y-4"></div>

                <!-- PANEL DE PRON√ìSTICO OPTIMISTA -->
<div class="mt-10 p-6 bg-gradient-to-br from-emerald-600/20 to-blue-600/20 rounded-[2rem] border border-emerald-500/30 relative overflow-hidden">
    <div class="relative z-10">
        <div class="flex items-center gap-2 mb-4">
            <div class="h-2 w-2 bg-emerald-400 rounded-full animate-ping"></div>
            <p class="text-[10px] font-black uppercase tracking-[0.2em] text-emerald-400">An√°lisis de Potencial de Ingresos</p>
        </div>
        
        <div class="space-y-4">
            <div>
                <p class="text-[11px] text-slate-300 font-bold leading-tight">
                    Al activar las herramientas de <span id="welcome-next-tier-name" class="text-white font-black">Siguiente Nivel</span>:
                </p>
            </div>

            <div class="flex justify-between items-center bg-black/20 p-4 rounded-2xl border border-white/5">
                <div>
                    <div class="flex items-baseline gap-2">
                        <span class="text-emerald-400 font-black text-2xl">+</span>
                        <span id="welcome-extra-sales" class="text-5xl font-black text-white">0</span>
                    </div>
                    <p class="text-[9px] text-emerald-400 font-black uppercase tracking-widest">Ventas Extra / Mes</p>
                </div>
                <div class="text-right border-l border-white/10 pl-4">
                    <p class="text-[9px] text-slate-400 font-bold uppercase mb-1">Total Proyectado:</p>
                    <span id="welcome-total-potential" class="text-2xl font-black text-white">0</span>
                    <p class="text-[8px] text-slate-500 font-bold">Eq. Mensuales</p>
                </div>
            </div>
        </div>

        <p id="welcome-motivational-phrase" class="text-[10px] text-slate-400 mt-4 italic leading-tight">
            "Con el Pack Masivo, tu alcance en Facebook se triplica autom√°ticamente."
        </p>
    </div>
</div>
            </div>

            <!-- BOT√ìN DE CIERRE PRINCIPAL -->
            <button onclick="closeWelcomeAgent()" class="w-full bg-[#1a4789] hover:bg-[#2c6fb5] text-white py-5 rounded-[1.5rem] font-black uppercase tracking-[0.2em] shadow-xl shadow-blue-500/20 transition-all active:scale-95">
                ¬°Entendido, a vender!
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes pop-in {
        0% { transform: scale(0.9); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
    .animate-pop-in { animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
</style>

<!-- MODAL INTRODUCCI√ìN PRECIOS FLEXIBLES -->
<div id="modal-intro-precios" class="fixed inset-0 z-[400] hidden bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300">
    
    <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2rem] overflow-hidden shadow-2xl relative animate-pop-in border border-white/10">
        
        <!-- Decoraci√≥n de Fondo -->
        <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-br from-indigo-600 to-blue-500"></div>
        <div class="absolute top-4 right-4 bg-white/20 p-2 rounded-full backdrop-blur-md">
            <span class="material-symbols-outlined text-white text-2xl">monetization_on</span>
        </div>

        <!-- Contenido -->
        <div class="relative pt-12 px-8 pb-8">
            
            <!-- Icono Principal Flotante -->
            <div class="bg-white dark:bg-slate-800 w-20 h-20 rounded-2xl shadow-xl flex items-center justify-center mx-auto mb-6 border-4 border-indigo-50 dark:border-slate-700">
                <span class="material-symbols-outlined text-4xl text-indigo-600">tune</span>
            </div>

            <div class="text-center mb-8">
                <h3 class="text-2xl font-black text-slate-800 dark:text-white uppercase italic tracking-tight mb-2">
                    Configurador de <span class="text-indigo-600">Precios</span>
                </h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-medium">
                    Toma el control total de tus ganancias.
                </p>
            </div>

            <!-- Lista de Beneficios -->
            <div class="space-y-4 mb-8">
                
                <!-- Punto 1 -->
                <div class="flex items-start gap-3 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                    <span class="material-symbols-outlined text-blue-500 bg-blue-100 dark:bg-blue-900/30 p-1 rounded-lg text-lg">edit</span>
                    <div>
                        <p class="text-xs font-black uppercase text-slate-700 dark:text-slate-300">Sube el Precio</p>
                        <p class="text-[11px] text-slate-500 leading-tight mt-0.5">
                            Edita el precio de venta en los productos marcados como <span class="font-bold text-blue-500">"Flexibles"</span>.
                        </p>
                    </div>
                </div>

                <!-- Punto 2 -->
                <div class="flex items-start gap-3 bg-emerald-50 dark:bg-emerald-900/20 p-3 rounded-xl border border-emerald-100 dark:border-emerald-800/30">
                    <span class="material-symbols-outlined text-emerald-500 bg-emerald-100 dark:bg-emerald-900/30 p-1 rounded-lg text-lg">savings</span>
                    <div>
                        <p class="text-xs font-black uppercase text-emerald-700 dark:text-emerald-400">100% Ganancia Extra</p>
                        <p class="text-[11px] text-emerald-600/80 dark:text-emerald-500 leading-tight mt-0.5">
                            Todo lo que subas por encima del precio base es <span class="font-bold underline">tuyo</span>.
                        </p>
                    </div>
                </div>

                <!-- Punto 3 -->
                <div class="flex items-start gap-3 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                    <span class="material-symbols-outlined text-purple-500 bg-purple-100 dark:bg-purple-900/30 p-1 rounded-lg text-lg">link</span>
                    <div>
                        <p class="text-xs font-black uppercase text-slate-700 dark:text-slate-300">Visible en tu Link</p>
                        <p class="text-[11px] text-slate-500 leading-tight mt-0.5">
                            Tus clientes ver√°n autom√°ticamente el precio final que t√∫ decidiste.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Bot√≥n de Acci√≥n -->
            <button onclick="closePriceIntro()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-xl font-black uppercase tracking-widest shadow-lg shadow-indigo-500/30 transition-all active:scale-95">
                ¬°Entendido, a configurar!
            </button>

        </div>
    </div>
</div>
</body>
</html>